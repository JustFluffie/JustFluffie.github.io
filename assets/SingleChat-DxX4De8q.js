import{m as Q,E as He,r as C,G as We,u as Qe,i as ce,q as J,D as ne,_ as j,k as K,a as S,o as h,e,f as q,z as M,y as m,h as de,w as z,v as N,x as H,M as Z,c as V,b as U,F as O,A as oe,n as D,H as re,C as Y,I as pe,t as F,d as W,S as se,J as Ke,L as Xe,N as Ye,B as X,s as be,O as Je,P as te,Q as Ze}from"./index-RyrZYN_Z.js";function _e(t,u){const a=Q(),s=He(),v=ce(),o=Qe(),n=C(!1);return{isTyping:n,triggerAiResponse:async()=>{console.log("[useAiResponder] triggerAiResponse triggered"),n.value=!0;try{const c=a.getCharacter(t.value),r=await u.getChatCompletion(t.value);if(r){a.messages[t.value]||(a.messages[t.value]=[]);const l=(c==null?void 0:c.isBlocked)||!1;let g=r.split("|||"),x=[];const f=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g;g.forEach(p=>{const d=p.split(f).map(b=>b.trim()).filter(b=>b);x.push(...d)});for(let p=0;p<x.length;p++){const d=x[p];p>0&&await new Promise(k=>setTimeout(k,1e3+Math.random()*1e3));let{type:b,content:L}=We(d),P={};if(b==="sticker"){const k=L,E=a.stickers.find(T=>T.name===k);E?(L=E.url,P.name=k):(b="text",L=`[表情包：${k}]`)}let B=!1;b==="image"&&!L.startsWith("http")&&!L.startsWith("data:")&&(B=!0),a.messages[t.value].push({id:Date.now().toString()+p,sender:"char",type:b,content:L,isTextGenerated:B,...P,time:Date.now(),blocked:l}),a.saveData(),o.path!==`/chat/room/${t.value}`&&(a.incrementUnreadCount(t.value),s.triggerNotification(c.nickname||c.name,b==="text"?L:`[${b}]`,c.avatar,()=>{v.push(`/chat/room/${t.value}`)},3e3,b))}}}catch(c){console.error("[useAiResponder] triggerAiResponse failed:",c)}finally{n.value=!1}}}}function et(t){const u=Q(),a=J(),s=C(!1),v=C(new Set),o=C(!1),n=g=>{console.log("[useMessageSelection] enterSelectionMode triggered"),s.value=!0,v.value.clear(),g&&v.value.add(g)},i=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),s.value=!1,v.value.clear()};return{isSelectionMode:s,selectedMessageIds:v,isForwarding:o,enterSelectionMode:n,exitSelectionMode:i,toggleMessageSelection:g=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${g}`),v.value.has(g)?v.value.delete(g):v.value.add(g)},handleBatchAction:g=>{if(console.log(`[useMessageSelection] handleBatchAction: ${g}`),v.value.size===0)return;const x=u.messages[t.value];g==="forward"?o.value=!0:g==="delete"?a.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),u.messages[t.value]=x.filter(f=>!v.value.has(f.id)),u.saveData(),i()}):g==="favorite"&&(u.favorites||(u.favorites=[]),x.forEach(f=>{v.value.has(f.id)&&(u.favorites.some(p=>p.id===f.id)||u.favorites.push(f))}),u.saveData(),a.showToast("已收藏","success"),i())},handleConfirmForward:g=>{console.log("[useMessageSelection] handleConfirmForward triggered"),o.value=!1;const f=(u.messages[t.value]||[]).filter(p=>v.value.has(p.id));f.length!==0&&(g.forEach(p=>{u.messages[p]||(u.messages[p]=[]),f.forEach(d=>{const b={...d,id:Date.now().toString()+Math.random()};u.messages[p].push(b)})}),u.saveData(),a.showToast(`已转发 ${f.length} 条消息`),i())}}}function tt(t,u,a){const s=C(null);return{editingMessageId:s,handleEditMessage:i=>{console.log("[useMessageEditing] handleEditMessage for msgId:",i),s.value=i},handleSaveEdit:({msgId:i,newContent:c})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",i);const l=t.messages[u.value].find(g=>g.id===i);l&&(l.content=c,t.saveData()),s.value=null},updateInputText:i=>{console.log("[useMessageEditing] updateInputText called"),a&&(a.value=i,ne(()=>{const c=document.querySelector(".chat-input");c&&c.focus()}))}}}function st(t,u,a,s){const v=C(""),o=C(null),n=(f,p,d={})=>{console.log(`[useMessageSender] sendMsg called with type: ${f}`);const b={...d};o.value&&(b.quote={id:o.value.id,sender:o.value.sender,content:o.value.content}),t.messages[u.value]||(t.messages[u.value]=[]),t.messages[u.value].push({id:Date.now().toString()+Math.random(),sender:"user",type:f,content:p,time:Date.now(),...b}),t.saveData(),s&&(s.value=null),o.value=null};return{inputText:v,quotingMessage:o,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const f=v.value.trim();f&&(n("text",f),v.value="")},sendMsg:n,sendSticker:f=>{console.log("[useMessageSender] sendSticker triggered"),n("sticker",f.url,{name:f.name})},sendVoiceMessage:f=>{console.log("[useMessageSender] sendVoiceMessage triggered"),f&&n("voice",f)},handleSendImage:f=>{console.log("[useMessageSender] handleSendImage triggered"),f.isTextGenerated?n("image",f.description,{isTextGenerated:!0}):(f.type==="base64"||f.type==="url")&&n("image",f.content)},confirmSendLocation:(f,p)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!f){a.showToast("请输入位置名称","info");return}n("location",f,{detail:p})},sendTransfer:()=>{console.log("[useMessageSender] sendTransfer triggered"),n("transfer","88.88")}}}function nt(t){const u=C(null),a=C(!1),s=C({x:0,y:0}),v=(r,l)=>{console.log("[useMessageInteraction] showMenu triggered"),r.preventDefault();const g=r.target.closest(".msg-bubble, .system-message-wrapper");g&&(t.value={visible:!0,messageId:l,targetEl:g})};return{startLongPress:(r,l)=>{console.log("[useMessageInteraction] startLongPress triggered"),r.stopPropagation(),a.value=!1,clearTimeout(u.value),r.type.startsWith("touch")&&(s.value={x:r.touches[0].clientX,y:r.touches[0].clientY}),u.value=setTimeout(()=>{a.value=!0,v(r,l)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(u.value)},handleTouchMove:r=>{console.log("[useMessageInteraction] handleTouchMove triggered");const l=r.touches[0],g=Math.abs(l.clientX-s.value.x),x=Math.abs(l.clientY-s.value.y);(g>10||x>10)&&clearTimeout(u.value)},wasClickAfterLongPress:()=>a.value?(a.value=!1,!0):!1}}const ot={class:"chat-room-header"},at={class:"left-icons"},lt={class:"center-container"},it={class:"header-title-area"},rt={key:0,class:"chat-room-title"},ct={key:1,class:"typing-indicator"},dt={class:"right-icons"},ut={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},vt=["placeholder"],gt=["placeholder"],mt={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:u}){const a=t,{t:s}=K(),v=ce(),o=Q(),n=J(),i=C(!1),c=C(""),r=C(""),l=()=>{v.options.history.state.back?v.back():v.push("/chat")},g=()=>{const p=a.charStatus||{};c.value=p.icon||"✨",r.value=p.text||"",i.value=!0},x=()=>{const p=c.value.trim()||"✨",d=r.value.trim(),b=o.getCharacter(a.charId);b&&(d?b.status={icon:p,text:d}:b.status=null,o.saveData(),n.showToast(s("saveSuccess"))),i.value=!1},f=()=>{v.push({name:"memory-bank",params:{charId:a.charId}})};return(p,d)=>(h(),S("div",ot,[e("div",at,[e("div",{class:"btn-icon back-btn",onClick:l},[...d[6]||(d[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polyline",{points:"15 18 9 12 15 6"})],-1)])]),e("div",{class:"btn-icon bell-btn",onClick:d[0]||(d[0]=b=>p.$emit("trigger-ai")),ref:"bellBtn"},[...d[7]||(d[7]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)]),e("div",lt,[e("div",it,[t.isTyping?(h(),S("div",ct,[e("span",null,M(m(s)("chat.singleChat.typing")),1),d[8]||(d[8]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(h(),S("div",rt,M(t.charName),1))]),e("div",{class:"chat-room-status",onClick:g},[e("span",null,M(t.charStatus.icon||"✨"),1),e("span",null,M(t.charStatus.text||m(s)("chat.singleChat.addStatus")),1)])]),e("div",dt,[e("div",{class:"btn-icon memory-btn",onClick:f},[...d[9]||(d[9]=[de('<svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-c4e37645><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" data-v-c4e37645></path><polyline points="14 2 14 8 20 8" data-v-c4e37645></polyline><line x1="16" y1="13" x2="8" y2="13" data-v-c4e37645></line><line x1="16" y1="17" x2="8" y2="17" data-v-c4e37645></line><polyline points="10 9 9 9 8 9" data-v-c4e37645></polyline></svg>',1)])]),e("div",{class:"btn-icon more-btn",onClick:d[1]||(d[1]=b=>p.$emit("open-settings"))},[...d[10]||(d[10]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])]),q(Z,{visible:i.value,"onUpdate:visible":d[5]||(d[5]=b=>i.value=b),title:m(s)("chat.singleChat.setStatus")},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:d[4]||(d[4]=b=>i.value=!1)},M(m(s)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:x},M(m(s)("confirm")),1)]),default:z(()=>[e("div",ut,[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":d[2]||(d[2]=b=>c.value=b),placeholder:m(s)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,vt),[[H,c.value]]),N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":d[3]||(d[3]=b=>r.value=b),placeholder:m(s)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,gt),[[H,r.value]])])]),_:1},8,["visible","title"])]))}},ft=j(mt,[["__scopeId","data-v-c4e37645"]]),pt={key:0,class:"chat-panel",id:"stickerPanel"},bt={class:"sticker-panel-header"},ht={class:"sticker-groups"},kt=["onClick"],yt={class:"sticker-panel-content"},St=["onClick"],Mt=["src","alt"],Ct={class:"sticker-panel-footer"},$t={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:u}){const a=u,s=Q(),v=J(),o=C("默认"),n=C(!1),i=C(new Set),c=C(!1),r=C(!1),l=C(""),g=V(()=>["默认",...new Set(s.stickers.map(I=>I.group).filter(Boolean).filter(I=>I!=="默认"))]),x=V(()=>s.stickers.filter(T=>T.group===o.value)),f=T=>{n.value?i.value.has(T.id)?i.value.delete(T.id):i.value.add(T.id):a("send-sticker",T)},p=({group:T,stickers:I})=>{const w=I.map(R=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:R.url,name:R.name,group:T}));s.stickers.push(...w),s.saveData(),v.showToast(`成功导入 ${w.length} 个表情包`,"success")},d=()=>{c.value=!0},b=()=>{i.value.size>0&&(r.value=!0)},L=()=>{n.value=!n.value,i.value.clear()},P=()=>{const T=x.value;T.every(w=>i.value.has(w.id))?T.forEach(w=>i.value.delete(w.id)):T.forEach(w=>i.value.add(w.id))},B=()=>{i.value.size!==0&&v.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{s.stickers=s.stickers.filter(T=>!i.value.has(T.id)),s.saveData(),i.value.clear()})},k=()=>{const T=l.value.trim();if(!T)return v.showToast("请输入目标分组","info");s.stickers.forEach(I=>{i.value.has(I.id)&&(I.group=T)}),s.saveData(),r.value=!1,l.value="",i.value.clear(),n.value=!1,o.value=T},E=()=>{if(i.value.size===0)return;const T=s.stickers.filter(G=>i.value.has(G.id)).map(G=>`${G.name} ${G.url}`).join(`
`),I=new Blob([T],{type:"text/plain"}),w=URL.createObjectURL(I),R=document.createElement("a");R.href=w,R.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(w),i.value.clear(),n.value=!1};return(T,I)=>(h(),S("div",null,[t.visible?(h(),S("div",pt,[e("div",bt,[e("div",ht,[(h(!0),S(O,null,oe(g.value,w=>(h(),S("div",{class:D(["sticker-group-tab",{active:o.value===w}]),key:w,onClick:R=>o.value=w},M(w),11,kt))),128))])]),e("div",yt,[(h(!0),S(O,null,oe(x.value,w=>(h(),S("div",{class:D(["sticker-item",{selected:i.value.has(w.id),"manage-mode":n.value}]),key:w.id,onClick:R=>f(w)},[e("img",{src:w.url,alt:w.name},null,8,Mt),e("span",null,M(w.name),1)],10,St))),128))]),e("div",Ct,[N(e("div",{class:"sticker-add-btn",onClick:d},"＋",512),[[re,!n.value]]),e("div",{class:"sticker-manage-btn",style:Y({color:n.value?"var(--danger-color)":"#576B95"}),onClick:L},M(n.value?"完成":"管理"),5)]),e("div",{class:D(["manage-bar",{active:n.value}])},[e("button",{class:"btn btn-secondary",onClick:d},"导入"),e("button",{class:"btn btn-secondary",onClick:P},"全选"),e("button",{class:"btn btn-secondary",onClick:b},"移动"),e("button",{class:"btn btn-secondary",onClick:E},"导出"),e("button",{class:"btn btn-danger",onClick:B},"删除")],2)])):U("",!0),q(pe,{visible:c.value,"onUpdate:visible":I[0]||(I[0]=w=>c.value=w),type:"sticker-import",onImportSticker:p},null,8,["visible"]),q(Z,{visible:r.value,"onUpdate:visible":I[3]||(I[3]=w=>r.value=w),title:"移动到分组"},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:I[2]||(I[2]=w=>r.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:k},"确定")]),default:z(()=>[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":I[1]||(I[1]=w=>l.value=w),placeholder:"输入目标分组名称"},null,512),[[H,l.value]])]),_:1},8,["visible"])]))}},wt=j($t,[["__scopeId","data-v-f9fb1def"]]),xt={class:"chat-panel",id:"morePanel"},It={class:"more-panel-content"},Tt={class:"more-label"},Bt={class:"more-label"},Pt={class:"more-label"},At={class:"more-label"},Lt={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:u}=K();return(a,s)=>(h(),S("div",xt,[e("div",It,[e("div",{class:"more-item",onClick:s[0]||(s[0]=v=>a.$emit("trigger-image-upload"))},[s[4]||(s[4]=de('<div class="more-icon" data-v-731b24d5><svg class="svg-icon" viewBox="0 0 24 24" data-v-731b24d5><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-731b24d5></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-731b24d5></circle><polyline points="21 15 16 10 5 21" data-v-731b24d5></polyline></svg></div>',1)),e("span",Tt,M(m(u)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:s[1]||(s[1]=v=>a.$emit("start-video-call"))},[s[5]||(s[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Bt,M(m(u)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:s[2]||(s[2]=v=>a.$emit("send-location"))},[s[6]||(s[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",Pt,M(m(u)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:s[3]||(s[3]=v=>a.$emit("send-transfer"))},[s[7]||(s[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),e("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})])],-1)),e("span",At,M(m(u)("chat.morePanel.transfer")),1)])])]))}},Et=j(Lt,[["__scopeId","data-v-731b24d5"]]),Vt={class:"chat-footer"},Rt={key:0,class:"quote-preview"},qt={class:"quote-content"},Ut={class:"quote-sender"},Dt={class:"quote-text"},Nt={class:"chat-input-row"},zt={class:"chat-input-wrapper"},jt=["value"],Ft={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"21px",height:"21px",position:"relative",top:"1px",left:"-1px"}},Gt={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:u}){const{t:a}=K(),s=t,v=u,o=C(s.activePanel);F(()=>s.activePanel,r=>{o.value=r}),F(o,r=>{v("update:activePanel",r)});const n=r=>{o.value===r?o.value=null:o.value=r},i=()=>{s.modelValue.trim()&&v("send-message")},c=r=>{v("send-sticker",r),o.value=null};return(r,l)=>(h(),S("div",Vt,[t.quotingMessage?(h(),S("div",Rt,[e("div",qt,[e("span",Ut,M(t.quotingMessage.sender==="user"?m(a)("chat.self"):m(a)("chat.other"))+": ",1),e("span",Dt,M(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:l[0]||(l[0]=g=>r.$emit("cancel-quote"))},[...l[9]||(l[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):U("",!0),e("div",Nt,[e("div",{class:"chat-tool-btn",onClick:l[1]||(l[1]=g=>r.$emit("trigger-voice"))},[q(se,{name:"voice-circle",class:"svg-icon"})]),e("div",zt,[e("input",{type:"text",class:"chat-input",value:t.modelValue,onInput:l[2]||(l[2]=g=>r.$emit("update:modelValue",g.target.value)),onKeypress:Ke(i,["enter"]),id:"messageInput",autocomplete:"new-password"},null,40,jt)]),e("div",{class:"chat-tool-btn",onClick:l[3]||(l[3]=g=>n("sticker"))},[q(se,{name:"sticker",class:"svg-icon"})]),t.modelValue?(h(),S("div",{key:1,class:"send-btn-icon",onClick:i},[(h(),S("svg",Ft,[...l[10]||(l[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(h(),S("div",{key:0,class:"chat-tool-btn",onClick:l[4]||(l[4]=g=>n("more"))},[q(se,{name:"plus-circle",class:"svg-icon"})]))]),q(wt,{visible:o.value==="sticker",onSendSticker:c},null,8,["visible"]),o.value==="more"?(h(),W(Et,{key:1,onTriggerImageUpload:l[5]||(l[5]=g=>r.$emit("trigger-image")),onStartVideoCall:l[6]||(l[6]=g=>r.$emit("trigger-video")),onSendLocation:l[7]||(l[7]=g=>r.$emit("trigger-location")),onSendTransfer:l[8]||(l[8]=g=>r.$emit("trigger-transfer"))})):U("",!0)]))}},Ot=j(Gt,[["__scopeId","data-v-5b0f6609"]]),Ht={class:"menu-grid"},Wt={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:u}){const a=t,s=u,v=Xe("phoneScreenRef"),{t:o}=K(),n=Q(),i=J(),c=C(null),r=C({}),l=C(0),g=C("top");F(()=>a.visible,async p=>{p&&a.targetEl&&(await ne(),x())});const x=()=>{const p=c.value;if(!p)return;const d=a.targetEl.getBoundingClientRect(),b=p.offsetWidth,L=p.offsetHeight,P=8,B=v.value,k=B?B.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};g.value="top";let E=d.top-L-P;E<k.top+P&&(g.value="bottom",E=d.bottom+P);const T=d.left+d.width/2;let I=T-b/2;I<k.left+P&&(I=k.left+P),I+b>k.left+k.width-P&&(I=k.left+k.width-b-P);let w=T-I;const R=12,G=R/2+5,_=b-R/2-5;w=Math.max(G,Math.min(w,_)),r.value={top:`${E}px`,left:`${I}px`},l.value=w},f=p=>{const d=a.messageId;if(!d)return;const b=n.messages[a.charId],L=b.findIndex(k=>k.id===d),P=b[L],B={copy:()=>{P.content&&(navigator.clipboard.writeText(P.content),i.showToast(o("chat.messageMenu.toast.copied")))},favorite:()=>{n.favorites||(n.favorites=[]),n.favorites.some(k=>k.id===P.id)?i.showToast(o("chat.messageMenu.toast.alreadyFavorited")):(n.favorites.push(P),n.saveData(),i.showToast(o("chat.messageMenu.toast.favorited")))},delete:()=>{i.showConfirm(o("chat.messageMenu.confirmDelete"),o("chat.messageMenu.confirmDeleteMsg"),()=>{n.messages[a.charId].splice(L,1),n.saveData()})},revoke:()=>{P&&(P.type="revoked",n.saveData(),i.showToast(o("chat.messageMenu.toast.revoked")))},select:()=>s("enter-selection-mode",d),quote:()=>s("quote-message",d),retry:()=>{P.sender!=="user"?(n.messages[a.charId].splice(L,1),n.saveData(),s("trigger-ai-response")):i.showToast(o("chat.messageMenu.toast.retryAiOnly"),"info")},edit:()=>{P.type==="text"?s("edit-message",d):i.showToast(o("chat.messageMenu.toast.editTextOnly"),"info")}};B[p]&&B[p](),s("close")};return(p,d)=>t.visible?(h(),S("div",{key:0,ref_key:"menuRef",ref:c,class:D(["message-menu",{"menu-top":g.value==="top","menu-bottom":g.value==="bottom"}]),style:Y(r.value)},[e("div",Ht,[e("div",{class:"menu-item",onClick:d[0]||(d[0]=b=>f("copy"))},M(m(o)("copy")),1),e("div",{class:"menu-item",onClick:d[1]||(d[1]=b=>f("favorite"))},M(m(o)("favorite")),1),e("div",{class:"menu-item",onClick:d[2]||(d[2]=b=>f("delete"))},M(m(o)("delete")),1),e("div",{class:"menu-item",onClick:d[3]||(d[3]=b=>f("revoke"))},M(m(o)("revoke")),1),e("div",{class:"menu-item",onClick:d[4]||(d[4]=b=>f("select"))},M(m(o)("select")),1),e("div",{class:"menu-item",onClick:d[5]||(d[5]=b=>f("quote"))},M(m(o)("quote")),1),e("div",{class:"menu-item",onClick:d[6]||(d[6]=b=>f("retry"))},M(m(o)("retry")),1),e("div",{class:"menu-item",onClick:d[7]||(d[7]=b=>f("edit"))},M(m(o)("edit")),1)]),e("div",{class:"menu-arrow",style:Y({left:l.value+"px"})},null,4)],6)):U("",!0)}},Qt=j(Wt,[["__scopeId","data-v-9d6ff2c4"]]),Kt={class:"chat-action-row"},Xt={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:u}=K();return(a,s)=>(h(),S("div",Kt,[e("div",{class:"action-btn",onClick:s[0]||(s[0]=v=>a.$emit("action","favorite"))},[s[4]||(s[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,M(m(u)("favorite")),1)]),e("div",{class:"action-btn",onClick:s[1]||(s[1]=v=>a.$emit("action","forward"))},[s[5]||(s[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,M(m(u)("forward")),1)]),e("div",{class:"action-btn",onClick:s[2]||(s[2]=v=>a.$emit("action","delete"))},[s[6]||(s[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,M(m(u)("delete")),1)]),e("div",{class:"action-btn",onClick:s[3]||(s[3]=v=>a.$emit("cancel"))},[s[7]||(s[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,M(m(u)("done")),1)])]))}},Yt=j(Xt,[["__scopeId","data-v-be1a592f"]]),Jt={class:"msg-avatar"},Zt=["src"],_t={class:"msg-content-wrapper"},es={class:"msg-bubble-box"},ts={key:0,class:"quote-in-bubble"},ss={class:"quote-in-bubble-sender"},ns={class:"quote-in-bubble-text"},os={key:1,class:"edit-view"},as={key:0},ls={class:"description-placeholder"},is=["src"],rs={key:2,class:"sticker-msg"},cs=["src"],ds={key:3,class:"voice-msg-wrapper"},us={class:"voice-msg"},vs={key:4,class:"location-msg"},gs={class:"location-text"},ms={class:"msg-title"},fs={key:5,class:"transfer-msg"},ps={class:"transfer-content"},bs={class:"transfer-info"},hs={class:"transfer-amount"},ks={class:"transfer-desc"},ys={key:6,class:"call-summary-msg"},Ss={key:0,class:"blocked-icon"},Ms={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg"],setup(t,{emit:u}){const a=t,s=u,v=Ye(),o=C(!1),n=C(!1),i=C(""),c=V(()=>a.editingMessageId===a.msg.id),r=V(()=>{const B=a.msg.type;return{"no-style":["image","sticker","location","transfer"].includes(B),"has-location":B==="location","has-transfer":B==="transfer"}});F(c,B=>{B&&(i.value=a.msg.content)});const l=B=>{s("long-press",B,a.msg.id)},g=()=>{s("cancel-long-press")},x=B=>{s("touch-move",B)},f=B=>{a.msg.type==="voice"&&p(),a.msg.type!=="image"&&s("click-msg",B,a.msg.id)},p=()=>{o.value=!o.value},d=()=>{n.value=!n.value},b=()=>{i.value.trim()&&s("save-edit",{msgId:a.msg.id,newContent:i.value})},L=()=>{s("cancel-edit")},P=()=>a.msg.type==="notification"?a.msg.content:a.msg.type==="revoked"?`"${a.msg.sender==="user"?"你":a.charName}" 撤回了一条消息`:"";return(B,k)=>(h(),S("div",{class:D(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[e("div",{class:D(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:k[0]||(k[0]=X(E=>B.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),t.msg.type==="revoked"||t.msg.type==="notification"?(h(),S("div",{key:0,class:"system-message-wrapper",onMousedown:l,onMouseup:g,onMouseleave:g,onTouchstart:l,onTouchend:g,onTouchmove:x,onClick:X(f,["prevent"])},[e("div",{class:"system-message-text",onClick:k[1]||(k[1]=X(E=>!t.isSelectionMode&&d(),["stop"]))},M(P()),1),t.msg.type==="revoked"?N((h(),S("div",{key:0,class:"revoked-content"},M(t.msg.sender==="user"?"我":t.charName)+"："+M(t.msg.content),513)),[[re,n.value]]):U("",!0)],32)):(h(),S(O,{key:1},[e("div",Jt,[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(h(),S("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,Zt)):(h(),S("div",{key:1,class:D(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",_t,[e("div",es,[e("div",{class:D(["msg-bubble",r.value]),style:Y(t.bubbleStyle),onMousedown:l,onMouseup:g,onMouseleave:g,onTouchstart:l,onTouchend:g,onTouchmove:x,onClick:X(f,["prevent"])},[t.msg.quote?(h(),S("div",ts,[e("div",ss,M(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",ns,M(t.msg.quote.content),1)])):U("",!0),c.value?(h(),S("div",os,[N(e("textarea",{"onUpdate:modelValue":k[2]||(k[2]=E=>i.value=E),class:"edit-textarea",rows:"3"},null,512),[[H,i.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:L,class:"edit-btn cancel"},"取消"),e("button",{onClick:b,class:"edit-btn save"},"保存")])])):(h(),S(O,{key:2},[t.msg.type==="text"?(h(),S("div",as,M(t.msg.content),1)):t.msg.type==="image"?(h(),S(O,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(h(),S("div",{key:0,class:"text-generated-image-container",onClick:k[3]||(k[3]=E=>m(v).preview(t.msg))},[e("div",ls,M(t.msg.content),1)])):(h(),S("div",{key:1,class:"image-msg",onClick:k[4]||(k[4]=E=>m(v).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,is)]))],64)):t.msg.type==="sticker"?(h(),S("div",rs,[e("img",{src:t.msg.content,alt:"表情包"},null,8,cs)])):t.msg.type==="voice"?(h(),S("div",ds,[e("div",us,[q(se,{name:"voice-wave",class:D(["voice-icon-svg",{playing:o.value}])},null,8,["class"]),e("span",null,M(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(h(),S("div",vs,[e("div",gs,[e("div",ms,M(t.msg.content||"位置信息"),1),k[5]||(k[5]=e("div",{class:"msg-desc"},"详细地址",-1))]),k[6]||(k[6]=de('<div class="location-map" data-v-8cb932da><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-8cb932da><div class="location-pin" data-v-8cb932da><svg viewBox="0 0 24 24" fill="currentColor" data-v-8cb932da><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-8cb932da></path></svg></div></div>',1))])):t.msg.type==="transfer"?(h(),S("div",fs,[e("div",ps,[k[7]||(k[7]=e("div",{class:"transfer-icon"},"¥",-1)),e("div",bs,[e("div",hs,"¥"+M(t.msg.content),1),e("div",ks,M(t.msg.sender==="user"?`转账给${t.charName}`:"转账给你"),1)])]),k[8]||(k[8]=e("div",{class:"transfer-footer"},"微信转账",-1))])):t.msg.type==="call_summary"?(h(),S("div",ys,[k[9]||(k[9]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,M(t.msg.content),1)])):U("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(h(),S("div",Ss,[...k[10]||(k[10]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):U("",!0)]),t.msg.type==="voice"?N((h(),S("div",{key:0,class:"voice-text"},M(t.msg.content),513)),[[re,o.value]]):U("",!0)])],64))],2))}},Cs=j(Ms,[["__scopeId","data-v-8cb932da"]]),$s={key:0,class:"empty-message"},ws={key:0,class:"blocked-overlay"},xs={class:"blocked-content"},Is={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content"],setup(t,{expose:u}){const a=t,s=C(null),v=()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight)};return F(()=>a.messages,()=>{ne(()=>{v()})},{deep:!0}),F(()=>a.activePanel,o=>{o&&ne(()=>{v()})}),be(()=>{v()}),u({scrollToBottom:v}),(o,n)=>(h(),S(O,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:s},[t.messages.length===0?(h(),S("div",$s," 开始和 "+M(t.charName)+" 聊天吧~ ",1)):U("",!0),(h(!0),S(O,null,oe(t.messages,i=>(h(),W(Cs,{key:i.id,msg:i,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(i.id),editingMessageId:t.editingMessageId,onSaveEdit:n[0]||(n[0]=c=>o.$emit("save-edit",c)),onCancelEdit:n[1]||(n[1]=c=>o.$emit("cancel-edit")),onToggleSelection:n[2]||(n[2]=c=>o.$emit("toggle-selection",c)),onLongPress:n[3]||(n[3]=(c,r)=>o.$emit("long-press",c,r)),onCancelLongPress:n[4]||(n[4]=c=>o.$emit("cancel-long-press")),onTouchMove:n[5]||(n[5]=c=>o.$emit("touch-move",c)),onClickMsg:n[6]||(n[6]=(c,r)=>o.$emit("click-msg",c,r)),onShowTextContent:n[7]||(n[7]=c=>o.$emit("show-text-content",c))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"]))),128))],512),t.isBlocked?(h(),S("div",ws,[e("div",xs,[n[9]||(n[9]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:n[8]||(n[8]=i=>o.$emit("unblock"))},"解除拉黑")])])):U("",!0)],64))}},Ts=j(Is,[["__scopeId","data-v-460d6803"]]),Bs={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:u}){const a=t,s=u,v=V({get:()=>a.visible,set:i=>s("update:visible",i)}),o=C("");F(()=>a.visible,i=>{i&&(o.value="")});const n=()=>{const i=o.value.trim();s("confirm",i),v.value=!1};return(i,c)=>(h(),W(Z,{visible:v.value,"onUpdate:visible":c[2]||(c[2]=r=>v.value=r),title:"发送语音"},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:c[1]||(c[1]=r=>v.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:n},"发送")]),default:z(()=>[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":c[0]||(c[0]=r=>o.value=r),placeholder:"输入语音内容..."},null,512),[[H,o.value]])]),_:1},8,["visible"]))}},Ps={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:u}){const a=t,s=u,v=V({get:()=>a.visible,set:c=>s("update:visible",c)}),o=C(""),n=C("");F(()=>a.visible,c=>{c&&(o.value="",n.value="")});const i=()=>{const c=o.value.trim(),r=n.value.trim();c&&(s("confirm",{name:c,detail:r}),v.value=!1)};return(c,r)=>(h(),W(Z,{visible:v.value,"onUpdate:visible":r[3]||(r[3]=l=>v.value=l),title:"发送位置"},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:r[2]||(r[2]=X(l=>v.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:i},"发送")]),default:z(()=>[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[0]||(r[0]=l=>o.value=l),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[H,o.value]]),N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[1]||(r[1]=l=>n.value=l),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[H,n.value]])]),_:1},8,["visible"]))}},As={class:"chat-list-container"},Ls=["onClick"],Es=["src"],Vs={class:"chat-info"},Rs={class:"chat-name"},qs=["disabled"],Us={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:u}){const a=t,s=u,v=Q(),o=C(a.visible),n=C(new Set),i=V(()=>v.characters);F(()=>a.visible,l=>{o.value=l,l||n.value.clear()});const c=l=>{n.value.has(l)?n.value.delete(l):n.value.add(l)},r=()=>{n.value.size>0&&s("confirm",Array.from(n.value))};return(l,g)=>(h(),W(Z,{visible:o.value,"onUpdate:visible":g[1]||(g[1]=x=>o.value=x),title:"选择聊天",onClose:g[2]||(g[2]=x=>l.$emit("close"))},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:g[0]||(g[0]=x=>l.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:n.value.size===0,onClick:r}," 确定 ("+M(n.value.size)+") ",9,qs)]),default:z(()=>[e("div",As,[(h(!0),S(O,null,oe(i.value,x=>(h(),S("div",{key:x.id,class:"chat-item",onClick:f=>c(x.id)},[e("img",{src:x.avatar,alt:"avatar",class:"avatar"},null,8,Es),e("div",Vs,[e("div",Rs,M(x.name),1)]),e("div",{class:D(["checkbox",{selected:n.value.has(x.id)}])},null,2)],8,Ls))),128))])]),_:1},8,["visible"]))}},Ds=j(Us,[["__scopeId","data-v-00bcf675"]]),Ns={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const u=t;ce();const{t:a}=K(),s=Q(),v=J(),o=Je(),n=C(null),i=C(null),c=C(null),r=C(!1),l=C({visible:!1,messageId:null,targetEl:null}),g=C(!1),x=C(!1),f=C(!1),p=V(()=>s.getCharacter(u.charId)),d=V(()=>{var $;return(($=p.value)==null?void 0:$.isBlocked)||!1}),b=V(()=>{var $,y;return(($=p.value)==null?void 0:$.nickname)||((y=p.value)==null?void 0:y.name)||a("chat.unknownCharacter")}),L=V(()=>{var $;return($=p.value)==null?void 0:$.avatar}),P=V(()=>{var $;return(($=p.value)==null?void 0:$.status)||{}}),B=V(()=>{var $;return(($=p.value)==null?void 0:$.chatBackground)||""}),k=V(()=>{var y;const $=s.userPersonas;if((y=p.value)!=null&&y.userPersona&&p.value.userPersona!=="default"){const A=$.find(le=>le.id===p.value.userPersona);if(A&&A.avatar)return A.avatar}return localStorage.getItem("homeAvatar")||""}),E=V(()=>s.messages[u.charId]||[]),T=V(()=>{var $;return(($=p.value)==null?void 0:$.bubbleSettings)||{}}),{isSelectionMode:I,selectedMessageIds:w,isForwarding:R,enterSelectionMode:G,exitSelectionMode:_,toggleMessageSelection:ue,handleBatchAction:he,handleConfirmForward:ke}=et(te(u,"charId")),{isTyping:ye,triggerAiResponse:ve}=_e(te(u,"charId"),o),{inputText:ee,quotingMessage:ae,sendMessage:Se,sendSticker:Me,sendVoiceMessage:Ce,handleSendImage:$e,confirmSendLocation:we,sendTransfer:xe}=st(s,te(u,"charId"),v,c),{editingMessageId:ge,handleEditMessage:Ie,handleSaveEdit:Te,updateInputText:Be}=tt(s,te(u,"charId"),ee),{startLongPress:Pe,cancelLongPress:Ae,handleTouchMove:Le,wasClickAfterLongPress:Ee}=nt(l),Ve=V(()=>{const $=T.value,y={fontSize:$.fontSize?`${$.fontSize}px`:"14px"};if($.css){const A={};return $.css.split(";").forEach(le=>{const ie=le.split(":");if(ie.length>=2){const me=ie[0].trim(),fe=ie.slice(1).join(":").trim();me&&fe&&(A[me]=fe)}}),{...y,...A}}return y});be(()=>{s.clearUnreadCount(u.charId)});const Re=()=>{p.value&&(p.value.isBlocked=!1,s.messages[u.charId]&&s.messages[u.charId].forEach($=>{$.blocked&&($.blocked=!1)}),s.saveData(),v.showToast(a("chat.toast.unblocked")))},qe=$=>{const y=$.target;y.closest(".modal-overlay.active")||(c.value&&!y.closest(".chat-footer")&&(c.value=null),I.value&&!y.closest(".message")&&!y.closest(".chat-action-row")&&!y.closest(".message-checkbox")&&!y.closest(".message-menu")&&_(),l.value.visible&&!y.closest(".message-menu")&&(l.value.visible=!1))},Ue=($,y)=>{if(Ee()){$.preventDefault(),$.stopPropagation();return}I.value&&ue(y)},De=$=>{const y=E.value.find(A=>A.id===$);y&&(ae.value=y)},Ne=()=>{x.value=!0},ze=$=>{Ce($),x.value=!1},je=()=>{c.value=null,g.value=!0},Fe=()=>{f.value=!0},Ge=({name:$,detail:y})=>{we($,y),f.value=!1},Oe=()=>{s.startVideoCall(u.charId)};return($,y)=>(h(),S("div",{class:D(["chat-room active",{"selection-mode":m(I)}]),onClick:qe,ref_key:"chatRoomRef",ref:i},[e("div",{class:"chat-bg",style:Y(B.value?{backgroundImage:`url(${B.value})`}:{})},null,4),q(ft,{charId:u.charId,charName:b.value,charStatus:P.value,isTyping:m(ye),onTriggerAi:m(ve),onOpenSettings:y[0]||(y[0]=A=>r.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),q(Ts,{ref_key:"messageListRef",ref:n,messages:E.value,charName:b.value,charAvatar:L.value,userAvatar:k.value,bubbleStyle:Ve.value,isSelectionMode:m(I),selectedMessageIds:m(w),isBlocked:d.value,editingMessageId:m(ge),activePanel:c.value,onSaveEdit:m(Te),onCancelEdit:y[1]||(y[1]=A=>ge.value=null),onToggleSelection:m(ue),onLongPress:m(Pe),onCancelLongPress:m(Ae),onTouchMove:m(Le),onClickMsg:Ue,onUnblock:Re},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),m(I)?U("",!0):(h(),W(Ot,{key:0,modelValue:m(ee),"onUpdate:modelValue":y[2]||(y[2]=A=>Ze(ee)?ee.value=A:null),activePanel:c.value,"onUpdate:activePanel":y[3]||(y[3]=A=>c.value=A),quotingMessage:m(ae),onCancelQuote:y[4]||(y[4]=A=>ae.value=null),onSendMessage:m(Se),onSendSticker:m(Me),onTriggerVoice:Ne,onTriggerImage:je,onTriggerVideo:Oe,onTriggerLocation:Fe,onTriggerTransfer:m(xe)},null,8,["modelValue","activePanel","quotingMessage","onSendMessage","onSendSticker","onTriggerTransfer"])),m(I)?(h(),W(Yt,{key:1,onAction:m(he),onCancel:m(_)},null,8,["onAction","onCancel"])):U("",!0),q(Bs,{visible:x.value,"onUpdate:visible":y[5]||(y[5]=A=>x.value=A),onConfirm:ze},null,8,["visible"]),q(pe,{visible:g.value,"onUpdate:visible":y[6]||(y[6]=A=>g.value=A),onSendImage:m($e)},null,8,["visible","onSendImage"]),q(Ps,{visible:f.value,"onUpdate:visible":y[7]||(y[7]=A=>f.value=A),onConfirm:Ge},null,8,["visible"]),q(Qt,{visible:l.value.visible,targetEl:l.value.targetEl,messageId:l.value.messageId,charId:u.charId,isSelectionMode:m(I),selectedMessageIds:m(w),onClose:y[8]||(y[8]=A=>l.value.visible=!1),onEnterSelectionMode:m(G),onTriggerAiResponse:m(ve),"onUpdate:inputText":m(Be),onQuoteMessage:De,onEditMessage:m(Ie)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),q(Ds,{visible:m(R),onClose:y[9]||(y[9]=A=>R.value=!1),onConfirm:m(ke)},null,8,["visible","onConfirm"])],2))}},js=j(Ns,[["__scopeId","data-v-4f4d4569"]]);export{js as default};
