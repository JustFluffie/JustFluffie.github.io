import{_ as P,r as $,x as X,a6 as le,c as C,d as f,o as c,e,g as x,f as T,E as A,t as w,w as Y,A as q,D as L,O as K,F as H,C as E,y as oe,ch as ee,ci as j,S as G,by as Q,i as V,b as Z,u as z,W as te,k as B,n as ie,h as he,cx as me,V as ne,m as ve,B as ge,a9 as fe,a4 as be}from"./index-rmqAKKIs.js";const ye={key:0,class:"upload-hint"},De={class:"left-section"},ke={key:0,class:"upload-hint"},_e={class:"date-info"},Se={class:"weekday"},$e={class:"date"},we={class:"right-section"},Ce={class:"text-inputs-row"},Me={class:"photos-row"},xe={key:0,class:"upload-hint"},Ie={key:0,class:"upload-hint"},Ne={__name:"CharPhoneHeader",props:{widgetData:{type:Object,default:()=>({background:"",avatar:"",photos:["",""],photoTexts:["",""]})}},emits:["update:widgetData"],setup(t,{emit:n}){var h,l;const s=t,y=n,v=$(!1),r=$("background"),g=$(0),d=$([((h=s.widgetData.photoTexts)==null?void 0:h[0])||"",((l=s.widgetData.photoTexts)==null?void 0:l[1])||""]),b=$(""),u=$("");let k=null;const p=()=>{const o=new Date,a=(o.getMonth()+1).toString().padStart(2,"0"),i=o.getDate().toString().padStart(2,"0");b.value=`${a}.${i}`;const F=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];u.value=F[o.getDay()]};X(()=>{p(),k=setInterval(p,6e4)}),le(()=>{k&&clearInterval(k)});const D=C(()=>s.widgetData.background?{backgroundImage:`url('${s.widgetData.background}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),_=C(()=>s.widgetData.avatar?{backgroundImage:`url('${s.widgetData.avatar}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),I=o=>s.widgetData.photos[o]?{backgroundImage:`url('${s.widgetData.photos[o]}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"},N=()=>{r.value="background",v.value=!0},O=()=>{r.value="avatar",v.value=!0},U=o=>{g.value=o,r.value=`photo${o}`,v.value=!0},S=o=>{const a={...s.widgetData};r.value==="background"?a.background=o.content:r.value==="avatar"?a.avatar=o.content:r.value.startsWith("photo")&&(a.photos=[...s.widgetData.photos],a.photos[g.value]=o.content),y("update:widgetData",a)},m=o=>{const a={...s.widgetData,photoTexts:[...d.value]};y("update:widgetData",a)};return(o,a)=>(c(),f("div",{class:"char-phone-header",onClick:L(N,["stop"])},[e("div",{class:"widget-background",style:A(D.value)},[t.widgetData.background?T("",!0):(c(),f("div",ye," 点击上传 "))],4),e("div",{class:"widget-content",onClick:a[8]||(a[8]=L(()=>{},["stop"]))},[e("div",De,[e("div",{class:"avatar-circle",style:A(_.value),onClick:O},[t.widgetData.avatar?T("",!0):(c(),f("div",ke," 点击上传 "))],4),e("div",_e,[e("div",Se,w(u.value),1),e("div",$e,w(b.value),1)])]),e("div",we,[e("div",Ce,[Y(e("input",{"onUpdate:modelValue":a[0]||(a[0]=i=>d.value[0]=i),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:a[1]||(a[1]=i=>m()),onClick:a[2]||(a[2]=L(()=>{},["stop"]))},null,544),[[q,d.value[0]]]),Y(e("input",{"onUpdate:modelValue":a[3]||(a[3]=i=>d.value[1]=i),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:a[4]||(a[4]=i=>m()),onClick:a[5]||(a[5]=L(()=>{},["stop"]))},null,544),[[q,d.value[1]]])]),e("div",Me,[e("div",{class:"photo-item",style:A(I(0)),onClick:a[6]||(a[6]=i=>U(0))},[t.widgetData.photos[0]?T("",!0):(c(),f("div",xe," 点击上传 "))],4),e("div",{class:"photo-item",style:A(I(1)),onClick:a[7]||(a[7]=i=>U(1))},[t.widgetData.photos[1]?T("",!0):(c(),f("div",Ie," 点击上传 "))],4)])])]),x(K,{visible:v.value,"onUpdate:visible":a[9]||(a[9]=i=>v.value=i),type:"basic","biz-type":r.value,onUploadComplete:S},null,8,["visible","biz-type"])]))}},Te=P(Ne,[["__scopeId","data-v-baafc6b9"]]),Ue={class:"char-phone-middle-widget"},Oe={class:"photo-section"},Ae={class:"photo-wrapper"},Pe={key:0,class:"upload-hint"},Fe={class:"app-section"},Je={class:"app-grid-wrapper"},Be={class:"app-grid"},Re=["onClick"],We={class:"app-label"},Le={__name:"CharPhoneMiddleWidget",props:{widgetData:{type:Object,default:()=>({photo:"",apps:[]})}},emits:["update:widgetData","app-click"],setup(t,{emit:n}){const s=t,y=n,v=$(!1),r=C(()=>s.widgetData.photo?{backgroundImage:`url('${s.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),g=()=>{v.value=!0},d=u=>{y("app-click",u)},b=u=>{const k={...s.widgetData};k.photo=u.content,y("update:widgetData",k)};return(u,k)=>(c(),f("div",Ue,[e("div",Oe,[e("div",Ae,[e("div",{class:"photo-container",style:A(r.value),onClick:g},[t.widgetData.photo?T("",!0):(c(),f("div",Pe," 点击上传 "))],4)])]),e("div",Fe,[e("div",Je,[e("div",Be,[(c(!0),f(H,null,E(t.widgetData.apps,(p,D)=>(c(),f("div",{key:D,class:"app-item",onClick:_=>d(p)},[e("div",{class:"app-icon",style:A({background:p.color})},null,4),e("div",We,w(p.label),1)],8,Re))),128))])])]),x(K,{visible:v.value,"onUpdate:visible":k[0]||(k[0]=p=>v.value=p),type:"basic","biz-type":"photo",onUploadComplete:b},null,8,["visible"])]))}},je=P(Le,[["__scopeId","data-v-1ed9bd3c"]]),He={class:"char-phone-bottom-widget"},Ve={class:"app-section"},Ee={class:"app-grid-wrapper"},ze={class:"app-grid"},Ge=["onClick"],Ye={class:"app-label"},qe={class:"photo-section"},Ke={class:"photo-wrapper"},Ze={key:0,class:"upload-hint"},Qe={class:"text-inputs"},Xe={__name:"CharPhoneBottomWidget",props:{widgetData:{type:Object,default:()=>({photo:"",text1:"",text2:"",apps:[]})}},emits:["update:widgetData"],setup(t,{emit:n}){const s=t,y=n,v=$(!1),r=C(()=>s.widgetData.photo?{backgroundImage:`url('${s.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),g=()=>{v.value=!0},d=k=>{console.log("打开应用:",k.label)},b=k=>{const p={...s.widgetData};p.photo=k.content,y("update:widgetData",p)},u=()=>{y("update:widgetData",{...s.widgetData})};return(k,p)=>(c(),f("div",He,[e("div",Ve,[e("div",Ee,[e("div",ze,[(c(!0),f(H,null,E(t.widgetData.apps,(D,_)=>(c(),f("div",{key:_,class:"app-item",onClick:I=>d(D)},[e("div",{class:"app-icon",style:A({background:D.color})},null,4),e("div",Ye,w(D.label),1)],8,Ge))),128))])])]),e("div",qe,[e("div",Ke,[e("div",{class:"photo-container",style:A(r.value),onClick:g},[t.widgetData.photo?T("",!0):(c(),f("div",Ze," 点击上传 "))],4),e("div",Qe,[Y(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":p[0]||(p[0]=D=>t.widgetData.text1=D),placeholder:"输入文本1",onInput:u},null,544),[[q,t.widgetData.text1]]),Y(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":p[1]||(p[1]=D=>t.widgetData.text2=D),placeholder:"输入文本2",onInput:u},null,544),[[q,t.widgetData.text2]])])])]),x(K,{visible:v.value,"onUpdate:visible":p[2]||(p[2]=D=>v.value=D),type:"basic","biz-type":"photo",onUploadComplete:b},null,8,["visible"])]))}},et=P(Xe,[["__scopeId","data-v-97a53399"]]),tt={class:"char-phone-widget-container"},at={class:"widget-item top-widget"},st={class:"widget-item middle-widget"},ot={class:"widget-item bottom-widget"},nt={__name:"CharPhoneWidgetContainer",props:{headerData:{type:Object,required:!0},middleData:{type:Object,required:!0},bottomData:{type:Object,required:!0}},emits:["update:headerData","update:middleData","update:bottomData","app-click"],setup(t,{emit:n}){const s=n,y=d=>{s("update:headerData",d)},v=d=>{s("update:middleData",d)},r=d=>{s("update:bottomData",d)},g=d=>{s("app-click",d)};return(d,b)=>(c(),f("div",tt,[e("div",at,[x(Te,{"widget-data":t.headerData,"onUpdate:widgetData":y},null,8,["widget-data"])]),e("div",st,[x(je,{"widget-data":t.middleData,"onUpdate:widgetData":v,onAppClick:g},null,8,["widget-data"])]),e("div",ot,[x(et,{"widget-data":t.bottomData,"onUpdate:widgetData":r},null,8,["widget-data"])])]))}},lt=P(nt,[["__scopeId","data-v-94277424"]]),it={class:"char-phone-dock"},rt={class:"message-row other-message"},dt={key:0,class:"upload-hint"},ct=["data-placeholder"],ut={class:"message-row my-message"},pt=["data-placeholder"],ht={key:0,class:"upload-hint"},mt={__name:"CharPhoneDock",props:{dockData:{type:Object,default:()=>({avatars:{other:"",mine:""},messages:{other:"",mine:""}})}},emits:["update:dockData"],setup(t,{emit:n}){var S,m;const s=t,y=n,v=$(!1),r=$("avatar-other"),g=$({other:((S=s.dockData.messages)==null?void 0:S.other)||"",mine:((m=s.dockData.messages)==null?void 0:m.mine)||""}),d=$(!1),b=$(null),u=$(null);oe(()=>g.value.other,h=>{b.value&&b.value.textContent!==h&&(b.value.textContent=h)},{immediate:!0}),oe(()=>g.value.mine,h=>{u.value&&u.value.textContent!==h&&(u.value.textContent=h)},{immediate:!0});const k=()=>{d.value=!0},p=(h,l)=>{d.value=!1,g.value[l]=h.target.textContent},D=(h,l)=>{d.value||(g.value[l]=h.target.textContent)},_=(h,l)=>{g.value[l]=h.target.textContent,U()},I=h=>{var o;const l=(o=s.dockData.avatars)==null?void 0:o[h];return l?{backgroundImage:`url('${l}')`,backgroundSize:"cover",backgroundPosition:"center",backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.9)"}},N=h=>{r.value=`avatar-${h}`,v.value=!0},O=h=>{const l={...s.dockData,avatars:{...s.dockData.avatars}};r.value==="avatar-other"?l.avatars.other=h.content:r.value==="avatar-mine"&&(l.avatars.mine=h.content),y("update:dockData",l)},U=h=>{const l={...s.dockData,messages:{...g.value}};y("update:dockData",l)};return(h,l)=>(c(),f("div",it,[e("div",rt,[e("div",{class:"avatar",style:A(I("other")),onClick:l[0]||(l[0]=o=>N("other"))},[t.dockData.avatars.other?T("",!0):(c(),f("div",dt," 点击上传 "))],4),e("div",{ref_key:"bubbleOtherRef",ref:b,class:"bubble bubble-other",onClick:l[1]||(l[1]=L(()=>{},["stop"])),contenteditable:"true",onCompositionstart:k,onCompositionend:l[2]||(l[2]=o=>p(o,"other")),onInput:l[3]||(l[3]=o=>D(o,"other")),onBlur:l[4]||(l[4]=o=>_(o,"other")),"data-placeholder":g.value.other?"":"点击输入文字"},null,40,ct)]),e("div",ut,[e("div",{ref_key:"bubbleMineRef",ref:u,class:"bubble bubble-mine",onClick:l[5]||(l[5]=L(()=>{},["stop"])),contenteditable:"true",onCompositionstart:k,onCompositionend:l[6]||(l[6]=o=>p(o,"mine")),onInput:l[7]||(l[7]=o=>D(o,"mine")),onBlur:l[8]||(l[8]=o=>_(o,"mine")),"data-placeholder":g.value.mine?"":"点击输入文字"},null,40,pt),e("div",{class:"avatar",style:A(I("mine")),onClick:l[9]||(l[9]=o=>N("mine"))},[t.dockData.avatars.mine?T("",!0):(c(),f("div",ht," 点击上传 "))],4)]),x(K,{visible:v.value,"onUpdate:visible":l[10]||(l[10]=o=>v.value=o),type:"basic","biz-type":r.value,onUploadComplete:O},null,8,["visible","biz-type"])]))}},vt=P(mt,[["__scopeId","data-v-0f4f42af"]]),gt=ee("diary",{state:()=>({diaries:{}}),actions:{initData(){const t=localStorage.getItem("aiPhoneDiaryData");if(t)try{const n=j.decompressFromUTF16(t),s=JSON.parse(n||t);this.diaries=s.diaries||{}}catch(n){console.error("Failed to parse diary data",n),this.diaries={}}else this.migrateFromSingleStore()},migrateFromSingleStore(){try{const t=localStorage.getItem("aiPhoneSingleChatData");if(t){const n=j.decompressFromUTF16(t),s=JSON.parse(n||t);s&&s.diaries&&(this.diaries=s.diaries,this.saveData(),console.log("Successfully migrated diaries from singleStore"))}}catch(t){console.error("Failed to migrate diary data",t)}},saveData(){setTimeout(()=>{const t={diaries:this.diaries};try{const n=JSON.stringify(t),s=j.compressToUTF16(n);localStorage.setItem("aiPhoneDiaryData",s)}catch(n){console.error("Error saving diary data",n)}},0)},addDiary(t,n){this.diaries[t]||(this.diaries[t]=[]),this.diaries[t].unshift({id:Date.now().toString(),content:n,timestamp:Date.now()}),this.saveData()},getDiaries(t){return this.diaries[t]||[]},deleteDiary(t,n){if(this.diaries[t]){const s=this.diaries[t].findIndex(y=>y.id===n);s!==-1&&(this.diaries[t].splice(s,1),this.saveData())}},clearDiaries(t){this.diaries[t]&&(delete this.diaries[t],this.saveData())}}}),ft={class:"c-phone-app-header"},bt={class:"title"},yt={class:"header-actions"},Dt={__name:"CPhoneAppHeader",props:{title:{type:String,default:""},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["back","clear","refresh"],setup(t,{emit:n}){const s=n,y=()=>{s("back")};return(v,r)=>(c(),f("header",ft,[e("div",{class:"back-btn",onClick:y},[x(G,{name:"back-btn",class:"back-icon"})]),e("h1",bt,w(t.title),1),e("div",yt,[t.showClear?(c(),f("div",{key:0,class:"action-btn",onClick:r[0]||(r[0]=g=>s("clear"))},[x(G,{name:"trash"})])):T("",!0),t.showRefresh?(c(),f("div",{key:1,class:"action-btn",onClick:r[1]||(r[1]=g=>s("refresh"))},[x(G,{name:"refresh"})])):T("",!0),Q(v.$slots,"action",{},void 0,!0)])]))}},kt=P(Dt,[["__scopeId","data-v-05bc6111"]]),_t={class:"app-container"},St={__name:"CPhoneAppsLayout",props:{title:{type:String,default:""},background:{type:String,default:"#ffffff"},color:{type:String,default:"#000000"},themeColor:{type:String,default:"#000000"},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["close","clear","refresh"],setup(t,{emit:n}){const s=n,y=()=>{s("close")};return(v,r)=>(c(),f("div",{class:"c-phone-app-layout",style:A({"--app-bg":t.background,"--app-text":t.color,"--app-theme":t.themeColor})},[x(kt,{title:t.title,"show-clear":t.showClear,"show-refresh":t.showRefresh,onBack:y,onClear:r[0]||(r[0]=g=>s("clear")),onRefresh:r[1]||(r[1]=g=>s("refresh"))},{action:V(()=>[Q(v.$slots,"action",{},void 0,!0)]),_:3},8,["title","show-clear","show-refresh"]),e("div",_t,[Q(v.$slots,"default",{},void 0,!0)])],4))}},ae=P(St,[["__scopeId","data-v-9de005de"]]),$t={key:0,class:"diary-notebook-container"},wt={class:"open-book-leather"},Ct={class:"paper-stack"},Mt={class:"paper-sheet"},xt={key:0,class:"polaroid"},It={class:"photo-frame"},Nt=["src"],Tt={class:"photo-name"},Ut={class:"paper-content"},Ot={class:"diary-header"},At={class:"date-group"},Pt={class:"day"},Ft={class:"month-year-group"},Jt={class:"month"},Bt={class:"year"},Rt={class:"weekday-badge"},Wt={class:"diary-body"},Lt={key:0,class:"generating-container"},jt={class:"fountain-pen-loading"},Ht={key:1,class:"handwritten-text"},Vt={class:"page-number"},Et={class:"cover-texture"},zt={class:"cover-label"},Gt={class:"label-border"},Yt={class:"book-subtitle"},qt={class:"owner-name"},Kt={__name:"CharDiary",emits:["close"],setup(t,{emit:n}){const s=n,y=Z(),v=z(),r=gt(),g=te(),d=y.params.charId,b=$(!1),u=C(()=>v.getCharacter(d)),k=C(()=>u.value?`${u.value.name}的日记`:"日记"),p=C(()=>r.getDiaries(d)),D=C(()=>p.value.length>0?p.value[0]:null),_=C(()=>{var a;return b.value?Date.now():((a=D.value)==null?void 0:a.timestamp)||Date.now()}),I=C(()=>{var a;return(a=D.value)!=null&&a.content?D.value.content.split(`
`).filter(i=>i.trim()):[]}),N=a=>new Date(Number(a)).getDate().toString().padStart(2,"0"),O=a=>["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][new Date(Number(a)).getMonth()],U=a=>new Date(Number(a)).getFullYear(),S=a=>["Sun.","Mon.","Tue.","Wed.","Thu.","Fri.","Sat."][new Date(Number(a)).getDay()],m=a=>{a.target.style.display="none",a.target.parentElement.style.backgroundColor="#eee"},h=()=>{s("close")},l=()=>{D.value&&confirm("确定要撕掉这页日记吗？")&&r.deleteDiary(d,D.value.id)},o=async()=>{if(!b.value){b.value=!0;try{const a=v.getCharacter(d);if(!a)return;const F=v.getFormattedRecentMessages(d,20).map(W=>`${W.role==="user"?"用户":"我"}: ${W.content}`).join(`
`),R=`你现在是${a.name}。请根据以下最近的聊天记录，写一篇简短的日记（100-200字）。
日记应该以第一人称“我”的视角，记录最近发生的事情、你的心情和对用户的想法。
请直接输出日记内容，不要包含任何其他解释或格式。

聊天记录：
${F}

日记内容：`;let M=null;a.api&&a.api!=="default"&&(M=g.presets.find(W=>W.name===a.api));const J=await g.getGenericCompletion([{role:"user",content:R}],M);J&&r.addDiary(d,J.trim())}catch(a){console.error("Failed to generate diary:",a)}finally{b.value=!1}}};return(a,i)=>(c(),B(ae,{title:k.value,"show-clear":!0,"show-refresh":!0,onClose:h,onClear:l,onRefresh:o,background:"#f8f6f3",color:"#37474f",themeColor:"#555"},{default:V(()=>{var F,R;return[e("div",{class:ie(["diary-container",{"is-open":D.value||b.value}])},[i[10]||(i[10]=e("div",{class:"desktop-texture"},null,-1)),D.value||b.value?(c(),f("div",$t,[e("div",wt,[i[2]||(i[2]=e("div",{class:"bookmark-ribbon"},null,-1)),e("div",Ct,[e("div",Mt,[u.value?(c(),f("div",xt,[e("div",It,[e("img",{src:u.value.avatar,alt:"char",onError:m},null,40,Nt)]),e("div",Tt,w(u.value.name),1)])):T("",!0),e("div",Ut,[e("div",Ot,[e("div",At,[e("span",Pt,w(N(_.value)),1),e("div",Ft,[e("span",Jt,w(O(_.value)),1),e("span",Bt,w(U(_.value)),1)]),e("div",Rt,w(S(_.value)),1)]),i[0]||(i[0]=e("div",{class:"stamp-mark"},[e("div",{class:"stamp-inner"},"CONFIDENTIAL")],-1))]),i[1]||(i[1]=e("div",{class:"diary-divider"},null,-1)),e("div",Wt,[b.value?(c(),f("div",Lt,[e("div",jt,[x(G,{name:"pencil",class:"pen-icon"}),e("span",null,w(((F=u.value)==null?void 0:F.name)||"Ta")+" 正在提笔...",1)])])):(c(),f("div",Ht,[(c(!0),f(H,null,E(I.value,(M,J)=>(c(),f("p",{key:J},w(M),1))),128))]))]),e("div",Vt,"- "+w(new Date(Number(_.value)).getDate())+" -",1)])])])])])):(c(),f("div",{key:1,class:"diary-book-cover",onClick:o},[i[9]||(i[9]=e("div",{class:"book-spine"},null,-1)),e("div",Et,[i[7]||(i[7]=e("div",{class:"stitching-border"},null,-1)),e("div",zt,[e("div",Gt,[i[4]||(i[4]=e("h2",{class:"book-title"},"DIARY",-1)),e("div",Yt,[e("span",qt,w(((R=u.value)==null?void 0:R.name)||"Character"),1),i[3]||(i[3]=e("span",{class:"of-word"},"'s",-1))]),i[5]||(i[5]=e("div",{class:"label-line"},null,-1)),i[6]||(i[6]=e("div",{class:"book-hint"},"打开日记本",-1))])]),i[8]||(i[8]=e("div",{class:"elastic-band"},null,-1))])]))],2)]}),_:1},8,["title"]))}},Zt=P(Kt,[["__scopeId","data-v-8dbdc24d"]]);function Qt(t){const n=t.match(/```json\n([\s\S]*?)\n```/);if(n&&n[1])try{return JSON.parse(n[1])}catch(s){return console.error("Failed to parse JSON from AI response:",s),null}return console.error("No JSON block found in AI response."),null}const Xt=ee("memo",{state:()=>({memos:{},isLoading:!1}),actions:{async _updateMemosViaApi(t,n){this.isLoading=!0;const s=te(),v=z().getCharacter(t);if(!v){console.error("Character not found for memo operation"),this.isLoading=!1;return}const r=this.memos[t]||[],g=`
你是角色 ${v.name} 的备忘录管理助手。
你的任务是管理一个备忘录列表。当前的备忘录列表如下:
${JSON.stringify(r,null,2)}

用户希望执行以下操作: "${n}"。

请在一个JSON代码块中，返回**完整的、更新后的**备忘录列表。
JSON应该是一个对象数组，每个对象包含 "id"、"content" 和 "timestamp" 字段。
返回示例格式:
\`\`\`json
[
  { "id": "1678886400000", "content": "买牛奶", "timestamp": 1678886400000 },
  { "id": "1678886400001", "content": "打电话给妈妈", "timestamp": 1678886400001 }
]
\`\`\`
`;try{const d=await s.getGenericCompletion([{role:"system",content:g.trim()}]);if(d&&d.content){const b=Qt(d.content);b?this.memos[t]=b:console.error("Could not update memos due to invalid API response.")}}catch(d){console.error("Error updating memos via API:",d)}finally{this.isLoading=!1}},async fetchMemos(t){await this._updateMemosViaApi(t,"列出所有当前的备忘录。")},async addMemo(t,n){const s={id:Date.now().toString(),content:n,timestamp:Date.now()};await this._updateMemosViaApi(t,`添加以下新备忘录: ${JSON.stringify(s)}`)},async deleteMemo(t,n){await this._updateMemosViaApi(t,`删除ID为 "${n}" 的备忘录。`)},async updateMemo(t,n,s){await this._updateMemosViaApi(t,`将ID为 "${n}" 的备忘录内容更新为: "${s}"。`)},async clearMemos(t){await this._updateMemosViaApi(t,"删除所有备忘录并返回一个空列表。")},getMemos(t){return this.memos[t]||[]}}}),ea={class:"memo-list cork-board"},ta=["onBlur"],aa={class:"memo-footer"},sa={class:"memo-date"},oa=["onClick"],na={key:0,class:"empty-state"},la={__name:"CharMemo",emits:["close"],setup(t,{emit:n}){const s=n,y=Z(),v=z(),r=Xt(),g=y.params.charId,d=C(()=>v.getCharacter(g)),b=C(()=>r.getMemos(g)),u=C(()=>r.isLoading),k=C(()=>d.value?`${d.value.name}的备忘录`:"备忘录");X(()=>{r.fetchMemos(g)});const p=()=>{s("close")},D=S=>{const m=new Date(Number(S));return`${m.getMonth()+1}/${m.getDate()} ${m.getHours()}:${m.getMinutes().toString().padStart(2,"0")}`},_=async()=>{await r.addMemo(g,"新备忘录")},I=async()=>{await _()},N=async()=>{confirm("确定要清除所有备忘录吗？")&&await r.clearMemos(g)},O=async(S,m)=>{const h=m.target.innerText;await r.updateMemo(g,S,h)},U=async S=>{confirm("确定要删除这条备忘录吗？")&&await r.deleteMemo(g,S)};return(S,m)=>{const h=he("svg-icon");return c(),B(ae,{title:k.value,"show-clear":!0,"show-refresh":!0,onClose:p,onClear:N,onRefresh:I,background:"#8d6e63",color:"#fff",themeColor:"#d7ccc8"},{default:V(()=>[e("div",ea,[u.value?(c(),B(me,{key:0,text:"正在与AI同步备忘录..."})):T("",!0),u.value?T("",!0):(c(),f(H,{key:1},[(c(!0),f(H,null,E(b.value,l=>(c(),f("div",{key:l.id,class:"memo-item"},[m[0]||(m[0]=e("div",{class:"pin"},null,-1)),e("div",{class:"memo-content",contenteditable:"true",onBlur:o=>O(l.id,o)},w(l.content),41,ta),e("div",aa,[e("span",sa,w(D(l.timestamp)),1),e("div",{class:"delete-btn",onClick:o=>U(l.id)},[x(h,{name:"trash",class:"delete-icon"})],8,oa)])]))),128)),b.value.length===0?(c(),f("div",na,[...m[1]||(m[1]=[e("div",{class:"empty-hint"},[e("span",null,"墙上空空如也..."),e("br"),e("small",null,"点击右上角贴一张新的便利贴吧")],-1)])])):T("",!0)],64))])]),_:1},8,["title"])}}},ia=P(la,[["__scopeId","data-v-c1901049"]]),ra=ee("schedule",{state:()=>({schedules:{}}),actions:{initData(){const t=localStorage.getItem("aiPhoneScheduleData");if(t)try{const n=j.decompressFromUTF16(t),s=JSON.parse(n||t);this.schedules=s.schedules||{}}catch(n){console.error("Failed to parse schedule data",n),this.schedules={}}else this.migrateFromSingleStore()},migrateFromSingleStore(){try{const t=localStorage.getItem("aiPhoneSingleChatData");if(t){const n=j.decompressFromUTF16(t),s=JSON.parse(n||t);s&&s.schedules&&(this.schedules=s.schedules,this.saveData(),console.log("Successfully migrated schedules from singleStore"))}}catch(t){console.error("Failed to migrate schedule data",t)}},saveData(){setTimeout(()=>{const t={schedules:this.schedules};try{const n=JSON.stringify(t),s=j.compressToUTF16(n);localStorage.setItem("aiPhoneScheduleData",s)}catch(n){console.error("Error saving schedule data",n)}},0)},addSchedule(t,n){this.schedules[t]||(this.schedules[t]=[]),this.schedules[t].unshift({id:Date.now().toString(),content:n,timestamp:Date.now()}),this.saveData()},updateSchedule(t,n,s){if(!this.schedules[t])return;const y=this.schedules[t].find(v=>v.id===n);y&&(y.content=s,this.saveData())},getSchedules(t){return this.schedules[t]||[]},deleteSchedule(t,n){if(this.schedules[t]){const s=this.schedules[t].findIndex(y=>y.id===n);s!==-1&&(this.schedules[t].splice(s,1),this.saveData())}},clearSchedules(t){this.schedules[t]&&(delete this.schedules[t],this.saveData())}}}),da={key:0,class:"schedule-paper"},ca={class:"paper-content"},ua={class:"schedule-header"},pa={class:"date-stamp"},ha={class:"schedule-body"},ma={key:0,class:"generating-text"},va={key:1,class:"handwritten-text"},ga={class:"time-col"},fa={class:"event-col"},ba={key:1,class:"empty-state"},ya={__name:"CharSchedule",emits:["close"],setup(t,{emit:n}){const s=n,y=Z(),v=z(),r=ra(),g=te(),d=y.params.charId,b=$(!1),u=C(()=>v.getCharacter(d)),k=C(()=>r.getSchedules(d)),p=C(()=>k.value.length>0?k.value[0]:null),D=C(()=>u.value?`${u.value.name}的行程`:"行程表"),_=()=>{s("close")},I=S=>{const m=new Date(Number(S)),h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return`${m.getFullYear()}.${(m.getMonth()+1).toString().padStart(2,"0")}.${m.getDate().toString().padStart(2,"0")} ${h[m.getDay()]}`},N=()=>{p.value&&confirm("确定要撕掉这张行程表吗？")&&r.deleteSchedule(d,p.value.id)},O=S=>S?S.split(`
`).map(m=>{if(m=m.trim(),!m)return null;const h=m.match(/^(\d{1,2}:\d{2})/);if(h){const l=h[1];let o=m.substring(l.length).trim();return(o.startsWith(":")||o.startsWith("：")||o.startsWith("-"))&&(o=o.substring(1).trim()),{time:l,event:o}}else return{time:"",event:m}}).filter(m=>m!==null):[],U=async()=>{if(!b.value){b.value=!0;try{if(!u.value)return;const m=v.getFormattedRecentMessages(d,10).map(M=>`${M.role==="user"?"用户":"我"}: ${M.content}`).join(`
`),h=new Date,l=`${h.getFullYear()}.${(h.getMonth()+1).toString().padStart(2,"0")}.${h.getDate().toString().padStart(2,"0")}`;let o=null;if(p.value){const M=new Date(Number(p.value.timestamp));`${M.getFullYear()}.${(M.getMonth()+1).toString().padStart(2,"0")}.${M.getDate().toString().padStart(2,"0")}`===l&&(o=p.value)}const a=`${h.getHours().toString().padStart(2,"0")}:${h.getMinutes().toString().padStart(2,"0")}`;let i="";o?i=`角色:${u.value.name}
当前时间:${l} ${a}
任务:以角色的口吻补充现有行程表(仅补充${a}之前未记录的)。

规则:
1.严禁包含晚于${a}的时间点。
2.格式:HH:MM 事件内容
3.输出完整列表(含旧数据)，按时间排序。
4.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
5.每条字数控制在10-20字。

现有行程:
${o.content}

完整行程:`:i=`角色:${u.value.name}
当前时间:${l} ${a}
任务:根据参考聊天和角色设定，以角色的口吻生成截止到目前的今日行程(已发生的事)。

规则:
1.严禁包含晚于${a}的时间点。
2.格式:HH:MM 事件内容
3.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
4.每条字数控制在10-20字。

参考聊天:
${m}

行程:`;let F=null;u.value.api&&u.value.api!=="default"&&(F=g.presets.find(M=>M.name===u.value.api));const R=await g.getGenericCompletion([{role:"user",content:i}],F);if(R){const M=R.split(`
`).filter(J=>{const W=J.trim().match(/^(\d{1,2}:\d{2})/);if(W){const[se,re]=W[1].split(":").map(Number),de=se*60+re,[ce,ue]=a.split(":").map(Number),pe=ce*60+ue;return de<=pe}return!0}).join(`
`);o?r.updateSchedule(d,o.id,M.trim()):r.addSchedule(d,M.trim())}}catch(S){console.error("Failed to generate schedule:",S)}finally{b.value=!1}}};return(S,m)=>(c(),B(ae,{title:D.value,"show-clear":!0,"show-refresh":!0,onClose:_,onClear:N,onRefresh:U,background:"#f0f4f8",color:"#37474f",themeColor:"#546e7a"},{default:V(()=>[p.value||b.value?(c(),f("div",da,[e("div",ca,[e("div",ua,[m[0]||(m[0]=e("div",{class:"clip"},null,-1)),e("div",pa,w(b.value?I(Date.now()):I(p.value.timestamp)),1)]),e("div",ha,[b.value?(c(),f("div",ma,"正在确认行程...")):(c(),f("div",va,[(c(!0),f(H,null,E(O(p.value.content),(h,l)=>(c(),f("div",{key:l,class:"schedule-item"},[e("div",ga,w(h.time),1),e("div",fa,w(h.event),1)]))),128))]))])])])):(c(),f("div",ba,[...m[1]||(m[1]=[e("div",{class:"empty-hint"},[ne("行程表是空的..."),e("br"),ne("点击右上角，看看我今天做了什么吧")],-1)])]))]),_:1},8,["title"]))}},Da=P(ya,[["__scopeId","data-v-ba3515c3"]]),ka={class:"char-phone-container"},_a={class:"char-phone-frame"},Sa={class:"char-phone-screen"},$a={class:"char-status-bar"},wa={class:"time"},Ca={class:"char-content"},Ma={__name:"CharPhone",setup(t){const{t:n}=ve(),s=Z();z();const y=s.params.charId,v=$("");let r=null;const g=()=>{const o=new Date,a=o.getHours().toString().padStart(2,"0"),i=o.getMinutes().toString().padStart(2,"0");v.value=`${a}:${i}`};X(()=>{g(),r=setInterval(g,1e3),I()}),le(()=>{r&&clearInterval(r)});const d=$({background:"",avatar:"",photos:["",""],photoTexts:["",""]}),b=[{label:"微信",color:"rgba(255, 255, 255, 0.9)",route:"/chat"},{label:"行程表",color:"rgba(255, 255, 255, 0.9)",route:"/schedule"},{label:"日记",color:"rgba(255, 255, 255, 0.9)",route:"/diary"},{label:"备忘录",color:"rgba(255, 255, 255, 0.9)",route:"/memo"}],u=$({photo:"",apps:JSON.parse(JSON.stringify(b))}),k=[{label:"购买记录",color:"rgba(255, 255, 255, 0.9)",route:"/purchase"},{label:"搜索记录",color:"rgba(255, 255, 255, 0.9)",route:"/search"},{label:"主题",color:"rgba(255, 255, 255, 0.9)",route:"/theme"},{label:"app1",color:"rgba(255, 255, 255, 0.9)",route:"/app1"}],p=$({photo:"",text1:"",text2:"",apps:JSON.parse(JSON.stringify(k))}),D=$({avatars:{other:"",mine:""},messages:{other:"",mine:""}}),_=$(null),I=()=>{const o=`charphone_${y}`,a=localStorage.getItem(o);if(a)try{const i=JSON.parse(a);i.header&&(d.value={...d.value,...i.header}),i.middle&&(u.value={...u.value,...i.middle},(!u.value.apps||u.value.apps.length===0||!u.value.apps[0].label)&&(u.value.apps=JSON.parse(JSON.stringify(b)))),i.bottom&&(p.value={...p.value,...i.bottom},(!p.value.apps||p.value.apps.length===0||!p.value.apps[0].label)&&(p.value.apps=JSON.parse(JSON.stringify(k)))),i.dock&&(D.value={...D.value,...i.dock})}catch(i){console.error("Failed to load char phone data:",i)}},N=()=>{const o=`charphone_${y}`,a={header:d.value,middle:u.value,bottom:p.value,dock:D.value};localStorage.setItem(o,JSON.stringify(a))},O=o=>{d.value=o,N()},U=o=>{u.value=o,N()},S=o=>{p.value=o,N()},m=o=>{D.value=o,N()},h=o=>{console.log("App clicked:",o),o.label==="日记"||o.route==="/diary"?_.value="diary":o.label==="备忘录"||o.route==="/memo"?_.value="memo":(o.label==="行程"||o.route==="/schedule")&&(_.value="schedule")},l=()=>{_.value=null};return(o,a)=>(c(),B(fe,{title:ge(n)("charPhone.title","查看手机"),"no-padding":"",class:ie({"hide-back-btn":_.value})},{default:V(()=>[e("div",ka,[e("div",_a,[a[2]||(a[2]=e("div",{class:"char-notch"},null,-1)),e("div",Sa,[e("div",$a,[e("span",wa,w(v.value),1),a[0]||(a[0]=e("div",{class:"icons"},[e("span",null,"5G"),e("div",{class:"battery-icon"})],-1))]),e("div",Ca,[x(lt,{"header-data":d.value,"middle-data":u.value,"bottom-data":p.value,"onUpdate:headerData":O,"onUpdate:middleData":U,"onUpdate:bottomData":S,onAppClick:h},null,8,["header-data","middle-data","bottom-data"])]),x(vt,{"dock-data":D.value,"onUpdate:dockData":m},null,8,["dock-data"]),x(be,{name:"app-fade"},{default:V(()=>[_.value==="diary"?(c(),B(Zt,{key:0,onClose:l})):_.value==="memo"?(c(),B(ia,{key:1,onClose:l})):_.value==="schedule"?(c(),B(Da,{key:2,onClose:l})):T("",!0)]),_:1}),a[1]||(a[1]=e("div",{class:"char-home-indicator"},null,-1))]),a[3]||(a[3]=e("div",{class:"char-btn-power"},null,-1)),a[4]||(a[4]=e("div",{class:"char-btn-volume-up"},null,-1)),a[5]||(a[5]=e("div",{class:"char-btn-volume-down"},null,-1))])])]),_:1},8,["title","class"]))}},Ia=P(Ma,[["__scopeId","data-v-28eb0f0d"]]);export{Ia as default};
