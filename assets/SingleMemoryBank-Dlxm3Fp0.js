import{_ as W,k as X,B as ee,Z as te,r as l,m as se,c as F,b as ae,w as c,e as oe,x as ne,q as le,o as b,i as s,f as u,g as D,t as y,G as ie,H as re,S as _,j as ce,p as I,F as T}from"./index-B0Nu_drc.js";const ue={class:"header-actions"},de={class:"memory-bank-content"},ve={class:"memory-scroll-container"},me={key:0,class:"empty-state"},fe={class:"empty-text"},pe={key:1,class:"memory-list"},he={class:"card-header-row"},ge={class:"header-left"},be={class:"char-info",style:{"padding-left":"8px"}},ye={class:"char-name"},_e={class:"save-time"},xe={class:"header-right"},Me=["onClick"],Se=["onClick"],ke=["onClick","title"],we={class:"card-content-row"},Ce={class:"refine-range-info"},$e={class:"refine-range-inputs"},Fe={__name:"SingleMemoryBank",setup(De){const G=se();ne();const d=X(),v=ee(),H=te(),N=l(G.params.charId),B=l(!1),p=l(!1),m=l(-1),r=l(""),x=l(!1),M=l(-1),S=l(!1),h=l(""),k=l(1),w=l(0),f=F(()=>d.getCharacter(N.value)),n=F(()=>{var t;return((t=f.value)==null?void 0:t.memories)||[]}),U=F(()=>{var t;return((t=f.value)==null?void 0:t.name)||"角色"}),R=F(()=>[...B.value?n.value.filter(e=>e.isFavorite):n.value].sort((e,o)=>(o.time||0)-(e.time||0))),V=()=>{p.value=!1,r.value=""},P=()=>{x.value=!1,M.value=-1},j=()=>{S.value=!1},A=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},O=()=>{m.value=-1,r.value="",p.value=!0},q=t=>{const e=n.value.findIndex(o=>o.id===t.id);e!==-1&&(m.value=e,r.value=t.content,p.value=!0)},z=()=>{if(!r.value.trim())return;const t=f.value;if(t.memories||(t.memories=[]),m.value>=0){const e=t.memories[m.value];typeof e=="string"?t.memories[m.value]={content:r.value,time:Date.now(),charName:t.name,isFavorite:!1}:e.content=r.value}else t.memories.unshift({content:r.value,time:Date.now(),charName:t.name,isFavorite:!1});d.saveData(),V()},L=t=>{const e=n.value.findIndex(o=>o.id===t.id);e!==-1&&(M.value=e,x.value=!0)},Y=()=>{M.value>=0&&(f.value.memories.splice(M.value,1),d.saveData()),P()},Z=t=>{const e=n.value.find(o=>o.id===t.id);if(e)if(typeof e=="string"){const o=n.value.indexOf(e),a={content:e,time:Date.now(),charName:U.value,isFavorite:!1};n.value[o]=a,d.toggleMemoryFavorite(N.value,a)}else d.toggleMemoryFavorite(N.value,e)},J=()=>{const t=`# 任务
你是一个记忆提炼助手,请对以下已有的长期记忆进行二次总结,生成一段更精炼的核心记忆。

这份记忆要**客观又自然**:

## 要求
- **字数限制**:总结控制在 200-300 字以内,只记录最核心的内容
- **我是叙述者,不是分析师**。只用我的口吻描述发生了什么,不作总结评价
- **保留时间线索**:尊重原记忆中的时间信息,不要将不同时间的事件混淆或合并
- **抓重点**:从已有记忆中提取最关键的事件、情感和关系变化
- **保持真实**:不要添加原记忆中没有的信息,只提炼已有内容
- **说人话**:务必避免"交互"、"需求"、"成功解决"这类报告式词汇

直接输出提炼后的记忆内容,不要加任何其他东西。`;h.value=f.value.memorySummaryPrompt||t,k.value=1,w.value=n.value.length,S.value=!0},K=async()=>{const t=f.value;if(!t)return;const e=n.value.length,o=Math.max(1,k.value),a=Math.min(e,w.value);if(o>a){v.showToast("起始范围不能大于结束范围","error");return}t.memorySummaryPrompt=h.value,v.showToast("正在提炼记忆...","info"),j();const C=n.value.slice(o-1,a);if(C.length===0){v.showToast("选定范围内没有记忆可供提炼","warn");return}const $=C.map((i,g)=>{const E=i.time?A(i.time):"";return`[${g+1}] ${E?`(${E}) `:""}${i.content}`}).join(`

`),Q=[{role:"user",content:`${h.value.trim()}

现有记忆如下：

${$}`}];try{const i=await H.getGenericCompletion(Q),g=i==null?void 0:i.content;g&&g.trim()?(t.memories||(t.memories=[]),t.memories.unshift({content:`[记忆提炼 ${o}-${a}] ${g.trim()}`,time:Date.now(),charName:t.name,isFavorite:!1}),d.saveData(),v.showToast("记忆提炼已完成","success")):v.showToast("提炼失败，未收到有效回复","error")}catch(i){console.error("记忆提炼失败:",i),v.showToast(`提炼失败: ${i.message}`,"error")}};return(t,e)=>{const o=le("Modal");return b(),ae(oe,{title:"长期记忆"},{action:c(()=>[s("div",ue,[s("button",{class:"icon-btn",onClick:J,title:"提炼"},[u(_,{name:"Sparkles"})]),s("button",{class:"icon-btn",onClick:O,title:"添加"},[u(_,{name:"plus"})])])]),default:c(()=>[s("div",de,[s("div",ve,[!R.value||R.value.length===0?(b(),D("div",me,[s("div",fe,y(B.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(b(),D("div",pe,[(b(!0),D(ie,null,re(R.value,(a,C)=>(b(),D("div",{key:a.id||C,class:"card memory-card"},[s("div",he,[s("div",ge,[s("div",be,[s("span",ye,y(a.charName||U.value),1),s("span",_e,y(A(a.time)),1)])]),s("div",xe,[s("button",{class:"icon-btn",onClick:$=>q(a),title:"编辑"},[u(_,{name:"pencil"})],8,Me),s("button",{class:"icon-btn danger",onClick:$=>L(a),title:"删除"},[u(_,{name:"trash"})],8,Se),s("button",{class:"icon-btn favorite-btn",onClick:$=>Z(a),title:a.isFavorite?"取消收藏":"收藏"},[u(_,{name:a.isFavorite?"heart-solid":"heart",class:ce({"is-favorite":a.isFavorite})},null,8,["name","class"])],8,ke)])]),s("div",we,y(a.content),1)]))),128))]))])]),u(o,{visible:p.value,"onUpdate:visible":e[1]||(e[1]=a=>p.value=a),title:m.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:c(()=>[s("button",{class:"modal-btn cancel",onClick:V},"取消"),s("button",{class:"modal-btn confirm",onClick:z},"确定")]),default:c(()=>[I(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[0]||(e[0]=a=>r.value=a),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[T,r.value]])]),_:1},8,["visible","title"]),u(o,{visible:x.value,"onUpdate:visible":e[2]||(e[2]=a=>x.value=a),title:"确认删除",class:"nested"},{footer:c(()=>[s("button",{class:"modal-btn cancel",onClick:P},"取消"),s("button",{class:"modal-btn confirm danger",onClick:Y},"确认删除")]),default:c(()=>[e[7]||(e[7]=s("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),u(o,{visible:S.value,"onUpdate:visible":e[6]||(e[6]=a=>S.value=a),title:"记忆提炼",class:"nested"},{footer:c(()=>[s("button",{class:"modal-btn cancel",onClick:j},"取消"),s("button",{class:"modal-btn confirm",onClick:K},"开始提炼")]),default:c(()=>[s("div",Ce," 当前共有 "+y(n.value.length)+" 条记忆。 ",1),s("div",$e,[e[8]||(e[8]=s("label",{for:"refine-start"},"从第",-1)),I(s("input",{id:"refine-start",type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>k.value=a),class:"base-input range-input"},null,512),[[T,k.value,void 0,{number:!0}]]),e[9]||(e[9]=s("label",{for:"refine-end"},"条 到 第",-1)),I(s("input",{id:"refine-end",type:"number","onUpdate:modelValue":e[4]||(e[4]=a=>w.value=a),class:"base-input range-input"},null,512),[[T,w.value,void 0,{number:!0}]]),e[10]||(e[10]=s("label",null,"条",-1))]),e[11]||(e[11]=s("p",{class:"summary-tip"},"将对选定范围内的长期记忆进行再总结。",-1)),I(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[5]||(e[5]=a=>h.value=a),placeholder:"输入总结提示词...",style:{height:"100px"}},null,512),[[T,h.value]])]),_:1},8,["visible"])]),_:1})}}},Ne=W(Fe,[["__scopeId","data-v-27dc0422"]]);export{Ne as default};
