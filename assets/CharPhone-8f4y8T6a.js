import{ch as Z,r as S,_ as R,x as ne,a6 as le,c as I,d as m,o as d,e,g as N,f as P,E as W,t as U,w as Q,A as X,D as H,O as Y,F as V,C as G,y as se,S as j,by as te,i as E,b as q,u as K,W as oe,k as z,n as ie,V as ae,m as he,B as ve,a9 as me,a4 as ge}from"./index-DkKgV7eZ.js";const re=Z("charTheme",()=>{const t=S({}),g=s=>(t.value[s]||(t.value[s]={wallpaper:"",appIcons:{}}),t.value[s]),n=(s,p)=>{t.value[s]||g(s),t.value[s].wallpaper=p,i()},b=(s,p,c)=>{t.value[s]||g(s),t.value[s].appIcons||(t.value[s].appIcons={}),t.value[s].appIcons[p]=c,i()},v=(s,p)=>{var c,_;(_=(c=t.value[s])==null?void 0:c.appIcons)!=null&&_[p]&&(delete t.value[s].appIcons[p],i())},u=s=>{const p=g(s);return p.wallpaper?{backgroundImage:`url(${p.wallpaper})`,backgroundSize:"cover",backgroundPosition:"center"}:{}},f=(s,p)=>{var _;return((_=g(s).appIcons)==null?void 0:_[p])||null},i=()=>{localStorage.setItem("charphone_themes",JSON.stringify(t.value))},y=()=>{const s=localStorage.getItem("charphone_themes");if(s)try{t.value=JSON.parse(s)}catch(p){console.error("Failed to load charphone themes:",p)}};return y(),{charThemes:t,getCharTheme:g,setWallpaper:n,setAppIcon:b,deleteAppIcon:v,getWallpaperStyle:u,getAppIcon:f,saveThemes:i,loadThemes:y}}),fe={key:0,class:"upload-hint"},be={class:"left-section"},ke={key:0,class:"upload-hint"},ye={class:"date-info"},_e={class:"weekday"},$e={class:"date"},Ce={class:"right-section"},De={class:"text-inputs-row"},we={class:"photos-row"},Se={key:0,class:"upload-hint"},Me={key:0,class:"upload-hint"},xe={__name:"CharPhoneHeader",props:{widgetData:{type:Object,default:()=>({background:"",avatar:"",photos:["",""],photoTexts:["",""]})}},emits:["update:widgetData"],setup(t,{emit:g}){var h,r;const n=t,b=g,v=S(!1),u=S("background"),f=S(0),i=S([((h=n.widgetData.photoTexts)==null?void 0:h[0])||"",((r=n.widgetData.photoTexts)==null?void 0:r[1])||""]),y=S(""),s=S("");let p=null;const c=()=>{const l=new Date,o=(l.getMonth()+1).toString().padStart(2,"0"),a=l.getDate().toString().padStart(2,"0");y.value=`${o}.${a}`;const k=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];s.value=k[l.getDay()]};ne(()=>{c(),p=setInterval(c,6e4)}),le(()=>{p&&clearInterval(p)});const _=I(()=>n.widgetData.background?{backgroundImage:`url('${n.widgetData.background}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),D=I(()=>n.widgetData.avatar?{backgroundImage:`url('${n.widgetData.avatar}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),M=l=>n.widgetData.photos[l]?{backgroundImage:`url('${n.widgetData.photos[l]}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"},T=()=>{u.value="background",v.value=!0},O=()=>{u.value="avatar",v.value=!0},x=l=>{f.value=l,u.value=`photo${l}`,v.value=!0},w=l=>{const o={...n.widgetData};u.value==="background"?o.background=l.content:u.value==="avatar"?o.avatar=l.content:u.value.startsWith("photo")&&(o.photos=[...n.widgetData.photos],o.photos[f.value]=l.content),b("update:widgetData",o)},$=l=>{const o={...n.widgetData,photoTexts:[...i.value]};b("update:widgetData",o)};return(l,o)=>(d(),m("div",{class:"char-phone-header",onClick:H(T,["stop"])},[e("div",{class:"widget-background",style:W(_.value)},[t.widgetData.background?P("",!0):(d(),m("div",fe," 点击上传 "))],4),e("div",{class:"widget-content",onClick:o[8]||(o[8]=H(()=>{},["stop"]))},[e("div",be,[e("div",{class:"avatar-circle",style:W(D.value),onClick:O},[t.widgetData.avatar?P("",!0):(d(),m("div",ke," 点击上传 "))],4),e("div",ye,[e("div",_e,U(s.value),1),e("div",$e,U(y.value),1)])]),e("div",Ce,[e("div",De,[Q(e("input",{"onUpdate:modelValue":o[0]||(o[0]=a=>i.value[0]=a),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:o[1]||(o[1]=a=>$()),onClick:o[2]||(o[2]=H(()=>{},["stop"]))},null,544),[[X,i.value[0]]]),Q(e("input",{"onUpdate:modelValue":o[3]||(o[3]=a=>i.value[1]=a),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:o[4]||(o[4]=a=>$()),onClick:o[5]||(o[5]=H(()=>{},["stop"]))},null,544),[[X,i.value[1]]])]),e("div",we,[e("div",{class:"photo-item",style:W(M(0)),onClick:o[6]||(o[6]=a=>x(0))},[t.widgetData.photos[0]?P("",!0):(d(),m("div",Se," 点击上传 "))],4),e("div",{class:"photo-item",style:W(M(1)),onClick:o[7]||(o[7]=a=>x(1))},[t.widgetData.photos[1]?P("",!0):(d(),m("div",Me," 点击上传 "))],4)])])]),N(Y,{visible:v.value,"onUpdate:visible":o[9]||(o[9]=a=>v.value=a),type:"basic","biz-type":u.value,onUploadComplete:w},null,8,["visible","biz-type"])]))}},Ie=R(xe,[["__scopeId","data-v-baafc6b9"]]),Te={class:"char-phone-middle-widget"},Ue={class:"photo-section"},Ae={class:"photo-wrapper"},Ne={key:0,class:"upload-hint"},Pe={class:"app-section"},Be={class:"app-grid-wrapper"},Oe={class:"app-grid"},We=["onClick"],Fe={class:"app-label"},Re={__name:"CharPhoneMiddleWidget",props:{widgetData:{type:Object,default:()=>({photo:"",apps:[]})}},emits:["update:widgetData","app-click"],setup(t,{emit:g}){const n=t,b=g,v=S(!1),u=I(()=>n.widgetData.photo?{backgroundImage:`url('${n.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),f=()=>{v.value=!0},i=s=>{b("app-click",s)},y=s=>{const p={...n.widgetData};p.photo=s.content,b("update:widgetData",p)};return(s,p)=>(d(),m("div",Te,[e("div",Ue,[e("div",Ae,[e("div",{class:"photo-container",style:W(u.value),onClick:f},[t.widgetData.photo?P("",!0):(d(),m("div",Ne," 点击上传 "))],4)])]),e("div",Pe,[e("div",Be,[e("div",Oe,[(d(!0),m(V,null,G(t.widgetData.apps,(c,_)=>(d(),m("div",{key:_,class:"app-item",onClick:D=>i(c)},[e("div",{class:"app-icon",style:W({background:c.color})},null,4),e("div",Fe,U(c.label),1)],8,We))),128))])])]),N(Y,{visible:v.value,"onUpdate:visible":p[0]||(p[0]=c=>v.value=c),type:"basic","biz-type":"photo",onUploadComplete:y},null,8,["visible"])]))}},Je=R(Re,[["__scopeId","data-v-1ed9bd3c"]]),ze={class:"char-phone-bottom-widget"},He={class:"app-section"},Ee={class:"app-grid-wrapper"},je={class:"app-grid"},Ve=["onClick"],Ge={class:"app-label"},Le={class:"photo-section"},Ye={class:"photo-wrapper"},qe={key:0,class:"upload-hint"},Ke={class:"text-inputs"},Qe={__name:"CharPhoneBottomWidget",props:{widgetData:{type:Object,default:()=>({photo:"",text1:"",text2:"",apps:[]})}},emits:["update:widgetData","app-click"],setup(t,{emit:g}){const n=t,b=g,v=S(!1),u=I(()=>n.widgetData.photo?{backgroundImage:`url('${n.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),f=()=>{v.value=!0},i=p=>{console.log("Bottom widget - 打开应用:",p.label),b("app-click",p)},y=p=>{const c={...n.widgetData};c.photo=p.content,b("update:widgetData",c)},s=()=>{b("update:widgetData",{...n.widgetData})};return(p,c)=>(d(),m("div",ze,[e("div",He,[e("div",Ee,[e("div",je,[(d(!0),m(V,null,G(t.widgetData.apps,(_,D)=>(d(),m("div",{key:D,class:"app-item",onClick:M=>i(_)},[e("div",{class:"app-icon",style:W({background:_.color})},null,4),e("div",Ge,U(_.label),1)],8,Ve))),128))])])]),e("div",Le,[e("div",Ye,[e("div",{class:"photo-container",style:W(u.value),onClick:f},[t.widgetData.photo?P("",!0):(d(),m("div",qe," 点击上传 "))],4),e("div",Ke,[Q(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":c[0]||(c[0]=_=>t.widgetData.text1=_),placeholder:"输入文本1",onInput:s},null,544),[[X,t.widgetData.text1]]),Q(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":c[1]||(c[1]=_=>t.widgetData.text2=_),placeholder:"输入文本2",onInput:s},null,544),[[X,t.widgetData.text2]])])])]),N(Y,{visible:v.value,"onUpdate:visible":c[2]||(c[2]=_=>v.value=_),type:"basic","biz-type":"photo",onUploadComplete:y},null,8,["visible"])]))}},Xe=R(Qe,[["__scopeId","data-v-b1cc1a4e"]]),Ze={class:"char-phone-widget-container"},et={class:"widget-item top-widget"},tt={class:"widget-item middle-widget"},at={class:"widget-item bottom-widget"},ot={__name:"CharPhoneWidgetContainer",props:{headerData:{type:Object,required:!0},middleData:{type:Object,required:!0},bottomData:{type:Object,required:!0}},emits:["update:headerData","update:middleData","update:bottomData","app-click"],setup(t,{emit:g}){const n=g,b=i=>{n("update:headerData",i)},v=i=>{n("update:middleData",i)},u=i=>{n("update:bottomData",i)},f=i=>{n("app-click",i)};return(i,y)=>(d(),m("div",Ze,[e("div",et,[N(Ie,{"widget-data":t.headerData,"onUpdate:widgetData":b},null,8,["widget-data"])]),e("div",tt,[N(Je,{"widget-data":t.middleData,"onUpdate:widgetData":v,onAppClick:f},null,8,["widget-data"])]),e("div",at,[N(Xe,{"widget-data":t.bottomData,"onUpdate:widgetData":u,onAppClick:f},null,8,["widget-data"])])]))}},st=R(ot,[["__scopeId","data-v-7ce323fa"]]),nt={class:"char-phone-dock"},lt={class:"message-row other-message"},it={key:0,class:"upload-hint"},rt=["data-placeholder"],dt={class:"message-row my-message"},ct=["data-placeholder"],ut={key:0,class:"upload-hint"},pt={__name:"CharPhoneDock",props:{dockData:{type:Object,default:()=>({avatars:{other:"",mine:""},messages:{other:"",mine:""}})}},emits:["update:dockData"],setup(t,{emit:g}){var w,$;const n=t,b=g,v=S(!1),u=S("avatar-other"),f=S({other:((w=n.dockData.messages)==null?void 0:w.other)||"",mine:(($=n.dockData.messages)==null?void 0:$.mine)||""}),i=S(!1),y=S(null),s=S(null);se(()=>f.value.other,h=>{y.value&&y.value.textContent!==h&&(y.value.textContent=h)},{immediate:!0}),se(()=>f.value.mine,h=>{s.value&&s.value.textContent!==h&&(s.value.textContent=h)},{immediate:!0});const p=()=>{i.value=!0},c=(h,r)=>{i.value=!1,f.value[r]=h.target.textContent},_=(h,r)=>{i.value||(f.value[r]=h.target.textContent)},D=(h,r)=>{f.value[r]=h.target.textContent,x()},M=h=>{var l;const r=(l=n.dockData.avatars)==null?void 0:l[h];return r?{backgroundImage:`url('${r}')`,backgroundSize:"cover",backgroundPosition:"center",backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.9)"}},T=h=>{u.value=`avatar-${h}`,v.value=!0},O=h=>{const r={...n.dockData,avatars:{...n.dockData.avatars}};u.value==="avatar-other"?r.avatars.other=h.content:u.value==="avatar-mine"&&(r.avatars.mine=h.content),b("update:dockData",r)},x=h=>{const r={...n.dockData,messages:{...f.value}};b("update:dockData",r)};return(h,r)=>(d(),m("div",nt,[e("div",lt,[e("div",{class:"avatar",style:W(M("other")),onClick:r[0]||(r[0]=l=>T("other"))},[t.dockData.avatars.other?P("",!0):(d(),m("div",it," 点击上传 "))],4),e("div",{ref_key:"bubbleOtherRef",ref:y,class:"bubble bubble-other",onClick:r[1]||(r[1]=H(()=>{},["stop"])),contenteditable:"true",onCompositionstart:p,onCompositionend:r[2]||(r[2]=l=>c(l,"other")),onInput:r[3]||(r[3]=l=>_(l,"other")),onBlur:r[4]||(r[4]=l=>D(l,"other")),"data-placeholder":f.value.other?"":"点击输入文字"},null,40,rt)]),e("div",dt,[e("div",{ref_key:"bubbleMineRef",ref:s,class:"bubble bubble-mine",onClick:r[5]||(r[5]=H(()=>{},["stop"])),contenteditable:"true",onCompositionstart:p,onCompositionend:r[6]||(r[6]=l=>c(l,"mine")),onInput:r[7]||(r[7]=l=>_(l,"mine")),onBlur:r[8]||(r[8]=l=>D(l,"mine")),"data-placeholder":f.value.mine?"":"点击输入文字"},null,40,ct),e("div",{class:"avatar",style:W(M("mine")),onClick:r[9]||(r[9]=l=>T("mine"))},[t.dockData.avatars.mine?P("",!0):(d(),m("div",ut," 点击上传 "))],4)]),N(Y,{visible:v.value,"onUpdate:visible":r[10]||(r[10]=l=>v.value=l),type:"basic","biz-type":u.value,onUploadComplete:O},null,8,["visible","biz-type"])]))}},ht=R(pt,[["__scopeId","data-v-0f4f42af"]]),vt=Z("diary",{state:()=>({diaries:{}}),actions:{addDiary(t,g){this.diaries[t]||(this.diaries[t]=[]),this.diaries[t].unshift({id:Date.now().toString(),content:g,timestamp:Date.now()})},getDiaries(t){return this.diaries[t]||[]},deleteDiary(t,g){if(this.diaries[t]){const n=this.diaries[t].findIndex(b=>b.id===g);n!==-1&&this.diaries[t].splice(n,1)}},clearDiaries(t){this.diaries[t]&&delete this.diaries[t]}},persist:!0}),mt={class:"c-phone-app-header"},gt={class:"title"},ft={class:"header-actions"},bt={__name:"CPhoneAppHeader",props:{title:{type:String,default:""},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["back","clear","refresh"],setup(t,{emit:g}){const n=g,b=()=>{n("back")};return(v,u)=>(d(),m("header",mt,[e("div",{class:"back-btn",onClick:b},[N(j,{name:"back-btn",class:"back-icon"})]),e("h1",gt,U(t.title),1),e("div",ft,[t.showClear?(d(),m("div",{key:0,class:"action-btn",onClick:u[0]||(u[0]=f=>n("clear"))},[N(j,{name:"trash"})])):P("",!0),t.showRefresh?(d(),m("div",{key:1,class:"action-btn",onClick:u[1]||(u[1]=f=>n("refresh"))},[N(j,{name:"refresh"})])):P("",!0),te(v.$slots,"action",{},void 0,!0)])]))}},kt=R(bt,[["__scopeId","data-v-05bc6111"]]),yt={class:"app-container"},_t={__name:"CPhoneAppsLayout",props:{title:{type:String,default:""},background:{type:String,default:"#ffffff"},color:{type:String,default:"#000000"},themeColor:{type:String,default:"#000000"},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["close","clear","refresh"],setup(t,{emit:g}){const n=g,b=()=>{n("close")};return(v,u)=>(d(),m("div",{class:"c-phone-app-layout",style:W({"--app-bg":t.background,"--app-text":t.color,"--app-theme":t.themeColor})},[N(kt,{title:t.title,"show-clear":t.showClear,"show-refresh":t.showRefresh,onBack:b,onClear:u[0]||(u[0]=f=>n("clear")),onRefresh:u[1]||(u[1]=f=>n("refresh"))},{action:E(()=>[te(v.$slots,"action",{},void 0,!0)]),_:3},8,["title","show-clear","show-refresh"]),e("div",yt,[te(v.$slots,"default",{},void 0,!0)])],4))}},ee=R(_t,[["__scopeId","data-v-9de005de"]]),$t={key:0,class:"diary-notebook-container"},Ct={class:"open-book-leather"},Dt={class:"paper-stack"},wt={class:"paper-sheet"},St={key:0,class:"polaroid"},Mt={class:"photo-frame"},xt=["src"],It={class:"photo-name"},Tt={class:"paper-content"},Ut={class:"diary-header"},At={class:"date-group"},Nt={class:"day"},Pt={class:"month-year-group"},Bt={class:"month"},Ot={class:"year"},Wt={class:"weekday-badge"},Ft={class:"diary-body"},Rt={key:0,class:"generating-container"},Jt={class:"fountain-pen-loading"},zt={key:1,class:"handwritten-text"},Ht={class:"page-number"},Et={class:"cover-texture"},jt={class:"cover-label"},Vt={class:"label-border"},Gt={class:"book-subtitle"},Lt={class:"owner-name"},Yt={__name:"CharDiary",emits:["close"],setup(t,{emit:g}){const n=g,b=q(),v=K(),u=vt(),f=oe(),i=b.params.charId,y=S(!1),s=I(()=>v.getCharacter(i)),p=I(()=>s.value?`${s.value.name}的日记`:"日记"),c=I(()=>u.getDiaries(i)),_=I(()=>c.value.length>0?c.value[0]:null),D=I(()=>{var o;return y.value?Date.now():((o=_.value)==null?void 0:o.timestamp)||Date.now()}),M=I(()=>{var o;return(o=_.value)!=null&&o.content?_.value.content.split(`
`).filter(a=>a.trim()):[]}),T=o=>new Date(Number(o)).getDate().toString().padStart(2,"0"),O=o=>["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][new Date(Number(o)).getMonth()],x=o=>new Date(Number(o)).getFullYear(),w=o=>["Sun.","Mon.","Tue.","Wed.","Thu.","Fri.","Sat."][new Date(Number(o)).getDay()],$=o=>{o.target.style.display="none",o.target.parentElement.style.backgroundColor="#eee"},h=()=>{n("close")},r=()=>{_.value&&confirm("确定要撕掉这页日记吗？")&&u.deleteDiary(i,_.value.id)},l=async()=>{if(!y.value){y.value=!0;try{const o=v.getCharacter(i);if(!o)return;const k=v.getFormattedRecentMessages(i,20).map(B=>`${B.role==="user"?"用户":"我"}: ${B.content}`).join(`
`),C=`你现在是${o.name}。请根据以下最近的聊天记录，写一篇简短的日记（100-200字）。
日记应该以第一人称“我”的视角，记录最近发生的事情、你的心情和对用户的想法。
请直接输出日记内容，不要包含任何其他解释或格式。

聊天记录：
${k}

日记内容：`;let A=null;o.api&&o.api!=="default"&&(A=f.presets.find(B=>B.name===o.api));const J=await f.getGenericCompletion([{role:"user",content:C}],A);J&&u.addDiary(i,J.trim())}catch(o){console.error("Failed to generate diary:",o)}finally{y.value=!1}}};return(o,a)=>(d(),z(ee,{title:p.value,"show-clear":!0,"show-refresh":!0,onClose:h,onClear:r,onRefresh:l,background:"#f8f6f3",color:"#37474f",themeColor:"#555"},{default:E(()=>{var k,C;return[e("div",{class:ie(["diary-container",{"is-open":_.value||y.value}])},[a[10]||(a[10]=e("div",{class:"desktop-texture"},null,-1)),_.value||y.value?(d(),m("div",$t,[e("div",Ct,[a[2]||(a[2]=e("div",{class:"bookmark-ribbon"},null,-1)),e("div",Dt,[e("div",wt,[s.value?(d(),m("div",St,[e("div",Mt,[e("img",{src:s.value.avatar,alt:"char",onError:$},null,40,xt)]),e("div",It,U(s.value.name),1)])):P("",!0),e("div",Tt,[e("div",Ut,[e("div",At,[e("span",Nt,U(T(D.value)),1),e("div",Pt,[e("span",Bt,U(O(D.value)),1),e("span",Ot,U(x(D.value)),1)]),e("div",Wt,U(w(D.value)),1)]),a[0]||(a[0]=e("div",{class:"stamp-mark"},[e("div",{class:"stamp-inner"},"CONFIDENTIAL")],-1))]),a[1]||(a[1]=e("div",{class:"diary-divider"},null,-1)),e("div",Ft,[y.value?(d(),m("div",Rt,[e("div",Jt,[N(j,{name:"pencil",class:"pen-icon"}),e("span",null,U(((k=s.value)==null?void 0:k.name)||"Ta")+" 正在提笔...",1)])])):(d(),m("div",zt,[(d(!0),m(V,null,G(M.value,(A,J)=>(d(),m("p",{key:J},U(A),1))),128))]))]),e("div",Ht,"- "+U(new Date(Number(D.value)).getDate())+" -",1)])])])])])):(d(),m("div",{key:1,class:"diary-book-cover",onClick:l},[a[9]||(a[9]=e("div",{class:"book-spine"},null,-1)),e("div",Et,[a[7]||(a[7]=e("div",{class:"stitching-border"},null,-1)),e("div",jt,[e("div",Vt,[a[4]||(a[4]=e("h2",{class:"book-title"},"DIARY",-1)),e("div",Gt,[e("span",Lt,U(((C=s.value)==null?void 0:C.name)||"Character"),1),a[3]||(a[3]=e("span",{class:"of-word"},"'s",-1))]),a[5]||(a[5]=e("div",{class:"label-line"},null,-1)),a[6]||(a[6]=e("div",{class:"book-hint"},"打开日记本",-1))])]),a[8]||(a[8]=e("div",{class:"elastic-band"},null,-1))])]))],2)]}),_:1},8,["title"]))}},qt=R(Yt,[["__scopeId","data-v-8dbdc24d"]]),Kt=Z("memo",{state:()=>({memos:{}}),actions:{addMemo(t,g){this.memos[t]||(this.memos[t]=[]);const n=g.map(b=>({id:Date.now().toString()+Math.random(),content:b,timestamp:Date.now()}));this.memos[t].unshift(...n)},updateMemo(t,g,n){if(!this.memos[t])return;const b=this.memos[t].find(v=>v.id===g);b&&(b.content=n)},getMemos(t){return this.memos[t]||[]},deleteMemo(t,g){if(this.memos[t]){const n=this.memos[t].findIndex(b=>b.id===g);n!==-1&&this.memos[t].splice(n,1)}},clearMemos(t){this.memos[t]&&(this.memos[t]=[])}},persist:!0}),Qt={key:0,class:"memo-list cork-board"},Xt={key:0,class:"generating-overlay"},Zt={class:"memo-item"},ea={class:"memo-content"},ta={class:"memo-footer"},aa={class:"memo-date"},oa=["onClick"],sa={key:1,class:"empty-state cork-board"},na={__name:"CharMemo",emits:["close"],setup(t,{emit:g}){const n=g,b=q(),v=K(),u=Kt(),f=oe(),i=b.params.charId,y=S(!1),s=I(()=>v.getCharacter(i)),p=I(()=>u.getMemos(i)),c=I(()=>s.value?`${s.value.name}的备忘录`:"备忘录"),_=()=>{n("close")},D=x=>x?new Date(x).toLocaleDateString("en-CA"):"",M=x=>{u.deleteMemo(i,x)},T=()=>{p.value.length>0&&confirm("确定要清空所有备忘录吗？")&&u.clearMemos(i)},O=async()=>{if(!y.value){y.value=!0;try{if(!s.value)return;const w=v.getFormattedRecentMessages(i,15).map(l=>`${l.role==="user"?"用户":"我"}: ${l.content}`).join(`
`),$=`角色: ${s.value.name}
任务: 你正在写一些私密的备忘录便利贴。请基于你的人设的日常琐事（如工作、爱好、生活习惯）以及最近和用户的聊天内容，写5-8条简短的备忘录。

规则:
1.  输出5-8条备忘录，每条字数控制在10-30字。
2.  每条备忘录都是独立的、零散的想法。
3.  内容可以关于你的日常生活、不为人知的小秘密、对用户的真实想法、或和用户聊天中产生的想法。
4.  风格要口语化、生活化，就像随手写下的笔记，体现角色性格和生活气息。
5.  每条内容占一行，不要带序号或任何标记。

参考聊天记录:
${w}

备忘录内容:`;let h=null;s.value.api&&s.value.api!=="default"&&(h=f.presets.find(l=>l.name===s.value.api));const r=await f.getGenericCompletion([{role:"user",content:$}],h);if(r){const l=r.split(`
`).map(o=>o.trim()).filter(o=>o.length>0);l.length>0&&u.addMemo(i,l)}}catch(x){console.error("Failed to generate memos:",x)}finally{y.value=!1}}};return(x,w)=>(d(),z(ee,{title:c.value,"show-clear":!0,"show-refresh":!0,onClose:_,onClear:T,onRefresh:O,background:"#ba9e76",color:"#3e2723",themeColor:"#795548"},{default:E(()=>[p.value.length>0||y.value?(d(),m("div",Qt,[y.value?(d(),m("div",Xt,[...w[0]||(w[0]=[e("div",{class:"generating-text"},"正在写备忘录...",-1)])])):P("",!0),(d(!0),m(V,null,G(p.value,$=>(d(),m("div",{key:$.id,class:"memo-item-wrapper"},[e("div",Zt,[w[1]||(w[1]=e("div",{class:"pin"},null,-1)),e("p",ea,U($.content),1),e("div",ta,[e("span",aa,U(D($.timestamp)),1),e("div",{class:"delete-btn",onClick:h=>M($.id)},[N(j,{name:"delete",class:"delete-icon"})],8,oa)])])]))),128))])):(d(),m("div",sa,[...w[2]||(w[2]=[e("div",{class:"empty-hint"},[ae(" 备忘录是空的... "),e("br"),e("small",null,"点击右上角，让我写点东西吧")],-1)])]))]),_:1},8,["title"]))}},la=R(na,[["__scopeId","data-v-70878ab1"]]),ia=Z("schedule",{state:()=>({schedules:{}}),actions:{addSchedule(t,g){this.schedules[t]||(this.schedules[t]=[]),this.schedules[t].unshift({id:Date.now().toString(),content:g,timestamp:Date.now()})},updateSchedule(t,g,n){if(!this.schedules[t])return;const b=this.schedules[t].find(v=>v.id===g);b&&(b.content=n)},getSchedules(t){return this.schedules[t]||[]},deleteSchedule(t,g){if(this.schedules[t]){const n=this.schedules[t].findIndex(b=>b.id===g);n!==-1&&this.schedules[t].splice(n,1)}},clearSchedules(t){this.schedules[t]&&delete this.schedules[t]}},persist:!0}),ra={key:0,class:"schedule-paper"},da={class:"paper-content"},ca={class:"schedule-header"},ua={class:"date-stamp"},pa={class:"schedule-body"},ha={key:0,class:"generating-text"},va={key:1,class:"handwritten-text"},ma={class:"time-col"},ga={class:"event-col"},fa={key:1,class:"empty-state"},ba={__name:"CharSchedule",emits:["close"],setup(t,{emit:g}){const n=g,b=q(),v=K(),u=ia(),f=oe(),i=b.params.charId,y=S(!1),s=I(()=>v.getCharacter(i)),p=I(()=>u.getSchedules(i)),c=I(()=>p.value.length>0?p.value[0]:null),_=I(()=>s.value?`${s.value.name}的行程`:"行程表"),D=()=>{n("close")},M=w=>{const $=new Date(Number(w)),h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return`${$.getFullYear()}.${($.getMonth()+1).toString().padStart(2,"0")}.${$.getDate().toString().padStart(2,"0")} ${h[$.getDay()]}`},T=()=>{c.value&&confirm("确定要撕掉这张行程表吗？")&&u.deleteSchedule(i,c.value.id)},O=w=>w?w.split(`
`).map($=>{if($=$.trim(),!$)return null;const h=$.match(/^(\d{1,2}:\d{2})/);if(h){const r=h[1];let l=$.substring(r.length).trim();return(l.startsWith(":")||l.startsWith("：")||l.startsWith("-"))&&(l=l.substring(1).trim()),{time:r,event:l}}else return{time:"",event:$}}).filter($=>$!==null):[],x=async()=>{if(!y.value){y.value=!0;try{if(!s.value)return;const $=v.getFormattedRecentMessages(i,10).map(A=>`${A.role==="user"?"用户":"我"}: ${A.content}`).join(`
`),h=new Date,r=`${h.getFullYear()}.${(h.getMonth()+1).toString().padStart(2,"0")}.${h.getDate().toString().padStart(2,"0")}`;let l=null;if(c.value){const A=new Date(Number(c.value.timestamp));`${A.getFullYear()}.${(A.getMonth()+1).toString().padStart(2,"0")}.${A.getDate().toString().padStart(2,"0")}`===r&&(l=c.value)}const o=`${h.getHours().toString().padStart(2,"0")}:${h.getMinutes().toString().padStart(2,"0")}`;let a="";l?a=`角色:${s.value.name}
当前时间:${r} ${o}
任务:以角色的口吻补充现有行程表(仅补充${o}之前未记录的)。

规则:
1.严禁包含晚于${o}的时间点。
2.格式:HH:MM 事件内容
3.输出完整列表(含旧数据)，按时间排序。
4.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
5.每条字数控制在10-20字。

现有行程:
${l.content}

完整行程:`:a=`角色:${s.value.name}
当前时间:${r} ${o}
任务:根据参考聊天和角色设定，以角色的口吻生成截止到目前的今日行程(已发生的事)。

规则:
1.严禁包含晚于${o}的时间点。
2.格式:HH:MM 事件内容
3.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
4.每条字数控制在10-20字。

参考聊天:
${$}

行程:`;let k=null;s.value.api&&s.value.api!=="default"&&(k=f.presets.find(A=>A.name===s.value.api));const C=await f.getGenericCompletion([{role:"user",content:a}],k);if(C){const A=C.split(`
`).filter(J=>{const B=J.trim().match(/^(\d{1,2}:\d{2})/);if(B){const[F,L]=B[1].split(":").map(Number),de=F*60+L,[ce,ue]=o.split(":").map(Number),pe=ce*60+ue;return de<=pe}return!0}).join(`
`);l?u.updateSchedule(i,l.id,A.trim()):u.addSchedule(i,A.trim())}}catch(w){console.error("Failed to generate schedule:",w)}finally{y.value=!1}}};return(w,$)=>(d(),z(ee,{title:_.value,"show-clear":!0,"show-refresh":!0,onClose:D,onClear:T,onRefresh:x,background:"#f0f4f8",color:"#37474f",themeColor:"#546e7a"},{default:E(()=>[c.value||y.value?(d(),m("div",ra,[e("div",da,[e("div",ca,[$[0]||($[0]=e("div",{class:"clip"},null,-1)),e("div",ua,U(y.value?M(Date.now()):M(c.value.timestamp)),1)]),e("div",pa,[y.value?(d(),m("div",ha,"正在确认行程...")):(d(),m("div",va,[(d(!0),m(V,null,G(O(c.value.content),(h,r)=>(d(),m("div",{key:r,class:"schedule-item"},[e("div",ma,U(h.time),1),e("div",ga,U(h.event),1)]))),128))]))])])])):(d(),m("div",fa,[...$[1]||($[1]=[e("div",{class:"empty-hint"},[ae("行程表是空的..."),e("br"),ae("点击右上角，看看我今天做了什么吧")],-1)])]))]),_:1},8,["title"]))}},ka=R(ba,[["__scopeId","data-v-ba3515c3"]]),ya={class:"theme-container"},_a={class:"theme-section"},$a={class:"wallpaper-preview-container"},Ca={key:0,class:"upload-hint"},Da={class:"theme-section"},wa={class:"app-icons-grid"},Sa=["onClick"],Ma={class:"app-icon-box"},xa=["src"],Ia={key:1,class:"app-icon-placeholder"},Ta={class:"app-name"},Ua=["onClick"],Aa={__name:"CharTheme",emits:["close"],setup(t,{emit:g}){const n=g,b=q(),v=K(),u=re(),f=b.params.charId,i=S(!1),y=S(""),s=S("theme"),p=S(null),c=I(()=>v.getCharacter(f)),_=I(()=>c.value?`${c.value.name}的主题`:"主题"),D=I(()=>u.getCharTheme(f)),M=I(()=>D.value.wallpaper),T=I(()=>M.value?{backgroundImage:`url(${M.value})`,backgroundSize:"cover",backgroundPosition:"center"}:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}),O=I(()=>{var A,J;const a=`charphone_${f}`,k=localStorage.getItem(a),C=[];if(k)try{const B=JSON.parse(k);(A=B.middle)!=null&&A.apps&&B.middle.apps.forEach(F=>{F.label&&!C.find(L=>L.label===F.label)&&C.push({label:F.label,route:F.route})}),(J=B.bottom)!=null&&J.apps&&B.bottom.apps.forEach(F=>{F.label&&!C.find(L=>L.label===F.label)&&C.push({label:F.label,route:F.route})})}catch(B){console.error("Failed to parse charphone data:",B)}return C}),x=()=>{n("close")},w=()=>{y.value="设置壁纸",s.value="theme",p.value={type:"wallpaper"},i.value=!0},$=a=>{y.value=`设置 ${a} 图标`,s.value="avatar",p.value={type:"appIcon",appLabel:a},i.value=!0},h=a=>{const k=a.content;p.value.type==="wallpaper"?u.setWallpaper(f,k):p.value.type==="appIcon"&&u.setAppIcon(f,p.value.appLabel,k),i.value=!1,p.value=null},r=()=>{confirm("确定要清除壁纸吗？")&&u.setWallpaper(f,"")},l=a=>{confirm(`确定要清除 ${a} 的图标吗？`)&&u.deleteAppIcon(f,a)},o=a=>u.getAppIcon(f,a);return(a,k)=>(d(),z(ee,{title:_.value,onClose:x,background:"#f8f6f3",color:"#37474f",themeColor:"#555"},{default:E(()=>[e("div",ya,[e("div",_a,[k[2]||(k[2]=e("div",{class:"section-title"},"壁纸设置",-1)),e("div",$a,[e("div",{class:"wallpaper-preview",style:W(T.value),onClick:w},[M.value?P("",!0):(d(),m("div",Ca,[N(j,{name:"image",class:"hint-icon"}),k[1]||(k[1]=e("span",null,"点击上传壁纸",-1))]))],4),M.value?(d(),m("button",{key:0,class:"btn-clear",onClick:r}," 清除壁纸 ")):P("",!0)])]),e("div",Da,[k[3]||(k[3]=e("div",{class:"section-title"},"App图标设置",-1)),e("div",wa,[(d(!0),m(V,null,G(O.value,C=>(d(),m("div",{key:C.label,class:"app-icon-item",onClick:A=>$(C.label)},[e("div",Ma,[o(C.label)?(d(),m("img",{key:0,src:o(C.label),alt:"app icon"},null,8,xa)):(d(),m("div",Ia,[e("span",null,U(C.label.charAt(0)),1)]))]),e("span",Ta,U(C.label),1),o(C.label)?(d(),m("button",{key:0,class:"btn-clear-icon",onClick:H(A=>l(C.label),["stop"])}," × ",8,Ua)):P("",!0)],8,Sa))),128))])])]),N(Y,{visible:i.value,"onUpdate:visible":k[0]||(k[0]=C=>i.value=C),title:y.value,bizType:s.value,type:"basic",onUploadComplete:h,onSendImage:h},null,8,["visible","title","bizType"])]),_:1},8,["title"]))}},Na=R(Aa,[["__scopeId","data-v-be4ff353"]]),Pa={class:"char-phone-container"},Ba={class:"char-phone-frame"},Oa={class:"char-status-bar"},Wa={class:"time"},Fa={class:"char-content"},Ra={__name:"CharPhone",setup(t){const{t:g}=he(),n=q();K();const b=re(),v=n.params.charId,u=I(()=>b.getWallpaperStyle(v)),f=S("");let i=null;const y=()=>{const a=new Date,k=a.getHours().toString().padStart(2,"0"),C=a.getMinutes().toString().padStart(2,"0");f.value=`${k}:${C}`};ne(()=>{y(),i=setInterval(y,1e3),O()}),le(()=>{i&&clearInterval(i)});const s=S({background:"",avatar:"",photos:["",""],photoTexts:["",""]}),p=[{label:"微信",color:"rgba(255, 255, 255, 0.9)",route:"/chat"},{label:"行程表",color:"rgba(255, 255, 255, 0.9)",route:"/schedule"},{label:"日记",color:"rgba(255, 255, 255, 0.9)",route:"/diary"},{label:"备忘录",color:"rgba(255, 255, 255, 0.9)",route:"/memo"}],c=S({photo:"",apps:JSON.parse(JSON.stringify(p))}),_=[{label:"购买记录",color:"rgba(255, 255, 255, 0.9)",route:"/purchase"},{label:"搜索记录",color:"rgba(255, 255, 255, 0.9)",route:"/search"},{label:"主题",color:"rgba(255, 255, 255, 0.9)",route:"/theme"},{label:"app1",color:"rgba(255, 255, 255, 0.9)",route:"/app1"}],D=S({photo:"",text1:"",text2:"",apps:JSON.parse(JSON.stringify(_))}),M=S({avatars:{other:"",mine:""},messages:{other:"",mine:""}}),T=S(null),O=()=>{const a=`charphone_${v}`,k=localStorage.getItem(a);if(k)try{const C=JSON.parse(k);C.header&&(s.value={...s.value,...C.header}),C.middle&&(c.value={...c.value,...C.middle},(!c.value.apps||c.value.apps.length===0||!c.value.apps[0].label)&&(c.value.apps=JSON.parse(JSON.stringify(p)))),C.bottom&&(D.value={...D.value,...C.bottom},(!D.value.apps||D.value.apps.length===0||!D.value.apps[0].label)&&(D.value.apps=JSON.parse(JSON.stringify(_)))),C.dock&&(M.value={...M.value,...C.dock})}catch(C){console.error("Failed to load char phone data:",C)}},x=()=>{const a=`charphone_${v}`,k={header:s.value,middle:c.value,bottom:D.value,dock:M.value};localStorage.setItem(a,JSON.stringify(k))},w=a=>{s.value=a,x()},$=a=>{c.value=a,x()},h=a=>{D.value=a,x()},r=a=>{M.value=a,x()},l=a=>{console.log("App clicked:",a),a.label==="日记"||a.route==="/diary"?T.value="diary":a.label==="备忘录"||a.route==="/memo"?T.value="memo":a.label==="行程"||a.label==="行程表"||a.route==="/schedule"?T.value="schedule":(a.label==="主题"||a.route==="/theme")&&(T.value="theme")},o=()=>{T.value=null};return(a,k)=>(d(),z(me,{title:ve(g)("charPhone.title","查看手机"),"no-padding":"",class:ie({"hide-back-btn":T.value})},{default:E(()=>[e("div",Pa,[e("div",Ba,[k[2]||(k[2]=e("div",{class:"char-notch"},null,-1)),e("div",{class:"char-phone-screen",style:W(u.value)},[e("div",Oa,[e("span",Wa,U(f.value),1),k[0]||(k[0]=e("div",{class:"icons"},[e("span",null,"5G"),e("div",{class:"battery-icon"})],-1))]),e("div",Fa,[N(st,{"header-data":s.value,"middle-data":c.value,"bottom-data":D.value,"onUpdate:headerData":w,"onUpdate:middleData":$,"onUpdate:bottomData":h,onAppClick:l},null,8,["header-data","middle-data","bottom-data"])]),N(ht,{"dock-data":M.value,"onUpdate:dockData":r},null,8,["dock-data"]),N(ge,{name:"app-fade"},{default:E(()=>[T.value==="diary"?(d(),z(qt,{key:0,onClose:o})):T.value==="memo"?(d(),z(la,{key:1,onClose:o})):T.value==="schedule"?(d(),z(ka,{key:2,onClose:o})):T.value==="theme"?(d(),z(Na,{key:3,onClose:o})):P("",!0)]),_:1}),k[1]||(k[1]=e("div",{class:"char-home-indicator"},null,-1))],4),k[3]||(k[3]=e("div",{class:"char-btn-power"},null,-1)),k[4]||(k[4]=e("div",{class:"char-btn-volume-up"},null,-1)),k[5]||(k[5]=e("div",{class:"char-btn-volume-down"},null,-1))])])]),_:1},8,["title","class"]))}},za=R(Ra,[["__scopeId","data-v-2184d572"]]);export{za as default};
