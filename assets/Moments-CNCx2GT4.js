import{_ as ce,u as me,R as Pe,r as m,c as $,a5 as Ue,d as r,o as i,e as n,E as D,f as g,t as d,n as de,F as E,C as H,D as f,B as R,V as j,G as ve,a as Le,s as Be,W as Oe,a3 as De,y as re,x as Ve,a6 as ze,Q as Ae,g as q,w as J,A as X,P as Ee,O as Fe,i as G,M as ue,k as Ne}from"./index-DVQm_1x6.js";import Re from"./PostMoment-HTM5Qt_t.js";const je={class:"moment-content"},qe={class:"moment-name"},Ge={key:0,class:"moment-text"},He=["onClick"],Ye=["src"],We=["onClick"],Ke={class:"text-inner-scroll"},Qe={key:2,class:"moment-remind"},Je={key:3,class:"moment-visibility"},Xe={key:0},Ze={key:1},_e={class:"moment-footer"},et={class:"time-and-location"},tt={class:"time"},nt={key:0,class:"moment-location"},ot={class:"actions"},st={key:0,class:"action-menu"},lt={key:4,class:"moment-interactions"},at={key:0,class:"likes-list"},it={key:1,class:"comments-list"},rt=["onClick"],ut={class:"comment-user"},ct={key:0,class:"comment-reply"},mt={class:"comment-user"},dt={class:"comment-content"},vt={__name:"MomentItem",props:{moment:{type:Object,required:!0},currentUserAvatar:String,currentUserName:String,isMenuOpen:Boolean},emits:["toggle-menu","like","comment","reply","long-press"],setup(l,{emit:Y}){const v=l,c=Y,y=me(),S=Pe(),{getImageUrl:V,preview:I}=S,P=m([]),T=m(null),U=a=>{if(a==="user")return v.currentUserAvatar;const o=y.getCharacter(a);return o?o.avatar:""},p=a=>{if(a==="user")return v.currentUserName;const o=y.getCharacter(a);return o?o.name:"未知用户"},W=a=>{const o=Date.now()-a;if(o<6e4)return"刚刚";if(o<36e5)return`${Math.floor(o/6e4)}分钟前`;if(o<864e5)return`${Math.floor(o/36e5)}小时前`;const s=new Date(a);return`${s.getMonth()+1}月${s.getDate()}日`},w=a=>{if(!a||a.isTextGenerated)return!1;const o=a.content||a.url;return typeof o=="string"&&(o.startsWith("http")||o.startsWith("data:image"))},z=$(()=>v.moment.likes.includes("user")),k=$(()=>y.isMomentFavorited(v.moment.id)),L=()=>{c("toggle-menu",v.moment.id)},M=()=>{k.value?y.removeMomentFromFavorites(v.moment.id):y.addMomentToFavorites(v.moment),c("toggle-menu",null)},F=()=>{c("like",v.moment)},B=()=>{c("comment",v.moment)},O=a=>{c("reply",v.moment,a)},A=a=>{a.target.closest(".image-item, .action-btn, .action-menu")||(T.value=setTimeout(()=>{c("long-press",v.moment)},600))},x=()=>{T.value&&clearTimeout(T.value),T.value=null},b=()=>{ve(()=>{P.value.forEach(a=>{a&&a.classList.toggle("is-overflowing",a.scrollHeight>a.clientHeight)})})};return Ue(()=>{b()}),(a,o)=>(i(),r("div",{class:"moment-item",onTouchstart:A,onTouchend:x,onMousedown:A,onMouseup:x,onContextmenu:o[0]||(o[0]=f(()=>{},["prevent"]))},[n("div",{class:"moment-avatar",style:D({backgroundImage:`url(${U(l.moment.userId)})`})},null,4),n("div",je,[n("div",qe,d(p(l.moment.userId)),1),l.moment.content?(i(),r("div",Ge,d(l.moment.content),1)):g("",!0),l.moment.images&&l.moment.images.length>0?(i(),r("div",{key:1,class:de(["moment-images",[`grid-${l.moment.images.length}`,{"single-image":l.moment.images.length===1}]])},[(i(!0),r(E,null,H(l.moment.images,(s,h)=>(i(),r(E,{key:h},[l.moment.images.length===1&&!s.isTextGenerated?(i(),r("div",{key:0,class:"moment-single-image-adaptive",onClick:f(C=>R(I)(s),["stop"])},[n("img",{src:R(V)(s),alt:"moment image"},null,8,Ye)],8,He)):(i(),r("div",{key:1,class:"image-item",style:D({backgroundImage:w(s)?`url(${R(V)(s)})`:"none",backgroundColor:s.isTextGenerated?"var(--text-quaternary)":"#e7e7e7"}),onClick:f(C=>R(I)(s),["stop"])},[s.isTextGenerated?(i(),r("div",{key:0,class:"moment-text-placeholder",ref_for:!0,ref:C=>{C&&(P.value[h]=C)}},[n("div",Ke,d(l.moment.images.length>1?`第${h+1}张图片`:"一张图片"),1)],512)):g("",!0)],12,We))],64))),128))],2)):g("",!0),l.moment.remind&&l.moment.remind.length>0?(i(),r("div",Qe," 提到了: "+d(l.moment.remind.map(s=>p(s)).join(", ")),1)):g("",!0),l.moment.visibility&&l.moment.visibility.type!=="public"?(i(),r("div",Je,[l.moment.visibility.allowed.length>0?(i(),r("span",Xe,"部分可见: "+d(l.moment.visibility.allowed.map(s=>p(s)).join(", ")),1)):(i(),r("span",Ze,"私密"))])):g("",!0),n("div",_e,[n("div",et,[n("span",tt,d(W(l.moment.time)),1),l.moment.location?(i(),r("div",nt,[o[1]||(o[1]=n("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"#576B95",xmlns:"http://www.w3.org/2000/svg"},[n("circle",{cx:"12",cy:"8",r:"4.5"}),n("rect",{x:"11.4",y:"12",width:"2",height:"9"})],-1)),n("span",null,d(l.moment.location),1)])):g("",!0)]),n("div",ot,[n("div",{class:"action-btn",onClick:f(L,["stop"])},[...o[2]||(o[2]=[n("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[n("circle",{cx:"12",cy:"12",r:"1"}),n("circle",{cx:"19",cy:"12",r:"1"}),n("circle",{cx:"5",cy:"12",r:"1"})],-1)])]),l.isMenuOpen?(i(),r("div",st,[n("div",{class:"menu-item",onClick:f(M,["stop"])},[o[3]||(o[3]=n("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[n("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})],-1)),j(" "+d(k.value?"取消":"收藏"),1)]),n("div",{class:"menu-item",onClick:f(F,["stop"])},[o[4]||(o[4]=n("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[n("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})],-1)),j(" "+d(z.value?"取消":"赞"),1)]),n("div",{class:"menu-item",onClick:f(B,["stop"])},[...o[5]||(o[5]=[n("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[n("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})],-1),j(" 评论 ",-1)])])])):g("",!0)])]),l.moment.likes.length||l.moment.comments.length?(i(),r("div",lt,[l.moment.likes.length?(i(),r("div",at,[o[6]||(o[6]=n("svg",{class:"svg-icon like-icon",viewBox:"0 0 24 24",fill:"#576b95",stroke:"none"},[n("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})],-1)),(i(!0),r(E,null,H(l.moment.likes,(s,h)=>(i(),r("span",{key:s},d(p(s))+d(h<l.moment.likes.length-1?", ":""),1))),128))])):g("",!0),l.moment.comments.length?(i(),r("div",it,[(i(!0),r(E,null,H(l.moment.comments,s=>(i(),r("div",{key:s.id,class:"comment-item",onClick:f(h=>O(s),["stop"])},[n("span",ut,d(p(s.userId)),1),s.replyTo?(i(),r("span",ct,[o[7]||(o[7]=j("回复 ",-1)),n("span",mt,d(s.replyTo.name),1)])):g("",!0),n("span",dt,": "+d(s.content),1)],8,rt))),128))])):g("",!0)])):g("",!0)])],32))}},gt=ce(vt,[["__scopeId","data-v-c5bc5d4a"]]),ht={class:"moments-header"},ft={class:"user-info"},pt={class:"moments-list"},kt={key:0,class:"comment-input-header"},yt={class:"comment-input-wrapper"},Mt=["placeholder"],bt=["disabled"],Ct={class:"modal-actions"},wt={__name:"Moments",setup(l,{expose:Y}){const v=me(),c=Le(),y=Be();Oe();const S=Ae("setShowMomentsCamera"),V=$(()=>c.userMomentsProfile.cover),I=$(()=>c.userMomentsProfile.name),P=$(()=>c.userMomentsProfile.avatar),T=$(()=>c.userMomentsProfile.signature),U=m(I.value||"我"),p=m(T.value),W=$(()=>{const e="user";return c.moments.filter(t=>{var ie;if(t.userId===e)return!0;if(v.getCharacter(t.userId)){const N=t.visibility;if(!N||N.type==="public"||N.type==="private"&&((ie=N.allowed)!=null&&ie.includes(e)))return!0}return!1})}),w=m(null),z=m(!1),k=m(""),L=m(null),M=m(null),F=m(null),B=m(!1),O=De({title:"",bizType:"avatar"}),A=m(""),x=m(!1),b=m(null),a=m(!1),o=m(null),s=m(0),h=m(!1),C=m(0),K=m(!1);re(I,e=>{U.value=e}),re(T,e=>{p.value=e}),Ve(()=>{document.addEventListener("click",le);const e=document.querySelector(".chat-moments");e&&e.addEventListener("scroll",ae)}),ze(()=>{document.removeEventListener("click",le);const e=document.querySelector(".chat-moments");e&&e.removeEventListener("scroll",ae),S&&S(!0)});const ge=e=>{if(e==="user")return I.value;const t=v.getCharacter(e);return t?t.name:"未知用户"},Z=e=>{const t=e==="name"?U.value:p.value;c.updateUserMomentsProfile({[e]:t})},_=e=>{A.value=e,O.title=e==="cover"?"修改封面":"修改头像",O.bizType="avatar",B.value=!0},he=e=>{const t=(e.type==="url",e.content);t&&c.updateUserMomentsProfile({[A.value]:t}),B.value=!1},fe=()=>{K.value=!0},ee=()=>{K.value=!1},pe=e=>{c.addMoment({userId:"user",...e,time:Date.now(),likes:[],comments:[]}),ee()},ke=e=>{b.value=e,x.value=!0},Q=()=>{x.value=!1,b.value=null},ye=()=>{b.value&&(c.deleteMoment(b.value.id),Q())},Me=async()=>{if(!b.value)return;y.showToast("正在重新生成...","info");const e=b.value.id;Q(),await c.retryMoment(e)?y.showToast("动态已更新","success"):y.showToast("重试失败","error")},be=e=>{c.likeMoment(e.id,"user"),w.value=null},te=(e,t=null)=>{L.value=e,M.value=t,k.value="",z.value=!0,ve(()=>{var u;return(u=F.value)==null?void 0:u.focus()})},Ce=e=>{te(e.id),w.value=null},we=(e,t)=>{t.userId==="user"?(o.value={momentId:e.id,commentId:t.id},a.value=!0):te(e.id,{id:t.userId,name:ge(t.userId)})},Ie=()=>{if(o.value){const{momentId:e,commentId:t}=o.value;c.deleteComment(e,t),ne()}},ne=()=>{a.value=!1,o.value=null},oe=()=>{z.value=!1,L.value=null,M.value=null,k.value=""},se=()=>{!k.value.trim()||!L.value||(c.addComment(L.value,{userId:"user",content:k.value,time:Date.now(),replyTo:M.value}),oe())},Te=e=>{document.querySelector(".chat-moments").scrollTop===0&&(C.value=e.touches[0].clientY)},xe=e=>{if(C.value>0&&!h.value){const t=e.touches[0].clientY-C.value;t>0&&(s.value=Math.min(t*.5,100),t>10&&e.cancelable&&e.preventDefault())}},$e=async()=>{const e=()=>{const t=setInterval(()=>{s.value-=5,s.value<=0&&(s.value=0,C.value=0,clearInterval(t))},10)};s.value>60&&!h.value?(h.value=!0,s.value=60,await c.triggerRandomCharacterMoment(),setTimeout(()=>{h.value=!1,e()},500)):h.value||e()},Se=e=>{w.value=w.value===e?null:e},le=e=>{e.target.closest(".actions")||(w.value=null)},ae=e=>{S&&S(e.target.scrollTop<300/2)};return Y({openPostMomentModal:fe}),(e,t)=>(i(),r("div",{class:"chat-moments",onTouchstart:Te,onTouchmove:xe,onTouchend:$e},[n("div",{class:"pull-refresh-loading",style:D({opacity:Math.min(s.value/60,1),transform:`rotate(${s.value*5}deg)`})},[n("div",{class:de(["loading-icon",{"is-spinning":h.value}])},[...t[13]||(t[13]=[n("svg",{viewBox:"0 0 24 24",width:"30",height:"30",fill:"white"},[n("path",{d:"M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"})],-1)])],2)],4),n("div",{class:"moments-content-wrapper",style:D({transform:`translateY(${s.value}px)`})},[n("div",ht,[n("div",{class:"cover-image",style:D(V.value?{backgroundImage:`url(${V.value})`}:{backgroundColor:"#333"}),onClick:t[7]||(t[7]=u=>_("cover"))},[n("div",ft,[J(n("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>U.value=u),class:"username-input",onClick:t[1]||(t[1]=f(()=>{},["stop"])),onInput:t[2]||(t[2]=u=>Z("name")),placeholder:"昵称"},null,544),[[X,U.value]]),n("div",{class:"avatar",style:D(P.value?{backgroundImage:`url(${P.value})`}:{backgroundColor:"#ccc"}),onClick:t[3]||(t[3]=f(u=>_("avatar"),["stop"]))},null,4),J(n("input",{"onUpdate:modelValue":t[4]||(t[4]=u=>p.value=u),class:"signature-input",onClick:t[5]||(t[5]=f(()=>{},["stop"])),onInput:t[6]||(t[6]=u=>Z("signature")),placeholder:"个性签名"},null,544),[[X,p.value]])])],4)]),n("div",pt,[(i(!0),r(E,null,H(W.value,u=>(i(),Ne(gt,{key:u.id,moment:u,"current-user-avatar":P.value,"current-user-name":I.value,"is-menu-open":w.value===u.id,onToggleMenu:Se,onLike:be,onComment:Ce,onReply:we,onLongPress:ke},null,8,["moment","current-user-avatar","current-user-name","is-menu-open"]))),128))])],4),z.value?(i(),r("div",{key:0,class:"comment-input-overlay",onClick:oe},[n("div",{class:"comment-input-box",onClick:t[9]||(t[9]=f(()=>{},["stop"]))},[M.value?(i(),r("div",kt," 回复 "+d(M.value.name)+": ",1)):g("",!0),n("div",yt,[J(n("input",{ref_key:"commentInputRef",ref:F,"onUpdate:modelValue":t[8]||(t[8]=u=>k.value=u),class:"base-input",placeholder:M.value?`回复 ${M.value.name}`:"评论",onKeyup:Ee(se,["enter"])},null,40,Mt),[[X,k.value]]),n("button",{onClick:se,disabled:!k.value.trim()},"发送",8,bt)])])])):g("",!0),q(Fe,{visible:B.value,"onUpdate:visible":t[10]||(t[10]=u=>B.value=u),title:O.title,bizType:O.bizType,type:"basic",onSendImage:he},null,8,["visible","title","bizType"]),q(ue,{visible:x.value,"onUpdate:visible":t[11]||(t[11]=u=>x.value=u),title:"动态操作"},{footer:G(()=>[n("button",{class:"modal-btn cancel",onClick:Q},"取消")]),default:G(()=>[n("div",Ct,[b.value?(i(),r("button",{key:0,class:"btn btn-secondary big-btn",onClick:Me},"重试")):g("",!0),n("button",{class:"btn btn-secondary big-btn",onClick:ye},"删除")])]),_:1},8,["visible"]),q(ue,{visible:a.value,"onUpdate:visible":t[12]||(t[12]=u=>a.value=u),title:"评论操作"},{footer:G(()=>[n("button",{class:"modal-btn cancel",onClick:ne},"取消")]),default:G(()=>[n("div",{class:"modal-actions"},[n("button",{class:"btn btn-secondary big-btn",onClick:Ie},"删除")])]),_:1},8,["visible"]),q(Re,{show:K.value,onClose:ee,onPost:pe},null,8,["show"])],32))}},xt=ce(wt,[["__scopeId","data-v-9b07a823"]]);export{xt as default};
