import{u as K,s as _,r as B,G as le,H as st,I as nt,a as ot,J as at,L as lt,b as it,j as he,N as rt,_ as G,m as ee,x as ke,d as $,o as k,k as Q,f as U,g as q,e,T as fe,t as w,B as x,i as Y,w as W,A as Z,M as ce,c as E,F as O,C as ie,n as F,v as pe,E as re,O as we,z as $e,y as z,S as X,P as ct,D as j,Q as dt,R as ut,U as vt,V as ae,W as gt,X as mt,Y as ve,Z as ft}from"./index-rmqAKKIs.js";import{M as pt}from"./MoneyPacket-DGScEc4v.js";function ht(t){const f=K(),s=_(),n=B(!1),v=B(new Set),p=B(!1),g=(l,m)=>{console.log("[useMessageSelection] enterSelectionMode triggered");let A=0,d=0;const r=document.querySelector(".message-list");m&&r&&(A=r.scrollTop,d=m.getBoundingClientRect().top),n.value=!0,v.value.clear(),l&&v.value.add(l),m&&r&&le(()=>{const c=document.querySelector(".selection-bar"),C=c?c.offsetHeight:0,P=m.getBoundingClientRect().top-d;r.scrollTop=A+P-C})},o=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),n.value=!1,v.value.clear()};return{isSelectionMode:n,selectedMessageIds:v,isForwarding:p,enterSelectionMode:g,exitSelectionMode:o,toggleMessageSelection:l=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${l}`),v.value.has(l)?v.value.delete(l):v.value.add(l)},handleBatchAction:l=>{if(console.log(`[useMessageSelection] handleBatchAction: ${l}`),v.value.size===0)return;const m=f.messages[t.value];if(l==="forward")p.value=!0;else if(l==="delete")s.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),f.messages[t.value]=m.filter(A=>!v.value.has(A.id)),f.saveData(),o()});else if(l==="favorite"){const A=m.filter(d=>v.value.has(d.id));A.length>0&&(f.addToFavorites(t.value,A),s.showToast("已收藏","success")),o()}},handleConfirmForward:l=>{console.log("[useMessageSelection] handleConfirmForward triggered"),p.value=!1;const A=(f.messages[t.value]||[]).filter(d=>v.value.has(d.id));A.length!==0&&(l.forEach(d=>{f.messages[d]||(f.messages[d]=[]),A.forEach(r=>{const c={...r,id:Date.now().toString()+Math.random()};f.messages[d].push(c)})}),f.saveData(),s.showToast(`已转发 ${A.length} 条消息`),o())}}}function kt(t,f){const s=K(),n=st(),v=nt(),p=ot(),g=he(),o=it(),{buildInnerVoicePrompt:i}=at(),u=B(!1),b=c=>{const C=/\[撤回\]/g;if(C.test(c)){const a=s.messages[t.value]||[];for(let P=a.length-1;P>=0;P--){const L=a[P];if(L.sender==="char"&&!L.isRevoked){s.revokeMessage(t.value,L.id),console.log(`[useAiHandler] Revoked message: ${L.id}`);break}}return c.replace(C,"").trim()}return c},l=c=>{const C=/\[互动朋友圈：(.+?)\]/g;let a;for(;(a=C.exec(c))!==null;)try{const P=JSON.parse(a[1]),{action:L,response:R}=P,I=p.moments.filter(y=>y.userId==="user");if(I.length>0){const y=I[0];L==="like"?(p.likeMoment(y.id,t.value),console.log(`[useAiHandler] Liked user's latest moment: ${y.id}`)):L==="comment"&&R&&(p.likeMoment(y.id,t.value),p.addComment(y.id,{userId:t.value,content:R,time:Date.now()}),console.log(`[useAiHandler] Commented on user's latest moment: ${y.id}`))}}catch(P){console.error("[useAiHandler] Failed to parse moment interaction data:",P)}return c.replace(C,"").trim()},m=c=>{const C=/\[朋友圈：(.+?)\]/g;let a;for(;(a=C.exec(c))!==null;)try{const P=JSON.parse(a[1]),{text:L,imageDescription:R}=P,I=[];R&&I.push({content:R,isTextGenerated:!0}),(L||I.length>0)&&(p.addMoment({userId:t.value,content:L||"",images:I,time:Date.now()}),console.log(`[useAiHandler] Added new moment for ${t.value}`))}catch(P){console.error("[useAiHandler] Failed to parse moment data from AI response:",P)}return c.replace(C,"").trim()},A=c=>{const C=/\[待办：(?:((?:\d{4}-\d{2}-\d{2}\s)?\d{1,2}:\d{2}|\d{4}-\d{2}-\d{2})\s)?(.+?)\]/g;let a;for(;(a=C.exec(c))!==null;){const P=a[1],L=a[2].trim();let R=new Date,I="";if(P)if(P.includes("-"))if(P.includes(":")){const[y,h]=P.split(/\s+/);R=new Date(y),I=h}else R=new Date(P),I="";else I=P;else{const y=new Date,h=[15,30,60],S=h[Math.floor(Math.random()*h.length)];y.setMinutes(y.getMinutes()+S);const D=y.getHours().toString().padStart(2,"0"),H=y.getMinutes().toString().padStart(2,"0");I=`${D}:${H}`}if(L){let y=L;y.length>18&&(y=y.substring(0,18)+"..."),v.addEvent({type:"todo",title:y,content:y,date:rt(R,{representation:"date"}),done:!1,time:I}),console.log(`[useAiHandler] Added new todo: "${y}"`)}}return c.replace(C,"").trim()},d=async()=>{try{const c=s.getCharacter(t.value);if(!c)return;const C=s.innerVoices[t.value]||[];let a=1;if(C.length>0){const I=C[0].title;if(I){const y=I.match(/#(\d+)/);y?a=parseInt(y[1],10)+1:a=C.length+1}else a=C.length+1}const P=s.getFormattedRecentMessages(t.value,10),L=i(c,P,a),R=await f.getGenericCompletion([{role:"user",content:L}]);if(R){const I=R.indexOf("{"),y=R.lastIndexOf("}");if(I!==-1&&y!==-1){const h=R.substring(I,y+1),S=JSON.parse(h);s.addInnerVoice(t.value,S),console.log("[useAiHandler] Inner voice generated and saved:",S)}else console.warn("[useAiHandler] Failed to find JSON in inner voice response.")}}catch(c){console.error("[useAiHandler] Failed to generate inner voice:",c)}};return{isTyping:u,triggerAiResponse:async()=>{console.log("[useAiHandler] triggerAiResponse triggered"),u.value=!0;try{const c=s.getCharacter(t.value),C=s.getPendingUserTransfers(t.value);console.log("[useAiHandler] Pending transfers to accept:",C.length);let a=await f.getChatCompletion(t.value);if(console.log("[useAiHandler] AI Response:",a),a){if(a=b(a),a=l(a),a=m(a),a=A(a),!a){u.value=!1,d();return}s.messages[t.value]||(s.messages[t.value]=[]);const P=(c==null?void 0:c.isBlocked)||!1,L=/(?:\||\\\||｜)\s*(?:\||\\\||｜)\s*(?:\||\\\||｜)+/g;let I=a.replace(L,"|||").split("|||"),y=[];const h=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g;I.forEach(S=>{const D=S.split(h).map(H=>H.trim()).filter(H=>H);y.push(...D)});for(let S=0;S<y.length;S++){const D=y[S];S>0&&await new Promise(J=>setTimeout(J,1e3+Math.random()*1e3));let{type:H,content:N}=lt(D),te={};if(H==="transfer_accepted"){await new Promise(J=>setTimeout(J,800+Math.random()*500)),s.autoAcceptPendingTransfers(t.value),console.log("[useAiHandler] Transfer acceptance message processed.");continue}if(H==="sticker"){const J=N,ne=s.stickers.find(de=>de.name===J);ne?(N=ne.url,te.name=J):(H="text",N=`[表情包：${J}]`)}let se=!1;H==="image"&&!N.startsWith("http")&&!N.startsWith("data:")&&(se=!0),s.addMessage(t.value,{id:Date.now().toString()+S,sender:"char",type:H,content:N,isTextGenerated:se,...te,time:Date.now(),blocked:P}),o.path!==`/chat/room/${t.value}`&&(s.incrementUnreadCount(t.value),n.triggerNotification(c.nickname||c.name,H==="text"?N:`[${H}]`,c.avatar,()=>{g.push(`/chat/room/${t.value}`)},3e3,H))}C.length>0&&s.getPendingUserTransfers(t.value).length>0&&(await new Promise(S=>setTimeout(S,800+Math.random()*500)),s.autoAcceptPendingTransfers(t.value),console.log("[useAiHandler] Fallback transfer acceptance executed at the end"))}}catch(c){console.error("[useAiHandler] triggerAiResponse failed:",c)}finally{u.value=!1,d()}}}}function bt(t,f,s){const n=B(null);return{editingMessageId:n,handleEditMessage:o=>{console.log("[useMessageEditing] handleEditMessage for msgId:",o),n.value=o},handleSaveEdit:({msgId:o,newContent:i})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",o);const b=t.messages[f.value].find(l=>l.id===o);b&&(b.content=i,t.saveData()),n.value=null},updateInputText:o=>{console.log("[useMessageEditing] updateInputText called"),s&&(s.value=o,le(()=>{const i=document.querySelector(".chat-input");i&&i.focus()}))}}}function yt(t,f,s,n,v={}){const p=B(""),g=B(null),o=(d,r,c={})=>{console.log(`[useMessageSender] sendMsg called with type: ${d}`);const C={...c};g.value&&(C.quote={id:g.value.id,sender:g.value.sender,content:g.value.content}),t.addMessage(f.value,{id:Date.now().toString()+Math.random(),sender:"user",type:d,content:r,timestamp:Date.now(),...C}),n&&(n.value=null),g.value=null};return{inputText:p,quotingMessage:g,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const d=p.value.trim();d&&(o("text",d),p.value="")},sendMsg:o,sendSticker:d=>{console.log("[useMessageSender] sendSticker triggered"),o("sticker",d.url,{name:d.name})},sendVoiceMessage:d=>{console.log("[useMessageSender] sendVoiceMessage triggered"),d&&o("voice",d)},handleSendImage:d=>{console.log("[useMessageSender] handleSendImage triggered"),d.isTextGenerated?o("image",d.description,{isTextGenerated:!0}):(d.type==="base64"||d.type==="url")&&o("image",d.content)},confirmSendLocation:(d,r)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!d){s.showToast("请输入位置名称","info");return}o("location",d,{detail:r})},sendTransfer:(d,r)=>{console.log("[useMessageSender] sendTransfer triggered",d,r),o("transfer",d,{note:r,status:"pending"})}}}function St(t){const f=B(null),s=B(!1),n=B({x:0,y:0}),v=(u,b)=>{console.log("[useMessageInteraction] showMenu triggered"),u.preventDefault();const l=u.target.closest(".msg-bubble, .system-message-wrapper");l&&(t.value={visible:!0,messageId:b,targetEl:l})};return{startLongPress:(u,b)=>{console.log("[useMessageInteraction] startLongPress triggered"),u.stopPropagation(),s.value=!1,clearTimeout(f.value),u.type.startsWith("touch")&&(n.value={x:u.touches[0].clientX,y:u.touches[0].clientY}),f.value=setTimeout(()=>{s.value=!0,v(u,b)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(f.value)},handleTouchMove:u=>{console.log("[useMessageInteraction] handleTouchMove triggered");const b=u.touches[0],l=Math.abs(b.clientX-n.value.x),m=Math.abs(b.clientY-n.value.y);(l>10||m>10)&&clearTimeout(f.value)},wasClickAfterLongPress:()=>s.value?(s.value=!1,!0):!1}}const Mt={class:"header-title-area"},wt={key:0,class:"chat-room-title"},$t={key:1,class:"typing-indicator"},Ct={class:"right-icons-group"},Tt={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},xt=["placeholder"],It=["placeholder"],At={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:f}){const s=t,{t:n}=ee(),v=he(),p=K(),g=_(),o=B(!1),i=B(""),u=B(""),b=B(!1);ke(()=>{b.value=!0});const l=()=>{const d=s.charStatus||{};i.value=d.icon||"✨",u.value=d.text||"",o.value=!0},m=()=>{const d=i.value.trim()||"✨",r=u.value.trim(),c=p.getCharacter(s.charId);c&&(r?c.status={icon:d,text:r}:c.status=null,p.saveData(),g.showToast(n("saveSuccess"))),o.value=!1},A=()=>{v.push({name:"memory-bank",params:{charId:s.charId}})};return(d,r)=>(k(),$("div",null,[b.value?(k(),Q(fe,{key:0,to:"#chatRoomLeftArea"},[e("div",{class:"btn-icon bell-btn",onClick:r[0]||(r[0]=c=>d.$emit("trigger-ai")),ref:"bellBtn"},[...r[6]||(r[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)])):U("",!0),b.value?(k(),Q(fe,{key:1,to:"#chatRoomTitleArea"},[e("div",Mt,[t.isTyping?(k(),$("div",$t,[e("span",null,w(x(n)("chat.singleChat.typing")),1),r[7]||(r[7]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(k(),$("div",wt,w(t.charName),1))]),e("div",{class:"chat-room-status",onClick:l},[e("span",null,w(t.charStatus.icon||"✨"),1),e("span",null,w(t.charStatus.text||x(n)("chat.singleChat.addStatus")),1)])])):U("",!0),b.value?(k(),Q(fe,{key:2,to:"#chatRoomActionArea"},[e("div",Ct,[e("div",{class:"btn-icon memory-btn",onClick:A},[...r[8]||(r[8]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e("polyline",{points:"14 2 14 8 20 8"}),e("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e("polyline",{points:"10 9 9 9 8 9"})],-1)])]),e("div",{class:"btn-icon more-btn",onClick:r[1]||(r[1]=c=>d.$emit("open-settings"))},[...r[9]||(r[9]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])])])):U("",!0),q(ce,{visible:o.value,"onUpdate:visible":r[5]||(r[5]=c=>o.value=c),title:x(n)("chat.singleChat.setStatus")},{footer:Y(()=>[e("button",{class:"modal-btn cancel",onClick:r[4]||(r[4]=c=>o.value=!1)},w(x(n)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:m},w(x(n)("confirm")),1)]),default:Y(()=>[e("div",Tt,[W(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[2]||(r[2]=c=>i.value=c),placeholder:x(n)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,xt),[[Z,i.value]]),W(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[3]||(r[3]=c=>u.value=c),placeholder:x(n)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,It),[[Z,u.value]])])]),_:1},8,["visible","title"])]))}},Pt=G(At,[["__scopeId","data-v-9265e8b0"]]),Bt={key:0,class:"chat-panel",id:"stickerPanel"},Lt={class:"sticker-panel-header"},Vt={class:"sticker-groups"},Rt=["onClick"],Dt={class:"sticker-panel-content"},Et=["onClick"],qt=["src","alt"],Ht={class:"sticker-panel-footer"},Ut={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:f}){const s=f,n=K(),v=_(),p=B("默认"),g=B(!1),o=B(new Set),i=B(!1),u=B(!1),b=B(""),l=E(()=>["默认",...new Set(n.stickers.map(y=>y.group).filter(Boolean).filter(y=>y!=="默认"))]),m=E(()=>n.stickers.filter(I=>I.group===p.value)),A=I=>{g.value?o.value.has(I.id)?o.value.delete(I.id):o.value.add(I.id):s("send-sticker",I)},d=({group:I,stickers:y})=>{const h=y.map(S=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:S.url,name:S.name,group:I}));n.stickers.push(...h),n.saveData(),v.showToast(`成功导入 ${h.length} 个表情包`,"success")},r=()=>{i.value=!0},c=()=>{o.value.size>0&&(u.value=!0)},C=()=>{g.value=!g.value,o.value.clear()},a=()=>{const I=m.value;I.every(h=>o.value.has(h.id))?I.forEach(h=>o.value.delete(h.id)):I.forEach(h=>o.value.add(h.id))},P=()=>{o.value.size!==0&&v.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{n.stickers=n.stickers.filter(I=>!o.value.has(I.id)),n.saveData(),o.value.clear()})},L=()=>{const I=b.value.trim();if(!I)return v.showToast("请输入目标分组","info");n.stickers.forEach(y=>{o.value.has(y.id)&&(y.group=I)}),n.saveData(),u.value=!1,b.value="",o.value.clear(),g.value=!1,p.value=I},R=()=>{if(o.value.size===0)return;const I=n.stickers.filter(D=>o.value.has(D.id)).map(D=>`${D.name} ${D.url}`).join(`
`),y=new Blob([I],{type:"text/plain"}),h=URL.createObjectURL(y),S=document.createElement("a");S.href=h,S.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(h),o.value.clear(),g.value=!1};return(I,y)=>(k(),$("div",null,[t.visible?(k(),$("div",Bt,[e("div",Lt,[e("div",Vt,[(k(!0),$(O,null,ie(l.value,h=>(k(),$("div",{class:F(["sticker-group-tab",{active:p.value===h}]),key:h,onClick:S=>p.value=h},w(h),11,Rt))),128))])]),e("div",Dt,[(k(!0),$(O,null,ie(m.value,h=>(k(),$("div",{class:F(["sticker-item",{selected:o.value.has(h.id),"manage-mode":g.value}]),key:h.id,onClick:S=>A(h)},[e("img",{src:h.url,alt:h.name},null,8,qt),e("span",null,w(h.name),1)],10,Et))),128))]),e("div",Ht,[W(e("div",{class:"sticker-add-btn",onClick:r},"＋",512),[[pe,!g.value]]),e("div",{class:"sticker-manage-btn",style:re({color:g.value?"var(--danger-color)":"#576B95"}),onClick:C},w(g.value?"完成":"管理"),5)]),e("div",{class:F(["manage-bar",{active:g.value}])},[e("button",{class:"btn btn-secondary",onClick:r},"导入"),e("button",{class:"btn btn-secondary",onClick:a},"全选"),e("button",{class:"btn btn-secondary",onClick:c},"移动"),e("button",{class:"btn btn-secondary",onClick:R},"导出"),e("button",{class:"btn btn-danger",onClick:P},"删除")],2)])):U("",!0),q(we,{visible:i.value,"onUpdate:visible":y[0]||(y[0]=h=>i.value=h),type:"sticker-import",onImportSticker:d},null,8,["visible"]),q(ce,{visible:u.value,"onUpdate:visible":y[3]||(y[3]=h=>u.value=h),title:"移动到分组"},{footer:Y(()=>[e("button",{class:"modal-btn cancel",onClick:y[2]||(y[2]=h=>u.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:L},"确定")]),default:Y(()=>[W(e("input",{type:"text",class:"base-input","onUpdate:modelValue":y[1]||(y[1]=h=>b.value=h),placeholder:"输入目标分组名称"},null,512),[[Z,b.value]])]),_:1},8,["visible"])]))}},Nt=G(Ut,[["__scopeId","data-v-c6bef6fa"]]),Ft={class:"chat-panel",id:"morePanel"},zt={class:"more-panel-content"},jt={class:"more-label"},Ot={class:"more-label"},Gt={class:"more-label"},Wt={class:"more-label"},Yt={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:f}=ee();return(s,n)=>(k(),$("div",Ft,[e("div",zt,[e("div",{class:"more-item",onClick:n[0]||(n[0]=v=>s.$emit("trigger-image-upload"))},[n[4]||(n[4]=$e('<div class="more-icon" data-v-d00cc944><svg class="svg-icon" viewBox="0 0 24 24" data-v-d00cc944><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-d00cc944></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-d00cc944></circle><polyline points="21 15 16 10 5 21" data-v-d00cc944></polyline></svg></div>',1)),e("span",jt,w(x(f)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:n[1]||(n[1]=v=>s.$emit("start-video-call"))},[n[5]||(n[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Ot,w(x(f)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:n[2]||(n[2]=v=>s.$emit("send-location"))},[n[6]||(n[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",Gt,w(x(f)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:n[3]||(n[3]=v=>s.$emit("send-transfer"))},[n[7]||(n[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M8 5 L4 9 H20 M16 19 L20 15 H4"})])],-1)),e("span",Wt,w(x(f)("chat.morePanel.transfer")),1)])])]))}},Jt=G(Yt,[["__scopeId","data-v-d00cc944"]]),Qt={class:"chat-footer"},Kt={key:0,class:"quote-preview"},Xt={class:"quote-content"},Zt={class:"quote-sender"},_t={class:"quote-text"},es={class:"chat-input-row"},ts={class:"chat-input-wrapper"},ss=["value","onKeydown"],ns={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"24px",height:"24px",position:"relative",top:"1px",left:"-1px"}},os={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null},charId:{type:String,required:!0}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:f}){const{t:s}=ee(),n=K(),v=t,p=f,g=B(v.activePanel);z(()=>v.activePanel,l=>{g.value=l}),z(g,l=>{p("update:activePanel",l)});const o=E(()=>{if(!v.quotingMessage)return"";if(v.quotingMessage.sender==="user")return s("chat.self");{const l=n.getCharacter(v.charId);return(l==null?void 0:l.nickname)||(l==null?void 0:l.name)||s("chat.other")}}),i=l=>{g.value===l?g.value=null:g.value=l},u=()=>{v.modelValue.trim()&&p("send-message")},b=l=>{p("send-sticker",l),g.value=null};return(l,m)=>(k(),$("div",Qt,[t.quotingMessage?(k(),$("div",Kt,[e("div",Xt,[e("span",Zt,w(o.value)+": ",1),e("span",_t,w(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:m[0]||(m[0]=A=>l.$emit("cancel-quote"))},[...m[9]||(m[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):U("",!0),e("div",es,[e("div",{class:"chat-tool-btn",onClick:m[1]||(m[1]=A=>l.$emit("trigger-voice"))},[q(X,{name:"voice-circle",class:"svg-icon"})]),e("div",ts,[e("textarea",{class:"chat-input",value:t.modelValue,onInput:m[2]||(m[2]=A=>l.$emit("update:modelValue",A.target.value)),onKeydown:ct(j(u,["exact","prevent"]),["enter"]),id:"messageInput",autocomplete:"off",rows:"1"},null,40,ss)]),e("div",{class:"chat-tool-btn",onClick:m[3]||(m[3]=A=>i("sticker"))},[q(X,{name:"sticker",class:"svg-icon"})]),t.modelValue?(k(),$("div",{key:1,class:"send-btn-icon",onClick:u},[(k(),$("svg",ns,[...m[10]||(m[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(k(),$("div",{key:0,class:"chat-tool-btn",onClick:m[4]||(m[4]=A=>i("more"))},[q(X,{name:"plus-circle",class:"svg-icon"})]))]),q(Nt,{visible:g.value==="sticker",onSendSticker:b},null,8,["visible"]),g.value==="more"?(k(),Q(Jt,{key:1,onTriggerImageUpload:m[5]||(m[5]=A=>l.$emit("trigger-image")),onStartVideoCall:m[6]||(m[6]=A=>l.$emit("trigger-video")),onSendLocation:m[7]||(m[7]=A=>l.$emit("trigger-location")),onSendTransfer:m[8]||(m[8]=A=>l.$emit("trigger-transfer"))})):U("",!0)]))}},as=G(os,[["__scopeId","data-v-3da6a910"]]),ls={class:"menu-grid"},is={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:f}){const s=t,n=f,v=dt("phoneScreenRef"),{t:p}=ee(),g=K(),o=_(),i=B(null),u=B({}),b=B(0),l=B("top");z(()=>s.visible,async d=>{d&&s.targetEl&&(await le(),m())});const m=()=>{const d=i.value;if(!d)return;const r=s.targetEl.getBoundingClientRect(),c=d.offsetWidth,C=d.offsetHeight,a=8,P=v.value,L=P?P.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};l.value="top";let R=r.top-C-a;R<L.top+a&&(l.value="bottom",R=r.bottom+a);const I=r.left+r.width/2;let y=I-c/2;y<L.left+a&&(y=L.left+a),y+c>L.left+L.width-a&&(y=L.left+L.width-c-a);let h=I-y;const S=12,D=S/2+5,H=c-S/2-5;h=Math.max(D,Math.min(h,H)),u.value={top:`${R}px`,left:`${y}px`},b.value=h},A=d=>{const r=s.messageId;if(!r)return;const c=g.messages[s.charId],C=c.findIndex(L=>L.id===r),a=c[C],P={copy:()=>{a.content&&(navigator.clipboard.writeText(a.content),o.showToast(p("chat.messageMenu.toast.copied")))},favorite:()=>{g.addToFavorites(s.charId,a),o.showToast(p("chat.messageMenu.toast.favorited"))},delete:()=>{o.showConfirm(p("chat.messageMenu.confirmDelete"),p("chat.messageMenu.confirmDeleteMsg"),()=>{g.messages[s.charId].splice(C,1),g.saveData()})},revoke:()=>{a&&(a.type="revoked",g.saveData(),o.showToast(p("chat.messageMenu.toast.revoked")))},select:()=>n("enter-selection-mode",r,s.targetEl),quote:()=>n("quote-message",r),retry:()=>{a.sender!=="user"?g.messages[s.charId].splice(C,1):g.retryFromMessage(s.charId,r),g.saveData(),n("trigger-ai-response")},edit:()=>{a.type==="text"?n("edit-message",r):o.showToast(p("chat.messageMenu.toast.editTextOnly"),"info")}};P[d]&&P[d](),n("close")};return(d,r)=>t.visible?(k(),$("div",{key:0,ref_key:"menuRef",ref:i,class:F(["message-menu",{"menu-top":l.value==="top","menu-bottom":l.value==="bottom"}]),style:re(u.value)},[e("div",ls,[e("div",{class:"menu-item",onClick:r[0]||(r[0]=c=>A("copy"))},w(x(p)("copy")),1),e("div",{class:"menu-item",onClick:r[1]||(r[1]=c=>A("favorite"))},w(x(p)("favorite")),1),e("div",{class:"menu-item",onClick:r[2]||(r[2]=c=>A("delete"))},w(x(p)("delete")),1),e("div",{class:"menu-item",onClick:r[3]||(r[3]=c=>A("revoke"))},w(x(p)("revoke")),1),e("div",{class:"menu-item",onClick:r[4]||(r[4]=c=>A("select"))},w(x(p)("select")),1),e("div",{class:"menu-item",onClick:r[5]||(r[5]=c=>A("quote"))},w(x(p)("quote")),1),e("div",{class:"menu-item",onClick:r[6]||(r[6]=c=>A("retry"))},w(x(p)("retry")),1),e("div",{class:"menu-item",onClick:r[7]||(r[7]=c=>A("edit"))},w(x(p)("edit")),1)]),e("div",{class:"menu-arrow",style:re({left:b.value+"px"})},null,4)],6)):U("",!0)}},rs=G(is,[["__scopeId","data-v-611c1739"]]),cs={class:"chat-action-row"},ds={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:f}=ee();return(s,n)=>(k(),$("div",cs,[e("div",{class:"action-btn",onClick:n[0]||(n[0]=v=>s.$emit("action","favorite"))},[n[4]||(n[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,w(x(f)("favorite")),1)]),e("div",{class:"action-btn",onClick:n[1]||(n[1]=v=>s.$emit("action","forward"))},[n[5]||(n[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,w(x(f)("forward")),1)]),e("div",{class:"action-btn",onClick:n[2]||(n[2]=v=>s.$emit("action","delete"))},[n[6]||(n[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,w(x(f)("delete")),1)]),e("div",{class:"action-btn",onClick:n[3]||(n[3]=v=>s.$emit("cancel"))},[n[7]||(n[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,w(x(f)("done")),1)])]))}},us=G(ds,[["__scopeId","data-v-be1a592f"]]),vs=["src"],gs={class:"msg-content-wrapper"},ms={class:"msg-bubble-box"},fs={key:0,class:"quote-in-bubble"},ps={class:"quote-in-bubble-sender"},hs={class:"quote-in-bubble-text"},ks={key:1,class:"edit-view"},bs={key:0},ys={class:"description-placeholder"},Ss=["src"],Ms={key:2,class:"sticker-msg"},ws=["src"],$s={key:3,class:"voice-msg-wrapper"},Cs={class:"voice-msg"},Ts={key:4,class:"location-msg"},xs={class:"location-text"},Is={class:"msg-title"},As={class:"transfer-content"},Ps={class:"transfer-icon"},Bs={key:0,viewBox:"0 0 24 24",fill:"currentColor"},Ls={key:1,viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},Vs={class:"transfer-info"},Rs={class:"transfer-amount"},Ds={class:"transfer-desc"},Es={class:"transfer-footer"},qs={key:6,class:"call-summary-msg"},Hs={key:0,class:"blocked-icon"},Us={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","show-thought","accept-transfer"],setup(t,{emit:f}){const s=t,n=f,v=ut(),p=B(!1),g=B(!1),o=B(""),i=E(()=>s.editingMessageId===s.msg.id),u=E(()=>{const h=s.msg.type,S=h==="transfer"&&s.msg.status==="accepted";return{"no-style":["image","sticker","location","transfer"].includes(h),"has-location":h==="location","has-transfer":h==="transfer",accepted:S}}),b=E(()=>{if(s.msg.type!=="transfer")return{};const h=s.msg.status==="accepted",S=s.msg.sender==="user";return{"accepted-sender":h&&S,"accepted-receiver":h&&!S,pending:!h}}),l=E(()=>{if(s.msg.type!=="transfer")return"";const h=s.msg.sender==="user",S=s.msg.status==="accepted",D=s.msg.isReceived;return s.msg.note?s.msg.note:D?"已收款":S?"已被接收":h?"你发起了一笔转账":"请收款"}),m=E(()=>s.msg.type!=="transfer"?"":s.msg.isReceived?"已收款":s.msg.status==="accepted"?"已被接收":"微信转账");z(i,h=>{h&&(o.value=s.msg.content)});const A=h=>{n("long-press",h,s.msg.id)},d=()=>{n("cancel-long-press")},r=h=>{n("touch-move",h)},c=h=>{s.msg.type==="voice"&&a(),s.msg.type!=="image"&&n("click-msg",h,s.msg.id)},C=()=>{s.msg.sender!=="user"&&n("show-thought",s.msg.id)},a=()=>{p.value=!p.value},P=()=>{g.value=!g.value},L=()=>{o.value.trim()&&n("save-edit",{msgId:s.msg.id,newContent:o.value})},R=()=>{n("cancel-edit")},I=()=>s.msg.type==="notification"?s.msg.content:s.msg.type==="revoked"?`"${s.msg.sender==="user"?"你":s.charName}" 撤回了一条消息`:"",y=()=>{(s.msg.status==="pending"||s.msg.status===void 0)&&s.msg.sender!=="user"&&!s.isSelectionMode&&n("accept-transfer",s.msg.id)};return(h,S)=>(k(),$("div",{class:F(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[t.msg.type==="revoked"||t.msg.type==="notification"?(k(),$(O,{key:0},[e("div",{class:F(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:S[0]||(S[0]=j(D=>h.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),e("div",{class:"system-message-wrapper",onMousedown:A,onMouseup:d,onMouseleave:d,onTouchstart:A,onTouchend:d,onTouchmove:r,onClick:j(c,["prevent"])},[e("div",{class:"system-message-text",onClick:S[1]||(S[1]=j(D=>!t.isSelectionMode&&P(),["stop"]))},w(I()),1),t.msg.type==="revoked"?W((k(),$("div",{key:0,class:"revoked-content"},w(t.msg.sender==="user"?"我":t.charName)+"："+w(t.msg.content),513)),[[pe,g.value]]):U("",!0)],32)],64)):(k(),$(O,{key:1},[e("div",{class:"msg-avatar",onClick:C},[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(k(),$("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,vs)):(k(),$("div",{key:1,class:F(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",gs,[e("div",ms,[e("div",{class:F(["msg-bubble",u.value]),style:re(t.bubbleStyle),onMousedown:A,onMouseup:d,onMouseleave:d,onTouchstart:A,onTouchend:d,onTouchmove:r,onClick:j(c,["prevent"])},[t.msg.quote?(k(),$("div",fs,[e("div",ps,w(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",hs,w(t.msg.quote.content),1)])):U("",!0),i.value?(k(),$("div",ks,[W(e("textarea",{"onUpdate:modelValue":S[2]||(S[2]=D=>o.value=D),class:"edit-textarea",rows:"3"},null,512),[[Z,o.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:R,class:"edit-btn cancel"},"取消"),e("button",{onClick:L,class:"edit-btn save"},"保存")])])):(k(),$(O,{key:2},[t.msg.type==="text"?(k(),$("div",bs,w(t.msg.content),1)):t.msg.type==="image"?(k(),$(O,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(k(),$("div",{key:0,class:"text-generated-image-container",onClick:S[3]||(S[3]=D=>x(v).preview(t.msg))},[e("div",ys,w(t.msg.content),1)])):(k(),$("div",{key:1,class:"image-msg",onClick:S[4]||(S[4]=D=>x(v).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,Ss)]))],64)):t.msg.type==="sticker"?(k(),$("div",Ms,[e("img",{src:t.msg.content,alt:"表情包"},null,8,ws)])):t.msg.type==="voice"?(k(),$("div",$s,[e("div",Cs,[q(X,{name:"voice-wave",class:F(["voice-icon-svg",{playing:p.value}])},null,8,["class"]),e("span",null,w(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(k(),$("div",Ts,[e("div",xs,[e("div",Is,w(t.msg.content||"位置信息"),1),S[6]||(S[6]=e("div",{class:"msg-desc"},"详细地址",-1))]),S[7]||(S[7]=$e('<div class="location-map" data-v-219f64dd><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-219f64dd><div class="location-pin" data-v-219f64dd><svg viewBox="0 0 24 24" fill="currentColor" data-v-219f64dd><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-219f64dd></path></svg></div></div>',1))])):t.msg.type==="transfer"?(k(),$("div",{key:5,class:F(["transfer-msg",b.value]),onClick:j(y,["stop"])},[e("div",As,[e("div",Ps,[t.msg.status==="accepted"||t.msg.isReceived?(k(),$("svg",Bs,[...S[8]||(S[8]=[e("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"},null,-1)])])):(k(),$("svg",Ls,[...S[9]||(S[9]=[e("path",{d:"M8 5 L4 9 H20 M16 19 L20 15 H4"},null,-1)])]))]),e("div",Vs,[e("div",Rs,"¥"+w(t.msg.content),1),e("div",Ds,w(l.value),1)])]),e("div",Es,w(m.value),1)],2)):t.msg.type==="call_summary"?(k(),$("div",qs,[S[10]||(S[10]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,w(t.msg.content),1)])):U("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(k(),$("div",Hs,[...S[11]||(S[11]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):U("",!0)]),t.msg.type==="voice"?W((k(),$("div",{key:0,class:"voice-text"},w(t.msg.content),513)),[[pe,p.value]]):U("",!0)]),e("div",{class:F(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:S[5]||(S[5]=j(D=>h.$emit("toggle-selection",t.msg.id),["stop"]))},null,2)],64))],2))}},Ns=G(Us,[["__scopeId","data-v-219f64dd"]]),Fs={key:0,class:"empty-message"},zs={key:0,class:"timestamp"},js={key:0,class:"blocked-overlay"},Os={class:"blocked-content"},Gs=5*60*1e3,Ws={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content","show-thought","accept-transfer"],setup(t,{expose:f}){const s=t,n=B(null),v=o=>{if(o===0)return!0;const i=s.messages[o],u=s.messages[o-1];if(!i.timestamp||!u.timestamp)return!1;const b=new Date(i.timestamp).getTime(),l=new Date(u.timestamp).getTime();return b-l>Gs},p=o=>{if(!o)return"";const i=new Date(o),u=new Date,b=new Date(u.getFullYear(),u.getMonth(),u.getDate()),l=new Date(b.getTime()-864e5),m=u.getDay()===0?7:u.getDay(),A=new Date(b.getTime()-(m-1)*864e5),d=i.getHours().toString().padStart(2,"0"),r=i.getMinutes().toString().padStart(2,"0"),c=`${d}:${r}`;if(i.getTime()>=b.getTime())return c;if(i.getTime()>=l.getTime())return`昨天 ${c}`;if(i.getTime()>=A.getTime())return`${["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][i.getDay()]} ${c}`;{const C=i.getFullYear(),a=(i.getMonth()+1).toString(),P=i.getDate().toString();return C===u.getFullYear()?`${a}月${P}日 ${c}`:`${C}年${a}月${P}日 ${c}`}},g=()=>{n.value&&(n.value.scrollTop=n.value.scrollHeight)};return z(()=>s.messages,()=>{le(()=>{g()})},{deep:!0}),z(()=>s.activePanel,o=>{o&&le(()=>{g()})}),ke(()=>{g()}),f({scrollToBottom:g}),(o,i)=>(k(),$(O,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:n},[t.messages.length===0?(k(),$("div",Fs," 开始和 "+w(t.charName)+" 聊天吧~ ",1)):U("",!0),(k(!0),$(O,null,ie(t.messages,(u,b)=>(k(),$(O,{key:u.id},[v(b)?(k(),$("div",zs,w(p(u.timestamp)),1)):U("",!0),q(Ns,{msg:u,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(u.id),editingMessageId:t.editingMessageId,onSaveEdit:i[0]||(i[0]=l=>o.$emit("save-edit",l)),onCancelEdit:i[1]||(i[1]=l=>o.$emit("cancel-edit")),onToggleSelection:i[2]||(i[2]=l=>o.$emit("toggle-selection",l)),onLongPress:i[3]||(i[3]=(l,m)=>o.$emit("long-press",l,m)),onCancelLongPress:i[4]||(i[4]=l=>o.$emit("cancel-long-press")),onTouchMove:i[5]||(i[5]=l=>o.$emit("touch-move",l)),onClickMsg:i[6]||(i[6]=(l,m)=>o.$emit("click-msg",l,m)),onShowTextContent:i[7]||(i[7]=l=>o.$emit("show-text-content",l)),onShowThought:i[8]||(i[8]=l=>o.$emit("show-thought",l)),onAcceptTransfer:i[9]||(i[9]=l=>o.$emit("accept-transfer",l))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"])],64))),128))],512),t.isBlocked?(k(),$("div",js,[e("div",Os,[i[11]||(i[11]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:i[10]||(i[10]=u=>o.$emit("unblock"))},"解除拉黑")])])):U("",!0)],64))}},Ys=G(Ws,[["__scopeId","data-v-deb1a117"]]),Js={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:f}){const s=t,n=f,v=E({get:()=>s.visible,set:o=>n("update:visible",o)}),p=B("");z(()=>s.visible,o=>{o&&(p.value="")});const g=()=>{const o=p.value.trim();n("confirm",o),v.value=!1};return(o,i)=>(k(),Q(ce,{visible:v.value,"onUpdate:visible":i[2]||(i[2]=u=>v.value=u),title:"发送语音"},{footer:Y(()=>[e("button",{class:"modal-btn cancel",onClick:i[1]||(i[1]=u=>v.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:g},"发送")]),default:Y(()=>[W(e("input",{type:"text",class:"base-input","onUpdate:modelValue":i[0]||(i[0]=u=>p.value=u),placeholder:"输入语音内容..."},null,512),[[Z,p.value]])]),_:1},8,["visible"]))}},Qs={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:f}){const s=t,n=f,v=E({get:()=>s.visible,set:i=>n("update:visible",i)}),p=B(""),g=B("");z(()=>s.visible,i=>{i&&(p.value="",g.value="")});const o=()=>{const i=p.value.trim(),u=g.value.trim();i&&(n("confirm",{name:i,detail:u}),v.value=!1)};return(i,u)=>(k(),Q(ce,{visible:v.value,"onUpdate:visible":u[3]||(u[3]=b=>v.value=b),title:"发送位置"},{footer:Y(()=>[e("button",{class:"modal-btn cancel",onClick:u[2]||(u[2]=j(b=>v.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:o},"发送")]),default:Y(()=>[W(e("input",{type:"text",class:"base-input","onUpdate:modelValue":u[0]||(u[0]=b=>p.value=b),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[Z,p.value]]),W(e("input",{type:"text",class:"base-input","onUpdate:modelValue":u[1]||(u[1]=b=>g.value=b),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[Z,g.value]])]),_:1},8,["visible"]))}},Ks={class:"chat-list-container"},Xs=["onClick"],Zs=["src"],_s={class:"chat-info"},en={class:"chat-name"},tn=["disabled"],sn={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:f}){const s=t,n=f,v=K(),p=B(s.visible),g=B(new Set),o=E(()=>v.characters);z(()=>s.visible,b=>{p.value=b,b||g.value.clear()});const i=b=>{g.value.has(b)?g.value.delete(b):g.value.add(b)},u=()=>{g.value.size>0&&n("confirm",Array.from(g.value))};return(b,l)=>(k(),Q(ce,{visible:p.value,"onUpdate:visible":l[1]||(l[1]=m=>p.value=m),title:"选择聊天",onClose:l[2]||(l[2]=m=>b.$emit("close"))},{footer:Y(()=>[e("button",{class:"modal-btn cancel",onClick:l[0]||(l[0]=m=>b.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:g.value.size===0,onClick:u}," 确定 ("+w(g.value.size)+") ",9,tn)]),default:Y(()=>[e("div",Ks,[(k(!0),$(O,null,ie(o.value,m=>(k(),$("div",{key:m.id,class:"chat-item",onClick:A=>i(m.id)},[e("img",{src:m.avatar,alt:"avatar",class:"avatar"},null,8,Zs),e("div",_s,[e("div",en,w(m.name),1)]),e("div",{class:F(["checkbox",{selected:g.value.has(m.id)}])},null,2)],8,Xs))),128))])]),_:1},8,["visible"]))}},nn=G(sn,[["__scopeId","data-v-00bcf675"]]),on={class:"note-container"},an={key:0,class:"content-wrapper"},ln={class:"note-header current-header"},rn=["src"],cn={key:1,class:"avatar-placeholder"},dn={class:"character-name"},un={class:"content-body"},vn={class:"status-section"},gn={class:"status-row"},mn={class:"status-value"},fn={class:"status-row"},pn={class:"status-value"},hn={class:"status-row"},kn={class:"status-value"},bn={class:"inner-voice-section"},yn={class:"inner-voice-box"},Sn={class:"unspoken-section"},Mn={class:"unspoken-text"},wn={key:1,class:"content-wrapper history-wrapper"},$n={class:"note-header history-header"},Cn={class:"scroll-container"},Tn={class:"item-header"},xn={class:"header-left"},In=["onClick"],An={key:0,viewBox:"0 0 24 24",width:"16",height:"16",fill:"#f39c12",stroke:"#f39c12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Pn={key:1,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"#ccc","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Bn={class:"header-right"},Ln={class:"item-date"},Vn=["onClick"],Rn={class:"prop-row"},Dn={class:"prop-row"},En={class:"prop-row"},qn={class:"prop-row"},Hn={class:"prop-row"},Un={__name:"SingleCharStatus",props:{visible:{type:Boolean,default:!1},name:{type:String,default:""},avatar:{type:String,default:""},charId:{type:String,required:!0}},emits:["close"],setup(t,{emit:f}){const s=t,n=K(),v=_(),{currentInnerVoice:p,innerVoices:g}=vt(n),o=E(()=>p.value[s.charId]||{emotion:"",outfit:"",posture:"",innerVoice:"",unspokenWords:""}),i=E(()=>g.value[s.charId]||[]),u=C=>n.favorites?n.favorites.some(a=>String(a.charId)===String(s.charId)&&a.type==="thoughts"&&a.originalId===C.id):!1,b=C=>{n.toggleThoughtFavorite(s.charId,C)},l=C=>{v.showConfirm("删除心声","确定要删除这条心声记录吗？",()=>{n.deleteInnerVoice(s.charId,C.id)})},m=C=>C?new Date(C).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"."):"",A=f,d=B(!1),r=()=>{d.value=!d.value};z(()=>s.visible,C=>{C?(document.body.style.overflow="hidden",d.value=!1):document.body.style.overflow=""});const c=()=>{A("close")};return(C,a)=>t.visible?(k(),$("div",{key:0,class:"note-modal-mask",onClick:j(c,["self"])},[e("div",on,[e("div",{class:"tape-button",onClick:r}),e("div",{class:F(["note",{"history-mode":d.value}])},[a[13]||(a[13]=e("div",{class:"paper-texture"},null,-1)),d.value?(k(),$("div",wn,[e("div",$n,[a[5]||(a[5]=e("div",{class:"header-title"},"历史心声",-1)),e("button",{class:"close-btn",onClick:c},[q(X,{name:"x-mark"})])]),e("div",Cn,[(k(!0),$(O,null,ie(i.value,P=>(k(),$("div",{key:P.id,class:"history-item"},[e("div",Tn,[e("div",xn,[e("button",{class:"star-btn",onClick:j(L=>b(P),["stop"])},[u(P)?(k(),$("svg",An,[...a[6]||(a[6]=[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"},null,-1)])])):(k(),$("svg",Pn,[...a[7]||(a[7]=[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"},null,-1)])]))],8,In),e("span",null,w(P.title),1)]),e("div",Bn,[e("span",Ln,w(m(P.timestamp)),1),e("button",{class:"delete-btn",onClick:j(L=>l(P),["stop"])},[q(X,{name:"x-mark"})],8,Vn)])]),e("div",Rn,[a[8]||(a[8]=e("span",{class:"prop-label"},"情绪：",-1)),ae(w(P.emotion),1)]),e("div",Dn,[a[9]||(a[9]=e("span",{class:"prop-label"},"穿着：",-1)),ae(w(P.outfit),1)]),e("div",En,[a[10]||(a[10]=e("span",{class:"prop-label"},"姿态：",-1)),ae(w(P.posture),1)]),e("div",qn,[a[11]||(a[11]=e("span",{class:"prop-label"},"内心独白：",-1)),ae(w(P.innerVoice),1)]),e("div",Hn,[a[12]||(a[12]=e("span",{class:"prop-label"},"没说出口的话：",-1)),ae(w(P.unspokenWords),1)])]))),128))])])):(k(),$("div",an,[e("div",ln,[t.avatar?(k(),$("img",{key:0,src:t.avatar,class:"avatar-img",alt:"avatar"},null,8,rn)):(k(),$("div",cn,w(t.name?t.name.charAt(0):"?"),1)),e("div",dn,w(t.name),1),e("button",{class:"close-btn",onClick:c},[q(X,{name:"x-mark"})])]),e("div",un,[e("div",vn,[e("div",gn,[a[0]||(a[0]=e("span",{class:"status-label"},"情绪",-1)),e("span",mn,w(o.value.emotion||"无"),1)]),e("div",fn,[a[1]||(a[1]=e("span",{class:"status-label"},"穿着",-1)),e("span",pn,w(o.value.outfit||"无"),1)]),e("div",hn,[a[2]||(a[2]=e("span",{class:"status-label"},"姿态",-1)),e("span",kn,w(o.value.posture||"无"),1)])]),e("div",bn,[a[3]||(a[3]=e("div",{class:"section-title"},"Inner Voice",-1)),e("div",yn,[e("p",null,w(o.value.innerVoice||"（没有内心独白）"),1)])]),e("div",Sn,[a[4]||(a[4]=e("div",{class:"unspoken-title"},"没说出口的话",-1)),e("div",Mn,w(o.value.unspokenWords||"（没有想说的话）"),1)])])])),a[14]||(a[14]=e("div",{class:"torn-edge"},null,-1))],2)])])):U("",!0)}},Nn=G(Un,[["__scopeId","data-v-8a1bd83a"]]),Fn={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const f=t,s=he(),{t:n}=ee(),v=K(),p=_(),g=gt(),o=mt(),i=B(null),u=B(null),b=B(null),l=B(!1),m=B({visible:!1,messageId:null,targetEl:null}),A=B(!1),d=B(!1),r=B(!1),c=B(!1);B("");const C=B(!1),a=E(()=>v.getCharacter(f.charId)),P=E(()=>{var T;return((T=a.value)==null?void 0:T.isBlocked)||!1}),L=E(()=>{var T,M;return((T=a.value)==null?void 0:T.nickname)||((M=a.value)==null?void 0:M.name)||n("chat.unknownCharacter")}),R=E(()=>{var T;return((T=a.value)==null?void 0:T.name)||n("chat.unknownCharacter")}),I=E(()=>{var T;return(T=a.value)==null?void 0:T.avatar}),y=E(()=>{var T;return((T=a.value)==null?void 0:T.status)||{}}),h=E(()=>{var T;return((T=a.value)==null?void 0:T.chatBackground)||""}),S=E(()=>{const T=a.value;if(!T||!T.userPersona)return"";const M=v.userPersonas.find(V=>V.id===T.userPersona);return(M==null?void 0:M.avatar)||""}),D=E(()=>v.messages[f.charId]||[]),H=E(()=>{var T;return((T=a.value)==null?void 0:T.bubbleSettings)||{}}),{isSelectionMode:N,selectedMessageIds:te,isForwarding:se,enterSelectionMode:J,exitSelectionMode:ne,toggleMessageSelection:de,handleBatchAction:Ce,handleConfirmForward:Te}=ht(ve(f,"charId")),{isTyping:xe,triggerAiResponse:be}=kt(ve(f,"charId"),g),{inputText:ue,quotingMessage:ge,sendMessage:Ie,sendSticker:Ae,sendVoiceMessage:Pe,handleSendImage:Be,confirmSendLocation:Le,sendTransfer:Ve}=yt(v,ve(f,"charId"),p,b),{editingMessageId:ye,handleEditMessage:Re,handleSaveEdit:De,updateInputText:Ee}=bt(v,ve(f,"charId"),ue),{startLongPress:qe,cancelLongPress:He,handleTouchMove:Ue,wasClickAfterLongPress:Ne}=St(m),Fe=E(()=>{const T=H.value,M={fontSize:T.fontSize?`${T.fontSize}px`:"14px"};if(T.css){const V={};return T.css.split(";").forEach(oe=>{const me=oe.split(":");if(me.length>=2){const Se=me[0].trim(),Me=me.slice(1).join(":").trim();Se&&Me&&(V[Se]=Me)}}),{...M,...V}}return M});z(l,T=>{T&&(s.push({name:"single-chat-settings",params:{id:f.charId}}),l.value=!1)}),z(()=>{var T;return(T=v.messages[f.charId])==null?void 0:T.length},()=>{v.clearUnreadCount(f.charId)}),ke(()=>{v.clearUnreadCount(f.charId)});const ze=()=>{a.value&&(a.value.isBlocked=!1,v.messages[f.charId]&&v.messages[f.charId].forEach(T=>{T.blocked&&(T.blocked=!1)}),v.saveData(),p.showToast(n("chat.toast.unblocked")))},je=T=>{const M=T.target;M.closest(".modal-overlay.active")||(b.value&&!M.closest(".chat-footer")&&(b.value=null),N.value&&!M.closest(".message")&&!M.closest(".chat-action-row")&&!M.closest(".message-checkbox")&&!M.closest(".message-menu")&&ne(),m.value.visible&&!M.closest(".message-menu")&&(m.value.visible=!1))},Oe=(T,M)=>{if(Ne()){T.preventDefault(),T.stopPropagation();return}N.value&&de(M)},Ge=T=>{const M=D.value.find(V=>V.id===T);M&&(ge.value=M)},We=()=>{d.value=!0},Ye=T=>{Pe(T),d.value=!1},Je=()=>{b.value=null,A.value=!0},Qe=()=>{r.value=!0},Ke=({name:T,detail:M})=>{Le(T,M),r.value=!1},Xe=()=>{v.startVideoCall(f.charId,"user")},Ze=()=>{c.value=!0},_e=()=>{C.value=!0},et=({amount:T,note:M})=>{o.consume(T,`转账 - 转给 ${L.value}`)?(Ve(T,M),C.value=!1):p.showToast("余额不足","error")},tt=T=>{const M=D.value.find(oe=>oe.id===T),V=(M==null?void 0:M.status)==="pending"||(M==null?void 0:M.status)===void 0;if(M&&M.type==="transfer"&&V){if(M.sender!=="user"){const oe=parseFloat(M.content);o.income(oe,`转账 - 来自 ${L.value} `)?v.acceptTransfer(f.charId,T):p.showToast("收款失败","error")}}else v.acceptTransfer(f.charId,T)};return(T,M)=>(k(),$("div",{class:F(["chat-room active",{"selection-mode":x(N)}]),onClick:je,ref_key:"chatRoomRef",ref:u},[e("div",{class:"chat-bg",style:re(h.value?{backgroundImage:`url(${h.value})`}:{})},null,4),q(Pt,{charId:f.charId,charName:L.value,charStatus:y.value,isTyping:x(xe),onTriggerAi:x(be),onOpenSettings:M[0]||(M[0]=V=>l.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),q(Ys,{ref_key:"messageListRef",ref:i,messages:D.value,charName:L.value,charAvatar:I.value,userAvatar:S.value,bubbleStyle:Fe.value,isSelectionMode:x(N),selectedMessageIds:x(te),isBlocked:P.value,editingMessageId:x(ye),activePanel:b.value,onSaveEdit:x(De),onCancelEdit:M[1]||(M[1]=V=>ye.value=null),onToggleSelection:x(de),onLongPress:x(qe),onCancelLongPress:x(He),onTouchMove:x(Ue),onClickMsg:Oe,onUnblock:ze,onShowThought:Ze,onAcceptTransfer:tt},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),x(N)?U("",!0):(k(),Q(as,{key:0,modelValue:x(ue),"onUpdate:modelValue":M[2]||(M[2]=V=>ft(ue)?ue.value=V:null),activePanel:b.value,"onUpdate:activePanel":M[3]||(M[3]=V=>b.value=V),charId:f.charId,quotingMessage:x(ge),onCancelQuote:M[4]||(M[4]=V=>ge.value=null),onSendMessage:x(Ie),onSendSticker:x(Ae),onTriggerVoice:We,onTriggerImage:Je,onTriggerVideo:Xe,onTriggerLocation:Qe,onTriggerTransfer:_e},null,8,["modelValue","activePanel","charId","quotingMessage","onSendMessage","onSendSticker"])),x(N)?(k(),Q(us,{key:1,onAction:x(Ce),onCancel:x(ne)},null,8,["onAction","onCancel"])):U("",!0),q(Js,{visible:d.value,"onUpdate:visible":M[5]||(M[5]=V=>d.value=V),onConfirm:Ye},null,8,["visible"]),q(we,{visible:A.value,"onUpdate:visible":M[6]||(M[6]=V=>A.value=V),onSendImage:x(Be)},null,8,["visible","onSendImage"]),q(Qs,{visible:r.value,"onUpdate:visible":M[7]||(M[7]=V=>r.value=V),onConfirm:Ke},null,8,["visible"]),q(rs,{visible:m.value.visible,targetEl:m.value.targetEl,messageId:m.value.messageId,charId:f.charId,isSelectionMode:x(N),selectedMessageIds:x(te),onClose:M[8]||(M[8]=V=>m.value.visible=!1),onEnterSelectionMode:x(J),onTriggerAiResponse:x(be),"onUpdate:inputText":x(Ee),onQuoteMessage:Ge,onEditMessage:x(Re)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),q(nn,{visible:x(se),onClose:M[9]||(M[9]=V=>se.value=!1),onConfirm:x(Te)},null,8,["visible","onConfirm"]),q(Nn,{visible:c.value,name:R.value,avatar:I.value,charId:f.charId,onClose:M[10]||(M[10]=V=>c.value=!1)},null,8,["visible","name","avatar","charId"]),q(pt,{visible:C.value,"onUpdate:visible":M[11]||(M[11]=V=>C.value=V),targetName:L.value,targetAvatar:I.value,onConfirm:et},null,8,["visible","targetName","targetAvatar"])],2))}},On=G(Fn,[["__scopeId","data-v-47e2e1dc"]]);export{On as default};
