import{m as Q,E as We,r as w,G as Qe,u as Ke,i as ce,q as J,D as se,_ as F,k as K,a as S,o as h,e,f as q,z as M,y as m,h as de,w as z,v as N,x as H,M as Z,c as E,b as U,F as O,A as ne,n as D,H as re,C as Y,I as he,t as j,d as W,S as te,J as Xe,L as Ye,N as Je,B as X,s as be,O as Ze,P as ee,Q as _e}from"./index-BhBAuxlH.js";function et(t,u){const i=Q(),s=We(),r=ce(),o=Ke(),n=w(!1);return{isTyping:n,triggerAiResponse:async()=>{console.log("[useAiResponder] triggerAiResponse triggered"),n.value=!0;try{const v=i.getCharacter(t.value),a=await u.getChatCompletion(t.value);if(a){i.messages[t.value]||(i.messages[t.value]=[]);const d=(v==null?void 0:v.isBlocked)||!1;let g=a.split("|||"),x=[];const f=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g;g.forEach(b=>{const l=b.split(f).map(p=>p.trim()).filter(p=>p);x.push(...l)});for(let b=0;b<x.length;b++){const l=x[b];b>0&&await new Promise(k=>setTimeout(k,1e3+Math.random()*1e3));let{type:p,content:L}=Qe(l),P={};if(p==="sticker"){const k=L,V=i.stickers.find(I=>I.name===k);V?(L=V.url,P.name=k):(p="text",L=`[表情包：${k}]`)}let B=!1;p==="image"&&!L.startsWith("http")&&!L.startsWith("data:")&&(B=!0),i.messages[t.value].push({id:Date.now().toString()+b,sender:"char",type:p,content:L,isTextGenerated:B,...P,time:Date.now(),blocked:d}),i.saveData(),o.path!==`/chat/room/${t.value}`&&(i.incrementUnreadCount(t.value),s.triggerNotification(v.nickname||v.name,p==="text"?L:`[${p}]`,v.avatar,()=>{r.push(`/chat/room/${t.value}`)},3e3,p))}}}catch(v){console.error("[useAiResponder] triggerAiResponse failed:",v)}finally{n.value=!1}}}}function tt(t){const u=Q(),i=J(),s=w(!1),r=w(new Set),o=w(!1),n=g=>{console.log("[useMessageSelection] enterSelectionMode triggered"),s.value=!0,r.value.clear(),g&&r.value.add(g)},c=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),s.value=!1,r.value.clear()};return{isSelectionMode:s,selectedMessageIds:r,isForwarding:o,enterSelectionMode:n,exitSelectionMode:c,toggleMessageSelection:g=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${g}`),r.value.has(g)?r.value.delete(g):r.value.add(g)},handleBatchAction:g=>{if(console.log(`[useMessageSelection] handleBatchAction: ${g}`),r.value.size===0)return;const x=u.messages[t.value];g==="forward"?o.value=!0:g==="delete"?i.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),u.messages[t.value]=x.filter(f=>!r.value.has(f.id)),u.saveData(),c()}):g==="favorite"&&(u.favorites||(u.favorites=[]),x.forEach(f=>{r.value.has(f.id)&&(u.favorites.some(b=>b.id===f.id)||u.favorites.push(f))}),u.saveData(),i.showToast("已收藏","success"),c())},handleConfirmForward:g=>{console.log("[useMessageSelection] handleConfirmForward triggered"),o.value=!1;const f=(u.messages[t.value]||[]).filter(b=>r.value.has(b.id));f.length!==0&&(g.forEach(b=>{u.messages[b]||(u.messages[b]=[]),f.forEach(l=>{const p={...l,id:Date.now().toString()+Math.random()};u.messages[b].push(p)})}),u.saveData(),i.showToast(`已转发 ${f.length} 条消息`),c())}}}function st(t,u,i){const s=w(null);return{editingMessageId:s,handleEditMessage:c=>{console.log("[useMessageEditing] handleEditMessage for msgId:",c),s.value=c},handleSaveEdit:({msgId:c,newContent:v})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",c);const d=t.messages[u.value].find(g=>g.id===c);d&&(d.content=v,t.saveData()),s.value=null},updateInputText:c=>{console.log("[useMessageEditing] updateInputText called"),i&&(i.value=c,se(()=>{const v=document.querySelector(".chat-input");v&&v.focus()}))}}}function nt(t,u,i,s){const r=w(""),o=w(null),n=(f,b,l={})=>{console.log(`[useMessageSender] sendMsg called with type: ${f}`);const p={...l};o.value&&(p.quote={id:o.value.id,sender:o.value.sender,content:o.value.content}),t.messages[u.value]||(t.messages[u.value]=[]),t.messages[u.value].push({id:Date.now().toString()+Math.random(),sender:"user",type:f,content:b,time:Date.now(),...p}),t.saveData(),s&&(s.value=null),o.value=null};return{inputText:r,quotingMessage:o,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const f=r.value.trim();f&&(n("text",f),r.value="")},sendMsg:n,sendSticker:f=>{console.log("[useMessageSender] sendSticker triggered"),n("sticker",f.url,{name:f.name})},sendVoiceMessage:f=>{console.log("[useMessageSender] sendVoiceMessage triggered"),f&&n("voice",f)},handleSendImage:f=>{console.log("[useMessageSender] handleSendImage triggered"),f.isTextGenerated?n("image",f.description,{isTextGenerated:!0}):(f.type==="base64"||f.type==="url")&&n("image",f.content)},confirmSendLocation:(f,b)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!f){i.showToast("请输入位置名称","info");return}n("location",f,{detail:b})},sendTransfer:()=>{console.log("[useMessageSender] sendTransfer triggered"),n("transfer","88.88")}}}function ot(t){const u=w(null),i=w(!1),s=w({x:0,y:0}),r=(a,d)=>{console.log("[useMessageInteraction] showMenu triggered"),a.preventDefault();const g=a.target.closest(".msg-bubble, .system-message-wrapper");g&&(t.value={visible:!0,messageId:d,targetEl:g})};return{startLongPress:(a,d)=>{console.log("[useMessageInteraction] startLongPress triggered"),a.stopPropagation(),i.value=!1,clearTimeout(u.value),a.type.startsWith("touch")&&(s.value={x:a.touches[0].clientX,y:a.touches[0].clientY}),u.value=setTimeout(()=>{i.value=!0,r(a,d)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(u.value)},handleTouchMove:a=>{console.log("[useMessageInteraction] handleTouchMove triggered");const d=a.touches[0],g=Math.abs(d.clientX-s.value.x),x=Math.abs(d.clientY-s.value.y);(g>10||x>10)&&clearTimeout(u.value)},wasClickAfterLongPress:()=>i.value?(i.value=!1,!0):!1}}const at={class:"chat-room-header"},lt={class:"left-icons"},it={class:"center-container"},rt={class:"header-title-area"},ct={key:0,class:"chat-room-title"},dt={key:1,class:"typing-indicator"},ut={class:"right-icons"},vt={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},gt=["placeholder"],mt=["placeholder"],ft={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:u}){const i=t,{t:s}=K(),r=ce(),o=Q(),n=J(),c=w(!1),v=w(""),a=w(""),d=()=>{r.options.history.state.back?r.back():r.push("/chat")},g=()=>{const b=i.charStatus||{};v.value=b.icon||"✨",a.value=b.text||"",c.value=!0},x=()=>{const b=v.value.trim()||"✨",l=a.value.trim(),p=o.getCharacter(i.charId);p&&(l?p.status={icon:b,text:l}:p.status=null,o.saveData(),n.showToast(s("saveSuccess"))),c.value=!1},f=()=>{r.push({name:"memory-bank",params:{charId:i.charId}})};return(b,l)=>(h(),S("div",at,[e("div",lt,[e("div",{class:"btn-icon back-btn",onClick:d},[...l[6]||(l[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polyline",{points:"15 18 9 12 15 6"})],-1)])]),e("div",{class:"btn-icon bell-btn",onClick:l[0]||(l[0]=p=>b.$emit("trigger-ai")),ref:"bellBtn"},[...l[7]||(l[7]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)]),e("div",it,[e("div",rt,[t.isTyping?(h(),S("div",dt,[e("span",null,M(m(s)("chat.singleChat.typing")),1),l[8]||(l[8]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(h(),S("div",ct,M(t.charName),1))]),e("div",{class:"chat-room-status",onClick:g},[e("span",null,M(t.charStatus.icon||"✨"),1),e("span",null,M(t.charStatus.text||m(s)("chat.singleChat.addStatus")),1)])]),e("div",ut,[e("div",{class:"btn-icon memory-btn",onClick:f},[...l[9]||(l[9]=[de('<svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-c4e37645><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" data-v-c4e37645></path><polyline points="14 2 14 8 20 8" data-v-c4e37645></polyline><line x1="16" y1="13" x2="8" y2="13" data-v-c4e37645></line><line x1="16" y1="17" x2="8" y2="17" data-v-c4e37645></line><polyline points="10 9 9 9 8 9" data-v-c4e37645></polyline></svg>',1)])]),e("div",{class:"btn-icon more-btn",onClick:l[1]||(l[1]=p=>b.$emit("open-settings"))},[...l[10]||(l[10]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])]),q(Z,{visible:c.value,"onUpdate:visible":l[5]||(l[5]=p=>c.value=p),title:m(s)("chat.singleChat.setStatus")},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:l[4]||(l[4]=p=>c.value=!1)},M(m(s)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:x},M(m(s)("confirm")),1)]),default:z(()=>[e("div",vt,[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[2]||(l[2]=p=>v.value=p),placeholder:m(s)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,gt),[[H,v.value]]),N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[3]||(l[3]=p=>a.value=p),placeholder:m(s)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,mt),[[H,a.value]])])]),_:1},8,["visible","title"])]))}},pt=F(ft,[["__scopeId","data-v-c4e37645"]]),ht={key:0,class:"chat-panel",id:"stickerPanel"},bt={class:"sticker-panel-header"},kt={class:"sticker-groups"},yt=["onClick"],St={class:"sticker-panel-content"},Mt=["onClick"],Ct=["src","alt"],$t={class:"sticker-panel-footer"},wt={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:u}){const i=u,s=Q(),r=J(),o=w("默认"),n=w(!1),c=w(new Set),v=w(!1),a=w(!1),d=w(""),g=E(()=>["默认",...new Set(s.stickers.map(T=>T.group).filter(Boolean).filter(T=>T!=="默认"))]),x=E(()=>s.stickers.filter(I=>I.group===o.value)),f=I=>{n.value?c.value.has(I.id)?c.value.delete(I.id):c.value.add(I.id):i("send-sticker",I)},b=({group:I,stickers:T})=>{const C=T.map(R=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:R.url,name:R.name,group:I}));s.stickers.push(...C),s.saveData(),r.showToast(`成功导入 ${C.length} 个表情包`,"success")},l=()=>{v.value=!0},p=()=>{c.value.size>0&&(a.value=!0)},L=()=>{n.value=!n.value,c.value.clear()},P=()=>{const I=x.value;I.every(C=>c.value.has(C.id))?I.forEach(C=>c.value.delete(C.id)):I.forEach(C=>c.value.add(C.id))},B=()=>{c.value.size!==0&&r.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{s.stickers=s.stickers.filter(I=>!c.value.has(I.id)),s.saveData(),c.value.clear()})},k=()=>{const I=d.value.trim();if(!I)return r.showToast("请输入目标分组","info");s.stickers.forEach(T=>{c.value.has(T.id)&&(T.group=I)}),s.saveData(),a.value=!1,d.value="",c.value.clear(),n.value=!1,o.value=I},V=()=>{if(c.value.size===0)return;const I=s.stickers.filter(G=>c.value.has(G.id)).map(G=>`${G.name} ${G.url}`).join(`
`),T=new Blob([I],{type:"text/plain"}),C=URL.createObjectURL(T),R=document.createElement("a");R.href=C,R.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(C),c.value.clear(),n.value=!1};return(I,T)=>(h(),S("div",null,[t.visible?(h(),S("div",ht,[e("div",bt,[e("div",kt,[(h(!0),S(O,null,ne(g.value,C=>(h(),S("div",{class:D(["sticker-group-tab",{active:o.value===C}]),key:C,onClick:R=>o.value=C},M(C),11,yt))),128))])]),e("div",St,[(h(!0),S(O,null,ne(x.value,C=>(h(),S("div",{class:D(["sticker-item",{selected:c.value.has(C.id),"manage-mode":n.value}]),key:C.id,onClick:R=>f(C)},[e("img",{src:C.url,alt:C.name},null,8,Ct),e("span",null,M(C.name),1)],10,Mt))),128))]),e("div",$t,[N(e("div",{class:"sticker-add-btn",onClick:l},"＋",512),[[re,!n.value]]),e("div",{class:"sticker-manage-btn",style:Y({color:n.value?"var(--danger-color)":"#576B95"}),onClick:L},M(n.value?"完成":"管理"),5)]),e("div",{class:D(["manage-bar",{active:n.value}])},[e("button",{class:"btn btn-secondary",onClick:l},"导入"),e("button",{class:"btn btn-secondary",onClick:P},"全选"),e("button",{class:"btn btn-secondary",onClick:p},"移动"),e("button",{class:"btn btn-secondary",onClick:V},"导出"),e("button",{class:"btn btn-danger",onClick:B},"删除")],2)])):U("",!0),q(he,{visible:v.value,"onUpdate:visible":T[0]||(T[0]=C=>v.value=C),type:"sticker-import",onImportSticker:b},null,8,["visible"]),q(Z,{visible:a.value,"onUpdate:visible":T[3]||(T[3]=C=>a.value=C),title:"移动到分组"},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:T[2]||(T[2]=C=>a.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:k},"确定")]),default:z(()=>[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":T[1]||(T[1]=C=>d.value=C),placeholder:"输入目标分组名称"},null,512),[[H,d.value]])]),_:1},8,["visible"])]))}},xt=F(wt,[["__scopeId","data-v-f9fb1def"]]),It={class:"chat-panel",id:"morePanel"},Tt={class:"more-panel-content"},Bt={class:"more-label"},Pt={class:"more-label"},At={class:"more-label"},Lt={class:"more-label"},Et={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:u}=K();return(i,s)=>(h(),S("div",It,[e("div",Tt,[e("div",{class:"more-item",onClick:s[0]||(s[0]=r=>i.$emit("trigger-image-upload"))},[s[4]||(s[4]=de('<div class="more-icon" data-v-731b24d5><svg class="svg-icon" viewBox="0 0 24 24" data-v-731b24d5><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-731b24d5></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-731b24d5></circle><polyline points="21 15 16 10 5 21" data-v-731b24d5></polyline></svg></div>',1)),e("span",Bt,M(m(u)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:s[1]||(s[1]=r=>i.$emit("start-video-call"))},[s[5]||(s[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Pt,M(m(u)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:s[2]||(s[2]=r=>i.$emit("send-location"))},[s[6]||(s[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",At,M(m(u)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:s[3]||(s[3]=r=>i.$emit("send-transfer"))},[s[7]||(s[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),e("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})])],-1)),e("span",Lt,M(m(u)("chat.morePanel.transfer")),1)])])]))}},Vt=F(Et,[["__scopeId","data-v-731b24d5"]]),Rt={class:"chat-footer"},qt={key:0,class:"quote-preview"},Ut={class:"quote-content"},Dt={class:"quote-sender"},Nt={class:"quote-text"},zt={class:"chat-input-row"},jt={class:"chat-input-wrapper"},Ft=["value"],Gt={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"21px",height:"21px",position:"relative",top:"1px",left:"-1px"}},Ot={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:u}){const{t:i}=K(),s=t,r=u,o=w(s.activePanel);j(()=>s.activePanel,a=>{o.value=a}),j(o,a=>{r("update:activePanel",a)});const n=a=>{o.value===a?o.value=null:o.value=a},c=()=>{s.modelValue.trim()&&r("send-message")},v=a=>{r("send-sticker",a),o.value=null};return(a,d)=>(h(),S("div",Rt,[t.quotingMessage?(h(),S("div",qt,[e("div",Ut,[e("span",Dt,M(t.quotingMessage.sender==="user"?m(i)("chat.self"):m(i)("chat.other"))+": ",1),e("span",Nt,M(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:d[0]||(d[0]=g=>a.$emit("cancel-quote"))},[...d[9]||(d[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):U("",!0),e("div",zt,[e("div",{class:"chat-tool-btn",onClick:d[1]||(d[1]=g=>a.$emit("trigger-voice"))},[q(te,{name:"voice-circle",class:"svg-icon"})]),e("div",jt,[e("input",{type:"text",class:"chat-input",value:t.modelValue,onInput:d[2]||(d[2]=g=>a.$emit("update:modelValue",g.target.value)),onKeypress:Xe(c,["enter"]),id:"messageInput",autocomplete:"new-password"},null,40,Ft)]),e("div",{class:"chat-tool-btn",onClick:d[3]||(d[3]=g=>n("sticker"))},[q(te,{name:"sticker",class:"svg-icon"})]),t.modelValue?(h(),S("div",{key:1,class:"send-btn-icon",onClick:c},[(h(),S("svg",Gt,[...d[10]||(d[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(h(),S("div",{key:0,class:"chat-tool-btn",onClick:d[4]||(d[4]=g=>n("more"))},[q(te,{name:"plus-circle",class:"svg-icon"})]))]),q(xt,{visible:o.value==="sticker",onSendSticker:v},null,8,["visible"]),o.value==="more"?(h(),W(Vt,{key:1,onTriggerImageUpload:d[5]||(d[5]=g=>a.$emit("trigger-image")),onStartVideoCall:d[6]||(d[6]=g=>a.$emit("trigger-video")),onSendLocation:d[7]||(d[7]=g=>a.$emit("trigger-location")),onSendTransfer:d[8]||(d[8]=g=>a.$emit("trigger-transfer"))})):U("",!0)]))}},Ht=F(Ot,[["__scopeId","data-v-5b0f6609"]]),Wt={class:"menu-grid"},Qt={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:u}){const i=t,s=u,r=Ye("phoneScreenRef"),{t:o}=K(),n=Q(),c=J(),v=w(null),a=w({}),d=w(0),g=w("top");j(()=>i.visible,async b=>{b&&i.targetEl&&(await se(),x())});const x=()=>{const b=v.value;if(!b)return;const l=i.targetEl.getBoundingClientRect(),p=b.offsetWidth,L=b.offsetHeight,P=8,B=r.value,k=B?B.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};g.value="top";let V=l.top-L-P;V<k.top+P&&(g.value="bottom",V=l.bottom+P);const I=l.left+l.width/2;let T=I-p/2;T<k.left+P&&(T=k.left+P),T+p>k.left+k.width-P&&(T=k.left+k.width-p-P);let C=I-T;const R=12,G=R/2+5,oe=p-R/2-5;C=Math.max(G,Math.min(C,oe)),a.value={top:`${V}px`,left:`${T}px`},d.value=C},f=b=>{const l=i.messageId;if(!l)return;const p=n.messages[i.charId],L=p.findIndex(k=>k.id===l),P=p[L],B={copy:()=>{P.content&&(navigator.clipboard.writeText(P.content),c.showToast(o("chat.messageMenu.toast.copied")))},favorite:()=>{n.favorites||(n.favorites=[]),n.favorites.some(k=>k.id===P.id)?c.showToast(o("chat.messageMenu.toast.alreadyFavorited")):(n.favorites.push(P),n.saveData(),c.showToast(o("chat.messageMenu.toast.favorited")))},delete:()=>{c.showConfirm(o("chat.messageMenu.confirmDelete"),o("chat.messageMenu.confirmDeleteMsg"),()=>{n.messages[i.charId].splice(L,1),n.saveData()})},revoke:()=>{P&&(P.type="revoked",n.saveData(),c.showToast(o("chat.messageMenu.toast.revoked")))},select:()=>s("enter-selection-mode",l),quote:()=>s("quote-message",l),retry:()=>{P.sender!=="user"?(n.messages[i.charId].splice(L,1),n.saveData(),s("trigger-ai-response")):c.showToast(o("chat.messageMenu.toast.retryAiOnly"),"info")},edit:()=>{P.type==="text"?s("edit-message",l):c.showToast(o("chat.messageMenu.toast.editTextOnly"),"info")}};B[b]&&B[b](),s("close")};return(b,l)=>t.visible?(h(),S("div",{key:0,ref_key:"menuRef",ref:v,class:D(["message-menu",{"menu-top":g.value==="top","menu-bottom":g.value==="bottom"}]),style:Y(a.value)},[e("div",Wt,[e("div",{class:"menu-item",onClick:l[0]||(l[0]=p=>f("copy"))},M(m(o)("copy")),1),e("div",{class:"menu-item",onClick:l[1]||(l[1]=p=>f("favorite"))},M(m(o)("favorite")),1),e("div",{class:"menu-item",onClick:l[2]||(l[2]=p=>f("delete"))},M(m(o)("delete")),1),e("div",{class:"menu-item",onClick:l[3]||(l[3]=p=>f("revoke"))},M(m(o)("revoke")),1),e("div",{class:"menu-item",onClick:l[4]||(l[4]=p=>f("select"))},M(m(o)("select")),1),e("div",{class:"menu-item",onClick:l[5]||(l[5]=p=>f("quote"))},M(m(o)("quote")),1),e("div",{class:"menu-item",onClick:l[6]||(l[6]=p=>f("retry"))},M(m(o)("retry")),1),e("div",{class:"menu-item",onClick:l[7]||(l[7]=p=>f("edit"))},M(m(o)("edit")),1)]),e("div",{class:"menu-arrow",style:Y({left:d.value+"px"})},null,4)],6)):U("",!0)}},Kt=F(Qt,[["__scopeId","data-v-9d6ff2c4"]]),Xt={class:"chat-action-row"},Yt={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:u}=K();return(i,s)=>(h(),S("div",Xt,[e("div",{class:"action-btn",onClick:s[0]||(s[0]=r=>i.$emit("action","favorite"))},[s[4]||(s[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,M(m(u)("favorite")),1)]),e("div",{class:"action-btn",onClick:s[1]||(s[1]=r=>i.$emit("action","forward"))},[s[5]||(s[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,M(m(u)("forward")),1)]),e("div",{class:"action-btn",onClick:s[2]||(s[2]=r=>i.$emit("action","delete"))},[s[6]||(s[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,M(m(u)("delete")),1)]),e("div",{class:"action-btn",onClick:s[3]||(s[3]=r=>i.$emit("cancel"))},[s[7]||(s[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,M(m(u)("done")),1)])]))}},Jt=F(Yt,[["__scopeId","data-v-be1a592f"]]),Zt={class:"msg-avatar"},_t=["src"],es={class:"msg-content-wrapper"},ts={class:"msg-bubble-box"},ss={key:0,class:"quote-in-bubble"},ns={class:"quote-in-bubble-sender"},os={class:"quote-in-bubble-text"},as={key:1,class:"edit-view"},ls={key:0},is={class:"description-placeholder"},rs=["src"],cs={key:2,class:"sticker-msg"},ds=["src"],us={key:3,class:"voice-msg-wrapper"},vs={class:"voice-msg"},gs={key:4,class:"location-msg"},ms={class:"location-text"},fs={class:"msg-title"},ps={key:5,class:"transfer-msg"},hs={class:"transfer-content"},bs={class:"transfer-info"},ks={class:"transfer-amount"},ys={class:"transfer-desc"},Ss={key:6,class:"call-summary-msg"},Ms={key:0,class:"blocked-icon"},Cs={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg"],setup(t,{emit:u}){const i=t,s=u,r=Je(),o=w(!1),n=w(!1),c=w(""),v=E(()=>i.editingMessageId===i.msg.id),a=E(()=>{const B=i.msg.type;return{"no-style":["image","sticker","location","transfer"].includes(B),"has-location":B==="location","has-transfer":B==="transfer"}});j(v,B=>{B&&(c.value=i.msg.content)});const d=B=>{s("long-press",B,i.msg.id)},g=()=>{s("cancel-long-press")},x=B=>{s("touch-move",B)},f=B=>{i.msg.type==="voice"&&b(),i.msg.type!=="image"&&s("click-msg",B,i.msg.id)},b=()=>{o.value=!o.value},l=()=>{n.value=!n.value},p=()=>{c.value.trim()&&s("save-edit",{msgId:i.msg.id,newContent:c.value})},L=()=>{s("cancel-edit")},P=()=>i.msg.type==="notification"?i.msg.content:i.msg.type==="revoked"?`"${i.msg.sender==="user"?"你":i.charName}" 撤回了一条消息`:"";return(B,k)=>(h(),S("div",{class:D(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[e("div",{class:D(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:k[0]||(k[0]=X(V=>B.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),t.msg.type==="revoked"||t.msg.type==="notification"?(h(),S("div",{key:0,class:"system-message-wrapper",onMousedown:d,onMouseup:g,onMouseleave:g,onTouchstart:d,onTouchend:g,onTouchmove:x,onClick:X(f,["prevent"])},[e("div",{class:"system-message-text",onClick:k[1]||(k[1]=X(V=>!t.isSelectionMode&&l(),["stop"]))},M(P()),1),t.msg.type==="revoked"?N((h(),S("div",{key:0,class:"revoked-content"},M(t.msg.sender==="user"?"我":t.charName)+"："+M(t.msg.content),513)),[[re,n.value]]):U("",!0)],32)):(h(),S(O,{key:1},[e("div",Zt,[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(h(),S("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,_t)):(h(),S("div",{key:1,class:D(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",es,[e("div",ts,[e("div",{class:D(["msg-bubble",a.value]),style:Y(t.bubbleStyle),onMousedown:d,onMouseup:g,onMouseleave:g,onTouchstart:d,onTouchend:g,onTouchmove:x,onClick:X(f,["prevent"])},[t.msg.quote?(h(),S("div",ss,[e("div",ns,M(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",os,M(t.msg.quote.content),1)])):U("",!0),v.value?(h(),S("div",as,[N(e("textarea",{"onUpdate:modelValue":k[2]||(k[2]=V=>c.value=V),class:"edit-textarea",rows:"3"},null,512),[[H,c.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:L,class:"edit-btn cancel"},"取消"),e("button",{onClick:p,class:"edit-btn save"},"保存")])])):(h(),S(O,{key:2},[t.msg.type==="text"?(h(),S("div",ls,M(t.msg.content),1)):t.msg.type==="image"?(h(),S(O,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(h(),S("div",{key:0,class:"text-generated-image-container",onClick:k[3]||(k[3]=V=>m(r).preview(t.msg))},[e("div",is,M(t.msg.content),1)])):(h(),S("div",{key:1,class:"image-msg",onClick:k[4]||(k[4]=V=>m(r).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,rs)]))],64)):t.msg.type==="sticker"?(h(),S("div",cs,[e("img",{src:t.msg.content,alt:"表情包"},null,8,ds)])):t.msg.type==="voice"?(h(),S("div",us,[e("div",vs,[q(te,{name:"voice-wave",class:D(["voice-icon-svg",{playing:o.value}])},null,8,["class"]),e("span",null,M(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(h(),S("div",gs,[e("div",ms,[e("div",fs,M(t.msg.content||"位置信息"),1),k[5]||(k[5]=e("div",{class:"msg-desc"},"详细地址",-1))]),k[6]||(k[6]=de('<div class="location-map" data-v-8cb932da><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-8cb932da><div class="location-pin" data-v-8cb932da><svg viewBox="0 0 24 24" fill="currentColor" data-v-8cb932da><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-8cb932da></path></svg></div></div>',1))])):t.msg.type==="transfer"?(h(),S("div",ps,[e("div",hs,[k[7]||(k[7]=e("div",{class:"transfer-icon"},"¥",-1)),e("div",bs,[e("div",ks,"¥"+M(t.msg.content),1),e("div",ys,M(t.msg.sender==="user"?`转账给${t.charName}`:"转账给你"),1)])]),k[8]||(k[8]=e("div",{class:"transfer-footer"},"微信转账",-1))])):t.msg.type==="call_summary"?(h(),S("div",Ss,[k[9]||(k[9]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,M(t.msg.content),1)])):U("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(h(),S("div",Ms,[...k[10]||(k[10]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):U("",!0)]),t.msg.type==="voice"?N((h(),S("div",{key:0,class:"voice-text"},M(t.msg.content),513)),[[re,o.value]]):U("",!0)])],64))],2))}},$s=F(Cs,[["__scopeId","data-v-8cb932da"]]),ws={key:0,class:"empty-message"},xs={key:0,class:"blocked-overlay"},Is={class:"blocked-content"},Ts={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content"],setup(t,{expose:u}){const i=t,s=w(null),r=()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight)};return j(()=>i.messages,()=>{se(()=>{r()})},{deep:!0}),j(()=>i.activePanel,o=>{o&&se(()=>{r()})}),be(()=>{r()}),u({scrollToBottom:r}),(o,n)=>(h(),S(O,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:s},[t.messages.length===0?(h(),S("div",ws," 开始和 "+M(t.charName)+" 聊天吧~ ",1)):U("",!0),(h(!0),S(O,null,ne(t.messages,c=>(h(),W($s,{key:c.id,msg:c,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(c.id),editingMessageId:t.editingMessageId,onSaveEdit:n[0]||(n[0]=v=>o.$emit("save-edit",v)),onCancelEdit:n[1]||(n[1]=v=>o.$emit("cancel-edit")),onToggleSelection:n[2]||(n[2]=v=>o.$emit("toggle-selection",v)),onLongPress:n[3]||(n[3]=(v,a)=>o.$emit("long-press",v,a)),onCancelLongPress:n[4]||(n[4]=v=>o.$emit("cancel-long-press")),onTouchMove:n[5]||(n[5]=v=>o.$emit("touch-move",v)),onClickMsg:n[6]||(n[6]=(v,a)=>o.$emit("click-msg",v,a)),onShowTextContent:n[7]||(n[7]=v=>o.$emit("show-text-content",v))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"]))),128))],512),t.isBlocked?(h(),S("div",xs,[e("div",Is,[n[9]||(n[9]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:n[8]||(n[8]=c=>o.$emit("unblock"))},"解除拉黑")])])):U("",!0)],64))}},Bs=F(Ts,[["__scopeId","data-v-460d6803"]]),Ps={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:u}){const i=t,s=u,r=E({get:()=>i.visible,set:c=>s("update:visible",c)}),o=w("");j(()=>i.visible,c=>{c&&(o.value="")});const n=()=>{const c=o.value.trim();s("confirm",c),r.value=!1};return(c,v)=>(h(),W(Z,{visible:r.value,"onUpdate:visible":v[2]||(v[2]=a=>r.value=a),title:"发送语音"},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:v[1]||(v[1]=a=>r.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:n},"发送")]),default:z(()=>[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":v[0]||(v[0]=a=>o.value=a),placeholder:"输入语音内容..."},null,512),[[H,o.value]])]),_:1},8,["visible"]))}},As={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:u}){const i=t,s=u,r=E({get:()=>i.visible,set:v=>s("update:visible",v)}),o=w(""),n=w("");j(()=>i.visible,v=>{v&&(o.value="",n.value="")});const c=()=>{const v=o.value.trim(),a=n.value.trim();v&&(s("confirm",{name:v,detail:a}),r.value=!1)};return(v,a)=>(h(),W(Z,{visible:r.value,"onUpdate:visible":a[3]||(a[3]=d=>r.value=d),title:"发送位置"},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:a[2]||(a[2]=X(d=>r.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:c},"发送")]),default:z(()=>[N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":a[0]||(a[0]=d=>o.value=d),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[H,o.value]]),N(e("input",{type:"text",class:"base-input","onUpdate:modelValue":a[1]||(a[1]=d=>n.value=d),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[H,n.value]])]),_:1},8,["visible"]))}},Ls={class:"chat-list-container"},Es=["onClick"],Vs=["src"],Rs={class:"chat-info"},qs={class:"chat-name"},Us=["disabled"],Ds={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:u}){const i=t,s=u,r=Q(),o=w(i.visible),n=w(new Set),c=E(()=>r.characters);j(()=>i.visible,d=>{o.value=d,d||n.value.clear()});const v=d=>{n.value.has(d)?n.value.delete(d):n.value.add(d)},a=()=>{n.value.size>0&&s("confirm",Array.from(n.value))};return(d,g)=>(h(),W(Z,{visible:o.value,"onUpdate:visible":g[1]||(g[1]=x=>o.value=x),title:"选择聊天",onClose:g[2]||(g[2]=x=>d.$emit("close"))},{footer:z(()=>[e("button",{class:"modal-btn cancel",onClick:g[0]||(g[0]=x=>d.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:n.value.size===0,onClick:a}," 确定 ("+M(n.value.size)+") ",9,Us)]),default:z(()=>[e("div",Ls,[(h(!0),S(O,null,ne(c.value,x=>(h(),S("div",{key:x.id,class:"chat-item",onClick:f=>v(x.id)},[e("img",{src:x.avatar,alt:"avatar",class:"avatar"},null,8,Vs),e("div",Rs,[e("div",qs,M(x.name),1)]),e("div",{class:D(["checkbox",{selected:n.value.has(x.id)}])},null,2)],8,Es))),128))])]),_:1},8,["visible"]))}},Ns=F(Ds,[["__scopeId","data-v-00bcf675"]]),zs={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const u=t,i=ce(),{t:s}=K(),r=Q(),o=J(),n=Ze(),c=w(null),v=w(null),a=w(null),d=w(!1),g=w({visible:!1,messageId:null,targetEl:null}),x=w(!1),f=w(!1),b=w(!1),l=E(()=>r.getCharacter(u.charId)),p=E(()=>{var $;return(($=l.value)==null?void 0:$.isBlocked)||!1}),L=E(()=>{var $,y;return(($=l.value)==null?void 0:$.nickname)||((y=l.value)==null?void 0:y.name)||s("chat.unknownCharacter")}),P=E(()=>{var $;return($=l.value)==null?void 0:$.avatar}),B=E(()=>{var $;return(($=l.value)==null?void 0:$.status)||{}}),k=E(()=>{var $;return(($=l.value)==null?void 0:$.chatBackground)||""}),V=E(()=>{var y;const $=r.userPersonas;if((y=l.value)!=null&&y.userPersona&&l.value.userPersona!=="default"){const A=$.find(le=>le.id===l.value.userPersona);if(A&&A.avatar)return A.avatar}return localStorage.getItem("homeAvatar")||""}),I=E(()=>r.messages[u.charId]||[]),T=E(()=>{var $;return(($=l.value)==null?void 0:$.bubbleSettings)||{}}),{isSelectionMode:C,selectedMessageIds:R,isForwarding:G,enterSelectionMode:oe,exitSelectionMode:ue,toggleMessageSelection:ve,handleBatchAction:ke,handleConfirmForward:ye}=tt(ee(u,"charId")),{isTyping:Se,triggerAiResponse:ge}=et(ee(u,"charId"),n),{inputText:_,quotingMessage:ae,sendMessage:Me,sendSticker:Ce,sendVoiceMessage:$e,handleSendImage:we,confirmSendLocation:xe,sendTransfer:Ie}=nt(r,ee(u,"charId"),o,a),{editingMessageId:me,handleEditMessage:Te,handleSaveEdit:Be,updateInputText:Pe}=st(r,ee(u,"charId"),_),{startLongPress:Ae,cancelLongPress:Le,handleTouchMove:Ee,wasClickAfterLongPress:Ve}=ot(g),Re=E(()=>{const $=T.value,y={fontSize:$.fontSize?`${$.fontSize}px`:"14px"};if($.css){const A={};return $.css.split(";").forEach(le=>{const ie=le.split(":");if(ie.length>=2){const fe=ie[0].trim(),pe=ie.slice(1).join(":").trim();fe&&pe&&(A[fe]=pe)}}),{...y,...A}}return y});j(d,$=>{$&&(i.push({name:"single-chat-settings",params:{id:u.charId}}),d.value=!1)}),be(()=>{r.clearUnreadCount(u.charId)});const qe=()=>{l.value&&(l.value.isBlocked=!1,r.messages[u.charId]&&r.messages[u.charId].forEach($=>{$.blocked&&($.blocked=!1)}),r.saveData(),o.showToast(s("chat.toast.unblocked")))},Ue=$=>{const y=$.target;y.closest(".modal-overlay.active")||(a.value&&!y.closest(".chat-footer")&&(a.value=null),C.value&&!y.closest(".message")&&!y.closest(".chat-action-row")&&!y.closest(".message-checkbox")&&!y.closest(".message-menu")&&ue(),g.value.visible&&!y.closest(".message-menu")&&(g.value.visible=!1))},De=($,y)=>{if(Ve()){$.preventDefault(),$.stopPropagation();return}C.value&&ve(y)},Ne=$=>{const y=I.value.find(A=>A.id===$);y&&(ae.value=y)},ze=()=>{f.value=!0},je=$=>{$e($),f.value=!1},Fe=()=>{a.value=null,x.value=!0},Ge=()=>{b.value=!0},Oe=({name:$,detail:y})=>{xe($,y),b.value=!1},He=()=>{r.startVideoCall(u.charId)};return($,y)=>(h(),S("div",{class:D(["chat-room active",{"selection-mode":m(C)}]),onClick:Ue,ref_key:"chatRoomRef",ref:v},[e("div",{class:"chat-bg",style:Y(k.value?{backgroundImage:`url(${k.value})`}:{})},null,4),q(pt,{charId:u.charId,charName:L.value,charStatus:B.value,isTyping:m(Se),onTriggerAi:m(ge),onOpenSettings:y[0]||(y[0]=A=>d.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),q(Bs,{ref_key:"messageListRef",ref:c,messages:I.value,charName:L.value,charAvatar:P.value,userAvatar:V.value,bubbleStyle:Re.value,isSelectionMode:m(C),selectedMessageIds:m(R),isBlocked:p.value,editingMessageId:m(me),activePanel:a.value,onSaveEdit:m(Be),onCancelEdit:y[1]||(y[1]=A=>me.value=null),onToggleSelection:m(ve),onLongPress:m(Ae),onCancelLongPress:m(Le),onTouchMove:m(Ee),onClickMsg:De,onUnblock:qe},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),m(C)?U("",!0):(h(),W(Ht,{key:0,modelValue:m(_),"onUpdate:modelValue":y[2]||(y[2]=A=>_e(_)?_.value=A:null),activePanel:a.value,"onUpdate:activePanel":y[3]||(y[3]=A=>a.value=A),quotingMessage:m(ae),onCancelQuote:y[4]||(y[4]=A=>ae.value=null),onSendMessage:m(Me),onSendSticker:m(Ce),onTriggerVoice:ze,onTriggerImage:Fe,onTriggerVideo:He,onTriggerLocation:Ge,onTriggerTransfer:m(Ie)},null,8,["modelValue","activePanel","quotingMessage","onSendMessage","onSendSticker","onTriggerTransfer"])),m(C)?(h(),W(Jt,{key:1,onAction:m(ke),onCancel:m(ue)},null,8,["onAction","onCancel"])):U("",!0),q(Ps,{visible:f.value,"onUpdate:visible":y[5]||(y[5]=A=>f.value=A),onConfirm:je},null,8,["visible"]),q(he,{visible:x.value,"onUpdate:visible":y[6]||(y[6]=A=>x.value=A),onSendImage:m(we)},null,8,["visible","onSendImage"]),q(As,{visible:b.value,"onUpdate:visible":y[7]||(y[7]=A=>b.value=A),onConfirm:Oe},null,8,["visible"]),q(Kt,{visible:g.value.visible,targetEl:g.value.targetEl,messageId:g.value.messageId,charId:u.charId,isSelectionMode:m(C),selectedMessageIds:m(R),onClose:y[8]||(y[8]=A=>g.value.visible=!1),onEnterSelectionMode:m(oe),onTriggerAiResponse:m(ge),"onUpdate:inputText":m(Pe),onQuoteMessage:Ne,onEditMessage:m(Te)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),q(Ns,{visible:m(G),onClose:y[9]||(y[9]=A=>G.value=!1),onConfirm:m(ye)},null,8,["visible","onConfirm"])],2))}},Fs=F(zs,[["__scopeId","data-v-70b9c9a9"]]);export{Fs as default};
