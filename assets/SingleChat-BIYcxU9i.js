import{u as ee,s as oe,r as x,G as ce,H as nt,I as ot,a as at,J as Ce,L as it,b as lt,j as be,_ as Q,m as ae,x as Se,d as w,o as k,k as _,f as z,g as j,e,T as he,t as M,B as C,i as Z,w as X,A as se,M as ve,c as N,F as Y,C as de,n as O,v as ke,E as ue,N as Te,z as xe,y as W,S as te,O as rt,D as J,P as ct,Q as dt,R as ut,U as re,V as vt,W as gt,X as me,Y as mt}from"./index-CyxU7FNN.js";import{M as ft}from"./MoneyPacket-BDI8w6fM.js";function pt(t){const m=ee(),s=oe(),n=x(!1),d=x(new Set),v=x(!1),g=(o,u)=>{console.log("[useMessageSelection] enterSelectionMode triggered");let p=0,c=0;const l=document.querySelector(".message-list");u&&l&&(p=l.scrollTop,c=u.getBoundingClientRect().top),n.value=!0,d.value.clear(),o&&d.value.add(o),u&&l&&ce(()=>{const b=document.querySelector(".selection-bar"),I=b?b.offsetHeight:0,A=u.getBoundingClientRect().top-c;l.scrollTop=p+A-I})},a=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),n.value=!1,d.value.clear()};return{isSelectionMode:n,selectedMessageIds:d,isForwarding:v,enterSelectionMode:g,exitSelectionMode:a,toggleMessageSelection:o=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${o}`),d.value.has(o)?d.value.delete(o):d.value.add(o)},handleBatchAction:o=>{if(console.log(`[useMessageSelection] handleBatchAction: ${o}`),d.value.size===0)return;const u=m.messages[t.value];if(o==="forward")v.value=!0;else if(o==="delete")s.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),m.messages[t.value]=u.filter(p=>!d.value.has(p.id)),m.saveData(),a()});else if(o==="favorite"){const p=u.filter(c=>d.value.has(c.id));p.length>0&&(m.addToFavorites(t.value,p),s.showToast("已收藏","success")),a()}},handleConfirmForward:o=>{console.log("[useMessageSelection] handleConfirmForward triggered"),v.value=!1;const p=(m.messages[t.value]||[]).filter(c=>d.value.has(c.id));p.length!==0&&(o.forEach(c=>{m.messages[c]||(m.messages[c]=[]),p.forEach(l=>{const b={...l,id:Date.now().toString()+Math.random()};m.messages[c].push(b)})}),m.saveData(),s.showToast(`已转发 ${p.length} 条消息`),a())}}}const ht=(t,m,s)=>{const n=m.map(v=>`${v.role==="user"?"用户":t.name}: ${v.content}`).join(`
`),d=s.toString().padStart(2,"0");return`
你正在扮演角色“${t.name}”，你需要根据以下设定和最近的对话，生成一段角色的实时“心声”。
心声由多个部分组成，请严格按照下面的JSON格式返回，不要添加任何额外的解释或文字。

**角色人设:**
${t.charPersona}

**最近对话:**
${n}

**你的任务:**
生成符合当前情境和角色性格的内心活动。
- **情绪 (emotion)**: 描述角色当前的主要情绪，应在一定时间内保持稳定，5字以内。
- **穿着 (outfit)**: 描述角色当前的穿着，应在一定时间内保持稳定，10字以内。
- **姿态 (posture)**: 描述角色当前的姿态或小动作，应在一定时间内保持稳定，15字以内。
- **内心独白 (innerVoice)**: 角色此刻具体的内心想法，50字以内。
- **没说出口的话 (unspokenWords)**: 一句角色想说但没说出口的话，风格可以多变（如阴暗、腹黑、酸涩、色情等），必须符合人设，15字以内。
- **标题 (title)**: 为这次心声生成一个简短的小标题，格式固定为“#${d} 标题内容”，例如“#${d} 初次见面”。

**输出格式 (必须是可被解析的JSON):**
{
  "emotion": "...",
  "outfit": "...",
  "posture": "...",
  "innerVoice": "...",
  "unspokenWords": "...",
  "title": "#${d} ..."
}
`};function kt(t,m){const s=ee(),n=nt(),d=ot(),v=at(),g=be(),a=lt(),i=x(!1),f=async()=>{console.log("[useAiResponder] triggerAiResponse triggered"),i.value=!0;try{const o=s.getCharacter(t.value),u=s.getPendingUserTransfers(t.value);console.log("[useAiResponder] Pending transfers to accept:",u.length);let p=await m.getChatCompletion(t.value);if(console.log("[useAiResponder] AI Response:",p),p){const c=/\[撤回\]/g;if(c.test(p)){const B=s.messages[t.value]||[];for(let q=B.length-1;q>=0;q--){const L=B[q];if(L.sender==="char"&&!L.isRevoked){s.revokeMessage(t.value,L.id),console.log(`[useAiResponder] Revoked message: ${L.id}`);break}}p=p.replace(c,"").trim()}const l=/\[互动朋友圈：(.+?)\]/g;let b;for(;(b=l.exec(p))!==null;)try{const B=JSON.parse(b[1]),{action:q,response:L}=B,U=v.moments.filter(D=>D.userId==="user");if(U.length>0){const D=U[0];q==="like"?(v.likeMoment(D.id,t.value),console.log(`[useAiResponder] Liked user's latest moment: ${D.id}`)):q==="comment"&&L&&(v.likeMoment(D.id,t.value),v.addComment(D.id,{userId:t.value,content:L,time:Date.now()}),console.log(`[useAiResponder] Commented on user's latest moment: ${D.id}`))}}catch(B){console.error("[useAiResponder] Failed to parse moment interaction data:",B)}p=p.replace(l,"").trim();const I=/\[朋友圈：(.+?)\]/g;let r;for(;(r=I.exec(p))!==null;)try{const B=JSON.parse(r[1]),{text:q,imageDescription:L}=B,U=[];L&&U.push({content:L,isTextGenerated:!0}),(q||U.length>0)&&(v.addMoment({userId:t.value,content:q||"",images:U,time:Date.now()}),console.log(`[useAiResponder] Added new moment for ${t.value}`))}catch(B){console.error("[useAiResponder] Failed to parse moment data from AI response:",B)}p=p.replace(I,"").trim();const A=/\[待办：(?:((?:\d{4}-\d{2}-\d{2}\s)?\d{1,2}:\d{2}|\d{4}-\d{2}-\d{2})\s)?(.+?)\]/g;let V;for(;(V=A.exec(p))!==null;){const B=V[1],q=V[2].trim();let L=new Date,U="";if(B)if(B.includes("-"))if(B.includes(":")){const[D,K]=B.split(/\s+/);L=new Date(D),U=K}else L=new Date(B),U="";else U=B;else{const D=new Date,K=[15,30,60],H=K[Math.floor(Math.random()*K.length)];D.setMinutes(D.getMinutes()+H);const ne=D.getHours().toString().padStart(2,"0"),ie=D.getMinutes().toString().padStart(2,"0");U=`${ne}:${ie}`}if(q){let D=q;D.length>18&&(D=D.substring(0,18)+"..."),d.addEvent({type:"todo",title:D,content:D,date:Ce(L,{representation:"date"}),done:!1,time:U}),console.log(`[useAiResponder] Added new todo: "${D}" at ${U} on ${Ce(L,{representation:"date"})}`)}}if(p=p.replace(A,"").trim(),!p){i.value=!1,h();return}s.messages[t.value]||(s.messages[t.value]=[]);const G=(o==null?void 0:o.isBlocked)||!1,P=/(?:\||\\\||｜)\s*(?:\||\\\||｜)\s*(?:\||\\\||｜)+/g;let S=p.replace(P,"|||").split("|||"),T=[];const F=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g;S.forEach(B=>{const q=B.split(F).map(L=>L.trim()).filter(L=>L);T.push(...q)});for(let B=0;B<T.length;B++){const q=T[B];B>0&&await new Promise(H=>setTimeout(H,1e3+Math.random()*1e3));let{type:L,content:U}=it(q),D={};if(L==="transfer_accepted"){await new Promise(H=>setTimeout(H,800+Math.random()*500)),s.autoAcceptPendingTransfers(t.value),console.log("[useAiResponder] Transfer acceptance message processed.");continue}if(L==="sticker"){const H=U,ne=s.stickers.find(ie=>ie.name===H);ne?(U=ne.url,D.name=H):(L="text",U=`[表情包：${H}]`)}let K=!1;L==="image"&&!U.startsWith("http")&&!U.startsWith("data:")&&(K=!0),s.addMessage(t.value,{id:Date.now().toString()+B,sender:"char",type:L,content:U,isTextGenerated:K,...D,time:Date.now(),blocked:G}),a.path!==`/chat/room/${t.value}`&&(s.incrementUnreadCount(t.value),n.triggerNotification(o.nickname||o.name,L==="text"?U:`[${L}]`,o.avatar,()=>{g.push(`/chat/room/${t.value}`)},3e3,L))}u.length>0&&s.getPendingUserTransfers(t.value).length>0&&(await new Promise(B=>setTimeout(B,800+Math.random()*500)),s.autoAcceptPendingTransfers(t.value),console.log("[useAiResponder] Fallback transfer acceptance executed at the end"))}}catch(o){console.error("[useAiResponder] triggerAiResponse failed:",o)}finally{i.value=!1,h()}},h=async()=>{try{const o=s.getCharacter(t.value);if(!o)return;const u=s.innerVoices[t.value]||[];let p=1;if(u.length>0){const I=u[0].title;if(I){const r=I.match(/#(\d+)/);r?p=parseInt(r[1],10)+1:p=u.length+1}else p=u.length+1}const c=s.getFormattedRecentMessages(t.value,10),l=ht(o,c,p),b=await m.getGenericCompletion([{role:"user",content:l}]);if(b){const I=b.indexOf("{"),r=b.lastIndexOf("}");if(I!==-1&&r!==-1){const A=b.substring(I,r+1),V=JSON.parse(A);s.addInnerVoice(t.value,V),console.log("[useAiResponder] Inner voice generated and saved:",V)}else console.warn("[useAiResponder] Failed to find JSON in inner voice response.")}}catch(o){console.error("[useAiResponder] Failed to generate inner voice:",o)}};return{isTyping:i,triggerAiResponse:f}}function bt(t,m,s){const n=x(null);return{editingMessageId:n,handleEditMessage:a=>{console.log("[useMessageEditing] handleEditMessage for msgId:",a),n.value=a},handleSaveEdit:({msgId:a,newContent:i})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",a);const h=t.messages[m.value].find(o=>o.id===a);h&&(h.content=i,t.saveData()),n.value=null},updateInputText:a=>{console.log("[useMessageEditing] updateInputText called"),s&&(s.value=a,ce(()=>{const i=document.querySelector(".chat-input");i&&i.focus()}))}}}function St(t,m,s,n,d={}){const v=x(""),g=x(null),a=(c,l,b={})=>{console.log(`[useMessageSender] sendMsg called with type: ${c}`);const I={...b};g.value&&(I.quote={id:g.value.id,sender:g.value.sender,content:g.value.content}),t.addMessage(m.value,{id:Date.now().toString()+Math.random(),sender:"user",type:c,content:l,timestamp:Date.now(),...I}),n&&(n.value=null),g.value=null};return{inputText:v,quotingMessage:g,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const c=v.value.trim();c&&(a("text",c),v.value="")},sendMsg:a,sendSticker:c=>{console.log("[useMessageSender] sendSticker triggered"),a("sticker",c.url,{name:c.name})},sendVoiceMessage:c=>{console.log("[useMessageSender] sendVoiceMessage triggered"),c&&a("voice",c)},handleSendImage:c=>{console.log("[useMessageSender] handleSendImage triggered"),c.isTextGenerated?a("image",c.description,{isTextGenerated:!0}):(c.type==="base64"||c.type==="url")&&a("image",c.content)},confirmSendLocation:(c,l)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!c){s.showToast("请输入位置名称","info");return}a("location",c,{detail:l})},sendTransfer:(c,l)=>{console.log("[useMessageSender] sendTransfer triggered",c,l),a("transfer",c,{note:l,status:"pending"})}}}function yt(t){const m=x(null),s=x(!1),n=x({x:0,y:0}),d=(f,h)=>{console.log("[useMessageInteraction] showMenu triggered"),f.preventDefault();const o=f.target.closest(".msg-bubble, .system-message-wrapper");o&&(t.value={visible:!0,messageId:h,targetEl:o})};return{startLongPress:(f,h)=>{console.log("[useMessageInteraction] startLongPress triggered"),f.stopPropagation(),s.value=!1,clearTimeout(m.value),f.type.startsWith("touch")&&(n.value={x:f.touches[0].clientX,y:f.touches[0].clientY}),m.value=setTimeout(()=>{s.value=!0,d(f,h)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(m.value)},handleTouchMove:f=>{console.log("[useMessageInteraction] handleTouchMove triggered");const h=f.touches[0],o=Math.abs(h.clientX-n.value.x),u=Math.abs(h.clientY-n.value.y);(o>10||u>10)&&clearTimeout(m.value)},wasClickAfterLongPress:()=>s.value?(s.value=!1,!0):!1}}const Mt={class:"header-title-area"},wt={key:0,class:"chat-room-title"},$t={key:1,class:"typing-indicator"},Ct={class:"right-icons-group"},Tt={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},xt=["placeholder"],It=["placeholder"],At={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:m}){const s=t,{t:n}=ae(),d=be(),v=ee(),g=oe(),a=x(!1),i=x(""),f=x(""),h=x(!1);Se(()=>{h.value=!0});const o=()=>{const c=s.charStatus||{};i.value=c.icon||"✨",f.value=c.text||"",a.value=!0},u=()=>{const c=i.value.trim()||"✨",l=f.value.trim(),b=v.getCharacter(s.charId);b&&(l?b.status={icon:c,text:l}:b.status=null,v.saveData(),g.showToast(n("saveSuccess"))),a.value=!1},p=()=>{d.push({name:"memory-bank",params:{charId:s.charId}})};return(c,l)=>(k(),w("div",null,[h.value?(k(),_(he,{key:0,to:"#chatRoomLeftArea"},[e("div",{class:"btn-icon bell-btn",onClick:l[0]||(l[0]=b=>c.$emit("trigger-ai")),ref:"bellBtn"},[...l[6]||(l[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)])):z("",!0),h.value?(k(),_(he,{key:1,to:"#chatRoomTitleArea"},[e("div",Mt,[t.isTyping?(k(),w("div",$t,[e("span",null,M(C(n)("chat.singleChat.typing")),1),l[7]||(l[7]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(k(),w("div",wt,M(t.charName),1))]),e("div",{class:"chat-room-status",onClick:o},[e("span",null,M(t.charStatus.icon||"✨"),1),e("span",null,M(t.charStatus.text||C(n)("chat.singleChat.addStatus")),1)])])):z("",!0),h.value?(k(),_(he,{key:2,to:"#chatRoomActionArea"},[e("div",Ct,[e("div",{class:"btn-icon memory-btn",onClick:p},[...l[8]||(l[8]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e("polyline",{points:"14 2 14 8 20 8"}),e("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e("polyline",{points:"10 9 9 9 8 9"})],-1)])]),e("div",{class:"btn-icon more-btn",onClick:l[1]||(l[1]=b=>c.$emit("open-settings"))},[...l[9]||(l[9]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])])])):z("",!0),j(ve,{visible:a.value,"onUpdate:visible":l[5]||(l[5]=b=>a.value=b),title:C(n)("chat.singleChat.setStatus")},{footer:Z(()=>[e("button",{class:"modal-btn cancel",onClick:l[4]||(l[4]=b=>a.value=!1)},M(C(n)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:u},M(C(n)("confirm")),1)]),default:Z(()=>[e("div",Tt,[X(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[2]||(l[2]=b=>i.value=b),placeholder:C(n)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,xt),[[se,i.value]]),X(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[3]||(l[3]=b=>f.value=b),placeholder:C(n)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,It),[[se,f.value]])])]),_:1},8,["visible","title"])]))}},Pt=Q(At,[["__scopeId","data-v-9265e8b0"]]),Rt={key:0,class:"chat-panel",id:"stickerPanel"},Bt={class:"sticker-panel-header"},Lt={class:"sticker-groups"},Vt=["onClick"],Dt={class:"sticker-panel-content"},Et=["onClick"],qt=["src","alt"],Ut={class:"sticker-panel-footer"},Nt={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:m}){const s=m,n=ee(),d=oe(),v=x("默认"),g=x(!1),a=x(new Set),i=x(!1),f=x(!1),h=x(""),o=N(()=>["默认",...new Set(n.stickers.map(R=>R.group).filter(Boolean).filter(R=>R!=="默认"))]),u=N(()=>n.stickers.filter(P=>P.group===v.value)),p=P=>{g.value?a.value.has(P.id)?a.value.delete(P.id):a.value.add(P.id):s("send-sticker",P)},c=({group:P,stickers:R})=>{const S=R.map(T=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:T.url,name:T.name,group:P}));n.stickers.push(...S),n.saveData(),d.showToast(`成功导入 ${S.length} 个表情包`,"success")},l=()=>{i.value=!0},b=()=>{a.value.size>0&&(f.value=!0)},I=()=>{g.value=!g.value,a.value.clear()},r=()=>{const P=u.value;P.every(S=>a.value.has(S.id))?P.forEach(S=>a.value.delete(S.id)):P.forEach(S=>a.value.add(S.id))},A=()=>{a.value.size!==0&&d.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{n.stickers=n.stickers.filter(P=>!a.value.has(P.id)),n.saveData(),a.value.clear()})},V=()=>{const P=h.value.trim();if(!P)return d.showToast("请输入目标分组","info");n.stickers.forEach(R=>{a.value.has(R.id)&&(R.group=P)}),n.saveData(),f.value=!1,h.value="",a.value.clear(),g.value=!1,v.value=P},G=()=>{if(a.value.size===0)return;const P=n.stickers.filter(F=>a.value.has(F.id)).map(F=>`${F.name} ${F.url}`).join(`
`),R=new Blob([P],{type:"text/plain"}),S=URL.createObjectURL(R),T=document.createElement("a");T.href=S,T.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(S),a.value.clear(),g.value=!1};return(P,R)=>(k(),w("div",null,[t.visible?(k(),w("div",Rt,[e("div",Bt,[e("div",Lt,[(k(!0),w(Y,null,de(o.value,S=>(k(),w("div",{class:O(["sticker-group-tab",{active:v.value===S}]),key:S,onClick:T=>v.value=S},M(S),11,Vt))),128))])]),e("div",Dt,[(k(!0),w(Y,null,de(u.value,S=>(k(),w("div",{class:O(["sticker-item",{selected:a.value.has(S.id),"manage-mode":g.value}]),key:S.id,onClick:T=>p(S)},[e("img",{src:S.url,alt:S.name},null,8,qt),e("span",null,M(S.name),1)],10,Et))),128))]),e("div",Ut,[X(e("div",{class:"sticker-add-btn",onClick:l},"＋",512),[[ke,!g.value]]),e("div",{class:"sticker-manage-btn",style:ue({color:g.value?"var(--danger-color)":"#576B95"}),onClick:I},M(g.value?"完成":"管理"),5)]),e("div",{class:O(["manage-bar",{active:g.value}])},[e("button",{class:"btn btn-secondary",onClick:l},"导入"),e("button",{class:"btn btn-secondary",onClick:r},"全选"),e("button",{class:"btn btn-secondary",onClick:b},"移动"),e("button",{class:"btn btn-secondary",onClick:G},"导出"),e("button",{class:"btn btn-danger",onClick:A},"删除")],2)])):z("",!0),j(Te,{visible:i.value,"onUpdate:visible":R[0]||(R[0]=S=>i.value=S),type:"sticker-import",onImportSticker:c},null,8,["visible"]),j(ve,{visible:f.value,"onUpdate:visible":R[3]||(R[3]=S=>f.value=S),title:"移动到分组"},{footer:Z(()=>[e("button",{class:"modal-btn cancel",onClick:R[2]||(R[2]=S=>f.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:V},"确定")]),default:Z(()=>[X(e("input",{type:"text",class:"base-input","onUpdate:modelValue":R[1]||(R[1]=S=>h.value=S),placeholder:"输入目标分组名称"},null,512),[[se,h.value]])]),_:1},8,["visible"])]))}},Ft=Q(Nt,[["__scopeId","data-v-c6bef6fa"]]),jt={class:"chat-panel",id:"morePanel"},zt={class:"more-panel-content"},Ot={class:"more-label"},Ht={class:"more-label"},Wt={class:"more-label"},Gt={class:"more-label"},Jt={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:m}=ae();return(s,n)=>(k(),w("div",jt,[e("div",zt,[e("div",{class:"more-item",onClick:n[0]||(n[0]=d=>s.$emit("trigger-image-upload"))},[n[4]||(n[4]=xe('<div class="more-icon" data-v-d00cc944><svg class="svg-icon" viewBox="0 0 24 24" data-v-d00cc944><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-d00cc944></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-d00cc944></circle><polyline points="21 15 16 10 5 21" data-v-d00cc944></polyline></svg></div>',1)),e("span",Ot,M(C(m)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:n[1]||(n[1]=d=>s.$emit("start-video-call"))},[n[5]||(n[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Ht,M(C(m)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:n[2]||(n[2]=d=>s.$emit("send-location"))},[n[6]||(n[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",Wt,M(C(m)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:n[3]||(n[3]=d=>s.$emit("send-transfer"))},[n[7]||(n[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M8 5 L4 9 H20 M16 19 L20 15 H4"})])],-1)),e("span",Gt,M(C(m)("chat.morePanel.transfer")),1)])])]))}},Yt=Q(Jt,[["__scopeId","data-v-d00cc944"]]),Qt={class:"chat-footer"},Kt={key:0,class:"quote-preview"},Xt={class:"quote-content"},Zt={class:"quote-sender"},_t={class:"quote-text"},es={class:"chat-input-row"},ts={class:"chat-input-wrapper"},ss=["value","onKeydown"],ns={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"24px",height:"24px",position:"relative",top:"1px",left:"-1px"}},os={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null},charId:{type:String,required:!0}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:m}){const{t:s}=ae(),n=ee(),d=t,v=m,g=x(d.activePanel);W(()=>d.activePanel,o=>{g.value=o}),W(g,o=>{v("update:activePanel",o)});const a=N(()=>{if(!d.quotingMessage)return"";if(d.quotingMessage.sender==="user")return s("chat.self");{const o=n.getCharacter(d.charId);return(o==null?void 0:o.nickname)||(o==null?void 0:o.name)||s("chat.other")}}),i=o=>{g.value===o?g.value=null:g.value=o},f=()=>{d.modelValue.trim()&&v("send-message")},h=o=>{v("send-sticker",o),g.value=null};return(o,u)=>(k(),w("div",Qt,[t.quotingMessage?(k(),w("div",Kt,[e("div",Xt,[e("span",Zt,M(a.value)+": ",1),e("span",_t,M(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:u[0]||(u[0]=p=>o.$emit("cancel-quote"))},[...u[9]||(u[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):z("",!0),e("div",es,[e("div",{class:"chat-tool-btn",onClick:u[1]||(u[1]=p=>o.$emit("trigger-voice"))},[j(te,{name:"voice-circle",class:"svg-icon"})]),e("div",ts,[e("textarea",{class:"chat-input",value:t.modelValue,onInput:u[2]||(u[2]=p=>o.$emit("update:modelValue",p.target.value)),onKeydown:rt(J(f,["exact","prevent"]),["enter"]),id:"messageInput",autocomplete:"off",rows:"1"},null,40,ss)]),e("div",{class:"chat-tool-btn",onClick:u[3]||(u[3]=p=>i("sticker"))},[j(te,{name:"sticker",class:"svg-icon"})]),t.modelValue?(k(),w("div",{key:1,class:"send-btn-icon",onClick:f},[(k(),w("svg",ns,[...u[10]||(u[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(k(),w("div",{key:0,class:"chat-tool-btn",onClick:u[4]||(u[4]=p=>i("more"))},[j(te,{name:"plus-circle",class:"svg-icon"})]))]),j(Ft,{visible:g.value==="sticker",onSendSticker:h},null,8,["visible"]),g.value==="more"?(k(),_(Yt,{key:1,onTriggerImageUpload:u[5]||(u[5]=p=>o.$emit("trigger-image")),onStartVideoCall:u[6]||(u[6]=p=>o.$emit("trigger-video")),onSendLocation:u[7]||(u[7]=p=>o.$emit("trigger-location")),onSendTransfer:u[8]||(u[8]=p=>o.$emit("trigger-transfer"))})):z("",!0)]))}},as=Q(os,[["__scopeId","data-v-3da6a910"]]),is={class:"menu-grid"},ls={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:m}){const s=t,n=m,d=ct("phoneScreenRef"),{t:v}=ae(),g=ee(),a=oe(),i=x(null),f=x({}),h=x(0),o=x("top");W(()=>s.visible,async c=>{c&&s.targetEl&&(await ce(),u())});const u=()=>{const c=i.value;if(!c)return;const l=s.targetEl.getBoundingClientRect(),b=c.offsetWidth,I=c.offsetHeight,r=8,A=d.value,V=A?A.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};o.value="top";let G=l.top-I-r;G<V.top+r&&(o.value="bottom",G=l.bottom+r);const P=l.left+l.width/2;let R=P-b/2;R<V.left+r&&(R=V.left+r),R+b>V.left+V.width-r&&(R=V.left+V.width-b-r);let S=P-R;const T=12,F=T/2+5,B=b-T/2-5;S=Math.max(F,Math.min(S,B)),f.value={top:`${G}px`,left:`${R}px`},h.value=S},p=c=>{const l=s.messageId;if(!l)return;const b=g.messages[s.charId],I=b.findIndex(V=>V.id===l),r=b[I],A={copy:()=>{r.content&&(navigator.clipboard.writeText(r.content),a.showToast(v("chat.messageMenu.toast.copied")))},favorite:()=>{g.addToFavorites(s.charId,r),a.showToast(v("chat.messageMenu.toast.favorited"))},delete:()=>{a.showConfirm(v("chat.messageMenu.confirmDelete"),v("chat.messageMenu.confirmDeleteMsg"),()=>{g.messages[s.charId].splice(I,1),g.saveData()})},revoke:()=>{r&&(r.type="revoked",g.saveData(),a.showToast(v("chat.messageMenu.toast.revoked")))},select:()=>n("enter-selection-mode",l,s.targetEl),quote:()=>n("quote-message",l),retry:()=>{r.sender!=="user"?g.messages[s.charId].splice(I,1):g.retryFromMessage(s.charId,l),g.saveData(),n("trigger-ai-response")},edit:()=>{r.type==="text"?n("edit-message",l):a.showToast(v("chat.messageMenu.toast.editTextOnly"),"info")}};A[c]&&A[c](),n("close")};return(c,l)=>t.visible?(k(),w("div",{key:0,ref_key:"menuRef",ref:i,class:O(["message-menu",{"menu-top":o.value==="top","menu-bottom":o.value==="bottom"}]),style:ue(f.value)},[e("div",is,[e("div",{class:"menu-item",onClick:l[0]||(l[0]=b=>p("copy"))},M(C(v)("copy")),1),e("div",{class:"menu-item",onClick:l[1]||(l[1]=b=>p("favorite"))},M(C(v)("favorite")),1),e("div",{class:"menu-item",onClick:l[2]||(l[2]=b=>p("delete"))},M(C(v)("delete")),1),e("div",{class:"menu-item",onClick:l[3]||(l[3]=b=>p("revoke"))},M(C(v)("revoke")),1),e("div",{class:"menu-item",onClick:l[4]||(l[4]=b=>p("select"))},M(C(v)("select")),1),e("div",{class:"menu-item",onClick:l[5]||(l[5]=b=>p("quote"))},M(C(v)("quote")),1),e("div",{class:"menu-item",onClick:l[6]||(l[6]=b=>p("retry"))},M(C(v)("retry")),1),e("div",{class:"menu-item",onClick:l[7]||(l[7]=b=>p("edit"))},M(C(v)("edit")),1)]),e("div",{class:"menu-arrow",style:ue({left:h.value+"px"})},null,4)],6)):z("",!0)}},rs=Q(ls,[["__scopeId","data-v-611c1739"]]),cs={class:"chat-action-row"},ds={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:m}=ae();return(s,n)=>(k(),w("div",cs,[e("div",{class:"action-btn",onClick:n[0]||(n[0]=d=>s.$emit("action","favorite"))},[n[4]||(n[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,M(C(m)("favorite")),1)]),e("div",{class:"action-btn",onClick:n[1]||(n[1]=d=>s.$emit("action","forward"))},[n[5]||(n[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,M(C(m)("forward")),1)]),e("div",{class:"action-btn",onClick:n[2]||(n[2]=d=>s.$emit("action","delete"))},[n[6]||(n[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,M(C(m)("delete")),1)]),e("div",{class:"action-btn",onClick:n[3]||(n[3]=d=>s.$emit("cancel"))},[n[7]||(n[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,M(C(m)("done")),1)])]))}},us=Q(ds,[["__scopeId","data-v-be1a592f"]]),vs=["src"],gs={class:"msg-content-wrapper"},ms={class:"msg-bubble-box"},fs={key:0,class:"quote-in-bubble"},ps={class:"quote-in-bubble-sender"},hs={class:"quote-in-bubble-text"},ks={key:1,class:"edit-view"},bs={key:0},Ss={class:"description-placeholder"},ys=["src"],Ms={key:2,class:"sticker-msg"},ws=["src"],$s={key:3,class:"voice-msg-wrapper"},Cs={class:"voice-msg"},Ts={key:4,class:"location-msg"},xs={class:"location-text"},Is={class:"msg-title"},As={class:"transfer-content"},Ps={class:"transfer-icon"},Rs={key:0,viewBox:"0 0 24 24",fill:"currentColor"},Bs={key:1,viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},Ls={class:"transfer-info"},Vs={class:"transfer-amount"},Ds={class:"transfer-desc"},Es={class:"transfer-footer"},qs={key:6,class:"call-summary-msg"},Us={key:0,class:"blocked-icon"},Ns={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","show-thought","accept-transfer"],setup(t,{emit:m}){const s=t,n=m,d=dt(),v=x(!1),g=x(!1),a=x(""),i=N(()=>s.editingMessageId===s.msg.id),f=N(()=>{const S=s.msg.type,T=S==="transfer"&&s.msg.status==="accepted";return{"no-style":["image","sticker","location","transfer"].includes(S),"has-location":S==="location","has-transfer":S==="transfer",accepted:T}}),h=N(()=>{if(s.msg.type!=="transfer")return{};const S=s.msg.status==="accepted",T=s.msg.sender==="user";return{"accepted-sender":S&&T,"accepted-receiver":S&&!T,pending:!S}}),o=N(()=>{if(s.msg.type!=="transfer")return"";const S=s.msg.sender==="user",T=s.msg.status==="accepted",F=s.msg.isReceived;return s.msg.note?s.msg.note:F?"已收款":T?"已被接收":S?"你发起了一笔转账":"请收款"}),u=N(()=>s.msg.type!=="transfer"?"":s.msg.isReceived?"已收款":s.msg.status==="accepted"?"已被接收":"微信转账");W(i,S=>{S&&(a.value=s.msg.content)});const p=S=>{n("long-press",S,s.msg.id)},c=()=>{n("cancel-long-press")},l=S=>{n("touch-move",S)},b=S=>{s.msg.type==="voice"&&r(),s.msg.type!=="image"&&n("click-msg",S,s.msg.id)},I=()=>{s.msg.sender!=="user"&&n("show-thought",s.msg.id)},r=()=>{v.value=!v.value},A=()=>{g.value=!g.value},V=()=>{a.value.trim()&&n("save-edit",{msgId:s.msg.id,newContent:a.value})},G=()=>{n("cancel-edit")},P=()=>s.msg.type==="notification"?s.msg.content:s.msg.type==="revoked"?`"${s.msg.sender==="user"?"你":s.charName}" 撤回了一条消息`:"",R=()=>{(s.msg.status==="pending"||s.msg.status===void 0)&&s.msg.sender!=="user"&&!s.isSelectionMode&&n("accept-transfer",s.msg.id)};return(S,T)=>(k(),w("div",{class:O(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[t.msg.type==="revoked"||t.msg.type==="notification"?(k(),w(Y,{key:0},[e("div",{class:O(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:T[0]||(T[0]=J(F=>S.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),e("div",{class:"system-message-wrapper",onMousedown:p,onMouseup:c,onMouseleave:c,onTouchstart:p,onTouchend:c,onTouchmove:l,onClick:J(b,["prevent"])},[e("div",{class:"system-message-text",onClick:T[1]||(T[1]=J(F=>!t.isSelectionMode&&A(),["stop"]))},M(P()),1),t.msg.type==="revoked"?X((k(),w("div",{key:0,class:"revoked-content"},M(t.msg.sender==="user"?"我":t.charName)+"："+M(t.msg.content),513)),[[ke,g.value]]):z("",!0)],32)],64)):(k(),w(Y,{key:1},[e("div",{class:"msg-avatar",onClick:I},[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(k(),w("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,vs)):(k(),w("div",{key:1,class:O(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",gs,[e("div",ms,[e("div",{class:O(["msg-bubble",f.value]),style:ue(t.bubbleStyle),onMousedown:p,onMouseup:c,onMouseleave:c,onTouchstart:p,onTouchend:c,onTouchmove:l,onClick:J(b,["prevent"])},[t.msg.quote?(k(),w("div",fs,[e("div",ps,M(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",hs,M(t.msg.quote.content),1)])):z("",!0),i.value?(k(),w("div",ks,[X(e("textarea",{"onUpdate:modelValue":T[2]||(T[2]=F=>a.value=F),class:"edit-textarea",rows:"3"},null,512),[[se,a.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:G,class:"edit-btn cancel"},"取消"),e("button",{onClick:V,class:"edit-btn save"},"保存")])])):(k(),w(Y,{key:2},[t.msg.type==="text"?(k(),w("div",bs,M(t.msg.content),1)):t.msg.type==="image"?(k(),w(Y,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(k(),w("div",{key:0,class:"text-generated-image-container",onClick:T[3]||(T[3]=F=>C(d).preview(t.msg))},[e("div",Ss,M(t.msg.content),1)])):(k(),w("div",{key:1,class:"image-msg",onClick:T[4]||(T[4]=F=>C(d).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,ys)]))],64)):t.msg.type==="sticker"?(k(),w("div",Ms,[e("img",{src:t.msg.content,alt:"表情包"},null,8,ws)])):t.msg.type==="voice"?(k(),w("div",$s,[e("div",Cs,[j(te,{name:"voice-wave",class:O(["voice-icon-svg",{playing:v.value}])},null,8,["class"]),e("span",null,M(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(k(),w("div",Ts,[e("div",xs,[e("div",Is,M(t.msg.content||"位置信息"),1),T[6]||(T[6]=e("div",{class:"msg-desc"},"详细地址",-1))]),T[7]||(T[7]=xe('<div class="location-map" data-v-219f64dd><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-219f64dd><div class="location-pin" data-v-219f64dd><svg viewBox="0 0 24 24" fill="currentColor" data-v-219f64dd><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-219f64dd></path></svg></div></div>',1))])):t.msg.type==="transfer"?(k(),w("div",{key:5,class:O(["transfer-msg",h.value]),onClick:J(R,["stop"])},[e("div",As,[e("div",Ps,[t.msg.status==="accepted"||t.msg.isReceived?(k(),w("svg",Rs,[...T[8]||(T[8]=[e("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"},null,-1)])])):(k(),w("svg",Bs,[...T[9]||(T[9]=[e("path",{d:"M8 5 L4 9 H20 M16 19 L20 15 H4"},null,-1)])]))]),e("div",Ls,[e("div",Vs,"¥"+M(t.msg.content),1),e("div",Ds,M(o.value),1)])]),e("div",Es,M(u.value),1)],2)):t.msg.type==="call_summary"?(k(),w("div",qs,[T[10]||(T[10]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,M(t.msg.content),1)])):z("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(k(),w("div",Us,[...T[11]||(T[11]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):z("",!0)]),t.msg.type==="voice"?X((k(),w("div",{key:0,class:"voice-text"},M(t.msg.content),513)),[[ke,v.value]]):z("",!0)]),e("div",{class:O(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:T[5]||(T[5]=J(F=>S.$emit("toggle-selection",t.msg.id),["stop"]))},null,2)],64))],2))}},Fs=Q(Ns,[["__scopeId","data-v-219f64dd"]]),js={key:0,class:"empty-message"},zs={key:0,class:"timestamp"},Os={key:0,class:"blocked-overlay"},Hs={class:"blocked-content"},Ws=5*60*1e3,Gs={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content","show-thought","accept-transfer"],setup(t,{expose:m}){const s=t,n=x(null),d=a=>{if(a===0)return!0;const i=s.messages[a],f=s.messages[a-1];if(!i.timestamp||!f.timestamp)return!1;const h=new Date(i.timestamp).getTime(),o=new Date(f.timestamp).getTime();return h-o>Ws},v=a=>{if(!a)return"";const i=new Date(a),f=new Date,h=new Date(f.getFullYear(),f.getMonth(),f.getDate()),o=new Date(h.getTime()-864e5),u=f.getDay()===0?7:f.getDay(),p=new Date(h.getTime()-(u-1)*864e5),c=i.getHours().toString().padStart(2,"0"),l=i.getMinutes().toString().padStart(2,"0"),b=`${c}:${l}`;if(i.getTime()>=h.getTime())return b;if(i.getTime()>=o.getTime())return`昨天 ${b}`;if(i.getTime()>=p.getTime())return`${["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][i.getDay()]} ${b}`;{const I=i.getFullYear(),r=(i.getMonth()+1).toString(),A=i.getDate().toString();return I===f.getFullYear()?`${r}月${A}日 ${b}`:`${I}年${r}月${A}日 ${b}`}},g=()=>{n.value&&(n.value.scrollTop=n.value.scrollHeight)};return W(()=>s.messages,()=>{ce(()=>{g()})},{deep:!0}),W(()=>s.activePanel,a=>{a&&ce(()=>{g()})}),Se(()=>{g()}),m({scrollToBottom:g}),(a,i)=>(k(),w(Y,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:n},[t.messages.length===0?(k(),w("div",js," 开始和 "+M(t.charName)+" 聊天吧~ ",1)):z("",!0),(k(!0),w(Y,null,de(t.messages,(f,h)=>(k(),w(Y,{key:f.id},[d(h)?(k(),w("div",zs,M(v(f.timestamp)),1)):z("",!0),j(Fs,{msg:f,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(f.id),editingMessageId:t.editingMessageId,onSaveEdit:i[0]||(i[0]=o=>a.$emit("save-edit",o)),onCancelEdit:i[1]||(i[1]=o=>a.$emit("cancel-edit")),onToggleSelection:i[2]||(i[2]=o=>a.$emit("toggle-selection",o)),onLongPress:i[3]||(i[3]=(o,u)=>a.$emit("long-press",o,u)),onCancelLongPress:i[4]||(i[4]=o=>a.$emit("cancel-long-press")),onTouchMove:i[5]||(i[5]=o=>a.$emit("touch-move",o)),onClickMsg:i[6]||(i[6]=(o,u)=>a.$emit("click-msg",o,u)),onShowTextContent:i[7]||(i[7]=o=>a.$emit("show-text-content",o)),onShowThought:i[8]||(i[8]=o=>a.$emit("show-thought",o)),onAcceptTransfer:i[9]||(i[9]=o=>a.$emit("accept-transfer",o))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"])],64))),128))],512),t.isBlocked?(k(),w("div",Os,[e("div",Hs,[i[11]||(i[11]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:i[10]||(i[10]=f=>a.$emit("unblock"))},"解除拉黑")])])):z("",!0)],64))}},Js=Q(Gs,[["__scopeId","data-v-deb1a117"]]),Ys={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:m}){const s=t,n=m,d=N({get:()=>s.visible,set:a=>n("update:visible",a)}),v=x("");W(()=>s.visible,a=>{a&&(v.value="")});const g=()=>{const a=v.value.trim();n("confirm",a),d.value=!1};return(a,i)=>(k(),_(ve,{visible:d.value,"onUpdate:visible":i[2]||(i[2]=f=>d.value=f),title:"发送语音"},{footer:Z(()=>[e("button",{class:"modal-btn cancel",onClick:i[1]||(i[1]=f=>d.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:g},"发送")]),default:Z(()=>[X(e("input",{type:"text",class:"base-input","onUpdate:modelValue":i[0]||(i[0]=f=>v.value=f),placeholder:"输入语音内容..."},null,512),[[se,v.value]])]),_:1},8,["visible"]))}},Qs={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:m}){const s=t,n=m,d=N({get:()=>s.visible,set:i=>n("update:visible",i)}),v=x(""),g=x("");W(()=>s.visible,i=>{i&&(v.value="",g.value="")});const a=()=>{const i=v.value.trim(),f=g.value.trim();i&&(n("confirm",{name:i,detail:f}),d.value=!1)};return(i,f)=>(k(),_(ve,{visible:d.value,"onUpdate:visible":f[3]||(f[3]=h=>d.value=h),title:"发送位置"},{footer:Z(()=>[e("button",{class:"modal-btn cancel",onClick:f[2]||(f[2]=J(h=>d.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:a},"发送")]),default:Z(()=>[X(e("input",{type:"text",class:"base-input","onUpdate:modelValue":f[0]||(f[0]=h=>v.value=h),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[se,v.value]]),X(e("input",{type:"text",class:"base-input","onUpdate:modelValue":f[1]||(f[1]=h=>g.value=h),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[se,g.value]])]),_:1},8,["visible"]))}},Ks={class:"chat-list-container"},Xs=["onClick"],Zs=["src"],_s={class:"chat-info"},en={class:"chat-name"},tn=["disabled"],sn={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:m}){const s=t,n=m,d=ee(),v=x(s.visible),g=x(new Set),a=N(()=>d.characters);W(()=>s.visible,h=>{v.value=h,h||g.value.clear()});const i=h=>{g.value.has(h)?g.value.delete(h):g.value.add(h)},f=()=>{g.value.size>0&&n("confirm",Array.from(g.value))};return(h,o)=>(k(),_(ve,{visible:v.value,"onUpdate:visible":o[1]||(o[1]=u=>v.value=u),title:"选择聊天",onClose:o[2]||(o[2]=u=>h.$emit("close"))},{footer:Z(()=>[e("button",{class:"modal-btn cancel",onClick:o[0]||(o[0]=u=>h.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:g.value.size===0,onClick:f}," 确定 ("+M(g.value.size)+") ",9,tn)]),default:Z(()=>[e("div",Ks,[(k(!0),w(Y,null,de(a.value,u=>(k(),w("div",{key:u.id,class:"chat-item",onClick:p=>i(u.id)},[e("img",{src:u.avatar,alt:"avatar",class:"avatar"},null,8,Zs),e("div",_s,[e("div",en,M(u.name),1)]),e("div",{class:O(["checkbox",{selected:g.value.has(u.id)}])},null,2)],8,Xs))),128))])]),_:1},8,["visible"]))}},nn=Q(sn,[["__scopeId","data-v-00bcf675"]]),on={class:"note-container"},an={key:0,class:"content-wrapper"},ln={class:"note-header current-header"},rn=["src"],cn={key:1,class:"avatar-placeholder"},dn={class:"character-name"},un={class:"content-body"},vn={class:"status-section"},gn={class:"status-row"},mn={class:"status-value"},fn={class:"status-row"},pn={class:"status-value"},hn={class:"status-row"},kn={class:"status-value"},bn={class:"inner-voice-section"},Sn={class:"inner-voice-box"},yn={class:"unspoken-section"},Mn={class:"unspoken-text"},wn={key:1,class:"content-wrapper history-wrapper"},$n={class:"note-header history-header"},Cn={class:"scroll-container"},Tn={class:"item-header"},xn={class:"header-left"},In=["onClick"],An={key:0,viewBox:"0 0 24 24",width:"16",height:"16",fill:"#f39c12",stroke:"#f39c12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Pn={key:1,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"#ccc","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Rn={class:"header-right"},Bn={class:"item-date"},Ln=["onClick"],Vn={class:"prop-row"},Dn={class:"prop-row"},En={class:"prop-row"},qn={class:"prop-row"},Un={class:"prop-row"},Nn={__name:"SingleCharStatus",props:{visible:{type:Boolean,default:!1},name:{type:String,default:""},avatar:{type:String,default:""},charId:{type:String,required:!0}},emits:["close"],setup(t,{emit:m}){const s=t,n=ee(),d=oe(),{currentInnerVoice:v,innerVoices:g}=ut(n),a=N(()=>v.value[s.charId]||{emotion:"",outfit:"",posture:"",innerVoice:"",unspokenWords:""}),i=N(()=>g.value[s.charId]||[]),f=I=>n.favorites?n.favorites.some(r=>String(r.charId)===String(s.charId)&&r.type==="thoughts"&&r.originalId===I.id):!1,h=I=>{n.toggleThoughtFavorite(s.charId,I)},o=I=>{d.showConfirm("删除心声","确定要删除这条心声记录吗？",()=>{n.deleteInnerVoice(s.charId,I.id)})},u=I=>I?new Date(I).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"."):"",p=m,c=x(!1),l=()=>{c.value=!c.value};W(()=>s.visible,I=>{I?(document.body.style.overflow="hidden",c.value=!1):document.body.style.overflow=""});const b=()=>{p("close")};return(I,r)=>t.visible?(k(),w("div",{key:0,class:"note-modal-mask",onClick:J(b,["self"])},[e("div",on,[e("div",{class:"tape-button",onClick:l}),e("div",{class:O(["note",{"history-mode":c.value}])},[r[13]||(r[13]=e("div",{class:"paper-texture"},null,-1)),c.value?(k(),w("div",wn,[e("div",$n,[r[5]||(r[5]=e("div",{class:"header-title"},"历史心声",-1)),e("button",{class:"close-btn",onClick:b},[j(te,{name:"x-mark"})])]),e("div",Cn,[(k(!0),w(Y,null,de(i.value,A=>(k(),w("div",{key:A.id,class:"history-item"},[e("div",Tn,[e("div",xn,[e("button",{class:"star-btn",onClick:J(V=>h(A),["stop"])},[f(A)?(k(),w("svg",An,[...r[6]||(r[6]=[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"},null,-1)])])):(k(),w("svg",Pn,[...r[7]||(r[7]=[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"},null,-1)])]))],8,In),e("span",null,M(A.title),1)]),e("div",Rn,[e("span",Bn,M(u(A.timestamp)),1),e("button",{class:"delete-btn",onClick:J(V=>o(A),["stop"])},[j(te,{name:"x-mark"})],8,Ln)])]),e("div",Vn,[r[8]||(r[8]=e("span",{class:"prop-label"},"情绪：",-1)),re(M(A.emotion),1)]),e("div",Dn,[r[9]||(r[9]=e("span",{class:"prop-label"},"穿着：",-1)),re(M(A.outfit),1)]),e("div",En,[r[10]||(r[10]=e("span",{class:"prop-label"},"姿态：",-1)),re(M(A.posture),1)]),e("div",qn,[r[11]||(r[11]=e("span",{class:"prop-label"},"内心独白：",-1)),re(M(A.innerVoice),1)]),e("div",Un,[r[12]||(r[12]=e("span",{class:"prop-label"},"没说出口的话：",-1)),re(M(A.unspokenWords),1)])]))),128))])])):(k(),w("div",an,[e("div",ln,[t.avatar?(k(),w("img",{key:0,src:t.avatar,class:"avatar-img",alt:"avatar"},null,8,rn)):(k(),w("div",cn,M(t.name?t.name.charAt(0):"?"),1)),e("div",dn,M(t.name),1),e("button",{class:"close-btn",onClick:b},[j(te,{name:"x-mark"})])]),e("div",un,[e("div",vn,[e("div",gn,[r[0]||(r[0]=e("span",{class:"status-label"},"情绪",-1)),e("span",mn,M(a.value.emotion||"无"),1)]),e("div",fn,[r[1]||(r[1]=e("span",{class:"status-label"},"穿着",-1)),e("span",pn,M(a.value.outfit||"无"),1)]),e("div",hn,[r[2]||(r[2]=e("span",{class:"status-label"},"姿态",-1)),e("span",kn,M(a.value.posture||"无"),1)])]),e("div",bn,[r[3]||(r[3]=e("div",{class:"section-title"},"Inner Voice",-1)),e("div",Sn,[e("p",null,M(a.value.innerVoice||"（没有内心独白）"),1)])]),e("div",yn,[r[4]||(r[4]=e("div",{class:"unspoken-title"},"没说出口的话",-1)),e("div",Mn,M(a.value.unspokenWords||"（没有想说的话）"),1)])])])),r[14]||(r[14]=e("div",{class:"torn-edge"},null,-1))],2)])])):z("",!0)}},Fn=Q(Nn,[["__scopeId","data-v-8a1bd83a"]]),jn={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const m=t,s=be(),{t:n}=ae(),d=ee(),v=oe(),g=vt(),a=gt(),i=x(null),f=x(null),h=x(null),o=x(!1),u=x({visible:!1,messageId:null,targetEl:null}),p=x(!1),c=x(!1),l=x(!1),b=x(!1);x("");const I=x(!1),r=N(()=>d.getCharacter(m.charId)),A=N(()=>{var $;return(($=r.value)==null?void 0:$.isBlocked)||!1}),V=N(()=>{var $,y;return(($=r.value)==null?void 0:$.nickname)||((y=r.value)==null?void 0:y.name)||n("chat.unknownCharacter")}),G=N(()=>{var $;return(($=r.value)==null?void 0:$.name)||n("chat.unknownCharacter")}),P=N(()=>{var $;return($=r.value)==null?void 0:$.avatar}),R=N(()=>{var $;return(($=r.value)==null?void 0:$.status)||{}}),S=N(()=>{var $;return(($=r.value)==null?void 0:$.chatBackground)||""}),T=N(()=>{const $=r.value;if(!$||!$.userPersona)return"";const y=d.userPersonas.find(E=>E.id===$.userPersona);return(y==null?void 0:y.avatar)||""}),F=N(()=>d.messages[m.charId]||[]),B=N(()=>{var $;return(($=r.value)==null?void 0:$.bubbleSettings)||{}}),{isSelectionMode:q,selectedMessageIds:L,isForwarding:U,enterSelectionMode:D,exitSelectionMode:K,toggleMessageSelection:H,handleBatchAction:ne,handleConfirmForward:ie}=pt(me(m,"charId")),{isTyping:Ie,triggerAiResponse:ye}=kt(me(m,"charId"),g),{inputText:ge,quotingMessage:fe,sendMessage:Ae,sendSticker:Pe,sendVoiceMessage:Re,handleSendImage:Be,confirmSendLocation:Le,sendTransfer:Ve}=St(d,me(m,"charId"),v,h),{editingMessageId:Me,handleEditMessage:De,handleSaveEdit:Ee,updateInputText:qe}=bt(d,me(m,"charId"),ge),{startLongPress:Ue,cancelLongPress:Ne,handleTouchMove:Fe,wasClickAfterLongPress:je}=yt(u),ze=N(()=>{const $=B.value,y={fontSize:$.fontSize?`${$.fontSize}px`:"14px"};if($.css){const E={};return $.css.split(";").forEach(le=>{const pe=le.split(":");if(pe.length>=2){const we=pe[0].trim(),$e=pe.slice(1).join(":").trim();we&&$e&&(E[we]=$e)}}),{...y,...E}}return y});W(o,$=>{$&&(s.push({name:"single-chat-settings",params:{id:m.charId}}),o.value=!1)}),W(()=>{var $;return($=d.messages[m.charId])==null?void 0:$.length},()=>{d.clearUnreadCount(m.charId)}),Se(()=>{d.clearUnreadCount(m.charId)});const Oe=()=>{r.value&&(r.value.isBlocked=!1,d.messages[m.charId]&&d.messages[m.charId].forEach($=>{$.blocked&&($.blocked=!1)}),d.saveData(),v.showToast(n("chat.toast.unblocked")))},He=$=>{const y=$.target;y.closest(".modal-overlay.active")||(h.value&&!y.closest(".chat-footer")&&(h.value=null),q.value&&!y.closest(".message")&&!y.closest(".chat-action-row")&&!y.closest(".message-checkbox")&&!y.closest(".message-menu")&&K(),u.value.visible&&!y.closest(".message-menu")&&(u.value.visible=!1))},We=($,y)=>{if(je()){$.preventDefault(),$.stopPropagation();return}q.value&&H(y)},Ge=$=>{const y=F.value.find(E=>E.id===$);y&&(fe.value=y)},Je=()=>{c.value=!0},Ye=$=>{Re($),c.value=!1},Qe=()=>{h.value=null,p.value=!0},Ke=()=>{l.value=!0},Xe=({name:$,detail:y})=>{Le($,y),l.value=!1},Ze=()=>{d.startVideoCall(m.charId,"user")},_e=()=>{b.value=!0},et=()=>{I.value=!0},tt=({amount:$,note:y})=>{a.consume($,`转账 - 转给 ${V.value}`)?(Ve($,y),I.value=!1):v.showToast("余额不足","error")},st=$=>{const y=F.value.find(le=>le.id===$),E=(y==null?void 0:y.status)==="pending"||(y==null?void 0:y.status)===void 0;if(y&&y.type==="transfer"&&E){if(y.sender!=="user"){const le=parseFloat(y.content);a.income(le,`转账 - 来自 ${V.value} `)?d.acceptTransfer(m.charId,$):v.showToast("收款失败","error")}}else d.acceptTransfer(m.charId,$)};return($,y)=>(k(),w("div",{class:O(["chat-room active",{"selection-mode":C(q)}]),onClick:He,ref_key:"chatRoomRef",ref:f},[e("div",{class:"chat-bg",style:ue(S.value?{backgroundImage:`url(${S.value})`}:{})},null,4),j(Pt,{charId:m.charId,charName:V.value,charStatus:R.value,isTyping:C(Ie),onTriggerAi:C(ye),onOpenSettings:y[0]||(y[0]=E=>o.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),j(Js,{ref_key:"messageListRef",ref:i,messages:F.value,charName:V.value,charAvatar:P.value,userAvatar:T.value,bubbleStyle:ze.value,isSelectionMode:C(q),selectedMessageIds:C(L),isBlocked:A.value,editingMessageId:C(Me),activePanel:h.value,onSaveEdit:C(Ee),onCancelEdit:y[1]||(y[1]=E=>Me.value=null),onToggleSelection:C(H),onLongPress:C(Ue),onCancelLongPress:C(Ne),onTouchMove:C(Fe),onClickMsg:We,onUnblock:Oe,onShowThought:_e,onAcceptTransfer:st},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),C(q)?z("",!0):(k(),_(as,{key:0,modelValue:C(ge),"onUpdate:modelValue":y[2]||(y[2]=E=>mt(ge)?ge.value=E:null),activePanel:h.value,"onUpdate:activePanel":y[3]||(y[3]=E=>h.value=E),charId:m.charId,quotingMessage:C(fe),onCancelQuote:y[4]||(y[4]=E=>fe.value=null),onSendMessage:C(Ae),onSendSticker:C(Pe),onTriggerVoice:Je,onTriggerImage:Qe,onTriggerVideo:Ze,onTriggerLocation:Ke,onTriggerTransfer:et},null,8,["modelValue","activePanel","charId","quotingMessage","onSendMessage","onSendSticker"])),C(q)?(k(),_(us,{key:1,onAction:C(ne),onCancel:C(K)},null,8,["onAction","onCancel"])):z("",!0),j(Ys,{visible:c.value,"onUpdate:visible":y[5]||(y[5]=E=>c.value=E),onConfirm:Ye},null,8,["visible"]),j(Te,{visible:p.value,"onUpdate:visible":y[6]||(y[6]=E=>p.value=E),onSendImage:C(Be)},null,8,["visible","onSendImage"]),j(Qs,{visible:l.value,"onUpdate:visible":y[7]||(y[7]=E=>l.value=E),onConfirm:Xe},null,8,["visible"]),j(rs,{visible:u.value.visible,targetEl:u.value.targetEl,messageId:u.value.messageId,charId:m.charId,isSelectionMode:C(q),selectedMessageIds:C(L),onClose:y[8]||(y[8]=E=>u.value.visible=!1),onEnterSelectionMode:C(D),onTriggerAiResponse:C(ye),"onUpdate:inputText":C(qe),onQuoteMessage:Ge,onEditMessage:C(De)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),j(nn,{visible:C(U),onClose:y[9]||(y[9]=E=>U.value=!1),onConfirm:C(ie)},null,8,["visible","onConfirm"]),j(Fn,{visible:b.value,name:G.value,avatar:P.value,charId:m.charId,onClose:y[10]||(y[10]=E=>b.value=!1)},null,8,["visible","name","avatar","charId"]),j(ft,{visible:I.value,"onUpdate:visible":y[11]||(y[11]=E=>I.value=E),targetName:V.value,targetAvatar:P.value,onConfirm:tt},null,8,["visible","targetName","targetAvatar"])],2))}},Hn=Q(jn,[["__scopeId","data-v-486af9ec"]]);export{Hn as default};
