import{_ as Q,k as W,B as X,Z as ee,r as l,m as te,c as F,b as se,w as r,e as ae,x as oe,q as ne,o as g,i as t,f as c,g as D,t as b,G as le,H as ie,S as y,j as re,p as $,F as I}from"./index-eUNPqr_s.js";const ce={class:"header-actions"},ue={class:"memory-bank-content"},de={class:"memory-scroll-container"},ve={key:0,class:"empty-state"},me={class:"empty-text"},fe={key:1,class:"memory-list"},pe={class:"card-header-row"},he={class:"header-left"},ge={class:"char-info",style:{"padding-left":"8px"}},be={class:"char-name"},ye={class:"save-time"},_e={class:"header-right"},xe=["onClick"],Me=["onClick"],ke=["onClick","title"],Se={class:"card-content-row"},we={class:"refine-range-info"},Ce={class:"refine-range-inputs"},Fe={__name:"SingleMemoryBank",setup(De){const j=te();oe();const d=W(),v=X(),A=ee(),T=l(j.params.charId),R=l(!1),p=l(!1),m=l(-1),i=l(""),_=l(!1),x=l(-1),M=l(!1),h=l(""),k=l(1),S=l(0),f=F(()=>d.getCharacter(T.value)),n=F(()=>{var s;return((s=f.value)==null?void 0:s.memories)||[]}),B=F(()=>{var s;return((s=f.value)==null?void 0:s.name)||"角色"}),N=F(()=>[...R.value?n.value.filter(e=>e.isFavorite):n.value].sort((e,o)=>(o.time||0)-(e.time||0))),U=()=>{p.value=!1,i.value=""},V=()=>{_.value=!1,x.value=-1},P=()=>{M.value=!1},E=s=>{if(!s)return"";const e=new Date(s);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},G=()=>{m.value=-1,i.value="",p.value=!0},H=s=>{const e=n.value.findIndex(o=>o.id===s.id);e!==-1&&(m.value=e,i.value=s.content,p.value=!0)},O=()=>{if(!i.value.trim())return;const s=f.value;if(s.memories||(s.memories=[]),m.value>=0){const e=s.memories[m.value];typeof e=="string"?s.memories[m.value]={content:i.value,time:Date.now(),charName:s.name,isFavorite:!1}:e.content=i.value}else s.memories.unshift({content:i.value,time:Date.now(),charName:s.name,isFavorite:!1});d.saveData(),U()},q=s=>{const e=n.value.findIndex(o=>o.id===s.id);e!==-1&&(x.value=e,_.value=!0)},z=()=>{x.value>=0&&(f.value.memories.splice(x.value,1),d.saveData()),V()},L=s=>{const e=n.value.find(o=>o.id===s.id);if(e)if(typeof e=="string"){const o=n.value.indexOf(e),a={content:e,time:Date.now(),charName:B.value,isFavorite:!1};n.value[o]=a,d.toggleMemoryFavorite(T.value,a)}else d.toggleMemoryFavorite(T.value,e)},Y=()=>{h.value=f.value.memorySummaryPrompt||"",k.value=1,S.value=n.value.length,M.value=!0},Z=async()=>{const s=f.value;if(!s)return;const e=n.value.length,o=Math.max(1,k.value),a=Math.min(e,S.value);if(o>a){v.showToast("起始范围不能大于结束范围","error");return}s.memorySummaryPrompt=h.value,v.showToast("正在提炼记忆...","info"),P();const w=n.value.slice(o-1,a);if(w.length===0){v.showToast("选定范围内没有记忆可供提炼","warn");return}const C=w.map(u=>u.content).join(`
---
`),J=h.value||"请总结以下内容，提取关键信息。",K=[{role:"system",content:"你是一个记忆总结助手。"},{role:"user",content:`现有记忆如下：
${C}

请根据以下要求进行总结：
${J}`}];try{const u=await A.getGenericCompletion(K);u?(s.memories||(s.memories=[]),s.memories.unshift({content:`[记忆再总结] ${u}`,time:Date.now(),charName:s.name,isFavorite:!1}),d.saveData(),v.showToast("记忆提炼已完成","success")):v.showToast("提炼失败，未收到有效回复","error")}catch(u){console.error("记忆提炼失败:",u),v.showToast(`提炼失败: ${u.message}`,"error")}};return(s,e)=>{const o=ne("Modal");return g(),se(ae,{title:"长期记忆"},{action:r(()=>[t("div",ce,[t("button",{class:"icon-btn",onClick:Y,title:"提炼"},[c(y,{name:"Sparkles"})]),t("button",{class:"icon-btn",onClick:G,title:"添加"},[c(y,{name:"plus"})])])]),default:r(()=>[t("div",ue,[t("div",de,[!N.value||N.value.length===0?(g(),D("div",ve,[t("div",me,b(R.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(g(),D("div",fe,[(g(!0),D(le,null,ie(N.value,(a,w)=>(g(),D("div",{key:a.id||w,class:"card memory-card"},[t("div",pe,[t("div",he,[t("div",ge,[t("span",be,b(a.charName||B.value),1),t("span",ye,b(E(a.time)),1)])]),t("div",_e,[t("button",{class:"icon-btn",onClick:C=>H(a),title:"编辑"},[c(y,{name:"pencil"})],8,xe),t("button",{class:"icon-btn danger",onClick:C=>q(a),title:"删除"},[c(y,{name:"trash"})],8,Me),t("button",{class:"icon-btn favorite-btn",onClick:C=>L(a),title:a.isFavorite?"取消收藏":"收藏"},[c(y,{name:a.isFavorite?"heart-solid":"heart",class:re({"is-favorite":a.isFavorite})},null,8,["name","class"])],8,ke)])]),t("div",Se,b(a.content),1)]))),128))]))])]),c(o,{visible:p.value,"onUpdate:visible":e[1]||(e[1]=a=>p.value=a),title:m.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:r(()=>[t("button",{class:"modal-btn cancel",onClick:U},"取消"),t("button",{class:"modal-btn confirm",onClick:O},"确定")]),default:r(()=>[$(t("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[0]||(e[0]=a=>i.value=a),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[I,i.value]])]),_:1},8,["visible","title"]),c(o,{visible:_.value,"onUpdate:visible":e[2]||(e[2]=a=>_.value=a),title:"确认删除",class:"nested"},{footer:r(()=>[t("button",{class:"modal-btn cancel",onClick:V},"取消"),t("button",{class:"modal-btn confirm danger",onClick:z},"确认删除")]),default:r(()=>[e[7]||(e[7]=t("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),c(o,{visible:M.value,"onUpdate:visible":e[6]||(e[6]=a=>M.value=a),title:"记忆提炼",class:"nested"},{footer:r(()=>[t("button",{class:"modal-btn cancel",onClick:P},"取消"),t("button",{class:"modal-btn confirm",onClick:Z},"开始提炼")]),default:r(()=>[t("div",we," 当前共有 "+b(n.value.length)+" 条记忆。 ",1),t("div",Ce,[e[8]||(e[8]=t("label",{for:"refine-start"},"从第",-1)),$(t("input",{id:"refine-start",type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>k.value=a),class:"base-input range-input"},null,512),[[I,k.value,void 0,{number:!0}]]),e[9]||(e[9]=t("label",{for:"refine-end"},"条 到 第",-1)),$(t("input",{id:"refine-end",type:"number","onUpdate:modelValue":e[4]||(e[4]=a=>S.value=a),class:"base-input range-input"},null,512),[[I,S.value,void 0,{number:!0}]]),e[10]||(e[10]=t("label",null,"条",-1))]),e[11]||(e[11]=t("p",{class:"summary-tip"},"将对选定范围内的长期记忆进行再总结。",-1)),$(t("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[5]||(e[5]=a=>h.value=a),placeholder:"输入总结提示词...",style:{height:"100px"}},null,512),[[I,h.value]])]),_:1},8,["visible"])]),_:1})}}},Ie=Q(Fe,[["__scopeId","data-v-f20b79fb"]]);export{Ie as default};
