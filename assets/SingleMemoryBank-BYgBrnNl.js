import{_ as Z,m as ee,q as te,Q as se,r as l,u as ae,c as $,d as oe,w as u,a2 as ne,i as le,g as ie,o as y,e as s,f as r,a as I,z as k,F as re,A as ce,S as m,n as ue,v as T,x as N}from"./index-pecgbHBA.js";const ve={class:"header-actions"},de={class:"memory-bank-content"},me={class:"memory-scroll-container"},fe={key:0,class:"empty-state"},pe={class:"empty-text"},be={key:1,class:"memory-list"},he={class:"card-header-row"},ge={class:"header-left"},_e={class:"sort-buttons"},ye=["onClick","disabled"],ke=["onClick","disabled"],we={class:"char-info"},Se={class:"char-name"},Me={class:"save-time"},Ce={class:"header-right"},xe=["onClick"],De=["onClick"],Fe=["onClick","title"],$e={class:"card-content-row"},Ie={class:"refine-range-info"},Te={class:"refine-range-inputs"},Ne={__name:"SingleMemoryBank",setup(Re){const P=ae();le();const f=ee(),p=te(),z=se(),E=l(P.params.charId),w=l(!1),g=l(!1),b=l(-1),c=l(""),S=l(!1),M=l(-1),C=l(!1),_=l(""),x=l(1),D=l(0),i=$(()=>f.getCharacter(E.value)),o=$(()=>{var t;return((t=i.value)==null?void 0:t.memories)||[]}),U=$(()=>{var t;return((t=i.value)==null?void 0:t.name)||"角色"}),R=$(()=>w.value?o.value.filter(t=>t.isFavorite):o.value),B=()=>{g.value=!1,c.value=""},V=()=>{S.value=!1,M.value=-1},A=()=>{C.value=!1},j=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},v=t=>o.value.indexOf(t),q=()=>{b.value=-1,c.value="",g.value=!0},G=t=>{b.value=t;const e=o.value[t];c.value=typeof e=="string"?e:e.content,g.value=!0},H=()=>{if(!c.value.trim())return;const t=i.value;if(t.memories||(t.memories=[]),b.value>=0){const e=t.memories[b.value];typeof e=="string"?t.memories[b.value]={content:c.value,time:Date.now(),charName:t.name,isFavorite:!1}:e.content=c.value}else t.memories.unshift({content:c.value,time:Date.now(),charName:t.name,isFavorite:!1});f.saveData(),B()},L=t=>{M.value=t,S.value=!0},Q=()=>{M.value>=0&&(i.value.memories.splice(M.value,1),f.saveData()),V()},O=(t,e)=>{const n=t+e;if(n<0||n>=o.value.length)return;const a=i.value.memories[t];i.value.memories[t]=i.value.memories[n],i.value.memories[n]=a,f.saveData()},Y=t=>{const e=o.value[t];typeof e=="string"?o.value[t]={content:e,time:Date.now(),charName:U.value,isFavorite:!0}:e.isFavorite=!e.isFavorite,f.saveData()},J=()=>{_.value=i.value.memorySummaryPrompt||"",x.value=1,D.value=o.value.length,C.value=!0},K=async()=>{const t=i.value;if(!t)return;const e=o.value.length,n=Math.max(1,x.value),a=Math.min(e,D.value);if(n>a){p.showToast("起始范围不能大于结束范围","error");return}t.memorySummaryPrompt=_.value,p.showToast("正在提炼记忆...","info"),A();const F=o.value.slice(n-1,a);if(F.length===0){p.showToast("选定范围内没有记忆可供提炼","warn");return}const h=F.map(d=>d.content).join(`
---
`),W=_.value||"请总结以下内容，提取关键信息。",X=[{role:"system",content:"你是一个记忆总结助手。"},{role:"user",content:`现有记忆如下：
${h}

请根据以下要求进行总结：
${W}`}];try{const d=await z.getGenericCompletion(X);d?(t.memories||(t.memories=[]),t.memories.unshift({content:`[记忆再总结] ${d}`,time:Date.now(),charName:t.name,isFavorite:!1}),f.saveData(),p.showToast("记忆提炼已完成","success")):p.showToast("提炼失败，未收到有效回复","error")}catch(d){console.error("记忆提炼失败:",d),p.showToast(`提炼失败: ${d.message}`,"error")}};return(t,e)=>{const n=ie("Modal");return y(),oe(ne,{title:"长期记忆"},{action:u(()=>[s("div",ve,[s("button",{class:"icon-btn",onClick:J,title:"提炼"},[r(m,{name:"Sparkles"})]),s("button",{class:"icon-btn",onClick:q,title:"添加"},[r(m,{name:"plus"})])])]),default:u(()=>[s("div",de,[s("div",me,[!R.value||R.value.length===0?(y(),I("div",fe,[s("div",pe,k(w.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(y(),I("div",be,[(y(!0),I(re,null,ce(R.value,(a,F)=>(y(),I("div",{key:a.id||F,class:"card memory-card"},[s("div",he,[s("div",ge,[s("div",_e,[s("button",{class:"icon-btn sort-btn",onClick:h=>O(v(a),-1),disabled:v(a)===0||w.value,title:"上移"},[r(m,{name:"arrow-up"})],8,ye),s("button",{class:"icon-btn sort-btn",onClick:h=>O(v(a),1),disabled:v(a)===o.value.length-1||w.value,title:"下移"},[r(m,{name:"arrow-down"})],8,ke)]),s("div",we,[s("span",Se,k(a.charName||U.value),1),s("span",Me,k(j(a.time)),1)])]),s("div",Ce,[s("button",{class:"icon-btn",onClick:h=>G(v(a)),title:"编辑"},[r(m,{name:"pencil"})],8,xe),s("button",{class:"icon-btn danger",onClick:h=>L(v(a)),title:"删除"},[r(m,{name:"trash"})],8,De),s("button",{class:"icon-btn favorite-btn",onClick:h=>Y(v(a)),title:a.isFavorite?"取消收藏":"收藏"},[r(m,{name:a.isFavorite?"heart-solid":"heart",class:ue({"is-favorite":a.isFavorite})},null,8,["name","class"])],8,Fe)])]),s("div",$e,k(a.content),1)]))),128))]))])]),r(n,{visible:g.value,"onUpdate:visible":e[1]||(e[1]=a=>g.value=a),title:b.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:u(()=>[s("button",{class:"modal-btn cancel",onClick:B},"取消"),s("button",{class:"modal-btn confirm",onClick:H},"确定")]),default:u(()=>[T(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[0]||(e[0]=a=>c.value=a),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[N,c.value]])]),_:1},8,["visible","title"]),r(n,{visible:S.value,"onUpdate:visible":e[2]||(e[2]=a=>S.value=a),title:"确认删除",class:"nested"},{footer:u(()=>[s("button",{class:"modal-btn cancel",onClick:V},"取消"),s("button",{class:"modal-btn confirm danger",onClick:Q},"确认删除")]),default:u(()=>[e[7]||(e[7]=s("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),r(n,{visible:C.value,"onUpdate:visible":e[6]||(e[6]=a=>C.value=a),title:"记忆提炼",class:"nested"},{footer:u(()=>[s("button",{class:"modal-btn cancel",onClick:A},"取消"),s("button",{class:"modal-btn confirm",onClick:K},"开始提炼")]),default:u(()=>[s("div",Ie," 当前共有 "+k(o.value.length)+" 条记忆。 ",1),s("div",Te,[e[8]||(e[8]=s("label",{for:"refine-start"},"从第",-1)),T(s("input",{id:"refine-start",type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>x.value=a),class:"base-input range-input"},null,512),[[N,x.value,void 0,{number:!0}]]),e[9]||(e[9]=s("label",{for:"refine-end"},"条 到 第",-1)),T(s("input",{id:"refine-end",type:"number","onUpdate:modelValue":e[4]||(e[4]=a=>D.value=a),class:"base-input range-input"},null,512),[[N,D.value,void 0,{number:!0}]]),e[10]||(e[10]=s("label",null,"条",-1))]),e[11]||(e[11]=s("p",{class:"summary-tip"},"将对选定范围内的长期记忆进行再总结。",-1)),T(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[5]||(e[5]=a=>_.value=a),placeholder:"输入总结提示词...",style:{height:"100px"}},null,512),[[N,_.value]])]),_:1},8,["visible"])]),_:1})}}},Be=Z(Ne,[["__scopeId","data-v-aa0eb456"]]);export{Be as default};
