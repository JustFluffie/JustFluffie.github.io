import{m as ye,q as we,r as d,D as Fe,_ as ae,E as ot,c as N,g as wt,a as y,o as h,f as T,w as O,e,z as a,F as ve,A as Ve,S as X,n as q,v as F,x as j,k as Me,y as s,h as Xe,M as De,i as Je,b as H,G as Ye,C as Se,I as Ze,t as le,d as fe,H as Mt,J as $t,L as _t,N as at,O as It,s as et,T as be,P as xt,Q as Tt,B as Ue,R as qe,U as Pt,V as Bt}from"./index-C3urrqsp.js";import{C as Qe}from"./CustomSelect-CZHKmuYX.js";import{M as nt}from"./MultiSelect-DaE8m0qu.js";function At(n){const k=ye(),p=we(),o=d(!1),t=d(new Set),u=d(!1),l=S=>{console.log("[useMessageSelection] enterSelectionMode triggered"),o.value=!0,t.value.clear(),S&&t.value.add(S)},c=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),o.value=!1,t.value.clear()};return{isSelectionMode:o,selectedMessageIds:t,isForwarding:u,enterSelectionMode:l,exitSelectionMode:c,toggleMessageSelection:S=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${S}`),t.value.has(S)?t.value.delete(S):t.value.add(S)},handleBatchAction:S=>{if(console.log(`[useMessageSelection] handleBatchAction: ${S}`),t.value.size===0)return;const U=k.messages[n.value];S==="forward"?u.value=!0:S==="delete"?p.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),k.messages[n.value]=U.filter(b=>!t.value.has(b.id)),k.saveData(),c()}):S==="favorite"&&(k.favorites||(k.favorites=[]),U.forEach(b=>{t.value.has(b.id)&&(k.favorites.some(_=>_.id===b.id)||k.favorites.push(b))}),k.saveData(),p.showToast("已收藏","success"),c())},handleConfirmForward:S=>{console.log("[useMessageSelection] handleConfirmForward triggered"),u.value=!1;const b=(k.messages[n.value]||[]).filter(_=>t.value.has(_.id));b.length!==0&&(S.forEach(_=>{k.messages[_]||(k.messages[_]=[]),b.forEach(w=>{const f={...w,id:Date.now().toString()+Math.random()};k.messages[_].push(f)})}),k.saveData(),p.showToast(`已转发 ${b.length} 条消息`),c())}}}function Ut(n,k,p){const o=d(null);return{editingMessageId:o,handleEditMessage:c=>{console.log("[useMessageEditing] handleEditMessage for msgId:",c),o.value=c},handleSaveEdit:({msgId:c,newContent:C})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",c);const r=n.messages[k.value].find(S=>S.id===c);r&&(r.content=C,n.saveData()),o.value=null},updateInputText:c=>{console.log("[useMessageEditing] updateInputText called"),p&&(p.value=c,Fe(()=>{const C=document.querySelector(".chat-input");C&&C.focus()}))}}}function Vt(n,k,p,o){const t=d(""),u=d(null),l=(b,_,w={})=>{console.log(`[useMessageSender] sendMsg called with type: ${b}`);const f={...w};u.value&&(f.quote={id:u.value.id,sender:u.value.sender,content:u.value.content}),n.messages[k.value]||(n.messages[k.value]=[]),n.messages[k.value].push({id:Date.now().toString()+Math.random(),sender:"user",type:b,content:_,time:Date.now(),...f}),n.saveData(),o&&(o.value=null),u.value=null};return{inputText:t,quotingMessage:u,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const b=t.value.trim();b&&(l("text",b),t.value="")},sendMsg:l,sendSticker:b=>{console.log("[useMessageSender] sendSticker triggered"),l("sticker",b.url,{name:b.name})},sendVoiceMessage:b=>{console.log("[useMessageSender] sendVoiceMessage triggered"),b&&l("voice",b)},handleSendImage:b=>{console.log("[useMessageSender] handleSendImage triggered"),b.isTextGenerated?l("image",b.description,{isTextGenerated:!0}):(b.type==="base64"||b.type==="url")&&l("image",b.content)},confirmSendLocation:(b,_)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!b){p.showToast("请输入位置名称","info");return}l("location",b,{detail:_})},sendTransfer:()=>{console.log("[useMessageSender] sendTransfer triggered"),l("transfer","88.88")}}}function Dt(n){const k=d(null),p=d(!1),o=d({x:0,y:0}),t=(m,r)=>{console.log("[useMessageInteraction] showMenu triggered"),m.preventDefault();const S=m.target.closest(".msg-bubble, .system-message-wrapper");S&&(n.value={visible:!0,messageId:r,targetEl:S})};return{startLongPress:(m,r)=>{console.log("[useMessageInteraction] startLongPress triggered"),m.stopPropagation(),p.value=!1,clearTimeout(k.value),m.type.startsWith("touch")&&(o.value={x:m.touches[0].clientX,y:m.touches[0].clientY}),k.value=setTimeout(()=>{p.value=!0,t(m,r)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(k.value)},handleTouchMove:m=>{console.log("[useMessageInteraction] handleTouchMove triggered");const r=m.touches[0],S=Math.abs(r.clientX-o.value.x),U=Math.abs(r.clientY-o.value.y);(S>10||U>10)&&clearTimeout(k.value)},wasClickAfterLongPress:()=>p.value?(p.value=!1,!0):!1}}const Lt={class:"memory-bank-wrapper"},Et={class:"memory-scroll-container"},Rt={key:0,class:"empty-state"},Nt={class:"empty-text"},qt={key:1,class:"memory-list"},Ft={class:"card-header-row"},zt={class:"header-left"},Ot={class:"sort-buttons"},jt=["onClick","disabled"],Ht=["onClick","disabled"],Wt={class:"char-info"},Gt={class:"char-name"},Kt={class:"save-time"},Qt={class:"header-right"},Yt=["onClick"],Xt=["onClick"],Jt=["onClick","title"],Zt={class:"card-content-row"},es={__name:"SingleMemoryBank",props:{visible:Boolean,charId:String},emits:["update:visible"],setup(n,{emit:k}){const p=n,o=k,t=ye(),u=we(),l=ot(),c=d(!1),C=d(!1),m=d(-1),r=d(""),S=d(!1),U=d(-1),b=d(!1),_=d(""),w=N(()=>t.getCharacter(p.charId)),f=N(()=>{var I;return((I=w.value)==null?void 0:I.memories)||[]}),L=N(()=>{var I;return((I=w.value)==null?void 0:I.name)||"角色"}),R=N(()=>c.value?f.value.filter(I=>I.isFavorite):f.value),E=()=>{o("update:visible",!1)},M=()=>{C.value=!1,r.value=""},G=()=>{S.value=!1,U.value=-1},D=()=>{b.value=!1},B=I=>{if(!I)return"";const P=new Date(I);return`${P.getFullYear()}/${(P.getMonth()+1).toString().padStart(2,"0")}/${P.getDate().toString().padStart(2,"0")} ${P.getHours().toString().padStart(2,"0")}:${P.getMinutes().toString().padStart(2,"0")}`},$=I=>f.value.indexOf(I),W=()=>{m.value=-1,r.value="",C.value=!0},J=I=>{m.value=I;const P=f.value[I];r.value=typeof P=="string"?P:P.content,C.value=!0},ne=()=>{if(!r.value.trim())return;const I=w.value;if(I.memories||(I.memories=[]),m.value>=0){const P=I.memories[m.value];typeof P=="string"?I.memories[m.value]={content:r.value,time:Date.now(),charName:I.name,isFavorite:!1}:P.content=r.value}else I.memories.unshift({content:r.value,time:Date.now(),charName:I.name,isFavorite:!1});t.saveData(),M()},ee=I=>{U.value=I,S.value=!0},ge=()=>{U.value>=0&&(w.value.memories.splice(U.value,1),t.saveData()),G()},te=(I,P)=>{const K=I+P;if(K<0||K>=f.value.length)return;const V=w.value.memories[I];w.value.memories[I]=w.value.memories[K],w.value.memories[K]=V,t.saveData()},me=I=>{const P=f.value[I];typeof P=="string"?f.value[I]={content:P,time:Date.now(),charName:L.value,isFavorite:!0}:P.isFavorite=!P.isFavorite,t.saveData()},de=()=>{_.value=w.value.memorySummaryPrompt||"",b.value=!0},se=async()=>{const I=w.value;if(!I)return;I.memorySummaryPrompt=_.value,u.showToast("正在总结记忆...","info"),D();const P=f.value.map(Q=>Q.content).join(`
---
`),K=_.value||"请总结以下内容，提取关键信息。",V=[{role:"system",content:"你是一个记忆总结助手。"},{role:"user",content:`现有记忆如下：
${P}

请根据以下要求进行总结：
${K}`}];try{const Q=await l.getGenericCompletion(V);Q?(I.memories||(I.memories=[]),I.memories.unshift({content:`[记忆再总结] ${Q}`,time:Date.now(),charName:I.name,isFavorite:!1}),t.saveData(),u.showToast("记忆总结已完成","success")):u.showToast("总结失败，未收到有效回复","error")}catch(Q){console.error("记忆总结失败:",Q)}};return(I,P)=>{const K=wt("Modal");return h(),y("div",Lt,[T(K,{visible:n.visible,"onUpdate:visible":E,containerClass:"memory-bank-modal-container",teleportTo:"#phone-screen-container"},{header:O(()=>[e("div",{class:"modal-header-content"},[P[5]||(P[5]=e("h3",null,"长期记忆",-1)),e("div",{class:"header-actions"},[e("button",{class:"btn summary-btn",onClick:de},"总结")])])]),footer:O(()=>[e("button",{class:"modal-btn primary-text",onClick:W},"+ 新增"),e("button",{class:"modal-btn cancel",onClick:E},"关闭")]),default:O(()=>[e("div",Et,[!R.value||R.value.length===0?(h(),y("div",Rt,[e("div",Nt,a(c.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(h(),y("div",qt,[(h(!0),y(ve,null,Ve(R.value,V=>(h(),y("div",{key:V.id||I.index,class:"card memory-card"},[e("div",Ft,[e("div",zt,[e("div",Ot,[e("button",{class:"icon-btn sort-btn",onClick:Q=>te($(V),-1),disabled:$(V)===0||c.value,title:"上移"},[T(X,{name:"arrow-up"})],8,jt),e("button",{class:"icon-btn sort-btn",onClick:Q=>te($(V),1),disabled:$(V)===f.value.length-1||c.value,title:"下移"},[T(X,{name:"arrow-down"})],8,Ht)]),e("div",Wt,[e("span",Gt,a(V.charName||L.value),1),e("span",Kt,a(B(V.time)),1)])]),e("div",Qt,[e("button",{class:"icon-btn",onClick:Q=>J($(V)),title:"编辑"},[T(X,{name:"pencil"})],8,Yt),e("button",{class:"icon-btn danger",onClick:Q=>ee($(V)),title:"删除"},[T(X,{name:"trash"})],8,Xt),e("button",{class:"icon-btn favorite-btn",onClick:Q=>me($(V)),title:V.isFavorite?"取消收藏":"收藏"},[T(X,{name:V.isFavorite?"heart-solid":"heart",class:q({"is-favorite":V.isFavorite})},null,8,["name","class"])],8,Jt)])]),e("div",Zt,a(V.content),1)]))),128))]))])]),_:1},8,["visible"]),T(K,{visible:C.value,"onUpdate:visible":P[1]||(P[1]=V=>C.value=V),title:m.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:M},"取消"),e("button",{class:"modal-btn confirm",onClick:ne},"确定")]),default:O(()=>[F(e("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":P[0]||(P[0]=V=>r.value=V),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[j,r.value]])]),_:1},8,["visible","title"]),T(K,{visible:S.value,"onUpdate:visible":P[2]||(P[2]=V=>S.value=V),title:"确认删除",class:"nested"},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:G},"取消"),e("button",{class:"modal-btn confirm danger",onClick:ge},"确认删除")]),default:O(()=>[P[6]||(P[6]=e("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),T(K,{visible:b.value,"onUpdate:visible":P[4]||(P[4]=V=>b.value=V),title:"记忆总结",class:"nested"},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:D},"取消"),e("button",{class:"modal-btn confirm",onClick:se},"开始总结")]),default:O(()=>[P[7]||(P[7]=e("p",{class:"summary-tip"},"将对现有长期记忆进行再总结。",-1)),F(e("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":P[3]||(P[3]=V=>_.value=V),placeholder:"输入总结提示词...",style:{height:"100px"}},null,512),[[j,_.value]])]),_:1},8,["visible"])])}}},lt=ae(es,[["__scopeId","data-v-6b1d3cd9"]]),ts={class:"chat-room-header"},ss={class:"left-icons"},as={class:"center-container"},ns={class:"header-title-area"},os={key:0,class:"chat-room-title"},ls={key:1,class:"typing-indicator"},is={class:"right-icons"},cs={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},rs=["placeholder"],ds=["placeholder"],us={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(n,{emit:k}){const p=n,{t:o}=Me(),t=Je(),u=ye(),l=we(),c=d(!1),C=d(""),m=d(""),r=d(!1),S=()=>{t.options.history.state.back?t.back():t.push("/chat")},U=()=>{const w=p.charStatus||{};C.value=w.icon||"✨",m.value=w.text||"",c.value=!0},b=()=>{const w=C.value.trim()||"✨",f=m.value.trim(),L=u.getCharacter(p.charId);L&&(f?L.status={icon:w,text:f}:L.status=null,u.saveData(),l.showToast(o("saveSuccess"))),c.value=!1},_=()=>{r.value=!0};return(w,f)=>(h(),y("div",ts,[e("div",ss,[e("div",{class:"btn-icon back-btn",onClick:S},[...f[7]||(f[7]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polyline",{points:"15 18 9 12 15 6"})],-1)])]),e("div",{class:"btn-icon bell-btn",onClick:f[0]||(f[0]=L=>w.$emit("trigger-ai")),ref:"bellBtn"},[...f[8]||(f[8]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)]),e("div",as,[e("div",ns,[n.isTyping?(h(),y("div",ls,[e("span",null,a(s(o)("chat.singleChat.typing")),1),f[9]||(f[9]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(h(),y("div",os,a(n.charName),1))]),e("div",{class:"chat-room-status",onClick:U},[e("span",null,a(n.charStatus.icon||"✨"),1),e("span",null,a(n.charStatus.text||s(o)("chat.singleChat.addStatus")),1)])]),e("div",is,[e("div",{class:"btn-icon memory-btn",onClick:_},[...f[10]||(f[10]=[Xe('<svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-495576d3><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" data-v-495576d3></path><polyline points="14 2 14 8 20 8" data-v-495576d3></polyline><line x1="16" y1="13" x2="8" y2="13" data-v-495576d3></line><line x1="16" y1="17" x2="8" y2="17" data-v-495576d3></line><polyline points="10 9 9 9 8 9" data-v-495576d3></polyline></svg>',1)])]),e("div",{class:"btn-icon more-btn",onClick:f[1]||(f[1]=L=>w.$emit("open-settings"))},[...f[11]||(f[11]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])]),T(De,{visible:c.value,"onUpdate:visible":f[5]||(f[5]=L=>c.value=L),title:s(o)("chat.singleChat.setStatus")},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:f[4]||(f[4]=L=>c.value=!1)},a(s(o)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:b},a(s(o)("confirm")),1)]),default:O(()=>[e("div",cs,[F(e("input",{type:"text",class:"base-input","onUpdate:modelValue":f[2]||(f[2]=L=>C.value=L),placeholder:s(o)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,rs),[[j,C.value]]),F(e("input",{type:"text",class:"base-input","onUpdate:modelValue":f[3]||(f[3]=L=>m.value=L),placeholder:s(o)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,ds),[[j,m.value]])])]),_:1},8,["visible","title"]),T(lt,{visible:r.value,"onUpdate:visible":f[6]||(f[6]=L=>r.value=L),charId:n.charId},null,8,["visible","charId"])]))}},vs=ae(us,[["__scopeId","data-v-495576d3"]]),gs={key:0,class:"chat-panel",id:"stickerPanel"},ms={class:"sticker-panel-header"},hs={class:"sticker-groups"},ps=["onClick"],bs={class:"sticker-panel-content"},fs=["onClick"],ys=["src","alt"],Cs={class:"sticker-panel-footer"},ks={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(n,{emit:k}){const p=k,o=ye(),t=we(),u=d("默认"),l=d(!1),c=d(new Set),C=d(!1),m=d(!1),r=d(""),S=N(()=>["默认",...new Set(o.stickers.map(B=>B.group).filter(Boolean).filter(B=>B!=="默认"))]),U=N(()=>o.stickers.filter(D=>D.group===u.value)),b=D=>{l.value?c.value.has(D.id)?c.value.delete(D.id):c.value.add(D.id):p("send-sticker",D)},_=({group:D,stickers:B})=>{const $=B.map(W=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:W.url,name:W.name,group:D}));o.stickers.push(...$),o.saveData(),t.showToast(`成功导入 ${$.length} 个表情包`,"success")},w=()=>{C.value=!0},f=()=>{c.value.size>0&&(m.value=!0)},L=()=>{l.value=!l.value,c.value.clear()},R=()=>{const D=U.value;D.every($=>c.value.has($.id))?D.forEach($=>c.value.delete($.id)):D.forEach($=>c.value.add($.id))},E=()=>{c.value.size!==0&&t.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{o.stickers=o.stickers.filter(D=>!c.value.has(D.id)),o.saveData(),c.value.clear()})},M=()=>{const D=r.value.trim();if(!D)return t.showToast("请输入目标分组","info");o.stickers.forEach(B=>{c.value.has(B.id)&&(B.group=D)}),o.saveData(),m.value=!1,r.value="",c.value.clear(),l.value=!1,u.value=D},G=()=>{if(c.value.size===0)return;const D=o.stickers.filter(J=>c.value.has(J.id)).map(J=>`${J.name} ${J.url}`).join(`
`),B=new Blob([D],{type:"text/plain"}),$=URL.createObjectURL(B),W=document.createElement("a");W.href=$,W.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(W),W.click(),document.body.removeChild(W),URL.revokeObjectURL($),c.value.clear(),l.value=!1};return(D,B)=>(h(),y("div",null,[n.visible?(h(),y("div",gs,[e("div",ms,[e("div",hs,[(h(!0),y(ve,null,Ve(S.value,$=>(h(),y("div",{class:q(["sticker-group-tab",{active:u.value===$}]),key:$,onClick:W=>u.value=$},a($),11,ps))),128))])]),e("div",bs,[(h(!0),y(ve,null,Ve(U.value,$=>(h(),y("div",{class:q(["sticker-item",{selected:c.value.has($.id),"manage-mode":l.value}]),key:$.id,onClick:W=>b($)},[e("img",{src:$.url,alt:$.name},null,8,ys),e("span",null,a($.name),1)],10,fs))),128))]),e("div",Cs,[F(e("div",{class:"sticker-add-btn",onClick:w},"＋",512),[[Ye,!l.value]]),e("div",{class:"sticker-manage-btn",style:Se({color:l.value?"var(--danger-color)":"#576B95"}),onClick:L},a(l.value?"完成":"管理"),5)]),e("div",{class:q(["manage-bar",{active:l.value}])},[e("button",{class:"btn btn-secondary",onClick:w},"导入"),e("button",{class:"btn btn-secondary",onClick:R},"全选"),e("button",{class:"btn btn-secondary",onClick:f},"移动"),e("button",{class:"btn btn-secondary",onClick:G},"导出"),e("button",{class:"btn btn-danger",onClick:E},"删除")],2)])):H("",!0),T(Ze,{visible:C.value,"onUpdate:visible":B[0]||(B[0]=$=>C.value=$),type:"sticker-import",onImportSticker:_},null,8,["visible"]),T(De,{visible:m.value,"onUpdate:visible":B[3]||(B[3]=$=>m.value=$),title:"移动到分组"},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:B[2]||(B[2]=$=>m.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:M},"确定")]),default:O(()=>[F(e("input",{type:"text",class:"base-input","onUpdate:modelValue":B[1]||(B[1]=$=>r.value=$),placeholder:"输入目标分组名称"},null,512),[[j,r.value]])]),_:1},8,["visible"])]))}},Ss=ae(ks,[["__scopeId","data-v-f9fb1def"]]),ws={class:"chat-panel",id:"morePanel"},Ms={class:"more-panel-content"},$s={class:"more-label"},_s={class:"more-label"},Is={class:"more-label"},xs={class:"more-label"},Ts={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(n){const{t:k}=Me();return(p,o)=>(h(),y("div",ws,[e("div",Ms,[e("div",{class:"more-item",onClick:o[0]||(o[0]=t=>p.$emit("trigger-image-upload"))},[o[4]||(o[4]=Xe('<div class="more-icon" data-v-731b24d5><svg class="svg-icon" viewBox="0 0 24 24" data-v-731b24d5><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-731b24d5></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-731b24d5></circle><polyline points="21 15 16 10 5 21" data-v-731b24d5></polyline></svg></div>',1)),e("span",$s,a(s(k)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:o[1]||(o[1]=t=>p.$emit("start-video-call"))},[o[5]||(o[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",_s,a(s(k)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:o[2]||(o[2]=t=>p.$emit("send-location"))},[o[6]||(o[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",Is,a(s(k)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:o[3]||(o[3]=t=>p.$emit("send-transfer"))},[o[7]||(o[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),e("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})])],-1)),e("span",xs,a(s(k)("chat.morePanel.transfer")),1)])])]))}},Ps=ae(Ts,[["__scopeId","data-v-731b24d5"]]),Bs={class:"chat-footer"},As={key:0,class:"quote-preview"},Us={class:"quote-content"},Vs={class:"quote-sender"},Ds={class:"quote-text"},Ls={class:"chat-input-row"},Es={class:"chat-input-wrapper"},Rs=["value"],Ns={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"21px",height:"21px",position:"relative",top:"1px",left:"-1px"}},qs={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(n,{emit:k}){const{t:p}=Me(),o=n,t=k,u=d(o.activePanel);le(()=>o.activePanel,m=>{u.value=m}),le(u,m=>{t("update:activePanel",m)});const l=m=>{u.value===m?u.value=null:u.value=m},c=()=>{o.modelValue.trim()&&t("send-message")},C=m=>{t("send-sticker",m),u.value=null};return(m,r)=>(h(),y("div",Bs,[n.quotingMessage?(h(),y("div",As,[e("div",Us,[e("span",Vs,a(n.quotingMessage.sender==="user"?s(p)("chat.self"):s(p)("chat.other"))+": ",1),e("span",Ds,a(n.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:r[0]||(r[0]=S=>m.$emit("cancel-quote"))},[...r[9]||(r[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):H("",!0),e("div",Ls,[e("div",{class:"chat-tool-btn",onClick:r[1]||(r[1]=S=>m.$emit("trigger-voice"))},[T(X,{name:"voice-circle",class:"svg-icon"})]),e("div",Es,[e("input",{type:"text",class:"chat-input",value:n.modelValue,onInput:r[2]||(r[2]=S=>m.$emit("update:modelValue",S.target.value)),onKeypress:Mt(c,["enter"]),id:"messageInput",autocomplete:"new-password"},null,40,Rs)]),e("div",{class:"chat-tool-btn",onClick:r[3]||(r[3]=S=>l("sticker"))},[T(X,{name:"sticker",class:"svg-icon"})]),n.modelValue?(h(),y("div",{key:1,class:"send-btn-icon",onClick:c},[(h(),y("svg",Ns,[...r[10]||(r[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(h(),y("div",{key:0,class:"chat-tool-btn",onClick:r[4]||(r[4]=S=>l("more"))},[T(X,{name:"plus-circle",class:"svg-icon"})]))]),T(Ss,{visible:u.value==="sticker",onSendSticker:C},null,8,["visible"]),u.value==="more"?(h(),fe(Ps,{key:1,onTriggerImageUpload:r[5]||(r[5]=S=>m.$emit("trigger-image")),onStartVideoCall:r[6]||(r[6]=S=>m.$emit("trigger-video")),onSendLocation:r[7]||(r[7]=S=>m.$emit("trigger-location")),onSendTransfer:r[8]||(r[8]=S=>m.$emit("trigger-transfer"))})):H("",!0)]))}},Fs=ae(qs,[["__scopeId","data-v-5b0f6609"]]),zs={class:"chat-settings active"},Os={class:"app-header"},js={class:"title"},Hs={class:"action-btn"},Ws={class:"app-content settings-content"},Gs={class:"card"},Ks={key:"roleInfo"},Qs={class:"card-content"},Ys={class:"role-header-layout"},Xs=["src"],Js={key:1,class:"role-avatar-placeholder"},Zs={class:"role-inputs-wrapper"},ea=["placeholder"],ta=["placeholder"],sa={class:"form-item-vertical"},aa={class:"label-main",style:{"margin-bottom":"5px"}},na=["placeholder"],oa={class:"card"},la={key:"userInfo"},ia={class:"card-content"},ca={class:"settings-pure-item",style:{"border-bottom":"none"}},ra={class:"settings-pure-label"},da={class:"user-header-layout"},ua=["src"],va={key:1,class:"role-avatar-placeholder"},ga={class:"user-inputs-wrapper"},ma={class:"user-actions-row"},ha=["placeholder"],pa={class:"form-item-vertical"},ba={class:"label-main",style:{"margin-bottom":"5px"}},fa=["placeholder"],ya={class:"card"},Ca={class:"card-title-remark"},ka={key:"backgroundActivity"},Sa={class:"card-content"},wa={class:"settings-item-input"},Ma={class:"label-col"},$a={class:"label-main"},_a={class:"settings-pure-value"},Ia={class:"settings-item-input"},xa={class:"label-col"},Ta={class:"label-main"},Pa={class:"label-sub"},Ba={class:"mode-selector"},Aa={key:0},Ua={class:"settings-item-input"},Va={class:"label-col"},Da={class:"label-main"},La={class:"label-sub"},Ea={class:"settings-item-input"},Ra={class:"label-col"},Na={class:"label-main"},qa={class:"label-sub"},Fa={class:"settings-item-input"},za={class:"label-col"},Oa={class:"label-main"},ja={class:"label-sub"},Ha={class:"settings-item-input"},Wa={class:"label-col"},Ga={class:"label-main"},Ka={class:"label-sub"},Qa={class:"mode-selector"},Ya={key:0,class:"settings-item-input"},Xa={class:"label-col"},Ja={class:"label-main"},Za={class:"label-sub"},en={class:"card"},tn={key:"modeSettings"},sn={class:"card-content"},an={class:"settings-pure-item"},nn={class:"settings-pure-label"},on={class:"mode-selector"},ln={key:0,class:"settings-pure-item"},cn={class:"settings-pure-label"},rn={class:"settings-pure-item"},dn={class:"settings-pure-label"},un={class:"settings-item-input"},vn={class:"label-col"},gn={class:"label-main"},mn={class:"label-sub"},hn={class:"reply-length-container"},pn=["placeholder"],bn=["placeholder"],fn={class:"card"},yn={key:"summarySettings"},Cn={class:"card-content"},kn={class:"settings-item-input"},Sn={class:"label-col"},wn={class:"label-main"},Mn={class:"label-sub"},$n={class:"form-item-vertical"},_n={class:"label-main",style:{"margin-bottom":"5px"}},In=["placeholder"],xn={class:"settings-item-input"},Tn={class:"label-col"},Pn={class:"label-main"},Bn={class:"label-sub"},An={class:"settings-btn-row flex-distribute-children",style:{padding:"15px 0","border-bottom":"1px solid #f5f5f5"}},Un={class:"settings-item-input"},Vn={class:"label-col"},Dn={class:"label-main"},Ln={class:"label-sub"},En={class:"settings-pure-item"},Rn={class:"settings-pure-label"},Nn={class:"settings-pure-item"},qn={class:"settings-pure-label"},Fn={class:"settings-pure-value"},zn={class:"settings-pure-item"},On={class:"settings-pure-label"},jn={class:"settings-pure-value"},Hn={class:"card"},Wn={key:"bubbleSettings"},Gn={class:"card-content"},Kn={class:"settings-section-title"},Qn={class:"settings-row-group"},Yn={class:"settings-pure-label",style:{width:"60px"}},Xn={style:{flex:"1",margin:"0 10px"}},Jn={class:"btn-group-mini"},Zn=["disabled"],eo={class:"bubble-preview-container"},to={class:"bubble-preview-area"},so={class:"preview-msg-row left"},ao={class:"preview-avatar char"},no=["src"],oo={key:1,class:"default-avatar"},lo={class:"preview-msg-row right"},io={class:"preview-avatar user"},co=["src"],ro={key:1,class:"default-avatar"},uo={class:"settings-item-input"},vo={class:"label-col"},go={class:"label-main"},mo={class:"slider-container gray-slider"},ho={class:"slider-value"},po={class:"form-item-vertical no-border"},bo={class:"label-main",style:{"margin-bottom":"5px"}},fo=["placeholder"],yo={class:"settings-section-title"},Co={class:"settings-item-avatar",style:{"border-bottom":"none","margin-bottom":"0"}},ko={class:"avatar-layout"},So={class:"avatar-controls",style:{width:"100%"}},wo={class:"card"},Mo={key:"videoSettings"},$o={class:"card-content"},_o={class:"video-settings-container"},Io={class:"video-setting-col"},xo={class:"settings-item-label center"},To=["src"],Po={key:1,class:"default-avatar bg-placeholder"},Bo={class:"video-setting-col"},Ao={class:"settings-item-label center"},Uo=["src"],Vo={key:1,class:"default-avatar bg-placeholder"},Do={class:"card"},Lo={key:"advancedSettings"},Eo={class:"card-content"},Ro={class:"settings-pure-item"},No={class:"settings-pure-label"},qo={class:"settings-pure-value"},Fo={class:"danger-zone"},zo={class:"danger-btn-content"},Oo={class:"danger-btn-title"},jo={class:"danger-btn-desc"},Ho={class:"danger-btn-content"},Wo={class:"danger-btn-title"},Go={class:"danger-btn-desc"},Ko={class:"danger-btn-content"},Qo={class:"danger-btn-title"},Yo={class:"danger-btn-desc"},Xo={__name:"SingleChatSettings",props:{visible:Boolean,charId:String},emits:["update:visible"],setup(n,{emit:k}){const p=n,o=k,{t}=Me(),u=Je(),l=ye(),c=we(),C=$t(),m=_t(),{sortedWorldBooks:r}=at(m),S=It(),{sortedPresets:U}=at(S),b=d({roleInfo:!1,userInfo:!1,backgroundActivity:!1,modeSettings:!1,summarySettings:!1,bubbleSettings:!1,videoSettings:!1,advancedSettings:!1}),_=d(!1),w=d(!1),f=d(""),L=d(""),R=d(""),E=d(""),M=d("default"),G=d(""),D=d(""),B=d(""),$=d("default"),W=d(5),J=d(30),ne=d(10),ee=d("always"),ge=d(15),te=d(!0),me=d([]),de=d([]),se=d(""),I=d(""),P=d(20),K=d(""),V=d(!1),Q=d(10),ie=d(""),ce=d(""),oe=d(14),Ce=d(""),ke=d(""),ue=d(""),_e=d("default"),Le=d(0),he=d(!1),Ie=d(0),xe=d(0),Z=N(()=>l.getCharacter(p.charId)),pe=N(()=>{var v;return((v=Z.value)==null?void 0:v.name)||t("chat.unknownCharacter")}),$e=N(()=>{var v;return(v=Z.value)==null?void 0:v.avatar}),ze=N(()=>[{value:"default",label:t("chat.singleChat.settings.defaultUserPersona")},...(l.userPersonas||[]).map(v=>({value:v.id,label:v.name}))]),Oe=N(()=>[{value:"default",label:t("chat.singleChat.settings.default")+"配置"},{value:"api1",label:"配置一"},{value:"api2",label:"配置二"}]),je=N(()=>[{value:"",label:t("chat.singleChat.settings.custom")},...(l.bubblePresets||[]).map(v=>({value:v.id,label:v.name}))]),He=N(()=>$.value==="on"?!0:$.value==="off"?!1:C.globalBackgroundActivity),Ee=N(()=>{const v={fontSize:`${oe.value}px`};if(!ce.value)return v;const i={};return ce.value.split(";").forEach(g=>{const Y=g.split(":");if(Y.length>=2){const Be=Y[0].trim(),Ae=Y.slice(1).join(":").trim();Be&&Ae&&(i[Be]=Ae)}}),{...v,...i}}),We=N(()=>({avatar:t("chat.singleChat.settings.toast.setCharAvatar"),userPersonaAvatar:t("chat.singleChat.settings.toast.setUserAvatar"),chatBg:t("chat.singleChat.settings.toast.setChatBg"),videoBg:t("chat.singleChat.settings.toast.setCharImg"),userVideoImg:t("chat.singleChat.settings.toast.setUserImg")})[f.value]||t("chat.singleChat.settings.toast.upload"));le(M,v=>{v&&Ke(v)}),le(ie,v=>{v&&dt(v)}),et(()=>{if(!Z.value){A();return}it()});const re=v=>{b.value[v]=!b.value[v]},A=()=>{o("update:visible",!1)},x=()=>{_.value=!0},z=()=>{f.value="avatar",w.value=!0},Te=()=>{f.value="userPersonaAvatar",w.value=!0},Pe=()=>{f.value="chatBg",w.value=!0},Re=()=>{f.value="videoBg",w.value=!0},Ne=()=>{f.value="userVideoImg",w.value=!0},it=()=>{var Ae;const v=Z.value;L.value=v.name,R.value=v.nickname||"",E.value=v.charPersona||"",M.value=v.userPersona||"default",Ke(M.value),$.value=v.backgroundActivityOverride||"default",W.value=v.proactiveInterval||5,J.value=v.proactiveCooldown||30,ne.value=v.proactiveDailyLimit||10,ee.value=v.triggerMode||"always",ge.value=v.proactiveIdleTime||15,te.value=v.isOnline!==!1,me.value=Array.isArray(v.preset)?v.preset:v.preset?[v.preset]:[],de.value=v.worldbook||[];const[i,g]=(v.replyLength||(te.value?"10-50":"200-500")).split("-");se.value=i||"",I.value=g||"",P.value=v.summaryRange||20,K.value=v.summaryPrompt||"",V.value=v.autoSummary||!1,Q.value=v.memoryCount||10;const Y=v.bubbleSettings||{};ce.value=Y.css||"",oe.value=Y.fontSize||14,Ce.value=v.chatBackground||"",ke.value=v.videoBg||"",ue.value=v.userVideoImg||"",_e.value=v.api||"default",Le.value=((Ae=v.npc)==null?void 0:Ae.length)||0,he.value=v.isBlocked||!1;const Be=l.messages[p.charId]||[];xe.value=Be.length,Ie.value=Math.ceil(Be.reduce((kt,St)=>{var st;return kt+(((st=St.content)==null?void 0:st.length)||0)},0)*1.5)},Ge=()=>{const v=Z.value;v&&(Object.assign(v,{name:L.value.trim()||v.name,nickname:R.value.trim(),charPersona:E.value,userPersona:M.value,backgroundActivityOverride:$.value,proactiveInterval:W.value,proactiveCooldown:J.value,proactiveDailyLimit:ne.value,triggerMode:ee.value,proactiveIdleTime:ge.value,isOnline:te.value,preset:me.value,worldbook:de.value,replyLength:`${se.value}-${I.value}`,summaryRange:P.value,summaryPrompt:K.value,autoSummary:V.value,memoryCount:Q.value,bubbleSettings:{css:ce.value,fontSize:oe.value},chatBackground:Ce.value,videoBg:ke.value,userVideoImg:ue.value,isBlocked:he.value}),l.saveData(),c.showToast(t("theme.toast.saveSuccess")))},Ke=v=>{const i=t("chat.singleChat.settings.defaultUserPersona");let g=l.userPersonas.find(Y=>Y.id===v)||{name:i,avatar:"",description:"",videoImg:""};G.value=g.name===i?"":g.name,D.value=g.description||"",B.value=g.avatar||"",v!=="default"&&(ue.value=g.videoImg||"")},ct=()=>{const v=G.value.trim();if(!v)return c.showToast(t("chat.singleChat.settings.toast.personaNameRequired"),"error");const i={id:M.value==="default"?Date.now().toString():M.value,name:v,description:D.value,avatar:B.value,videoImg:ue.value};if(M.value==="default")l.userPersonas.push(i),M.value=i.id,c.showToast(t("chat.singleChat.settings.toast.personaSaved"));else{const g=l.userPersonas.findIndex(Y=>Y.id===M.value);g!==-1&&(l.userPersonas[g]=i,c.showToast(t("chat.singleChat.settings.toast.personaUpdated")))}l.saveData()},rt=()=>{if(M.value==="default")return c.showToast(t("chat.singleChat.settings.toast.defaultPersonaDelete"),"error");c.showConfirm(t("chat.singleChat.settings.toast.deletePersona"),t("chat.singleChat.settings.toast.confirmDeletePersona"),()=>{l.userPersonas=l.userPersonas.filter(v=>v.id!==M.value),l.characters.forEach(v=>{v.userPersona===M.value&&(v.userPersona="default")}),M.value="default",Ke("default"),l.saveData()})},dt=v=>{if(!v)return;const i=l.bubblePresets.find(g=>g.id===v);i&&(ce.value=i.css,oe.value=i.fontSize)},ut=()=>{const v=prompt(t("chat.singleChat.settings.toast.presetNameRequired"));if(!v)return;const i={id:Date.now().toString(),name:v,css:ce.value,fontSize:oe.value};l.bubblePresets.push(i),l.saveData(),ie.value=i.id,c.showToast(t("chat.singleChat.settings.toast.presetSaved"))},vt=()=>{ie.value&&c.showConfirm(t("chat.singleChat.settings.toast.deleteBubblePreset"),t("chat.singleChat.settings.toast.confirmDeleteBubblePreset"),()=>{l.bubblePresets=l.bubblePresets.filter(v=>v.id!==ie.value),l.saveData(),ie.value="",c.showToast(t("chat.singleChat.settings.toast.presetDeleted"))})},gt=v=>{const i=typeof v=="string"?v:v.content,g=f.value,Y={avatar:{obj:Z.value,key:"avatar",toast:t("chat.singleChat.settings.toast.avatarUpdated")},userPersonaAvatar:{obj:B,key:"value",toast:t("chat.singleChat.settings.toast.avatarUrlSet")},chatBg:{obj:Z.value,key:"chatBackground",toast:t("chat.singleChat.settings.toast.backgroundUpdated"),localRef:Ce},videoBg:{obj:Z.value,key:"videoBg",toast:t("chat.singleChat.settings.toast.charImageUpdated"),localRef:ke},userVideoImg:{obj:Z.value,key:"userVideoImg",toast:t("chat.singleChat.settings.toast.userImageUpdated"),localRef:ue}};Y[g]&&(Y[g].obj[Y[g].key]=i,Y[g].localRef&&(Y[g].localRef.value=i),g!=="userPersonaAvatar"&&l.saveData(),c.showToast(Y[g].toast)),w.value=!1},mt=()=>{if(!Ce.value)return c.showToast(t("chat.singleChat.settings.toast.noBgToApply"));c.showConfirm(t("chat.singleChat.settings.toast.applyBgToAll"),t("chat.singleChat.settings.toast.confirmApplyBgToAll"),()=>{l.applyChatBackgroundToAll(Ce.value),c.showToast(t("chat.singleChat.settings.toast.appliedToAll"))})},tt=v=>{te.value=v,[se.value,I.value]=v?["10","50"]:["200","500"]},ht=()=>{c.showConfirm(t("chat.singleChat.settings.confirmSummaryTitle"),t("chat.singleChat.settings.confirmSummaryMsg",{count:P.value}),()=>{const v=`[${t("chat.singleChat.settings.autoSummary")}] 与${pe.value}进行了愉快的对话...`;Z.value.memories||(Z.value.memories=[]),Z.value.memories.unshift({content:v,time:Date.now(),charName:pe.value}),l.saveData(),c.showToast(t("chat.singleChat.settings.toast.summaryDone")),_.value=!0})},pt=()=>{c.showConfirm(t("chat.singleChat.settings.confirmBlockTitle",{name:pe.value}),t("chat.singleChat.settings.confirmBlockMsg",{name:pe.value}),()=>{he.value=!0,Ge(),c.showToast(t("chat.singleChat.settings.toast.blocked"))},{messageStyle:{color:"#FF3B30",whiteSpace:"pre-wrap"},confirmText:"chat.singleChat.settings.block"})},bt=()=>{he.value=!1,Ge(),c.showToast(t("chat.singleChat.settings.toast.unblocked"))},ft=()=>{c.showConfirm(t("chat.singleChat.settings.confirmClearTitle"),t("chat.singleChat.settings.confirmClearMsg",{name:pe.value}),()=>{l.clearChatHistory(p.charId),c.showToast(t("chat.singleChat.settings.toast.historyCleared")),xe.value=0,Ie.value=0},{messageStyle:{whiteSpace:"pre-wrap",color:"#FF3B30"},confirmText:"chat.singleChat.settings.clear"})},yt=()=>{he.value?bt():pt()},Ct=()=>{c.showConfirm(t("chat.deleteCharacterTitle"),t("chat.deleteCharacterConfirm",{name:pe.value}),()=>{l.deleteCharacter(p.charId),c.showToast(t("chat.toast.deleteSuccess"),"success"),A(),u.push({name:"chat-list"})},{messageStyle:{whiteSpace:"pre-wrap",color:"#FF3B30"},confirmText:"delete"})};return(v,i)=>(h(),y("div",zs,[e("div",Os,[e("div",{class:"back-btn",onClick:A},[...i[39]||(i[39]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polyline",{points:"15 18 9 12 15 6"})],-1)])]),e("div",js,a(s(t)("chat.singleChat.settings.title")),1),e("div",Hs,[e("button",{class:"header-save-btn",onClick:Ge},a(s(t)("save")),1)])]),e("div",Ws,[e("div",Gs,[e("div",{class:"card-title",onClick:i[0]||(i[0]=g=>re("roleInfo"))},[e("span",null,a(s(t)("chat.singleChat.settings.roleInfo")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.roleInfo}])},[T(X,{name:"chevron-down"})],2)]),T(be,{name:"collapse"},{default:O(()=>[b.value.roleInfo?H("",!0):(h(),y("div",Ks,[e("div",Qs,[e("div",Ys,[e("div",{class:"role-avatar-wrapper",onClick:z},[$e.value?(h(),y("img",{key:0,src:$e.value,alt:"头像",class:"role-avatar-img"},null,8,Xs)):(h(),y("div",Js,a(s(t)("chat.singleChat.settings.uploadAvatar")),1))]),e("div",Zs,[F(e("input",{type:"text","onUpdate:modelValue":i[1]||(i[1]=g=>L.value=g),class:"base-input",placeholder:s(t)("chat.singleChat.settings.roleNamePlaceholder")},null,8,ea),[[j,L.value]]),F(e("input",{type:"text","onUpdate:modelValue":i[2]||(i[2]=g=>R.value=g),class:"base-input",placeholder:s(t)("chat.singleChat.settings.roleNicknamePlaceholder")},null,8,ta),[[j,R.value]])])]),e("div",sa,[e("div",aa,a(s(t)("chat.singleChat.settings.rolePersona")),1),F(e("textarea",{"onUpdate:modelValue":i[3]||(i[3]=g=>E.value=g),class:"base-input",style:{height:"80px","min-height":"40px"},placeholder:s(t)("chat.singleChat.settings.rolePersonaPlaceholder")},null,8,na),[[j,E.value]])])])]))]),_:1})]),e("div",oa,[e("div",{class:"card-title",onClick:i[4]||(i[4]=g=>re("userInfo"))},[e("span",null,a(s(t)("chat.singleChat.settings.userInfo")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.userInfo}])},[T(X,{name:"chevron-down"})],2)]),T(be,{name:"collapse"},{default:O(()=>[b.value.userInfo?H("",!0):(h(),y("div",la,[e("div",ia,[e("div",ca,[e("div",ra,a(s(t)("chat.singleChat.settings.currentUserPersona")),1),T(Qe,{options:ze.value,modelValue:M.value,"onUpdate:modelValue":i[5]||(i[5]=g=>M.value=g)},null,8,["options","modelValue"])]),e("div",da,[e("div",{class:"user-avatar-wrapper",onClick:Te},[B.value?(h(),y("img",{key:0,src:B.value,alt:"User",class:"role-avatar-img"},null,8,ua)):(h(),y("div",va,a(s(t)("chat.singleChat.settings.uploadAvatar")),1))]),e("div",ga,[e("div",ma,[e("button",{class:"btn btn-secondary btn-mini-grow",onClick:ct},a(s(t)("chat.singleChat.settings.savePersona")),1),e("button",{class:"btn btn-danger btn-mini-grow",onClick:rt},a(s(t)("chat.singleChat.settings.deletePersona")),1)]),F(e("input",{type:"text","onUpdate:modelValue":i[6]||(i[6]=g=>G.value=g),class:"base-input",placeholder:s(t)("chat.singleChat.settings.userNamePlaceholder")},null,8,ha),[[j,G.value]])])]),e("div",pa,[e("div",ba,a(s(t)("chat.singleChat.settings.userPersona")),1),F(e("textarea",{"onUpdate:modelValue":i[7]||(i[7]=g=>D.value=g),class:"base-input",style:{height:"80px","min-height":"40px"},placeholder:s(t)("chat.singleChat.settings.userPersonaPlaceholder")},null,8,fa),[[j,D.value]])])])]))]),_:1})]),e("div",ya,[e("div",{class:"card-title",onClick:i[8]||(i[8]=g=>re("backgroundActivity"))},[e("span",null,a(s(t)("chat.singleChat.settings.backgroundActivity")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.backgroundActivity}])},[T(X,{name:"chevron-down"})],2)]),e("div",Ca,a(s(t)("chat.singleChat.settings.backgroundActivityWarning")),1),T(be,{name:"collapse"},{default:O(()=>[b.value.backgroundActivity?H("",!0):(h(),y("div",ka,[e("div",Sa,[e("div",wa,[e("div",Ma,[e("div",$a,a(s(t)("chat.singleChat.settings.globalSettings")),1)]),e("div",_a,a(s(C).globalBackgroundActivity?s(t)("chat.singleChat.settings.globalOn"):s(t)("chat.singleChat.settings.globalOff")),1)]),e("div",Ia,[e("div",xa,[e("div",Ta,a(s(t)("chat.singleChat.settings.overrideGlobal")),1),e("div",Pa,a(s(t)("chat.singleChat.settings.overrideGlobalDesc")),1)]),e("div",Ba,[e("div",{class:q(["mode-option",{active:$.value==="default"}]),onClick:i[9]||(i[9]=g=>$.value="default")},a(s(t)("chat.singleChat.settings.default")),3),e("div",{class:q(["mode-option",{active:$.value==="on"}]),onClick:i[10]||(i[10]=g=>$.value="on")},a(s(t)("chat.singleChat.settings.on")),3),e("div",{class:q(["mode-option",{active:$.value==="off"}]),onClick:i[11]||(i[11]=g=>$.value="off")},a(s(t)("chat.singleChat.settings.off")),3)])]),He.value?(h(),y("div",Aa,[e("div",Ua,[e("div",Va,[e("div",Da,a(s(t)("chat.singleChat.settings.interval")),1),e("div",La,a(s(t)("chat.singleChat.settings.intervalDesc")),1)]),F(e("input",{type:"number","onUpdate:modelValue":i[12]||(i[12]=g=>W.value=g),class:"base-input base-input-short",placeholder:"5"},null,512),[[j,W.value,void 0,{number:!0}]])]),e("div",Ea,[e("div",Ra,[e("div",Na,a(s(t)("chat.singleChat.settings.cooldown")),1),e("div",qa,a(s(t)("chat.singleChat.settings.cooldownDesc")),1)]),F(e("input",{type:"number","onUpdate:modelValue":i[13]||(i[13]=g=>J.value=g),class:"base-input base-input-short",placeholder:"30"},null,512),[[j,J.value,void 0,{number:!0}]])]),e("div",Fa,[e("div",za,[e("div",Oa,a(s(t)("chat.singleChat.settings.dailyLimit")),1),e("div",ja,a(s(t)("chat.singleChat.settings.dailyLimitDesc")),1)]),F(e("input",{type:"number","onUpdate:modelValue":i[14]||(i[14]=g=>ne.value=g),class:"base-input base-input-short",placeholder:"10"},null,512),[[j,ne.value,void 0,{number:!0}]])]),e("div",Ha,[e("div",Wa,[e("div",Ga,a(s(t)("chat.singleChat.settings.triggerMode")),1),e("div",Ka,a(s(t)("chat.singleChat.settings.triggerModeDesc")),1)]),e("div",Qa,[e("div",{class:q(["mode-option",{active:ee.value==="idle"}]),onClick:i[15]||(i[15]=g=>ee.value="idle")},a(s(t)("chat.singleChat.settings.idleMode")),3),e("div",{class:q(["mode-option",{active:ee.value==="always"}]),onClick:i[16]||(i[16]=g=>ee.value="always")},a(s(t)("chat.singleChat.settings.alwaysMode")),3)])]),ee.value==="idle"?(h(),y("div",Ya,[e("div",Xa,[e("div",Ja,a(s(t)("chat.singleChat.settings.idleTime")),1),e("div",Za,a(s(t)("chat.singleChat.settings.idleTimeDesc")),1)]),F(e("input",{type:"number","onUpdate:modelValue":i[17]||(i[17]=g=>ge.value=g),class:"base-input base-input-short",placeholder:"15"},null,512),[[j,ge.value,void 0,{number:!0}]])])):H("",!0)])):H("",!0)])]))]),_:1})]),e("div",en,[e("div",{class:"card-title",onClick:i[18]||(i[18]=g=>re("modeSettings"))},[e("span",null,a(s(t)("chat.singleChat.settings.mode")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.modeSettings}])},[T(X,{name:"chevron-down"})],2)]),T(be,{name:"collapse"},{default:O(()=>[b.value.modeSettings?H("",!0):(h(),y("div",tn,[e("div",sn,[e("div",an,[e("div",nn,a(s(t)("chat.singleChat.settings.modeSelect")),1),e("div",on,[e("div",{class:q(["mode-option",{active:te.value}]),onClick:i[19]||(i[19]=g=>tt(!0))},a(s(t)("chat.singleChat.settings.online")),3),e("div",{class:q(["mode-option",{active:!te.value}]),onClick:i[20]||(i[20]=g=>tt(!1))},a(s(t)("chat.singleChat.settings.offline")),3)])]),te.value?H("",!0):(h(),y("div",ln,[e("div",cn,a(s(t)("chat.singleChat.settings.linkPreset")),1),T(nt,{modelValue:me.value,"onUpdate:modelValue":i[21]||(i[21]=g=>me.value=g),options:s(U),labelKey:"title",valueKey:"id",childrenKey:"entries",textAlign:"right",selectorWidth:"auto",dropdownWidth:"200px"},null,8,["modelValue","options"])])),e("div",rn,[e("div",dn,a(s(t)("chat.singleChat.settings.linkWorldbook")),1),T(nt,{modelValue:de.value,"onUpdate:modelValue":i[22]||(i[22]=g=>de.value=g),options:s(r),"label-key":"title","value-key":"id","children-key":"entries",textAlign:"right",selectorWidth:"auto",dropdownWidth:"200px"},null,8,["modelValue","options"])]),e("div",un,[e("div",vn,[e("div",gn,a(s(t)("chat.singleChat.settings.replyLength")),1),e("div",mn,a(s(t)("chat.singleChat.settings.replyLengthDesc")),1)]),e("div",hn,[F(e("input",{type:"number","onUpdate:modelValue":i[23]||(i[23]=g=>se.value=g),class:"base-input base-input-mini",placeholder:s(t)("chat.singleChat.settings.min")},null,8,pn),[[j,se.value]]),i[40]||(i[40]=e("span",null,"-",-1)),F(e("input",{type:"number","onUpdate:modelValue":i[24]||(i[24]=g=>I.value=g),class:"base-input base-input-mini",placeholder:s(t)("chat.singleChat.settings.max")},null,8,bn),[[j,I.value]])])])])]))]),_:1})]),e("div",fn,[e("div",{class:"card-title",onClick:i[25]||(i[25]=g=>re("summarySettings"))},[e("span",null,a(s(t)("chat.singleChat.settings.summary")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.summarySettings}])},[T(X,{name:"chevron-down"})],2)]),T(be,{name:"collapse"},{default:O(()=>[b.value.summarySettings?H("",!0):(h(),y("div",yn,[e("div",Cn,[e("div",kn,[e("div",Sn,[e("div",wn,a(s(t)("chat.singleChat.settings.summaryRange")),1),e("div",Mn,a(s(t)("chat.singleChat.settings.summaryRangeDesc")),1)]),F(e("input",{type:"number","onUpdate:modelValue":i[26]||(i[26]=g=>P.value=g),class:"base-input base-input-short",placeholder:"20"},null,512),[[j,P.value,void 0,{number:!0}]])]),e("div",$n,[e("div",_n,a(s(t)("chat.singleChat.settings.summaryPrompt")),1),F(e("textarea",{"onUpdate:modelValue":i[27]||(i[27]=g=>K.value=g),class:"base-input",style:{height:"80px","min-height":"40px"},placeholder:s(t)("chat.singleChat.settings.summaryPromptPlaceholder")},null,8,In),[[j,K.value]])]),e("div",xn,[e("div",Tn,[e("div",Pn,a(s(t)("chat.singleChat.settings.autoSummary")),1),e("div",Bn,a(s(t)("chat.singleChat.settings.autoSummaryDesc")),1)]),e("div",{class:q(["toggle-switch",{active:V.value}]),onClick:i[28]||(i[28]=g=>V.value=!V.value)},null,2)]),e("div",An,[e("button",{class:"btn btn-secondary",onClick:ht},a(s(t)("chat.singleChat.settings.manualSummary")),1),e("button",{class:"btn btn-secondary",onClick:x},a(s(t)("chat.singleChat.settings.viewSummary")),1)]),e("div",Un,[e("div",Vn,[e("div",Dn,a(s(t)("chat.singleChat.settings.contextMemory")),1),e("div",Ln,a(s(t)("chat.singleChat.settings.contextMemoryDesc")),1)]),F(e("input",{type:"number","onUpdate:modelValue":i[29]||(i[29]=g=>Q.value=g),class:"base-input base-input-short",placeholder:"10"},null,512),[[j,Q.value,void 0,{number:!0}]])]),e("div",En,[e("div",Rn,a(s(t)("chat.singleChat.settings.apiConfig")),1),T(Qe,{options:Oe.value,modelValue:_e.value,"onUpdate:modelValue":i[30]||(i[30]=g=>_e.value=g)},null,8,["options","modelValue"])]),e("div",Nn,[e("div",qn,a(s(t)("chat.singleChat.settings.tokenCount")),1),e("div",Fn,a(Ie.value),1)]),e("div",zn,[e("div",On,a(s(t)("chat.singleChat.settings.msgCount")),1),e("div",jn,a(xe.value),1)])])]))]),_:1})]),e("div",Hn,[e("div",{class:"card-title",onClick:i[31]||(i[31]=g=>re("bubbleSettings"))},[e("span",null,a(s(t)("chat.singleChat.settings.beautification")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.bubbleSettings}])},[T(X,{name:"chevron-down"})],2)]),T(be,{name:"collapse"},{default:O(()=>[b.value.bubbleSettings?H("",!0):(h(),y("div",Wn,[e("div",Gn,[e("div",Kn,a(s(t)("chat.singleChat.settings.bubble")),1),e("div",Qn,[e("div",Yn,a(s(t)("chat.singleChat.settings.bubblePreset")),1),e("div",Xn,[T(Qe,{options:je.value,modelValue:ie.value,"onUpdate:modelValue":i[32]||(i[32]=g=>ie.value=g)},null,8,["options","modelValue"])]),e("div",Jn,[e("button",{class:"btn btn-secondary btn-mini",onClick:ut},a(s(t)("save")),1),e("button",{class:"btn btn-danger btn-mini",disabled:!ie.value,onClick:vt},a(s(t)("delete")),9,Zn)])]),e("div",eo,[e("div",to,[e("div",so,[e("div",ao,[$e.value?(h(),y("img",{key:0,src:$e.value,style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,no)):(h(),y("div",oo))]),e("div",{class:"preview-bubble char",style:Se(Ee.value)},a(s(t)("chat.singleChat.settings.bubblePreview")),5)]),e("div",lo,[e("div",{class:"preview-bubble user",style:Se(Ee.value)},a(s(t)("chat.singleChat.settings.bubblePreview")),5),e("div",io,[B.value?(h(),y("img",{key:0,src:B.value,style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,co)):(h(),y("div",ro))])])])]),e("div",uo,[e("div",vo,[e("div",go,a(s(t)("chat.singleChat.settings.fontSize")),1)]),e("div",mo,[F(e("input",{type:"range","onUpdate:modelValue":i[33]||(i[33]=g=>oe.value=g),min:"10",max:"30",step:"1"},null,512),[[j,oe.value,void 0,{number:!0}]]),e("span",ho,a(oe.value),1)])]),e("div",po,[e("div",bo,a(s(t)("chat.singleChat.settings.bubbleCss")),1),F(e("textarea",{"onUpdate:modelValue":i[34]||(i[34]=g=>ce.value=g),class:"base-input",placeholder:s(t)("chat.singleChat.settings.cssPlaceholder"),style:{"font-family":"monospace",height:"120px"}},null,8,fo),[[j,ce.value]])]),i[41]||(i[41]=e("div",{class:"settings-divider"},null,-1)),e("div",yo,a(s(t)("chat.singleChat.settings.chatBackground")),1),e("div",Co,[e("div",ko,[e("div",So,[e("button",{class:"btn btn-secondary",onClick:Pe},a(s(t)("chat.singleChat.settings.setChatBackground")),1),e("button",{class:"btn btn-secondary",onClick:mt,style:{"margin-top":"5px"}},a(s(t)("chat.singleChat.settings.applyToAll")),1)])])])])]))]),_:1})]),e("div",wo,[e("div",{class:"card-title",onClick:i[35]||(i[35]=g=>re("videoSettings"))},[e("span",null,a(s(t)("chat.singleChat.settings.videoCall")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.videoSettings}])},[T(X,{name:"chevron-down"})],2)]),T(be,{name:"collapse"},{default:O(()=>[b.value.videoSettings?H("",!0):(h(),y("div",Mo,[e("div",$o,[e("div",_o,[e("div",Io,[e("div",xo,a(s(t)("chat.singleChat.settings.characterImage")),1),e("div",{class:"video-preview",onClick:Re},[ke.value?(h(),y("img",{key:0,src:ke.value,class:"bg-img"},null,8,To)):(h(),y("div",Po,a(s(t)("chat.singleChat.settings.setImage")),1))])]),e("div",Bo,[e("div",Ao,a(s(t)("chat.singleChat.settings.userImage")),1),e("div",{class:"video-preview",onClick:Ne},[ue.value?(h(),y("img",{key:0,src:ue.value,class:"bg-img"},null,8,Uo)):(h(),y("div",Vo,a(s(t)("chat.singleChat.settings.setImage")),1))])])])])]))]),_:1})]),e("div",Do,[e("div",{class:"card-title",onClick:i[36]||(i[36]=g=>re("advancedSettings"))},[e("span",null,a(s(t)("chat.singleChat.settings.advanced")),1),e("div",{class:q(["collapse-arrow",{collapsed:b.value.advancedSettings}])},[T(X,{name:"chevron-down"})],2)]),T(be,{name:"collapse"},{default:O(()=>[b.value.advancedSettings?H("",!0):(h(),y("div",Lo,[e("div",Eo,[e("div",Ro,[e("div",No,a(s(t)("chat.singleChat.settings.linkedNpc")),1),e("div",qo,a(s(t)("chat.singleChat.settings.npcCount",{count:Le.value})),1),i[42]||(i[42]=e("div",{class:"settings-pure-arrow"},"›",-1))])])]))]),_:1})]),e("div",Fo,[e("button",{class:"btn btn-danger big-btn",onClick:yt},[e("div",zo,[e("div",Oo,a(he.value?s(t)("chat.singleChat.settings.unblock"):s(t)("chat.singleChat.settings.blockCharacter")),1),e("div",jo,a(s(t)("chat.singleChat.settings.blockCharacterDesc")),1)])]),e("button",{class:"btn btn-danger big-btn",onClick:ft},[e("div",Ho,[e("div",Wo,a(s(t)("chat.singleChat.settings.clearHistory")),1),e("div",Go,a(s(t)("chat.singleChat.settings.clearHistoryDesc")),1)])]),e("button",{class:"btn btn-danger big-btn",onClick:Ct},[e("div",Ko,[e("div",Qo,a(s(t)("chat.deleteCharacterTitle")),1),e("div",Yo,a(s(t)("chat.deleteCharacterWarning")),1)])])])]),T(lt,{visible:_.value,"onUpdate:visible":i[37]||(i[37]=g=>_.value=g),charId:p.charId},null,8,["visible","charId"]),T(Ze,{visible:w.value,"onUpdate:visible":i[38]||(i[38]=g=>w.value=g),type:"basic","biz-type":"avatar",title:We.value,onSendImage:gt},null,8,["visible","title"])]))}},Jo=ae(Xo,[["__scopeId","data-v-4546f776"]]),Zo={class:"menu-grid"},el={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(n,{emit:k}){const p=n,o=k,t=xt("phoneScreenRef"),{t:u}=Me(),l=ye(),c=we(),C=d(null),m=d({}),r=d(0),S=d("top");le(()=>p.visible,async _=>{_&&p.targetEl&&(await Fe(),U())});const U=()=>{const _=C.value;if(!_)return;const w=p.targetEl.getBoundingClientRect(),f=_.offsetWidth,L=_.offsetHeight,R=8,E=t.value,M=E?E.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};S.value="top";let G=w.top-L-R;G<M.top+R&&(S.value="bottom",G=w.bottom+R);const D=w.left+w.width/2;let B=D-f/2;B<M.left+R&&(B=M.left+R),B+f>M.left+M.width-R&&(B=M.left+M.width-f-R);let $=D-B;const W=12,J=W/2+5,ne=f-W/2-5;$=Math.max(J,Math.min($,ne)),m.value={top:`${G}px`,left:`${B}px`},r.value=$},b=_=>{const w=p.messageId;if(!w)return;const f=l.messages[p.charId],L=f.findIndex(M=>M.id===w),R=f[L],E={copy:()=>{R.content&&(navigator.clipboard.writeText(R.content),c.showToast(u("chat.messageMenu.toast.copied")))},favorite:()=>{l.favorites||(l.favorites=[]),l.favorites.some(M=>M.id===R.id)?c.showToast(u("chat.messageMenu.toast.alreadyFavorited")):(l.favorites.push(R),l.saveData(),c.showToast(u("chat.messageMenu.toast.favorited")))},delete:()=>{c.showConfirm(u("chat.messageMenu.confirmDelete"),u("chat.messageMenu.confirmDeleteMsg"),()=>{l.messages[p.charId].splice(L,1),l.saveData()})},revoke:()=>{R&&(R.type="revoked",l.saveData(),c.showToast(u("chat.messageMenu.toast.revoked")))},select:()=>o("enter-selection-mode",w),quote:()=>o("quote-message",w),retry:()=>{R.sender!=="user"?(l.messages[p.charId].splice(L,1),l.saveData(),o("trigger-ai-response")):c.showToast(u("chat.messageMenu.toast.retryAiOnly"),"info")},edit:()=>{R.type==="text"?o("edit-message",w):c.showToast(u("chat.messageMenu.toast.editTextOnly"),"info")}};E[_]&&E[_](),o("close")};return(_,w)=>n.visible?(h(),y("div",{key:0,ref_key:"menuRef",ref:C,class:q(["message-menu",{"menu-top":S.value==="top","menu-bottom":S.value==="bottom"}]),style:Se(m.value)},[e("div",Zo,[e("div",{class:"menu-item",onClick:w[0]||(w[0]=f=>b("copy"))},a(s(u)("copy")),1),e("div",{class:"menu-item",onClick:w[1]||(w[1]=f=>b("favorite"))},a(s(u)("favorite")),1),e("div",{class:"menu-item",onClick:w[2]||(w[2]=f=>b("delete"))},a(s(u)("delete")),1),e("div",{class:"menu-item",onClick:w[3]||(w[3]=f=>b("revoke"))},a(s(u)("revoke")),1),e("div",{class:"menu-item",onClick:w[4]||(w[4]=f=>b("select"))},a(s(u)("select")),1),e("div",{class:"menu-item",onClick:w[5]||(w[5]=f=>b("quote"))},a(s(u)("quote")),1),e("div",{class:"menu-item",onClick:w[6]||(w[6]=f=>b("retry"))},a(s(u)("retry")),1),e("div",{class:"menu-item",onClick:w[7]||(w[7]=f=>b("edit"))},a(s(u)("edit")),1)]),e("div",{class:"menu-arrow",style:Se({left:r.value+"px"})},null,4)],6)):H("",!0)}},tl=ae(el,[["__scopeId","data-v-9d6ff2c4"]]),sl={class:"chat-action-row"},al={__name:"SelectionBar",emits:["action","cancel"],setup(n){const{t:k}=Me();return(p,o)=>(h(),y("div",sl,[e("div",{class:"action-btn",onClick:o[0]||(o[0]=t=>p.$emit("action","favorite"))},[o[4]||(o[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,a(s(k)("favorite")),1)]),e("div",{class:"action-btn",onClick:o[1]||(o[1]=t=>p.$emit("action","forward"))},[o[5]||(o[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,a(s(k)("forward")),1)]),e("div",{class:"action-btn",onClick:o[2]||(o[2]=t=>p.$emit("action","delete"))},[o[6]||(o[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,a(s(k)("delete")),1)]),e("div",{class:"action-btn",onClick:o[3]||(o[3]=t=>p.$emit("cancel"))},[o[7]||(o[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,a(s(k)("done")),1)])]))}},nl=ae(al,[["__scopeId","data-v-be1a592f"]]),ol={class:"msg-avatar"},ll=["src"],il={class:"msg-content-wrapper"},cl={class:"msg-bubble-box"},rl={key:0,class:"quote-in-bubble"},dl={class:"quote-in-bubble-sender"},ul={class:"quote-in-bubble-text"},vl={key:1,class:"edit-view"},gl={key:0},ml={class:"description-placeholder"},hl=["src"],pl={key:2,class:"sticker-msg"},bl=["src"],fl={key:3,class:"voice-msg-wrapper"},yl={class:"voice-msg"},Cl={key:4,class:"location-msg"},kl={class:"location-text"},Sl={class:"msg-title"},wl={key:5,class:"transfer-msg"},Ml={class:"transfer-content"},$l={class:"transfer-info"},_l={class:"transfer-amount"},Il={class:"transfer-desc"},xl={key:6,class:"call-summary-msg"},Tl={key:0,class:"blocked-icon"},Pl={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg"],setup(n,{emit:k}){const p=n,o=k,t=Tt(),u=d(!1),l=d(!1),c=d(""),C=N(()=>p.editingMessageId===p.msg.id),m=N(()=>{const E=p.msg.type;return{"no-style":["image","sticker","location","transfer"].includes(E),"has-location":E==="location","has-transfer":E==="transfer"}});le(C,E=>{E&&(c.value=p.msg.content)});const r=E=>{o("long-press",E,p.msg.id)},S=()=>{o("cancel-long-press")},U=E=>{o("touch-move",E)},b=E=>{p.msg.type==="voice"&&_(),p.msg.type!=="image"&&o("click-msg",E,p.msg.id)},_=()=>{u.value=!u.value},w=()=>{l.value=!l.value},f=()=>{c.value.trim()&&o("save-edit",{msgId:p.msg.id,newContent:c.value})},L=()=>{o("cancel-edit")},R=()=>p.msg.type==="notification"?p.msg.content:p.msg.type==="revoked"?`"${p.msg.sender==="user"?"你":p.charName}" 撤回了一条消息`:"";return(E,M)=>(h(),y("div",{class:q(["message",{sent:n.msg.sender==="user",received:n.msg.sender!=="user",revoked:n.msg.type==="revoked"||n.msg.type==="notification","selection-mode-active":n.isSelectionMode}])},[e("div",{class:q(["message-checkbox",{checked:n.isSelected,visible:n.isSelectionMode}]),onClick:M[0]||(M[0]=Ue(G=>E.$emit("toggle-selection",n.msg.id),["stop"]))},null,2),n.msg.type==="revoked"||n.msg.type==="notification"?(h(),y("div",{key:0,class:"system-message-wrapper",onMousedown:r,onMouseup:S,onMouseleave:S,onTouchstart:r,onTouchend:S,onTouchmove:U,onClick:Ue(b,["prevent"])},[e("div",{class:"system-message-text",onClick:M[1]||(M[1]=Ue(G=>!n.isSelectionMode&&w(),["stop"]))},a(R()),1),n.msg.type==="revoked"?F((h(),y("div",{key:0,class:"revoked-content"},a(n.msg.sender==="user"?"我":n.charName)+"："+a(n.msg.content),513)),[[Ye,l.value]]):H("",!0)],32)):(h(),y(ve,{key:1},[e("div",ol,[(n.msg.sender==="user"?n.userAvatar:n.charAvatar)?(h(),y("img",{key:0,src:n.msg.sender==="user"?n.userAvatar:n.charAvatar,alt:"avatar"},null,8,ll)):(h(),y("div",{key:1,class:q(["default-avatar",{user:n.msg.sender==="user"}])},null,2))]),e("div",il,[e("div",cl,[e("div",{class:q(["msg-bubble",m.value]),style:Se(n.bubbleStyle),onMousedown:r,onMouseup:S,onMouseleave:S,onTouchstart:r,onTouchend:S,onTouchmove:U,onClick:Ue(b,["prevent"])},[n.msg.quote?(h(),y("div",rl,[e("div",dl,a(n.msg.quote.sender==="user"?"你":n.charName)+":",1),e("div",ul,a(n.msg.quote.content),1)])):H("",!0),C.value?(h(),y("div",vl,[F(e("textarea",{"onUpdate:modelValue":M[2]||(M[2]=G=>c.value=G),class:"edit-textarea",rows:"3"},null,512),[[j,c.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:L,class:"edit-btn cancel"},"取消"),e("button",{onClick:f,class:"edit-btn save"},"保存")])])):(h(),y(ve,{key:2},[n.msg.type==="text"?(h(),y("div",gl,a(n.msg.content),1)):n.msg.type==="image"?(h(),y(ve,{key:1},[n.msg.isTextGenerated||n.msg.sender!=="user"&&!n.msg.content.startsWith("http")&&!n.msg.content.startsWith("data:")?(h(),y("div",{key:0,class:"text-generated-image-container",onClick:M[3]||(M[3]=G=>s(t).preview(n.msg))},[e("div",ml,a(n.msg.content),1)])):(h(),y("div",{key:1,class:"image-msg",onClick:M[4]||(M[4]=G=>s(t).preview(n.msg))},[e("img",{src:n.msg.content,alt:"图片"},null,8,hl)]))],64)):n.msg.type==="sticker"?(h(),y("div",pl,[e("img",{src:n.msg.content,alt:"表情包"},null,8,bl)])):n.msg.type==="voice"?(h(),y("div",fl,[e("div",yl,[T(X,{name:"voice-wave",class:q(["voice-icon-svg",{playing:u.value}])},null,8,["class"]),e("span",null,a(Math.min(60,Math.ceil(n.msg.content.length/2)))+'"',1)])])):n.msg.type==="location"?(h(),y("div",Cl,[e("div",kl,[e("div",Sl,a(n.msg.content||"位置信息"),1),M[5]||(M[5]=e("div",{class:"msg-desc"},"详细地址",-1))]),M[6]||(M[6]=Xe('<div class="location-map" data-v-8cb932da><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-8cb932da><div class="location-pin" data-v-8cb932da><svg viewBox="0 0 24 24" fill="currentColor" data-v-8cb932da><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-8cb932da></path></svg></div></div>',1))])):n.msg.type==="transfer"?(h(),y("div",wl,[e("div",Ml,[M[7]||(M[7]=e("div",{class:"transfer-icon"},"¥",-1)),e("div",$l,[e("div",_l,"¥"+a(n.msg.content),1),e("div",Il,a(n.msg.sender==="user"?`转账给${n.charName}`:"转账给你"),1)])]),M[8]||(M[8]=e("div",{class:"transfer-footer"},"微信转账",-1))])):n.msg.type==="call_summary"?(h(),y("div",xl,[M[9]||(M[9]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,a(n.msg.content),1)])):H("",!0)],64))],38),n.msg.blocked&&n.msg.sender!=="user"?(h(),y("div",Tl,[...M[10]||(M[10]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):H("",!0)]),n.msg.type==="voice"?F((h(),y("div",{key:0,class:"voice-text"},a(n.msg.content),513)),[[Ye,u.value]]):H("",!0)])],64))],2))}},Bl=ae(Pl,[["__scopeId","data-v-8cb932da"]]),Al={key:0,class:"empty-message"},Ul={key:0,class:"blocked-overlay"},Vl={class:"blocked-content"},Dl={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content"],setup(n,{expose:k}){const p=n,o=d(null),t=()=>{o.value&&(o.value.scrollTop=o.value.scrollHeight)};return le(()=>p.messages,()=>{Fe(()=>{t()})},{deep:!0}),le(()=>p.activePanel,u=>{u&&Fe(()=>{t()})}),et(()=>{t()}),k({scrollToBottom:t}),(u,l)=>(h(),y(ve,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:o},[n.messages.length===0?(h(),y("div",Al," 开始和 "+a(n.charName)+" 聊天吧~ ",1)):H("",!0),(h(!0),y(ve,null,Ve(n.messages,c=>(h(),fe(Bl,{key:c.id,msg:c,charName:n.charName,charAvatar:n.charAvatar,userAvatar:n.userAvatar,bubbleStyle:n.bubbleStyle,isSelectionMode:n.isSelectionMode,isSelected:n.selectedMessageIds.has(c.id),editingMessageId:n.editingMessageId,onSaveEdit:l[0]||(l[0]=C=>u.$emit("save-edit",C)),onCancelEdit:l[1]||(l[1]=C=>u.$emit("cancel-edit")),onToggleSelection:l[2]||(l[2]=C=>u.$emit("toggle-selection",C)),onLongPress:l[3]||(l[3]=(C,m)=>u.$emit("long-press",C,m)),onCancelLongPress:l[4]||(l[4]=C=>u.$emit("cancel-long-press")),onTouchMove:l[5]||(l[5]=C=>u.$emit("touch-move",C)),onClickMsg:l[6]||(l[6]=(C,m)=>u.$emit("click-msg",C,m)),onShowTextContent:l[7]||(l[7]=C=>u.$emit("show-text-content",C))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"]))),128))],512),n.isBlocked?(h(),y("div",Ul,[e("div",Vl,[l[9]||(l[9]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:l[8]||(l[8]=c=>u.$emit("unblock"))},"解除拉黑")])])):H("",!0)],64))}},Ll=ae(Dl,[["__scopeId","data-v-460d6803"]]),El={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(n,{emit:k}){const p=n,o=k,t=N({get:()=>p.visible,set:c=>o("update:visible",c)}),u=d("");le(()=>p.visible,c=>{c&&(u.value="")});const l=()=>{const c=u.value.trim();o("confirm",c),t.value=!1};return(c,C)=>(h(),fe(De,{visible:t.value,"onUpdate:visible":C[2]||(C[2]=m=>t.value=m),title:"发送语音"},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:C[1]||(C[1]=m=>t.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:l},"发送")]),default:O(()=>[F(e("input",{type:"text",class:"base-input","onUpdate:modelValue":C[0]||(C[0]=m=>u.value=m),placeholder:"输入语音内容..."},null,512),[[j,u.value]])]),_:1},8,["visible"]))}},Rl={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(n,{emit:k}){const p=n,o=k,t=N({get:()=>p.visible,set:C=>o("update:visible",C)}),u=d(""),l=d("");le(()=>p.visible,C=>{C&&(u.value="",l.value="")});const c=()=>{const C=u.value.trim(),m=l.value.trim();C&&(o("confirm",{name:C,detail:m}),t.value=!1)};return(C,m)=>(h(),fe(De,{visible:t.value,"onUpdate:visible":m[3]||(m[3]=r=>t.value=r),title:"发送位置"},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:m[2]||(m[2]=Ue(r=>t.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:c},"发送")]),default:O(()=>[F(e("input",{type:"text",class:"base-input","onUpdate:modelValue":m[0]||(m[0]=r=>u.value=r),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[j,u.value]]),F(e("input",{type:"text",class:"base-input","onUpdate:modelValue":m[1]||(m[1]=r=>l.value=r),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[j,l.value]])]),_:1},8,["visible"]))}},Nl={class:"chat-list-container"},ql=["onClick"],Fl=["src"],zl={class:"chat-info"},Ol={class:"chat-name"},jl=["disabled"],Hl={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(n,{emit:k}){const p=n,o=k,t=ye(),u=d(p.visible),l=d(new Set),c=N(()=>t.characters);le(()=>p.visible,r=>{u.value=r,r||l.value.clear()});const C=r=>{l.value.has(r)?l.value.delete(r):l.value.add(r)},m=()=>{l.value.size>0&&o("confirm",Array.from(l.value))};return(r,S)=>(h(),fe(De,{visible:u.value,"onUpdate:visible":S[1]||(S[1]=U=>u.value=U),title:"选择聊天",onClose:S[2]||(S[2]=U=>r.$emit("close"))},{footer:O(()=>[e("button",{class:"modal-btn cancel",onClick:S[0]||(S[0]=U=>r.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:l.value.size===0,onClick:m}," 确定 ("+a(l.value.size)+") ",9,jl)]),default:O(()=>[e("div",Nl,[(h(!0),y(ve,null,Ve(c.value,U=>(h(),y("div",{key:U.id,class:"chat-item",onClick:b=>C(U.id)},[e("img",{src:U.avatar,alt:"avatar",class:"avatar"},null,8,Fl),e("div",zl,[e("div",Ol,a(U.name),1)]),e("div",{class:q(["checkbox",{selected:l.value.has(U.id)}])},null,2)],8,ql))),128))])]),_:1},8,["visible"]))}},Wl=ae(Hl,[["__scopeId","data-v-00bcf675"]]),Gl={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(n){const k=n;Je();const{t:p}=Me(),o=ye(),t=we(),u=ot(),l=d(null),c=d(null),C=d(null),m=d(!1),r=d({visible:!1,messageId:null,targetEl:null}),S=d(!1),U=d(!1),b=d(!1),_=N(()=>o.getCharacter(k.charId)),w=N(()=>{var A;return((A=_.value)==null?void 0:A.isBlocked)||!1}),f=N(()=>{var A,x;return((A=_.value)==null?void 0:A.nickname)||((x=_.value)==null?void 0:x.name)||p("chat.unknownCharacter")}),L=N(()=>{var A;return(A=_.value)==null?void 0:A.avatar}),R=N(()=>{var A;return((A=_.value)==null?void 0:A.status)||{}}),E=N(()=>{var A;return((A=_.value)==null?void 0:A.chatBackground)||""}),M=N(()=>{var x;const A=o.userPersonas;if((x=_.value)!=null&&x.userPersona&&_.value.userPersona!=="default"){const z=A.find(Te=>Te.id===_.value.userPersona);if(z&&z.avatar)return z.avatar}return localStorage.getItem("homeAvatar")||""}),G=N(()=>o.messages[k.charId]||[]),D=N(()=>{var A;return((A=_.value)==null?void 0:A.bubbleSettings)||{}}),{isSelectionMode:B,selectedMessageIds:$,isForwarding:W,enterSelectionMode:J,exitSelectionMode:ne,toggleMessageSelection:ee,handleBatchAction:ge,handleConfirmForward:te}=At(qe(k,"charId")),{isTyping:me,triggerAiResponse:de}=Pt(qe(k,"charId"),u),{inputText:se,quotingMessage:I,sendMessage:P,sendSticker:K,sendVoiceMessage:V,handleSendImage:Q,confirmSendLocation:ie,sendTransfer:ce}=Vt(o,qe(k,"charId"),t,C),{editingMessageId:oe,handleEditMessage:Ce,handleSaveEdit:ke,updateInputText:ue}=Ut(o,qe(k,"charId"),se),{startLongPress:_e,cancelLongPress:Le,handleTouchMove:he,wasClickAfterLongPress:Ie}=Dt(r),xe=N(()=>{const A=D.value,x={fontSize:A.fontSize?`${A.fontSize}px`:"14px"};if(A.css){const z={};return A.css.split(";").forEach(Te=>{const Pe=Te.split(":");if(Pe.length>=2){const Re=Pe[0].trim(),Ne=Pe.slice(1).join(":").trim();Re&&Ne&&(z[Re]=Ne)}}),{...x,...z}}return x});et(()=>{o.clearUnreadCount(k.charId)});const Z=()=>{_.value&&(_.value.isBlocked=!1,o.messages[k.charId]&&o.messages[k.charId].forEach(A=>{A.blocked&&(A.blocked=!1)}),o.saveData(),t.showToast(p("chat.toast.unblocked")))},pe=A=>{const x=A.target;x.closest(".modal-overlay.active")||(C.value&&!x.closest(".chat-footer")&&(C.value=null),B.value&&!x.closest(".message")&&!x.closest(".chat-action-row")&&!x.closest(".message-checkbox")&&!x.closest(".message-menu")&&ne(),r.value.visible&&!x.closest(".message-menu")&&(r.value.visible=!1))},$e=(A,x)=>{if(Ie()){A.preventDefault(),A.stopPropagation();return}B.value&&ee(x)},ze=A=>{const x=G.value.find(z=>z.id===A);x&&(I.value=x)},Oe=()=>{U.value=!0},je=A=>{V(A),U.value=!1},He=()=>{C.value=null,S.value=!0},Ee=()=>{b.value=!0},We=({name:A,detail:x})=>{ie(A,x),b.value=!1},re=()=>{o.startVideoCall(k.charId)};return(A,x)=>(h(),y("div",{class:q(["chat-room active",{"selection-mode":s(B)}]),onClick:pe,ref_key:"chatRoomRef",ref:c},[e("div",{class:"chat-bg",style:Se(E.value?{backgroundImage:`url(${E.value})`}:{})},null,4),T(vs,{charId:k.charId,charName:f.value,charStatus:R.value,isTyping:s(me),onTriggerAi:s(de),onOpenSettings:x[0]||(x[0]=z=>m.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),T(Ll,{ref_key:"messageListRef",ref:l,messages:G.value,charName:f.value,charAvatar:L.value,userAvatar:M.value,bubbleStyle:xe.value,isSelectionMode:s(B),selectedMessageIds:s($),isBlocked:w.value,editingMessageId:s(oe),activePanel:C.value,onSaveEdit:s(ke),onCancelEdit:x[1]||(x[1]=z=>oe.value=null),onToggleSelection:s(ee),onLongPress:s(_e),onCancelLongPress:s(Le),onTouchMove:s(he),onClickMsg:$e,onUnblock:Z},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),s(B)?H("",!0):(h(),fe(Fs,{key:0,modelValue:s(se),"onUpdate:modelValue":x[2]||(x[2]=z=>Bt(se)?se.value=z:null),activePanel:C.value,"onUpdate:activePanel":x[3]||(x[3]=z=>C.value=z),quotingMessage:s(I),onCancelQuote:x[4]||(x[4]=z=>I.value=null),onSendMessage:s(P),onSendSticker:s(K),onTriggerVoice:Oe,onTriggerImage:He,onTriggerVideo:re,onTriggerLocation:Ee,onTriggerTransfer:s(ce)},null,8,["modelValue","activePanel","quotingMessage","onSendMessage","onSendSticker","onTriggerTransfer"])),s(B)?(h(),fe(nl,{key:1,onAction:s(ge),onCancel:s(ne)},null,8,["onAction","onCancel"])):H("",!0),T(El,{visible:U.value,"onUpdate:visible":x[5]||(x[5]=z=>U.value=z),onConfirm:je},null,8,["visible"]),T(Ze,{visible:S.value,"onUpdate:visible":x[6]||(x[6]=z=>S.value=z),onSendImage:s(Q)},null,8,["visible","onSendImage"]),T(Rl,{visible:b.value,"onUpdate:visible":x[7]||(x[7]=z=>b.value=z),onConfirm:We},null,8,["visible"]),T(tl,{visible:r.value.visible,targetEl:r.value.targetEl,messageId:r.value.messageId,charId:k.charId,isSelectionMode:s(B),selectedMessageIds:s($),onClose:x[8]||(x[8]=z=>r.value.visible=!1),onEnterSelectionMode:s(J),onTriggerAiResponse:s(de),"onUpdate:inputText":s(ue),onQuoteMessage:ze,onEditMessage:s(Ce)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),m.value?(h(),fe(Jo,{key:2,visible:m.value,"onUpdate:visible":x[9]||(x[9]=z=>m.value=z),charId:k.charId},null,8,["visible","charId"])):H("",!0),T(Wl,{visible:s(W),onClose:x[10]||(x[10]=z=>W.value=!1),onConfirm:s(te)},null,8,["visible","onConfirm"])],2))}},Xl=ae(Gl,[["__scopeId","data-v-d06b6c30"]]);export{Xl as default};
