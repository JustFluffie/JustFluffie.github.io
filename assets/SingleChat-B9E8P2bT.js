import{m as W,E as Ke,r as w,G as Xe,u as Ze,i as ce,q as _,D as ae,_ as F,k as Q,a as S,o as b,e,f as R,z as k,y,h as de,w as H,v as O,x as J,M as ee,c as L,b as q,F as j,A as X,n as U,H as re,C as Z,I as be,t as z,d as Y,S as oe,J as _e,B as G,L as et,N as tt,s as ke,O as st,P as K,Q as nt,R as ne,T as ot}from"./index-gMwCw4Iw.js";const at=(t,v)=>{const o=v.map(s=>`${s.role==="user"?"用户":t.name}: ${s.content}`).join(`
`);return`
你正在扮演角色“${t.name}”，你需要根据以下设定和最近的对话，生成一段角色的实时“心声”。
心声由多个部分组成，请严格按照下面的JSON格式返回，不要添加任何额外的解释或文字。

**角色人设:**
${t.charPersona}

**最近对话:**
${o}

**你的任务:**
生成符合当前情境和角色性格的内心活动。
- **情绪 (emotion)**: 描述角色当前的主要情绪，应在一定时间内保持稳定，5字以内。
- **穿着 (outfit)**: 描述角色当前的穿着，应在一定时间内保持稳定，10字以内。
- **姿态 (posture)**: 描述角色当前的姿态或小动作，应在一定时间内保持稳定，15字以内。
- **内心独白 (innerVoice)**: 角色此刻具体的内心想法，50字以内。
- **没说出口的话 (unspokenWords)**: 一句角色想说但没说出口的话，风格可以多变（如阴暗、腹黑、酸涩、色情等），必须符合人设，15字以内。
- **标题 (title)**: 为这次心声生成一个简短的小标题，例如“#01 初次见面”。

**输出格式 (必须是可被解析的JSON):**
{
  "emotion": "...",
  "outfit": "...",
  "posture": "...",
  "innerVoice": "...",
  "unspokenWords": "...",
  "title": "..."
}
`};function it(t,v){const o=W(),s=Ke(),u=ce(),f=Ze(),r=w(!1),a=async()=>{console.log("[useAiResponder] triggerAiResponse triggered"),r.value=!0;try{const i=o.getCharacter(t.value),p=await v.getChatCompletion(t.value);if(p){o.messages[t.value]||(o.messages[t.value]=[]);const n=(i==null?void 0:i.isBlocked)||!1;let m=p.split("|||"),d=[];const g=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g;m.forEach(l=>{const h=l.split(g).map(A=>A.trim()).filter(A=>A);d.push(...h)});for(let l=0;l<d.length;l++){const h=d[l];l>0&&await new Promise(I=>setTimeout(I,1e3+Math.random()*1e3));let{type:A,content:T}=Xe(h),E={};if(A==="sticker"){const I=T,C=o.stickers.find(V=>V.name===I);C?(T=C.url,E.name=I):(A="text",T=`[表情包：${I}]`)}let B=!1;A==="image"&&!T.startsWith("http")&&!T.startsWith("data:")&&(B=!0),o.messages[t.value].push({id:Date.now().toString()+l,sender:"char",type:A,content:T,isTextGenerated:B,...E,time:Date.now(),blocked:n}),o.saveData(),f.path!==`/chat/room/${t.value}`&&(o.incrementUnreadCount(t.value),s.triggerNotification(i.nickname||i.name,A==="text"?T:`[${A}]`,i.avatar,()=>{u.push(`/chat/room/${t.value}`)},3e3,A))}}}catch(i){console.error("[useAiResponder] triggerAiResponse failed:",i)}finally{r.value=!1,c()}},c=async()=>{try{const i=o.getCharacter(t.value);if(!i)return;const p=o.getFormattedRecentMessages(t.value,10),n=at(i,p),m=await v.getGenericCompletion([{role:"user",content:n}]);if(m){const d=m.indexOf("{"),g=m.lastIndexOf("}");if(d!==-1&&g!==-1){const l=m.substring(d,g+1),h=JSON.parse(l);o.addInnerVoice(t.value,h),console.log("[useAiResponder] Inner voice generated and saved:",h)}else console.warn("[useAiResponder] Failed to find JSON in inner voice response.")}}catch(i){console.error("[useAiResponder] Failed to generate inner voice:",i)}};return{isTyping:r,triggerAiResponse:a}}function lt(t){const v=W(),o=_(),s=w(!1),u=w(new Set),f=w(!1),r=n=>{console.log("[useMessageSelection] enterSelectionMode triggered"),s.value=!0,u.value.clear(),n&&u.value.add(n)},a=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),s.value=!1,u.value.clear()};return{isSelectionMode:s,selectedMessageIds:u,isForwarding:f,enterSelectionMode:r,exitSelectionMode:a,toggleMessageSelection:n=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${n}`),u.value.has(n)?u.value.delete(n):u.value.add(n)},handleBatchAction:n=>{if(console.log(`[useMessageSelection] handleBatchAction: ${n}`),u.value.size===0)return;const m=v.messages[t.value];n==="forward"?f.value=!0:n==="delete"?o.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),v.messages[t.value]=m.filter(d=>!u.value.has(d.id)),v.saveData(),a()}):n==="favorite"&&(v.favorites||(v.favorites=[]),m.forEach(d=>{u.value.has(d.id)&&(v.favorites.some(g=>g.id===d.id)||v.favorites.push(d))}),v.saveData(),o.showToast("已收藏","success"),a())},handleConfirmForward:n=>{console.log("[useMessageSelection] handleConfirmForward triggered"),f.value=!1;const d=(v.messages[t.value]||[]).filter(g=>u.value.has(g.id));d.length!==0&&(n.forEach(g=>{v.messages[g]||(v.messages[g]=[]),d.forEach(l=>{const h={...l,id:Date.now().toString()+Math.random()};v.messages[g].push(h)})}),v.saveData(),o.showToast(`已转发 ${d.length} 条消息`),a())}}}function rt(t,v,o){const s=w(null);return{editingMessageId:s,handleEditMessage:a=>{console.log("[useMessageEditing] handleEditMessage for msgId:",a),s.value=a},handleSaveEdit:({msgId:a,newContent:c})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",a);const p=t.messages[v.value].find(n=>n.id===a);p&&(p.content=c,t.saveData()),s.value=null},updateInputText:a=>{console.log("[useMessageEditing] updateInputText called"),o&&(o.value=a,ae(()=>{const c=document.querySelector(".chat-input");c&&c.focus()}))}}}function ct(t,v,o,s){const u=w(""),f=w(null),r=(d,g,l={})=>{console.log(`[useMessageSender] sendMsg called with type: ${d}`);const h={...l};f.value&&(h.quote={id:f.value.id,sender:f.value.sender,content:f.value.content}),t.messages[v.value]||(t.messages[v.value]=[]),t.messages[v.value].push({id:Date.now().toString()+Math.random(),sender:"user",type:d,content:g,timestamp:Date.now(),...h}),t.saveData(),s&&(s.value=null),f.value=null};return{inputText:u,quotingMessage:f,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const d=u.value.trim();d&&(r("text",d),u.value="")},sendMsg:r,sendSticker:d=>{console.log("[useMessageSender] sendSticker triggered"),r("sticker",d.url,{name:d.name})},sendVoiceMessage:d=>{console.log("[useMessageSender] sendVoiceMessage triggered"),d&&r("voice",d)},handleSendImage:d=>{console.log("[useMessageSender] handleSendImage triggered"),d.isTextGenerated?r("image",d.description,{isTextGenerated:!0}):(d.type==="base64"||d.type==="url")&&r("image",d.content)},confirmSendLocation:(d,g)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!d){o.showToast("请输入位置名称","info");return}r("location",d,{detail:g})},sendTransfer:()=>{console.log("[useMessageSender] sendTransfer triggered"),r("transfer","88.88")}}}function dt(t){const v=w(null),o=w(!1),s=w({x:0,y:0}),u=(i,p)=>{console.log("[useMessageInteraction] showMenu triggered"),i.preventDefault();const n=i.target.closest(".msg-bubble, .system-message-wrapper");n&&(t.value={visible:!0,messageId:p,targetEl:n})};return{startLongPress:(i,p)=>{console.log("[useMessageInteraction] startLongPress triggered"),i.stopPropagation(),o.value=!1,clearTimeout(v.value),i.type.startsWith("touch")&&(s.value={x:i.touches[0].clientX,y:i.touches[0].clientY}),v.value=setTimeout(()=>{o.value=!0,u(i,p)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(v.value)},handleTouchMove:i=>{console.log("[useMessageInteraction] handleTouchMove triggered");const p=i.touches[0],n=Math.abs(p.clientX-s.value.x),m=Math.abs(p.clientY-s.value.y);(n>10||m>10)&&clearTimeout(v.value)},wasClickAfterLongPress:()=>o.value?(o.value=!1,!0):!1}}const ut={class:"chat-room-header"},vt={class:"left-icons"},gt={class:"center-container"},mt={class:"header-title-area"},ft={key:0,class:"chat-room-title"},pt={key:1,class:"typing-indicator"},ht={class:"right-icons"},bt={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},kt=["placeholder"],yt=["placeholder"],St={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:v}){const o=t,{t:s}=Q(),u=ce(),f=W(),r=_(),a=w(!1),c=w(""),i=w(""),p=()=>{u.options.history.state.back?u.back():u.push("/chat")},n=()=>{const g=o.charStatus||{};c.value=g.icon||"✨",i.value=g.text||"",a.value=!0},m=()=>{const g=c.value.trim()||"✨",l=i.value.trim(),h=f.getCharacter(o.charId);h&&(l?h.status={icon:g,text:l}:h.status=null,f.saveData(),r.showToast(s("saveSuccess"))),a.value=!1},d=()=>{u.push({name:"memory-bank",params:{charId:o.charId}})};return(g,l)=>(b(),S("div",ut,[e("div",vt,[e("div",{class:"btn-icon back-btn",onClick:p},[...l[6]||(l[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polyline",{points:"15 18 9 12 15 6"})],-1)])]),e("div",{class:"btn-icon bell-btn",onClick:l[0]||(l[0]=h=>g.$emit("trigger-ai")),ref:"bellBtn"},[...l[7]||(l[7]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)]),e("div",gt,[e("div",mt,[t.isTyping?(b(),S("div",pt,[e("span",null,k(y(s)("chat.singleChat.typing")),1),l[8]||(l[8]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(b(),S("div",ft,k(t.charName),1))]),e("div",{class:"chat-room-status",onClick:n},[e("span",null,k(t.charStatus.icon||"✨"),1),e("span",null,k(t.charStatus.text||y(s)("chat.singleChat.addStatus")),1)])]),e("div",ht,[e("div",{class:"btn-icon memory-btn",onClick:d},[...l[9]||(l[9]=[de('<svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-c4e37645><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" data-v-c4e37645></path><polyline points="14 2 14 8 20 8" data-v-c4e37645></polyline><line x1="16" y1="13" x2="8" y2="13" data-v-c4e37645></line><line x1="16" y1="17" x2="8" y2="17" data-v-c4e37645></line><polyline points="10 9 9 9 8 9" data-v-c4e37645></polyline></svg>',1)])]),e("div",{class:"btn-icon more-btn",onClick:l[1]||(l[1]=h=>g.$emit("open-settings"))},[...l[10]||(l[10]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])]),R(ee,{visible:a.value,"onUpdate:visible":l[5]||(l[5]=h=>a.value=h),title:y(s)("chat.singleChat.setStatus")},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:l[4]||(l[4]=h=>a.value=!1)},k(y(s)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:m},k(y(s)("confirm")),1)]),default:H(()=>[e("div",bt,[O(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[2]||(l[2]=h=>c.value=h),placeholder:y(s)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,kt),[[J,c.value]]),O(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[3]||(l[3]=h=>i.value=h),placeholder:y(s)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,yt),[[J,i.value]])])]),_:1},8,["visible","title"])]))}},$t=F(St,[["__scopeId","data-v-c4e37645"]]),Mt={key:0,class:"chat-panel",id:"stickerPanel"},wt={class:"sticker-panel-header"},Ct={class:"sticker-groups"},xt=["onClick"],It={class:"sticker-panel-content"},Tt=["onClick"],Bt=["src","alt"],Vt={class:"sticker-panel-footer"},At={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:v}){const o=v,s=W(),u=_(),f=w("默认"),r=w(!1),a=w(new Set),c=w(!1),i=w(!1),p=w(""),n=L(()=>["默认",...new Set(s.stickers.map(V=>V.group).filter(Boolean).filter(V=>V!=="默认"))]),m=L(()=>s.stickers.filter(C=>C.group===f.value)),d=C=>{r.value?a.value.has(C.id)?a.value.delete(C.id):a.value.add(C.id):o("send-sticker",C)},g=({group:C,stickers:V})=>{const x=V.map(D=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:D.url,name:D.name,group:C}));s.stickers.push(...x),s.saveData(),u.showToast(`成功导入 ${x.length} 个表情包`,"success")},l=()=>{c.value=!0},h=()=>{a.value.size>0&&(i.value=!0)},A=()=>{r.value=!r.value,a.value.clear()},T=()=>{const C=m.value;C.every(x=>a.value.has(x.id))?C.forEach(x=>a.value.delete(x.id)):C.forEach(x=>a.value.add(x.id))},E=()=>{a.value.size!==0&&u.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{s.stickers=s.stickers.filter(C=>!a.value.has(C.id)),s.saveData(),a.value.clear()})},B=()=>{const C=p.value.trim();if(!C)return u.showToast("请输入目标分组","info");s.stickers.forEach(V=>{a.value.has(V.id)&&(V.group=C)}),s.saveData(),i.value=!1,p.value="",a.value.clear(),r.value=!1,f.value=C},I=()=>{if(a.value.size===0)return;const C=s.stickers.filter(N=>a.value.has(N.id)).map(N=>`${N.name} ${N.url}`).join(`
`),V=new Blob([C],{type:"text/plain"}),x=URL.createObjectURL(V),D=document.createElement("a");D.href=x,D.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(D),D.click(),document.body.removeChild(D),URL.revokeObjectURL(x),a.value.clear(),r.value=!1};return(C,V)=>(b(),S("div",null,[t.visible?(b(),S("div",Mt,[e("div",wt,[e("div",Ct,[(b(!0),S(j,null,X(n.value,x=>(b(),S("div",{class:U(["sticker-group-tab",{active:f.value===x}]),key:x,onClick:D=>f.value=x},k(x),11,xt))),128))])]),e("div",It,[(b(!0),S(j,null,X(m.value,x=>(b(),S("div",{class:U(["sticker-item",{selected:a.value.has(x.id),"manage-mode":r.value}]),key:x.id,onClick:D=>d(x)},[e("img",{src:x.url,alt:x.name},null,8,Bt),e("span",null,k(x.name),1)],10,Tt))),128))]),e("div",Vt,[O(e("div",{class:"sticker-add-btn",onClick:l},"＋",512),[[re,!r.value]]),e("div",{class:"sticker-manage-btn",style:Z({color:r.value?"var(--danger-color)":"#576B95"}),onClick:A},k(r.value?"完成":"管理"),5)]),e("div",{class:U(["manage-bar",{active:r.value}])},[e("button",{class:"btn btn-secondary",onClick:l},"导入"),e("button",{class:"btn btn-secondary",onClick:T},"全选"),e("button",{class:"btn btn-secondary",onClick:h},"移动"),e("button",{class:"btn btn-secondary",onClick:I},"导出"),e("button",{class:"btn btn-danger",onClick:E},"删除")],2)])):q("",!0),R(be,{visible:c.value,"onUpdate:visible":V[0]||(V[0]=x=>c.value=x),type:"sticker-import",onImportSticker:g},null,8,["visible"]),R(ee,{visible:i.value,"onUpdate:visible":V[3]||(V[3]=x=>i.value=x),title:"移动到分组"},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:V[2]||(V[2]=x=>i.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:B},"确定")]),default:H(()=>[O(e("input",{type:"text",class:"base-input","onUpdate:modelValue":V[1]||(V[1]=x=>p.value=x),placeholder:"输入目标分组名称"},null,512),[[J,p.value]])]),_:1},8,["visible"])]))}},Pt=F(At,[["__scopeId","data-v-f9fb1def"]]),Lt={class:"chat-panel",id:"morePanel"},Et={class:"more-panel-content"},Rt={class:"more-label"},Dt={class:"more-label"},qt={class:"more-label"},Nt={class:"more-label"},Ut={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:v}=Q();return(o,s)=>(b(),S("div",Lt,[e("div",Et,[e("div",{class:"more-item",onClick:s[0]||(s[0]=u=>o.$emit("trigger-image-upload"))},[s[4]||(s[4]=de('<div class="more-icon" data-v-731b24d5><svg class="svg-icon" viewBox="0 0 24 24" data-v-731b24d5><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-731b24d5></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-731b24d5></circle><polyline points="21 15 16 10 5 21" data-v-731b24d5></polyline></svg></div>',1)),e("span",Rt,k(y(v)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:s[1]||(s[1]=u=>o.$emit("start-video-call"))},[s[5]||(s[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Dt,k(y(v)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:s[2]||(s[2]=u=>o.$emit("send-location"))},[s[6]||(s[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",qt,k(y(v)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:s[3]||(s[3]=u=>o.$emit("send-transfer"))},[s[7]||(s[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),e("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})])],-1)),e("span",Nt,k(y(v)("chat.morePanel.transfer")),1)])])]))}},zt=F(Ut,[["__scopeId","data-v-731b24d5"]]),Ft={class:"chat-footer"},Ot={key:0,class:"quote-preview"},jt={class:"quote-content"},Ht={class:"quote-sender"},Wt={class:"quote-text"},Gt={class:"chat-input-row"},Jt={class:"chat-input-wrapper"},Yt=["value","onKeydown"],Qt={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"21px",height:"21px",position:"relative",top:"1px",left:"-1px"}},Kt={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null},charId:{type:String,required:!0}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:v}){const{t:o}=Q(),s=W(),u=t,f=v,r=w(u.activePanel);z(()=>u.activePanel,n=>{r.value=n}),z(r,n=>{f("update:activePanel",n)});const a=L(()=>{if(!u.quotingMessage)return"";if(u.quotingMessage.sender==="user")return o("chat.self");{const n=s.getCharacter(u.charId);return(n==null?void 0:n.nickname)||(n==null?void 0:n.name)||o("chat.other")}}),c=n=>{r.value===n?r.value=null:r.value=n},i=()=>{u.modelValue.trim()&&f("send-message")},p=n=>{f("send-sticker",n),r.value=null};return(n,m)=>(b(),S("div",Ft,[t.quotingMessage?(b(),S("div",Ot,[e("div",jt,[e("span",Ht,k(a.value)+": ",1),e("span",Wt,k(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:m[0]||(m[0]=d=>n.$emit("cancel-quote"))},[...m[9]||(m[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):q("",!0),e("div",Gt,[e("div",{class:"chat-tool-btn",onClick:m[1]||(m[1]=d=>n.$emit("trigger-voice"))},[R(oe,{name:"voice-circle",class:"svg-icon"})]),e("div",Jt,[e("textarea",{class:"chat-input",value:t.modelValue,onInput:m[2]||(m[2]=d=>n.$emit("update:modelValue",d.target.value)),onKeydown:_e(G(i,["exact","prevent"]),["enter"]),id:"messageInput",autocomplete:"off",rows:"1"},null,40,Yt)]),e("div",{class:"chat-tool-btn",onClick:m[3]||(m[3]=d=>c("sticker"))},[R(oe,{name:"sticker",class:"svg-icon"})]),t.modelValue?(b(),S("div",{key:1,class:"send-btn-icon",onClick:i},[(b(),S("svg",Qt,[...m[10]||(m[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(b(),S("div",{key:0,class:"chat-tool-btn",onClick:m[4]||(m[4]=d=>c("more"))},[R(oe,{name:"plus-circle",class:"svg-icon"})]))]),R(Pt,{visible:r.value==="sticker",onSendSticker:p},null,8,["visible"]),r.value==="more"?(b(),Y(zt,{key:1,onTriggerImageUpload:m[5]||(m[5]=d=>n.$emit("trigger-image")),onStartVideoCall:m[6]||(m[6]=d=>n.$emit("trigger-video")),onSendLocation:m[7]||(m[7]=d=>n.$emit("trigger-location")),onSendTransfer:m[8]||(m[8]=d=>n.$emit("trigger-transfer"))})):q("",!0)]))}},Xt=F(Kt,[["__scopeId","data-v-490ed303"]]),Zt={class:"menu-grid"},_t={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:v}){const o=t,s=v,u=et("phoneScreenRef"),{t:f}=Q(),r=W(),a=_(),c=w(null),i=w({}),p=w(0),n=w("top");z(()=>o.visible,async g=>{g&&o.targetEl&&(await ae(),m())});const m=()=>{const g=c.value;if(!g)return;const l=o.targetEl.getBoundingClientRect(),h=g.offsetWidth,A=g.offsetHeight,T=8,E=u.value,B=E?E.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};n.value="top";let I=l.top-A-T;I<B.top+T&&(n.value="bottom",I=l.bottom+T);const C=l.left+l.width/2;let V=C-h/2;V<B.left+T&&(V=B.left+T),V+h>B.left+B.width-T&&(V=B.left+B.width-h-T);let x=C-V;const D=12,N=D/2+5,te=h-D/2-5;x=Math.max(N,Math.min(x,te)),i.value={top:`${I}px`,left:`${V}px`},p.value=x},d=g=>{const l=o.messageId;if(!l)return;const h=r.messages[o.charId],A=h.findIndex(B=>B.id===l),T=h[A],E={copy:()=>{T.content&&(navigator.clipboard.writeText(T.content),a.showToast(f("chat.messageMenu.toast.copied")))},favorite:()=>{r.favorites||(r.favorites=[]),r.favorites.some(B=>B.id===T.id)?a.showToast(f("chat.messageMenu.toast.alreadyFavorited")):(r.favorites.push(T),r.saveData(),a.showToast(f("chat.messageMenu.toast.favorited")))},delete:()=>{a.showConfirm(f("chat.messageMenu.confirmDelete"),f("chat.messageMenu.confirmDeleteMsg"),()=>{r.messages[o.charId].splice(A,1),r.saveData()})},revoke:()=>{T&&(T.type="revoked",r.saveData(),a.showToast(f("chat.messageMenu.toast.revoked")))},select:()=>s("enter-selection-mode",l),quote:()=>s("quote-message",l),retry:()=>{T.sender!=="user"?r.messages[o.charId].splice(A,1):r.retryFromMessage(o.charId,l),r.saveData(),s("trigger-ai-response")},edit:()=>{T.type==="text"?s("edit-message",l):a.showToast(f("chat.messageMenu.toast.editTextOnly"),"info")}};E[g]&&E[g](),s("close")};return(g,l)=>t.visible?(b(),S("div",{key:0,ref_key:"menuRef",ref:c,class:U(["message-menu",{"menu-top":n.value==="top","menu-bottom":n.value==="bottom"}]),style:Z(i.value)},[e("div",Zt,[e("div",{class:"menu-item",onClick:l[0]||(l[0]=h=>d("copy"))},k(y(f)("copy")),1),e("div",{class:"menu-item",onClick:l[1]||(l[1]=h=>d("favorite"))},k(y(f)("favorite")),1),e("div",{class:"menu-item",onClick:l[2]||(l[2]=h=>d("delete"))},k(y(f)("delete")),1),e("div",{class:"menu-item",onClick:l[3]||(l[3]=h=>d("revoke"))},k(y(f)("revoke")),1),e("div",{class:"menu-item",onClick:l[4]||(l[4]=h=>d("select"))},k(y(f)("select")),1),e("div",{class:"menu-item",onClick:l[5]||(l[5]=h=>d("quote"))},k(y(f)("quote")),1),e("div",{class:"menu-item",onClick:l[6]||(l[6]=h=>d("retry"))},k(y(f)("retry")),1),e("div",{class:"menu-item",onClick:l[7]||(l[7]=h=>d("edit"))},k(y(f)("edit")),1)]),e("div",{class:"menu-arrow",style:Z({left:p.value+"px"})},null,4)],6)):q("",!0)}},es=F(_t,[["__scopeId","data-v-466575cd"]]),ts={class:"chat-action-row"},ss={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:v}=Q();return(o,s)=>(b(),S("div",ts,[e("div",{class:"action-btn",onClick:s[0]||(s[0]=u=>o.$emit("action","favorite"))},[s[4]||(s[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,k(y(v)("favorite")),1)]),e("div",{class:"action-btn",onClick:s[1]||(s[1]=u=>o.$emit("action","forward"))},[s[5]||(s[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,k(y(v)("forward")),1)]),e("div",{class:"action-btn",onClick:s[2]||(s[2]=u=>o.$emit("action","delete"))},[s[6]||(s[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,k(y(v)("delete")),1)]),e("div",{class:"action-btn",onClick:s[3]||(s[3]=u=>o.$emit("cancel"))},[s[7]||(s[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,k(y(v)("done")),1)])]))}},ns=F(ss,[["__scopeId","data-v-be1a592f"]]),os=["src"],as={class:"msg-content-wrapper"},is={class:"msg-bubble-box"},ls={key:0,class:"quote-in-bubble"},rs={class:"quote-in-bubble-sender"},cs={class:"quote-in-bubble-text"},ds={key:1,class:"edit-view"},us={key:0},vs={class:"description-placeholder"},gs=["src"],ms={key:2,class:"sticker-msg"},fs=["src"],ps={key:3,class:"voice-msg-wrapper"},hs={class:"voice-msg"},bs={key:4,class:"location-msg"},ks={class:"location-text"},ys={class:"msg-title"},Ss={key:5,class:"transfer-msg"},$s={class:"transfer-content"},Ms={class:"transfer-info"},ws={class:"transfer-amount"},Cs={class:"transfer-desc"},xs={key:6,class:"call-summary-msg"},Is={key:0,class:"blocked-icon"},Ts={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","show-thought"],setup(t,{emit:v}){const o=t,s=v,u=tt(),f=w(!1),r=w(!1),a=w(""),c=L(()=>o.editingMessageId===o.msg.id),i=L(()=>{const B=o.msg.type;return{"no-style":["image","sticker","location","transfer"].includes(B),"has-location":B==="location","has-transfer":B==="transfer"}});z(c,B=>{B&&(a.value=o.msg.content)});const p=B=>{s("long-press",B,o.msg.id)},n=()=>{s("cancel-long-press")},m=B=>{s("touch-move",B)},d=B=>{o.msg.type==="voice"&&l(),o.msg.type!=="image"&&s("click-msg",B,o.msg.id)},g=()=>{o.msg.sender!=="user"&&s("show-thought",o.msg.id)},l=()=>{f.value=!f.value},h=()=>{r.value=!r.value},A=()=>{a.value.trim()&&s("save-edit",{msgId:o.msg.id,newContent:a.value})},T=()=>{s("cancel-edit")},E=()=>o.msg.type==="notification"?o.msg.content:o.msg.type==="revoked"?`"${o.msg.sender==="user"?"你":o.charName}" 撤回了一条消息`:"";return(B,I)=>(b(),S("div",{class:U(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[e("div",{class:U(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:I[0]||(I[0]=G(C=>B.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),t.msg.type==="revoked"||t.msg.type==="notification"?(b(),S("div",{key:0,class:"system-message-wrapper",onMousedown:p,onMouseup:n,onMouseleave:n,onTouchstart:p,onTouchend:n,onTouchmove:m,onClick:G(d,["prevent"])},[e("div",{class:"system-message-text",onClick:I[1]||(I[1]=G(C=>!t.isSelectionMode&&h(),["stop"]))},k(E()),1),t.msg.type==="revoked"?O((b(),S("div",{key:0,class:"revoked-content"},k(t.msg.sender==="user"?"我":t.charName)+"："+k(t.msg.content),513)),[[re,r.value]]):q("",!0)],32)):(b(),S(j,{key:1},[e("div",{class:"msg-avatar",onClick:g},[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(b(),S("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,os)):(b(),S("div",{key:1,class:U(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",as,[e("div",is,[e("div",{class:U(["msg-bubble",i.value]),style:Z(t.bubbleStyle),onMousedown:p,onMouseup:n,onMouseleave:n,onTouchstart:p,onTouchend:n,onTouchmove:m,onClick:G(d,["prevent"])},[t.msg.quote?(b(),S("div",ls,[e("div",rs,k(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",cs,k(t.msg.quote.content),1)])):q("",!0),c.value?(b(),S("div",ds,[O(e("textarea",{"onUpdate:modelValue":I[2]||(I[2]=C=>a.value=C),class:"edit-textarea",rows:"3"},null,512),[[J,a.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:T,class:"edit-btn cancel"},"取消"),e("button",{onClick:A,class:"edit-btn save"},"保存")])])):(b(),S(j,{key:2},[t.msg.type==="text"?(b(),S("div",us,k(t.msg.content),1)):t.msg.type==="image"?(b(),S(j,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(b(),S("div",{key:0,class:"text-generated-image-container",onClick:I[3]||(I[3]=C=>y(u).preview(t.msg))},[e("div",vs,k(t.msg.content),1)])):(b(),S("div",{key:1,class:"image-msg",onClick:I[4]||(I[4]=C=>y(u).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,gs)]))],64)):t.msg.type==="sticker"?(b(),S("div",ms,[e("img",{src:t.msg.content,alt:"表情包"},null,8,fs)])):t.msg.type==="voice"?(b(),S("div",ps,[e("div",hs,[R(oe,{name:"voice-wave",class:U(["voice-icon-svg",{playing:f.value}])},null,8,["class"]),e("span",null,k(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(b(),S("div",bs,[e("div",ks,[e("div",ys,k(t.msg.content||"位置信息"),1),I[5]||(I[5]=e("div",{class:"msg-desc"},"详细地址",-1))]),I[6]||(I[6]=de('<div class="location-map" data-v-9aec6d12><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-9aec6d12><div class="location-pin" data-v-9aec6d12><svg viewBox="0 0 24 24" fill="currentColor" data-v-9aec6d12><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-9aec6d12></path></svg></div></div>',1))])):t.msg.type==="transfer"?(b(),S("div",Ss,[e("div",$s,[I[7]||(I[7]=e("div",{class:"transfer-icon"},"¥",-1)),e("div",Ms,[e("div",ws,"¥"+k(t.msg.content),1),e("div",Cs,k(t.msg.sender==="user"?`转账给${t.charName}`:"转账给你"),1)])]),I[8]||(I[8]=e("div",{class:"transfer-footer"},"微信转账",-1))])):t.msg.type==="call_summary"?(b(),S("div",xs,[I[9]||(I[9]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,k(t.msg.content),1)])):q("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(b(),S("div",Is,[...I[10]||(I[10]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):q("",!0)]),t.msg.type==="voice"?O((b(),S("div",{key:0,class:"voice-text"},k(t.msg.content),513)),[[re,f.value]]):q("",!0)])],64))],2))}},Bs=F(Ts,[["__scopeId","data-v-9aec6d12"]]),Vs={key:0,class:"empty-message"},As={key:0,class:"timestamp"},Ps={key:0,class:"blocked-overlay"},Ls={class:"blocked-content"},Es=5*60*1e3,Rs={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content","show-thought"],setup(t,{expose:v}){const o=t,s=w(null),u=a=>{if(a===0)return!0;const c=o.messages[a],i=o.messages[a-1];if(!c.timestamp||!i.timestamp)return!1;const p=new Date(c.timestamp).getTime(),n=new Date(i.timestamp).getTime();return p-n>Es},f=a=>{if(!a)return"";const c=new Date(a),i=new Date,p=new Date(i.getFullYear(),i.getMonth(),i.getDate()),n=new Date(p.getTime()-864e5),m=i.getDay()===0?7:i.getDay(),d=new Date(p.getTime()-(m-1)*864e5),g=c.getHours().toString().padStart(2,"0"),l=c.getMinutes().toString().padStart(2,"0"),h=`${g}:${l}`;if(c.getTime()>=p.getTime())return h;if(c.getTime()>=n.getTime())return`昨天 ${h}`;if(c.getTime()>=d.getTime())return`${["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][c.getDay()]} ${h}`;{const A=c.getFullYear(),T=(c.getMonth()+1).toString(),E=c.getDate().toString();return A===i.getFullYear()?`${T}月${E}日 ${h}`:`${A}年${T}月${E}日 ${h}`}},r=()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight)};return z(()=>o.messages,()=>{ae(()=>{r()})},{deep:!0}),z(()=>o.activePanel,a=>{a&&ae(()=>{r()})}),ke(()=>{r()}),v({scrollToBottom:r}),(a,c)=>(b(),S(j,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:s},[t.messages.length===0?(b(),S("div",Vs," 开始和 "+k(t.charName)+" 聊天吧~ ",1)):q("",!0),(b(!0),S(j,null,X(t.messages,(i,p)=>(b(),S(j,{key:i.id},[u(p)?(b(),S("div",As,k(f(i.timestamp)),1)):q("",!0),R(Bs,{msg:i,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(i.id),editingMessageId:t.editingMessageId,onSaveEdit:c[0]||(c[0]=n=>a.$emit("save-edit",n)),onCancelEdit:c[1]||(c[1]=n=>a.$emit("cancel-edit")),onToggleSelection:c[2]||(c[2]=n=>a.$emit("toggle-selection",n)),onLongPress:c[3]||(c[3]=(n,m)=>a.$emit("long-press",n,m)),onCancelLongPress:c[4]||(c[4]=n=>a.$emit("cancel-long-press")),onTouchMove:c[5]||(c[5]=n=>a.$emit("touch-move",n)),onClickMsg:c[6]||(c[6]=(n,m)=>a.$emit("click-msg",n,m)),onShowTextContent:c[7]||(c[7]=n=>a.$emit("show-text-content",n)),onShowThought:c[8]||(c[8]=n=>a.$emit("show-thought",n))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"])],64))),128))],512),t.isBlocked?(b(),S("div",Ps,[e("div",Ls,[c[10]||(c[10]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:c[9]||(c[9]=i=>a.$emit("unblock"))},"解除拉黑")])])):q("",!0)],64))}},Ds=F(Rs,[["__scopeId","data-v-6207cf47"]]),qs={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:v}){const o=t,s=v,u=L({get:()=>o.visible,set:a=>s("update:visible",a)}),f=w("");z(()=>o.visible,a=>{a&&(f.value="")});const r=()=>{const a=f.value.trim();s("confirm",a),u.value=!1};return(a,c)=>(b(),Y(ee,{visible:u.value,"onUpdate:visible":c[2]||(c[2]=i=>u.value=i),title:"发送语音"},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:c[1]||(c[1]=i=>u.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:r},"发送")]),default:H(()=>[O(e("input",{type:"text",class:"base-input","onUpdate:modelValue":c[0]||(c[0]=i=>f.value=i),placeholder:"输入语音内容..."},null,512),[[J,f.value]])]),_:1},8,["visible"]))}},Ns={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:v}){const o=t,s=v,u=L({get:()=>o.visible,set:c=>s("update:visible",c)}),f=w(""),r=w("");z(()=>o.visible,c=>{c&&(f.value="",r.value="")});const a=()=>{const c=f.value.trim(),i=r.value.trim();c&&(s("confirm",{name:c,detail:i}),u.value=!1)};return(c,i)=>(b(),Y(ee,{visible:u.value,"onUpdate:visible":i[3]||(i[3]=p=>u.value=p),title:"发送位置"},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:i[2]||(i[2]=G(p=>u.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:a},"发送")]),default:H(()=>[O(e("input",{type:"text",class:"base-input","onUpdate:modelValue":i[0]||(i[0]=p=>f.value=p),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[J,f.value]]),O(e("input",{type:"text",class:"base-input","onUpdate:modelValue":i[1]||(i[1]=p=>r.value=p),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[J,r.value]])]),_:1},8,["visible"]))}},Us={class:"chat-list-container"},zs=["onClick"],Fs=["src"],Os={class:"chat-info"},js={class:"chat-name"},Hs=["disabled"],Ws={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:v}){const o=t,s=v,u=W(),f=w(o.visible),r=w(new Set),a=L(()=>u.characters);z(()=>o.visible,p=>{f.value=p,p||r.value.clear()});const c=p=>{r.value.has(p)?r.value.delete(p):r.value.add(p)},i=()=>{r.value.size>0&&s("confirm",Array.from(r.value))};return(p,n)=>(b(),Y(ee,{visible:f.value,"onUpdate:visible":n[1]||(n[1]=m=>f.value=m),title:"选择聊天",onClose:n[2]||(n[2]=m=>p.$emit("close"))},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:n[0]||(n[0]=m=>p.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:r.value.size===0,onClick:i}," 确定 ("+k(r.value.size)+") ",9,Hs)]),default:H(()=>[e("div",Us,[(b(!0),S(j,null,X(a.value,m=>(b(),S("div",{key:m.id,class:"chat-item",onClick:d=>c(m.id)},[e("img",{src:m.avatar,alt:"avatar",class:"avatar"},null,8,Fs),e("div",Os,[e("div",js,k(m.name),1)]),e("div",{class:U(["checkbox",{selected:r.value.has(m.id)}])},null,2)],8,zs))),128))])]),_:1},8,["visible"]))}},Gs=F(Ws,[["__scopeId","data-v-00bcf675"]]),Js={class:"note-container"},Ys={key:0,class:"content-wrapper"},Qs={class:"note-header current-header"},Ks=["src"],Xs={key:1,class:"avatar-placeholder"},Zs={class:"character-name"},_s={class:"status-section"},en={class:"status-row"},tn={class:"status-value"},sn={class:"status-row"},nn={class:"status-value"},on={class:"status-row"},an={class:"status-value"},ln={class:"inner-voice-section"},rn={class:"inner-voice-box"},cn={class:"unspoken-section"},dn={class:"unspoken-text"},un={key:1,class:"content-wrapper history-wrapper"},vn={class:"scroll-container"},gn={class:"item-header"},mn={class:"item-date"},fn={class:"prop-row"},pn={class:"prop-row"},hn={class:"prop-row"},bn={class:"prop-row"},kn={class:"prop-row"},yn={__name:"SingleCharStatus",props:{visible:{type:Boolean,default:!1},name:{type:String,default:""},avatar:{type:String,default:""},charId:{type:String,required:!0}},emits:["close"],setup(t,{emit:v}){const o=t,s=W(),{currentInnerVoice:u,innerVoices:f}=st(s),r=L(()=>u.value[o.charId]||{emotion:"",outfit:"",posture:"",innerVoice:"",unspokenWords:""}),a=L(()=>f.value[o.charId]||[]),c=d=>d?new Date(d).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"."):"",i=v,p=w(!1),n=()=>{p.value=!p.value};z(()=>o.visible,d=>{d?(document.body.style.overflow="hidden",p.value=!1):document.body.style.overflow=""});const m=()=>{i("close")};return(d,g)=>t.visible?(b(),S("div",{key:0,class:"note-modal-mask",onClick:G(m,["self"])},[e("div",Js,[e("div",{class:"tape-button",onClick:n}),e("div",{class:U(["note",{"history-mode":p.value}])},[g[11]||(g[11]=e("div",{class:"paper-texture"},null,-1)),p.value?(b(),S("div",un,[e("div",{class:"note-header history-header"},[g[5]||(g[5]=e("div",{class:"header-title"},"历史心声",-1)),e("button",{class:"close-btn",onClick:m},"✕")]),e("div",vn,[(b(!0),S(j,null,X(a.value,l=>(b(),S("div",{key:l.id,class:"history-item"},[e("div",gn,[e("span",null,k(l.title),1),e("span",mn,k(c(l.timestamp)),1)]),e("div",fn,[g[6]||(g[6]=e("span",{class:"prop-label"},"情绪：",-1)),K(k(l.emotion),1)]),e("div",pn,[g[7]||(g[7]=e("span",{class:"prop-label"},"穿着：",-1)),K(k(l.outfit),1)]),e("div",hn,[g[8]||(g[8]=e("span",{class:"prop-label"},"姿态：",-1)),K(k(l.posture),1)]),e("div",bn,[g[9]||(g[9]=e("span",{class:"prop-label"},"内心独白：",-1)),K(k(l.innerVoice),1)]),e("div",kn,[g[10]||(g[10]=e("span",{class:"prop-label"},"没说出口的话：",-1)),K(k(l.unspokenWords),1)])]))),128))])])):(b(),S("div",Ys,[e("div",Qs,[t.avatar?(b(),S("img",{key:0,src:t.avatar,class:"avatar-img",alt:"avatar"},null,8,Ks)):(b(),S("div",Xs,k(t.name?t.name.charAt(0):"?"),1)),e("div",Zs,k(t.name),1),e("button",{class:"close-btn",onClick:m},"✕")]),e("div",_s,[e("div",en,[g[0]||(g[0]=e("span",{class:"status-label"},"情绪",-1)),e("span",tn,k(r.value.emotion||"无"),1)]),e("div",sn,[g[1]||(g[1]=e("span",{class:"status-label"},"穿着",-1)),e("span",nn,k(r.value.outfit||"无"),1)]),e("div",on,[g[2]||(g[2]=e("span",{class:"status-label"},"姿态",-1)),e("span",an,k(r.value.posture||"无"),1)])]),e("div",ln,[g[3]||(g[3]=e("div",{class:"section-title"},"Inner Voice",-1)),e("div",rn,[e("p",null,k(r.value.innerVoice||"（没有内心独白）"),1)])]),e("div",cn,[g[4]||(g[4]=e("div",{class:"unspoken-title"},"没说出口的话",-1)),e("div",dn,k(r.value.unspokenWords||"（没有想说的话）"),1)])])),g[12]||(g[12]=e("div",{class:"torn-edge"},null,-1))],2)])])):q("",!0)}},Sn=F(yn,[["__scopeId","data-v-8274f6c4"]]),$n={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const v=t,o=ce(),{t:s}=Q(),u=W(),f=_(),r=nt(),a=w(null),c=w(null),i=w(null),p=w(!1),n=w({visible:!1,messageId:null,targetEl:null}),m=w(!1),d=w(!1),g=w(!1),l=w(!1);w("");const h=L(()=>u.getCharacter(v.charId)),A=L(()=>{var M;return((M=h.value)==null?void 0:M.isBlocked)||!1}),T=L(()=>{var M,$;return((M=h.value)==null?void 0:M.nickname)||(($=h.value)==null?void 0:$.name)||s("chat.unknownCharacter")}),E=L(()=>{var M;return((M=h.value)==null?void 0:M.name)||s("chat.unknownCharacter")}),B=L(()=>{var M;return(M=h.value)==null?void 0:M.avatar}),I=L(()=>{var M;return((M=h.value)==null?void 0:M.status)||{}}),C=L(()=>{var M;return((M=h.value)==null?void 0:M.chatBackground)||""}),V=L(()=>{const M=h.value;if(!M||!M.userPersona)return"";const $=u.userPersonas.find(P=>P.id===M.userPersona);return($==null?void 0:$.avatar)||""}),x=L(()=>u.messages[v.charId]||[]),D=L(()=>{var M;return((M=h.value)==null?void 0:M.bubbleSettings)||{}}),{isSelectionMode:N,selectedMessageIds:te,isForwarding:ue,enterSelectionMode:ye,exitSelectionMode:ve,toggleMessageSelection:ge,handleBatchAction:Se,handleConfirmForward:$e}=lt(ne(v,"charId")),{isTyping:Me,triggerAiResponse:me}=it(ne(v,"charId"),r),{inputText:se,quotingMessage:ie,sendMessage:we,sendSticker:Ce,sendVoiceMessage:xe,handleSendImage:Ie,confirmSendLocation:Te,sendTransfer:Be}=ct(u,ne(v,"charId"),f,i),{editingMessageId:fe,handleEditMessage:Ve,handleSaveEdit:Ae,updateInputText:Pe}=rt(u,ne(v,"charId"),se),{startLongPress:Le,cancelLongPress:Ee,handleTouchMove:Re,wasClickAfterLongPress:De}=dt(n),qe=L(()=>{const M=D.value,$={fontSize:M.fontSize?`${M.fontSize}px`:"14px"};if(M.css){const P={};return M.css.split(";").forEach(Qe=>{const le=Qe.split(":");if(le.length>=2){const pe=le[0].trim(),he=le.slice(1).join(":").trim();pe&&he&&(P[pe]=he)}}),{...$,...P}}return $});z(p,M=>{M&&(o.push({name:"single-chat-settings",params:{id:v.charId}}),p.value=!1)}),ke(()=>{u.clearUnreadCount(v.charId)});const Ne=()=>{h.value&&(h.value.isBlocked=!1,u.messages[v.charId]&&u.messages[v.charId].forEach(M=>{M.blocked&&(M.blocked=!1)}),u.saveData(),f.showToast(s("chat.toast.unblocked")))},Ue=M=>{const $=M.target;$.closest(".modal-overlay.active")||(i.value&&!$.closest(".chat-footer")&&(i.value=null),N.value&&!$.closest(".message")&&!$.closest(".chat-action-row")&&!$.closest(".message-checkbox")&&!$.closest(".message-menu")&&ve(),n.value.visible&&!$.closest(".message-menu")&&(n.value.visible=!1))},ze=(M,$)=>{if(De()){M.preventDefault(),M.stopPropagation();return}N.value&&ge($)},Fe=M=>{const $=x.value.find(P=>P.id===M);$&&(ie.value=$)},Oe=()=>{d.value=!0},je=M=>{xe(M),d.value=!1},He=()=>{i.value=null,m.value=!0},We=()=>{g.value=!0},Ge=({name:M,detail:$})=>{Te(M,$),g.value=!1},Je=()=>{u.startVideoCall(v.charId,"user")},Ye=()=>{l.value=!0};return(M,$)=>(b(),S("div",{class:U(["chat-room active",{"selection-mode":y(N)}]),onClick:Ue,ref_key:"chatRoomRef",ref:c},[e("div",{class:"chat-bg",style:Z(C.value?{backgroundImage:`url(${C.value})`}:{})},null,4),R($t,{charId:v.charId,charName:T.value,charStatus:I.value,isTyping:y(Me),onTriggerAi:y(me),onOpenSettings:$[0]||($[0]=P=>p.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),R(Ds,{ref_key:"messageListRef",ref:a,messages:x.value,charName:T.value,charAvatar:B.value,userAvatar:V.value,bubbleStyle:qe.value,isSelectionMode:y(N),selectedMessageIds:y(te),isBlocked:A.value,editingMessageId:y(fe),activePanel:i.value,onSaveEdit:y(Ae),onCancelEdit:$[1]||($[1]=P=>fe.value=null),onToggleSelection:y(ge),onLongPress:y(Le),onCancelLongPress:y(Ee),onTouchMove:y(Re),onClickMsg:ze,onUnblock:Ne,onShowThought:Ye},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),y(N)?q("",!0):(b(),Y(Xt,{key:0,modelValue:y(se),"onUpdate:modelValue":$[2]||($[2]=P=>ot(se)?se.value=P:null),activePanel:i.value,"onUpdate:activePanel":$[3]||($[3]=P=>i.value=P),charId:v.charId,quotingMessage:y(ie),onCancelQuote:$[4]||($[4]=P=>ie.value=null),onSendMessage:y(we),onSendSticker:y(Ce),onTriggerVoice:Oe,onTriggerImage:He,onTriggerVideo:Je,onTriggerLocation:We,onTriggerTransfer:y(Be)},null,8,["modelValue","activePanel","charId","quotingMessage","onSendMessage","onSendSticker","onTriggerTransfer"])),y(N)?(b(),Y(ns,{key:1,onAction:y(Se),onCancel:y(ve)},null,8,["onAction","onCancel"])):q("",!0),R(qs,{visible:d.value,"onUpdate:visible":$[5]||($[5]=P=>d.value=P),onConfirm:je},null,8,["visible"]),R(be,{visible:m.value,"onUpdate:visible":$[6]||($[6]=P=>m.value=P),onSendImage:y(Ie)},null,8,["visible","onSendImage"]),R(Ns,{visible:g.value,"onUpdate:visible":$[7]||($[7]=P=>g.value=P),onConfirm:Ge},null,8,["visible"]),R(es,{visible:n.value.visible,targetEl:n.value.targetEl,messageId:n.value.messageId,charId:v.charId,isSelectionMode:y(N),selectedMessageIds:y(te),onClose:$[8]||($[8]=P=>n.value.visible=!1),onEnterSelectionMode:y(ye),onTriggerAiResponse:y(me),"onUpdate:inputText":y(Pe),onQuoteMessage:Fe,onEditMessage:y(Ve)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),R(Gs,{visible:y(ue),onClose:$[9]||($[9]=P=>ue.value=!1),onConfirm:y($e)},null,8,["visible","onConfirm"]),R(Sn,{visible:l.value,name:E.value,avatar:B.value,charId:v.charId,onClose:$[10]||($[10]=P=>l.value=!1)},null,8,["visible","name","avatar","charId"])],2))}},wn=F($n,[["__scopeId","data-v-1b9190c7"]]);export{wn as default};
