import{t as J,x as ne,r as C,G as Q,H as nt,I as ot,J as ye,L as at,a as lt,k as ge,_ as O,q as Z,y as ce,b as $,o as b,l as G,e as N,f as q,d as e,T as re,B as y,j as w,h as W,w as H,A as K,M as oe,c as V,F as j,C as te,n as z,v as ve,E as se,N as Se,i as $e,z as F,S as ee,O as Me,D as Y,P as it,Q as rt,R as ct,U as X,V as dt,W as ut,X as vt,Y as ie,Z as gt}from"./index-fnHzAJGR.js";function mt(t){const p=J(),s=ne(),n=C(!1),r=C(new Set),h=C(!1),v=(o,m)=>{console.log("[useMessageSelection] enterSelectionMode triggered");let k=0,l=0;const i=document.querySelector(".message-list");m&&i&&(k=i.scrollTop,l=m.getBoundingClientRect().top),n.value=!0,r.value.clear(),o&&r.value.add(o),m&&i&&Q(()=>{const S=document.querySelector(".selection-bar"),A=S?S.offsetHeight:0,P=m.getBoundingClientRect().top-l;i.scrollTop=k+P-A})},a=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),n.value=!1,r.value.clear()};return{isSelectionMode:n,selectedMessageIds:r,isForwarding:h,enterSelectionMode:v,exitSelectionMode:a,toggleMessageSelection:o=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${o}`),r.value.has(o)?r.value.delete(o):r.value.add(o)},handleBatchAction:o=>{if(console.log(`[useMessageSelection] handleBatchAction: ${o}`),r.value.size===0)return;const m=p.messages[t.value];o==="forward"?h.value=!0:o==="delete"?s.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),p.messages[t.value]=m.filter(k=>!r.value.has(k.id)),p.saveData(),a()}):o==="favorite"&&(p.favorites||(p.favorites=[]),m.forEach(k=>{r.value.has(k.id)&&(p.favorites.some(l=>l.id===k.id)||p.favorites.push(k))}),p.saveData(),s.showToast("已收藏","success"),a())},handleConfirmForward:o=>{console.log("[useMessageSelection] handleConfirmForward triggered"),h.value=!1;const k=(p.messages[t.value]||[]).filter(l=>r.value.has(l.id));k.length!==0&&(o.forEach(l=>{p.messages[l]||(p.messages[l]=[]),k.forEach(i=>{const S={...i,id:Date.now().toString()+Math.random()};p.messages[l].push(S)})}),p.saveData(),s.showToast(`已转发 ${k.length} 条消息`),a())}}}const ft=(t,p,s)=>{const n=p.map(h=>`${h.role==="user"?"用户":t.name}: ${h.content}`).join(`
`),r=s.toString().padStart(2,"0");return`
你正在扮演角色“${t.name}”，你需要根据以下设定和最近的对话，生成一段角色的实时“心声”。
心声由多个部分组成，请严格按照下面的JSON格式返回，不要添加任何额外的解释或文字。

**角色人设:**
${t.charPersona}

**最近对话:**
${n}

**你的任务:**
生成符合当前情境和角色性格的内心活动。
- **情绪 (emotion)**: 描述角色当前的主要情绪，应在一定时间内保持稳定，5字以内。
- **穿着 (outfit)**: 描述角色当前的穿着，应在一定时间内保持稳定，10字以内。
- **姿态 (posture)**: 描述角色当前的姿态或小动作，应在一定时间内保持稳定，15字以内。
- **内心独白 (innerVoice)**: 角色此刻具体的内心想法，50字以内。
- **没说出口的话 (unspokenWords)**: 一句角色想说但没说出口的话，风格可以多变（如阴暗、腹黑、酸涩、色情等），必须符合人设，15字以内。
- **标题 (title)**: 为这次心声生成一个简短的小标题，格式固定为“#${r} 标题内容”，例如“#${r} 初次见面”。

**输出格式 (必须是可被解析的JSON):**
{
  "emotion": "...",
  "outfit": "...",
  "posture": "...",
  "innerVoice": "...",
  "unspokenWords": "...",
  "title": "#${r} ..."
}
`};function pt(t,p){const s=J(),n=nt(),r=ot(),h=ge(),v=lt(),a=C(!1),d=async()=>{console.log("[useAiResponder] triggerAiResponse triggered"),a.value=!0;try{const f=s.getCharacter(t.value),o=s.getPendingUserTransfers(t.value);console.log("[useAiResponder] Pending transfers to accept:",o.length);let m=await p.getChatCompletion(t.value);if(console.log("[useAiResponder] AI Response:",m),m){const k=/\[待办：(?:((?:\d{4}-\d{2}-\d{2}\s)?\d{1,2}:\d{2}|\d{4}-\d{2}-\d{2})\s)?(.+?)\]/g;let l;for(;(l=k.exec(m))!==null;){const R=l[1],I=l[2].trim();let c=new Date,u="";if(R)if(R.includes("-"))if(R.includes(":")){const[T,D]=R.split(/\s+/);c=new Date(T),u=D}else c=new Date(R),u="";else u=R;else u=new Date().toTimeString().slice(0,5);I&&(r.addEvent({type:"todo",title:I,content:I,date:ye(c,{representation:"date"}),done:!1,time:u}),console.log(`[useAiResponder] Added new todo: "${I}" at ${u} on ${ye(c,{representation:"date"})}`))}if(m=m.replace(k,"").trim(),!m){a.value=!1,g();return}s.messages[t.value]||(s.messages[t.value]=[]);const i=(f==null?void 0:f.isBlocked)||!1;let S=m.split("|||"),A=[];const B=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g;S.forEach(R=>{const I=R.split(B).map(c=>c.trim()).filter(c=>c);A.push(...I)});const P=o.length>0?0:-1;let E=!1;for(let R=0;R<A.length;R++){const I=A[R];R>0&&await new Promise(U=>setTimeout(U,1e3+Math.random()*1e3));let{type:c,content:u}=at(I),T={};if(c==="sticker"){const U=u,_=s.stickers.find(ae=>ae.name===U);_?(u=_.url,T.name=U):(c="text",u=`[表情包：${U}]`)}let D=!1;c==="image"&&!u.startsWith("http")&&!u.startsWith("data:")&&(D=!0),s.addMessage(t.value,{id:Date.now().toString()+R,sender:"char",type:c,content:u,isTextGenerated:D,...T,time:Date.now(),blocked:i}),R===P&&!E&&o.length>0&&(await new Promise(U=>setTimeout(U,800+Math.random()*500)),s.autoAcceptPendingTransfers(t.value),E=!0,console.log("[useAiResponder] Transfer acceptance inserted after message",R)),v.path!==`/chat/room/${t.value}`&&(s.incrementUnreadCount(t.value),n.triggerNotification(f.nickname||f.name,c==="text"?u:`[${c}]`,f.avatar,()=>{h.push(`/chat/room/${t.value}`)},3e3,c))}!E&&o.length>0&&(await new Promise(R=>setTimeout(R,800+Math.random()*500)),s.autoAcceptPendingTransfers(t.value),console.log("[useAiResponder] Transfer acceptance inserted at the end"))}}catch(f){console.error("[useAiResponder] triggerAiResponse failed:",f)}finally{a.value=!1,g()}},g=async()=>{try{const f=s.getCharacter(t.value);if(!f)return;const o=s.innerVoices[t.value]||[];let m=1;if(o.length>0){const S=o[0].title;if(S){const A=S.match(/#(\d+)/);A?m=parseInt(A[1],10)+1:m=o.length+1}else m=o.length+1}const k=s.getFormattedRecentMessages(t.value,10),l=ft(f,k,m),i=await p.getGenericCompletion([{role:"user",content:l}]);if(i){const S=i.indexOf("{"),A=i.lastIndexOf("}");if(S!==-1&&A!==-1){const B=i.substring(S,A+1),P=JSON.parse(B);s.addInnerVoice(t.value,P),console.log("[useAiResponder] Inner voice generated and saved:",P)}else console.warn("[useAiResponder] Failed to find JSON in inner voice response.")}}catch(f){console.error("[useAiResponder] Failed to generate inner voice:",f)}};return{isTyping:a,triggerAiResponse:d}}function ht(t,p,s){const n=C(null);return{editingMessageId:n,handleEditMessage:a=>{console.log("[useMessageEditing] handleEditMessage for msgId:",a),n.value=a},handleSaveEdit:({msgId:a,newContent:d})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",a);const f=t.messages[p.value].find(o=>o.id===a);f&&(f.content=d,t.saveData()),n.value=null},updateInputText:a=>{console.log("[useMessageEditing] updateInputText called"),s&&(s.value=a,Q(()=>{const d=document.querySelector(".chat-input");d&&d.focus()}))}}}function bt(t,p,s,n,r={}){const h=C(""),v=C(null),a=(l,i,S={})=>{console.log(`[useMessageSender] sendMsg called with type: ${l}`);const A={...S};v.value&&(A.quote={id:v.value.id,sender:v.value.sender,content:v.value.content}),t.addMessage(p.value,{id:Date.now().toString()+Math.random(),sender:"user",type:l,content:i,timestamp:Date.now(),...A}),n&&(n.value=null),v.value=null};return{inputText:h,quotingMessage:v,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const l=h.value.trim();l&&(a("text",l),h.value="")},sendMsg:a,sendSticker:l=>{console.log("[useMessageSender] sendSticker triggered"),a("sticker",l.url,{name:l.name})},sendVoiceMessage:l=>{console.log("[useMessageSender] sendVoiceMessage triggered"),l&&a("voice",l)},handleSendImage:l=>{console.log("[useMessageSender] handleSendImage triggered"),l.isTextGenerated?a("image",l.description,{isTextGenerated:!0}):(l.type==="base64"||l.type==="url")&&a("image",l.content)},confirmSendLocation:(l,i)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!l){s.showToast("请输入位置名称","info");return}a("location",l,{detail:i})},sendTransfer:(l,i)=>{console.log("[useMessageSender] sendTransfer triggered",l,i),a("transfer",l,{note:i,status:"pending"})}}}function kt(t){const p=C(null),s=C(!1),n=C({x:0,y:0}),r=(g,f)=>{console.log("[useMessageInteraction] showMenu triggered"),g.preventDefault();const o=g.target.closest(".msg-bubble, .system-message-wrapper");o&&(t.value={visible:!0,messageId:f,targetEl:o})};return{startLongPress:(g,f)=>{console.log("[useMessageInteraction] startLongPress triggered"),g.stopPropagation(),s.value=!1,clearTimeout(p.value),g.type.startsWith("touch")&&(n.value={x:g.touches[0].clientX,y:g.touches[0].clientY}),p.value=setTimeout(()=>{s.value=!0,r(g,f)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(p.value)},handleTouchMove:g=>{console.log("[useMessageInteraction] handleTouchMove triggered");const f=g.touches[0],o=Math.abs(f.clientX-n.value.x),m=Math.abs(f.clientY-n.value.y);(o>10||m>10)&&clearTimeout(p.value)},wasClickAfterLongPress:()=>s.value?(s.value=!1,!0):!1}}const yt={class:"header-title-area"},St={key:0,class:"chat-room-title"},$t={key:1,class:"typing-indicator"},Mt={class:"right-icons-group"},wt={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},Ct=["placeholder"],Tt=["placeholder"],xt={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:p}){const s=t,{t:n}=Z(),r=ge(),h=J(),v=ne(),a=C(!1),d=C(""),g=C(""),f=C(!1);ce(()=>{f.value=!0});const o=()=>{const l=s.charStatus||{};d.value=l.icon||"✨",g.value=l.text||"",a.value=!0},m=()=>{const l=d.value.trim()||"✨",i=g.value.trim(),S=h.getCharacter(s.charId);S&&(i?S.status={icon:l,text:i}:S.status=null,h.saveData(),v.showToast(n("saveSuccess"))),a.value=!1},k=()=>{r.push({name:"memory-bank",params:{charId:s.charId}})};return(l,i)=>(b(),$("div",null,[f.value?(b(),G(re,{key:0,to:"#chatRoomLeftArea"},[e("div",{class:"btn-icon bell-btn",onClick:i[0]||(i[0]=S=>l.$emit("trigger-ai")),ref:"bellBtn"},[...i[6]||(i[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)])):N("",!0),f.value?(b(),G(re,{key:1,to:"#chatRoomTitleArea"},[e("div",yt,[t.isTyping?(b(),$("div",$t,[e("span",null,y(w(n)("chat.singleChat.typing")),1),i[7]||(i[7]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(b(),$("div",St,y(t.charName),1))]),e("div",{class:"chat-room-status",onClick:o},[e("span",null,y(t.charStatus.icon||"✨"),1),e("span",null,y(t.charStatus.text||w(n)("chat.singleChat.addStatus")),1)])])):N("",!0),f.value?(b(),G(re,{key:2,to:"#chatRoomActionArea"},[e("div",Mt,[e("div",{class:"btn-icon memory-btn",onClick:k},[...i[8]||(i[8]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e("polyline",{points:"14 2 14 8 20 8"}),e("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e("polyline",{points:"10 9 9 9 8 9"})],-1)])]),e("div",{class:"btn-icon more-btn",onClick:i[1]||(i[1]=S=>l.$emit("open-settings"))},[...i[9]||(i[9]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])])])):N("",!0),q(oe,{visible:a.value,"onUpdate:visible":i[5]||(i[5]=S=>a.value=S),title:w(n)("chat.singleChat.setStatus")},{footer:W(()=>[e("button",{class:"modal-btn cancel",onClick:i[4]||(i[4]=S=>a.value=!1)},y(w(n)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:m},y(w(n)("confirm")),1)]),default:W(()=>[e("div",wt,[H(e("input",{type:"text",class:"base-input","onUpdate:modelValue":i[2]||(i[2]=S=>d.value=S),placeholder:w(n)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,Ct),[[K,d.value]]),H(e("input",{type:"text",class:"base-input","onUpdate:modelValue":i[3]||(i[3]=S=>g.value=S),placeholder:w(n)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,Tt),[[K,g.value]])])]),_:1},8,["visible","title"])]))}},It=O(xt,[["__scopeId","data-v-9265e8b0"]]),At={key:0,class:"chat-panel",id:"stickerPanel"},Pt={class:"sticker-panel-header"},Bt={class:"sticker-groups"},Rt=["onClick"],Vt={class:"sticker-panel-content"},Lt=["onClick"],Et=["src","alt"],Dt={class:"sticker-panel-footer"},Nt={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:p}){const s=p,n=J(),r=ne(),h=C("默认"),v=C(!1),a=C(new Set),d=C(!1),g=C(!1),f=C(""),o=V(()=>["默认",...new Set(n.stickers.map(c=>c.group).filter(Boolean).filter(c=>c!=="默认"))]),m=V(()=>n.stickers.filter(I=>I.group===h.value)),k=I=>{v.value?a.value.has(I.id)?a.value.delete(I.id):a.value.add(I.id):s("send-sticker",I)},l=({group:I,stickers:c})=>{const u=c.map(T=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:T.url,name:T.name,group:I}));n.stickers.push(...u),n.saveData(),r.showToast(`成功导入 ${u.length} 个表情包`,"success")},i=()=>{d.value=!0},S=()=>{a.value.size>0&&(g.value=!0)},A=()=>{v.value=!v.value,a.value.clear()},B=()=>{const I=m.value;I.every(u=>a.value.has(u.id))?I.forEach(u=>a.value.delete(u.id)):I.forEach(u=>a.value.add(u.id))},P=()=>{a.value.size!==0&&r.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{n.stickers=n.stickers.filter(I=>!a.value.has(I.id)),n.saveData(),a.value.clear()})},E=()=>{const I=f.value.trim();if(!I)return r.showToast("请输入目标分组","info");n.stickers.forEach(c=>{a.value.has(c.id)&&(c.group=I)}),n.saveData(),g.value=!1,f.value="",a.value.clear(),v.value=!1,h.value=I},R=()=>{if(a.value.size===0)return;const I=n.stickers.filter(D=>a.value.has(D.id)).map(D=>`${D.name} ${D.url}`).join(`
`),c=new Blob([I],{type:"text/plain"}),u=URL.createObjectURL(c),T=document.createElement("a");T.href=u,T.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(u),a.value.clear(),v.value=!1};return(I,c)=>(b(),$("div",null,[t.visible?(b(),$("div",At,[e("div",Pt,[e("div",Bt,[(b(!0),$(j,null,te(o.value,u=>(b(),$("div",{class:z(["sticker-group-tab",{active:h.value===u}]),key:u,onClick:T=>h.value=u},y(u),11,Rt))),128))])]),e("div",Vt,[(b(!0),$(j,null,te(m.value,u=>(b(),$("div",{class:z(["sticker-item",{selected:a.value.has(u.id),"manage-mode":v.value}]),key:u.id,onClick:T=>k(u)},[e("img",{src:u.url,alt:u.name},null,8,Et),e("span",null,y(u.name),1)],10,Lt))),128))]),e("div",Dt,[H(e("div",{class:"sticker-add-btn",onClick:i},"＋",512),[[ve,!v.value]]),e("div",{class:"sticker-manage-btn",style:se({color:v.value?"var(--danger-color)":"#576B95"}),onClick:A},y(v.value?"完成":"管理"),5)]),e("div",{class:z(["manage-bar",{active:v.value}])},[e("button",{class:"btn btn-secondary",onClick:i},"导入"),e("button",{class:"btn btn-secondary",onClick:B},"全选"),e("button",{class:"btn btn-secondary",onClick:S},"移动"),e("button",{class:"btn btn-secondary",onClick:R},"导出"),e("button",{class:"btn btn-danger",onClick:P},"删除")],2)])):N("",!0),q(Se,{visible:d.value,"onUpdate:visible":c[0]||(c[0]=u=>d.value=u),type:"sticker-import",onImportSticker:l},null,8,["visible"]),q(oe,{visible:g.value,"onUpdate:visible":c[3]||(c[3]=u=>g.value=u),title:"移动到分组"},{footer:W(()=>[e("button",{class:"modal-btn cancel",onClick:c[2]||(c[2]=u=>g.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:E},"确定")]),default:W(()=>[H(e("input",{type:"text",class:"base-input","onUpdate:modelValue":c[1]||(c[1]=u=>f.value=u),placeholder:"输入目标分组名称"},null,512),[[K,f.value]])]),_:1},8,["visible"])]))}},qt=O(Nt,[["__scopeId","data-v-c6bef6fa"]]),Ut={class:"chat-panel",id:"morePanel"},zt={class:"more-panel-content"},Ft={class:"more-label"},Ot={class:"more-label"},jt={class:"more-label"},Ht={class:"more-label"},Wt={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:p}=Z();return(s,n)=>(b(),$("div",Ut,[e("div",zt,[e("div",{class:"more-item",onClick:n[0]||(n[0]=r=>s.$emit("trigger-image-upload"))},[n[4]||(n[4]=$e('<div class="more-icon" data-v-731b24d5><svg class="svg-icon" viewBox="0 0 24 24" data-v-731b24d5><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-731b24d5></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-731b24d5></circle><polyline points="21 15 16 10 5 21" data-v-731b24d5></polyline></svg></div>',1)),e("span",Ft,y(w(p)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:n[1]||(n[1]=r=>s.$emit("start-video-call"))},[n[5]||(n[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Ot,y(w(p)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:n[2]||(n[2]=r=>s.$emit("send-location"))},[n[6]||(n[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",jt,y(w(p)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:n[3]||(n[3]=r=>s.$emit("send-transfer"))},[n[7]||(n[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),e("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})])],-1)),e("span",Ht,y(w(p)("chat.morePanel.transfer")),1)])])]))}},Gt=O(Wt,[["__scopeId","data-v-731b24d5"]]),Yt={class:"chat-footer"},Jt={key:0,class:"quote-preview"},Kt={class:"quote-content"},Qt={class:"quote-sender"},Xt={class:"quote-text"},Zt={class:"chat-input-row"},_t={class:"chat-input-wrapper"},es=["value","onKeydown"],ts={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"21px",height:"21px",position:"relative",top:"1px",left:"-1px"}},ss={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null},charId:{type:String,required:!0}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:p}){const{t:s}=Z(),n=J(),r=t,h=p,v=C(r.activePanel);F(()=>r.activePanel,o=>{v.value=o}),F(v,o=>{h("update:activePanel",o)});const a=V(()=>{if(!r.quotingMessage)return"";if(r.quotingMessage.sender==="user")return s("chat.self");{const o=n.getCharacter(r.charId);return(o==null?void 0:o.nickname)||(o==null?void 0:o.name)||s("chat.other")}}),d=o=>{v.value===o?v.value=null:v.value=o},g=()=>{r.modelValue.trim()&&h("send-message")},f=o=>{h("send-sticker",o),v.value=null};return(o,m)=>(b(),$("div",Yt,[t.quotingMessage?(b(),$("div",Jt,[e("div",Kt,[e("span",Qt,y(a.value)+": ",1),e("span",Xt,y(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:m[0]||(m[0]=k=>o.$emit("cancel-quote"))},[...m[9]||(m[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):N("",!0),e("div",Zt,[e("div",{class:"chat-tool-btn",onClick:m[1]||(m[1]=k=>o.$emit("trigger-voice"))},[q(ee,{name:"voice-circle",class:"svg-icon"})]),e("div",_t,[e("textarea",{class:"chat-input",value:t.modelValue,onInput:m[2]||(m[2]=k=>o.$emit("update:modelValue",k.target.value)),onKeydown:Me(Y(g,["exact","prevent"]),["enter"]),id:"messageInput",autocomplete:"off",rows:"1"},null,40,es)]),e("div",{class:"chat-tool-btn",onClick:m[3]||(m[3]=k=>d("sticker"))},[q(ee,{name:"sticker",class:"svg-icon"})]),t.modelValue?(b(),$("div",{key:1,class:"send-btn-icon",onClick:g},[(b(),$("svg",ts,[...m[10]||(m[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(b(),$("div",{key:0,class:"chat-tool-btn",onClick:m[4]||(m[4]=k=>d("more"))},[q(ee,{name:"plus-circle",class:"svg-icon"})]))]),q(qt,{visible:v.value==="sticker",onSendSticker:f},null,8,["visible"]),v.value==="more"?(b(),G(Gt,{key:1,onTriggerImageUpload:m[5]||(m[5]=k=>o.$emit("trigger-image")),onStartVideoCall:m[6]||(m[6]=k=>o.$emit("trigger-video")),onSendLocation:m[7]||(m[7]=k=>o.$emit("trigger-location")),onSendTransfer:m[8]||(m[8]=k=>o.$emit("trigger-transfer"))})):N("",!0)]))}},ns=O(ss,[["__scopeId","data-v-490ed303"]]),os={class:"menu-grid"},as={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:p}){const s=t,n=p,r=it("phoneScreenRef"),{t:h}=Z(),v=J(),a=ne(),d=C(null),g=C({}),f=C(0),o=C("top");F(()=>s.visible,async l=>{l&&s.targetEl&&(await Q(),m())});const m=()=>{const l=d.value;if(!l)return;const i=s.targetEl.getBoundingClientRect(),S=l.offsetWidth,A=l.offsetHeight,B=8,P=r.value,E=P?P.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};o.value="top";let R=i.top-A-B;R<E.top+B&&(o.value="bottom",R=i.bottom+B);const I=i.left+i.width/2;let c=I-S/2;c<E.left+B&&(c=E.left+B),c+S>E.left+E.width-B&&(c=E.left+E.width-S-B);let u=I-c;const T=12,D=T/2+5,U=S-T/2-5;u=Math.max(D,Math.min(u,U)),g.value={top:`${R}px`,left:`${c}px`},f.value=u},k=l=>{const i=s.messageId;if(!i)return;const S=v.messages[s.charId],A=S.findIndex(E=>E.id===i),B=S[A],P={copy:()=>{B.content&&(navigator.clipboard.writeText(B.content),a.showToast(h("chat.messageMenu.toast.copied")))},favorite:()=>{v.favorites||(v.favorites=[]),v.favorites.some(E=>E.id===B.id)?a.showToast(h("chat.messageMenu.toast.alreadyFavorited")):(v.favorites.push(B),v.saveData(),a.showToast(h("chat.messageMenu.toast.favorited")))},delete:()=>{a.showConfirm(h("chat.messageMenu.confirmDelete"),h("chat.messageMenu.confirmDeleteMsg"),()=>{v.messages[s.charId].splice(A,1),v.saveData()})},revoke:()=>{B&&(B.type="revoked",v.saveData(),a.showToast(h("chat.messageMenu.toast.revoked")))},select:()=>n("enter-selection-mode",i,s.targetEl),quote:()=>n("quote-message",i),retry:()=>{B.sender!=="user"?v.messages[s.charId].splice(A,1):v.retryFromMessage(s.charId,i),v.saveData(),n("trigger-ai-response")},edit:()=>{B.type==="text"?n("edit-message",i):a.showToast(h("chat.messageMenu.toast.editTextOnly"),"info")}};P[l]&&P[l](),n("close")};return(l,i)=>t.visible?(b(),$("div",{key:0,ref_key:"menuRef",ref:d,class:z(["message-menu",{"menu-top":o.value==="top","menu-bottom":o.value==="bottom"}]),style:se(g.value)},[e("div",os,[e("div",{class:"menu-item",onClick:i[0]||(i[0]=S=>k("copy"))},y(w(h)("copy")),1),e("div",{class:"menu-item",onClick:i[1]||(i[1]=S=>k("favorite"))},y(w(h)("favorite")),1),e("div",{class:"menu-item",onClick:i[2]||(i[2]=S=>k("delete"))},y(w(h)("delete")),1),e("div",{class:"menu-item",onClick:i[3]||(i[3]=S=>k("revoke"))},y(w(h)("revoke")),1),e("div",{class:"menu-item",onClick:i[4]||(i[4]=S=>k("select"))},y(w(h)("select")),1),e("div",{class:"menu-item",onClick:i[5]||(i[5]=S=>k("quote"))},y(w(h)("quote")),1),e("div",{class:"menu-item",onClick:i[6]||(i[6]=S=>k("retry"))},y(w(h)("retry")),1),e("div",{class:"menu-item",onClick:i[7]||(i[7]=S=>k("edit"))},y(w(h)("edit")),1)]),e("div",{class:"menu-arrow",style:se({left:f.value+"px"})},null,4)],6)):N("",!0)}},ls=O(as,[["__scopeId","data-v-b8d63ff8"]]),is={class:"chat-action-row"},rs={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:p}=Z();return(s,n)=>(b(),$("div",is,[e("div",{class:"action-btn",onClick:n[0]||(n[0]=r=>s.$emit("action","favorite"))},[n[4]||(n[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,y(w(p)("favorite")),1)]),e("div",{class:"action-btn",onClick:n[1]||(n[1]=r=>s.$emit("action","forward"))},[n[5]||(n[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,y(w(p)("forward")),1)]),e("div",{class:"action-btn",onClick:n[2]||(n[2]=r=>s.$emit("action","delete"))},[n[6]||(n[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,y(w(p)("delete")),1)]),e("div",{class:"action-btn",onClick:n[3]||(n[3]=r=>s.$emit("cancel"))},[n[7]||(n[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,y(w(p)("done")),1)])]))}},cs=O(rs,[["__scopeId","data-v-be1a592f"]]),ds=["src"],us={class:"msg-content-wrapper"},vs={class:"msg-bubble-box"},gs={key:0,class:"quote-in-bubble"},ms={class:"quote-in-bubble-sender"},fs={class:"quote-in-bubble-text"},ps={key:1,class:"edit-view"},hs={key:0},bs={class:"description-placeholder"},ks=["src"],ys={key:2,class:"sticker-msg"},Ss=["src"],$s={key:3,class:"voice-msg-wrapper"},Ms={class:"voice-msg"},ws={key:4,class:"location-msg"},Cs={class:"location-text"},Ts={class:"msg-title"},xs={class:"transfer-content"},Is={class:"transfer-icon"},As={key:0,viewBox:"0 0 24 24",fill:"currentColor"},Ps={key:1},Bs={class:"transfer-info"},Rs={class:"transfer-amount"},Vs={class:"transfer-desc"},Ls={class:"transfer-footer"},Es={key:6,class:"call-summary-msg"},Ds={key:0,class:"blocked-icon"},Ns={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","show-thought","accept-transfer"],setup(t,{emit:p}){const s=t,n=p,r=rt(),h=C(!1),v=C(!1),a=C(""),d=V(()=>s.editingMessageId===s.msg.id),g=V(()=>{const u=s.msg.type,T=u==="transfer"&&s.msg.status==="accepted";return{"no-style":["image","sticker","location","transfer"].includes(u),"has-location":u==="location","has-transfer":u==="transfer",accepted:T}}),f=V(()=>{if(s.msg.type!=="transfer")return{};const u=s.msg.status==="accepted",T=s.msg.sender==="user";return{"accepted-sender":u&&T,"accepted-receiver":u&&!T,pending:!u}}),o=V(()=>{if(s.msg.type!=="transfer")return"";const u=s.msg.sender==="user",T=s.msg.status==="accepted",D=s.msg.isReceived;return s.msg.note?s.msg.note:D?"已收款":T?"已被接收":u?`转账给${s.charName}`:"转账给你"}),m=V(()=>s.msg.type!=="transfer"?"":s.msg.isReceived?"已收款":s.msg.status==="accepted"?"已被领取":"微信转账");F(d,u=>{u&&(a.value=s.msg.content)});const k=u=>{n("long-press",u,s.msg.id)},l=()=>{n("cancel-long-press")},i=u=>{n("touch-move",u)},S=u=>{s.msg.type==="voice"&&B(),s.msg.type!=="image"&&n("click-msg",u,s.msg.id)},A=()=>{s.msg.sender!=="user"&&n("show-thought",s.msg.id)},B=()=>{h.value=!h.value},P=()=>{v.value=!v.value},E=()=>{a.value.trim()&&n("save-edit",{msgId:s.msg.id,newContent:a.value})},R=()=>{n("cancel-edit")},I=()=>s.msg.type==="notification"?s.msg.content:s.msg.type==="revoked"?`"${s.msg.sender==="user"?"你":s.charName}" 撤回了一条消息`:"",c=()=>{(s.msg.status==="pending"||s.msg.status===void 0)&&s.msg.sender!=="user"&&!s.isSelectionMode&&n("accept-transfer",s.msg.id)};return(u,T)=>(b(),$("div",{class:z(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[t.msg.type==="revoked"||t.msg.type==="notification"?(b(),$(j,{key:0},[e("div",{class:z(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:T[0]||(T[0]=Y(D=>u.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),e("div",{class:"system-message-wrapper",onMousedown:k,onMouseup:l,onMouseleave:l,onTouchstart:k,onTouchend:l,onTouchmove:i,onClick:Y(S,["prevent"])},[e("div",{class:"system-message-text",onClick:T[1]||(T[1]=Y(D=>!t.isSelectionMode&&P(),["stop"]))},y(I()),1),t.msg.type==="revoked"?H((b(),$("div",{key:0,class:"revoked-content"},y(t.msg.sender==="user"?"我":t.charName)+"："+y(t.msg.content),513)),[[ve,v.value]]):N("",!0)],32)],64)):(b(),$(j,{key:1},[e("div",{class:"msg-avatar",onClick:A},[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(b(),$("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,ds)):(b(),$("div",{key:1,class:z(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",us,[e("div",vs,[e("div",{class:z(["msg-bubble",g.value]),style:se(t.bubbleStyle),onMousedown:k,onMouseup:l,onMouseleave:l,onTouchstart:k,onTouchend:l,onTouchmove:i,onClick:Y(S,["prevent"])},[t.msg.quote?(b(),$("div",gs,[e("div",ms,y(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",fs,y(t.msg.quote.content),1)])):N("",!0),d.value?(b(),$("div",ps,[H(e("textarea",{"onUpdate:modelValue":T[2]||(T[2]=D=>a.value=D),class:"edit-textarea",rows:"3"},null,512),[[K,a.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:R,class:"edit-btn cancel"},"取消"),e("button",{onClick:E,class:"edit-btn save"},"保存")])])):(b(),$(j,{key:2},[t.msg.type==="text"?(b(),$("div",hs,y(t.msg.content),1)):t.msg.type==="image"?(b(),$(j,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(b(),$("div",{key:0,class:"text-generated-image-container",onClick:T[3]||(T[3]=D=>w(r).preview(t.msg))},[e("div",bs,y(t.msg.content),1)])):(b(),$("div",{key:1,class:"image-msg",onClick:T[4]||(T[4]=D=>w(r).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,ks)]))],64)):t.msg.type==="sticker"?(b(),$("div",ys,[e("img",{src:t.msg.content,alt:"表情包"},null,8,Ss)])):t.msg.type==="voice"?(b(),$("div",$s,[e("div",Ms,[q(ee,{name:"voice-wave",class:z(["voice-icon-svg",{playing:h.value}])},null,8,["class"]),e("span",null,y(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(b(),$("div",ws,[e("div",Cs,[e("div",Ts,y(t.msg.content||"位置信息"),1),T[6]||(T[6]=e("div",{class:"msg-desc"},"详细地址",-1))]),T[7]||(T[7]=$e('<div class="location-map" data-v-07f871f5><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-07f871f5><div class="location-pin" data-v-07f871f5><svg viewBox="0 0 24 24" fill="currentColor" data-v-07f871f5><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-07f871f5></path></svg></div></div>',1))])):t.msg.type==="transfer"?(b(),$("div",{key:5,class:z(["transfer-msg",f.value]),onClick:Y(c,["stop"])},[e("div",xs,[e("div",Is,[t.msg.status==="accepted"?(b(),$("svg",As,[...T[8]||(T[8]=[e("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"},null,-1)])])):(b(),$("span",Ps,"¥"))]),e("div",Bs,[e("div",Rs,"¥"+y(t.msg.content),1),e("div",Vs,y(o.value),1)])]),e("div",Ls,y(m.value),1)],2)):t.msg.type==="call_summary"?(b(),$("div",Es,[T[9]||(T[9]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,y(t.msg.content),1)])):N("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(b(),$("div",Ds,[...T[10]||(T[10]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):N("",!0)]),t.msg.type==="voice"?H((b(),$("div",{key:0,class:"voice-text"},y(t.msg.content),513)),[[ve,h.value]]):N("",!0)]),e("div",{class:z(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:T[5]||(T[5]=Y(D=>u.$emit("toggle-selection",t.msg.id),["stop"]))},null,2)],64))],2))}},qs=O(Ns,[["__scopeId","data-v-07f871f5"]]),Us={key:0,class:"empty-message"},zs={key:0,class:"timestamp"},Fs={key:0,class:"blocked-overlay"},Os={class:"blocked-content"},js=5*60*1e3,Hs={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content","show-thought","accept-transfer"],setup(t,{expose:p}){const s=t,n=C(null),r=a=>{if(a===0)return!0;const d=s.messages[a],g=s.messages[a-1];if(!d.timestamp||!g.timestamp)return!1;const f=new Date(d.timestamp).getTime(),o=new Date(g.timestamp).getTime();return f-o>js},h=a=>{if(!a)return"";const d=new Date(a),g=new Date,f=new Date(g.getFullYear(),g.getMonth(),g.getDate()),o=new Date(f.getTime()-864e5),m=g.getDay()===0?7:g.getDay(),k=new Date(f.getTime()-(m-1)*864e5),l=d.getHours().toString().padStart(2,"0"),i=d.getMinutes().toString().padStart(2,"0"),S=`${l}:${i}`;if(d.getTime()>=f.getTime())return S;if(d.getTime()>=o.getTime())return`昨天 ${S}`;if(d.getTime()>=k.getTime())return`${["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][d.getDay()]} ${S}`;{const A=d.getFullYear(),B=(d.getMonth()+1).toString(),P=d.getDate().toString();return A===g.getFullYear()?`${B}月${P}日 ${S}`:`${A}年${B}月${P}日 ${S}`}},v=()=>{n.value&&(n.value.scrollTop=n.value.scrollHeight)};return F(()=>s.messages,()=>{Q(()=>{v()})},{deep:!0}),F(()=>s.activePanel,a=>{a&&Q(()=>{v()})}),ce(()=>{v()}),p({scrollToBottom:v}),(a,d)=>(b(),$(j,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:n},[t.messages.length===0?(b(),$("div",Us," 开始和 "+y(t.charName)+" 聊天吧~ ",1)):N("",!0),(b(!0),$(j,null,te(t.messages,(g,f)=>(b(),$(j,{key:g.id},[r(f)?(b(),$("div",zs,y(h(g.timestamp)),1)):N("",!0),q(qs,{msg:g,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(g.id),editingMessageId:t.editingMessageId,onSaveEdit:d[0]||(d[0]=o=>a.$emit("save-edit",o)),onCancelEdit:d[1]||(d[1]=o=>a.$emit("cancel-edit")),onToggleSelection:d[2]||(d[2]=o=>a.$emit("toggle-selection",o)),onLongPress:d[3]||(d[3]=(o,m)=>a.$emit("long-press",o,m)),onCancelLongPress:d[4]||(d[4]=o=>a.$emit("cancel-long-press")),onTouchMove:d[5]||(d[5]=o=>a.$emit("touch-move",o)),onClickMsg:d[6]||(d[6]=(o,m)=>a.$emit("click-msg",o,m)),onShowTextContent:d[7]||(d[7]=o=>a.$emit("show-text-content",o)),onShowThought:d[8]||(d[8]=o=>a.$emit("show-thought",o)),onAcceptTransfer:d[9]||(d[9]=o=>a.$emit("accept-transfer",o))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"])],64))),128))],512),t.isBlocked?(b(),$("div",Fs,[e("div",Os,[d[11]||(d[11]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:d[10]||(d[10]=g=>a.$emit("unblock"))},"解除拉黑")])])):N("",!0)],64))}},Ws=O(Hs,[["__scopeId","data-v-deb1a117"]]),Gs={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:p}){const s=t,n=p,r=V({get:()=>s.visible,set:a=>n("update:visible",a)}),h=C("");F(()=>s.visible,a=>{a&&(h.value="")});const v=()=>{const a=h.value.trim();n("confirm",a),r.value=!1};return(a,d)=>(b(),G(oe,{visible:r.value,"onUpdate:visible":d[2]||(d[2]=g=>r.value=g),title:"发送语音"},{footer:W(()=>[e("button",{class:"modal-btn cancel",onClick:d[1]||(d[1]=g=>r.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:v},"发送")]),default:W(()=>[H(e("input",{type:"text",class:"base-input","onUpdate:modelValue":d[0]||(d[0]=g=>h.value=g),placeholder:"输入语音内容..."},null,512),[[K,h.value]])]),_:1},8,["visible"]))}},Ys={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:p}){const s=t,n=p,r=V({get:()=>s.visible,set:d=>n("update:visible",d)}),h=C(""),v=C("");F(()=>s.visible,d=>{d&&(h.value="",v.value="")});const a=()=>{const d=h.value.trim(),g=v.value.trim();d&&(n("confirm",{name:d,detail:g}),r.value=!1)};return(d,g)=>(b(),G(oe,{visible:r.value,"onUpdate:visible":g[3]||(g[3]=f=>r.value=f),title:"发送位置"},{footer:W(()=>[e("button",{class:"modal-btn cancel",onClick:g[2]||(g[2]=Y(f=>r.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:a},"发送")]),default:W(()=>[H(e("input",{type:"text",class:"base-input","onUpdate:modelValue":g[0]||(g[0]=f=>h.value=f),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[K,h.value]]),H(e("input",{type:"text",class:"base-input","onUpdate:modelValue":g[1]||(g[1]=f=>v.value=f),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[K,v.value]])]),_:1},8,["visible"]))}},Js={class:"chat-list-container"},Ks=["onClick"],Qs=["src"],Xs={class:"chat-info"},Zs={class:"chat-name"},_s=["disabled"],en={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:p}){const s=t,n=p,r=J(),h=C(s.visible),v=C(new Set),a=V(()=>r.characters);F(()=>s.visible,f=>{h.value=f,f||v.value.clear()});const d=f=>{v.value.has(f)?v.value.delete(f):v.value.add(f)},g=()=>{v.value.size>0&&n("confirm",Array.from(v.value))};return(f,o)=>(b(),G(oe,{visible:h.value,"onUpdate:visible":o[1]||(o[1]=m=>h.value=m),title:"选择聊天",onClose:o[2]||(o[2]=m=>f.$emit("close"))},{footer:W(()=>[e("button",{class:"modal-btn cancel",onClick:o[0]||(o[0]=m=>f.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:v.value.size===0,onClick:g}," 确定 ("+y(v.value.size)+") ",9,_s)]),default:W(()=>[e("div",Js,[(b(!0),$(j,null,te(a.value,m=>(b(),$("div",{key:m.id,class:"chat-item",onClick:k=>d(m.id)},[e("img",{src:m.avatar,alt:"avatar",class:"avatar"},null,8,Qs),e("div",Xs,[e("div",Zs,y(m.name),1)]),e("div",{class:z(["checkbox",{selected:v.value.has(m.id)}])},null,2)],8,Ks))),128))])]),_:1},8,["visible"]))}},tn=O(en,[["__scopeId","data-v-00bcf675"]]),sn={class:"note-container"},nn={key:0,class:"content-wrapper"},on={class:"note-header current-header"},an=["src"],ln={key:1,class:"avatar-placeholder"},rn={class:"character-name"},cn={class:"status-section"},dn={class:"status-row"},un={class:"status-value"},vn={class:"status-row"},gn={class:"status-value"},mn={class:"status-row"},fn={class:"status-value"},pn={class:"inner-voice-section"},hn={class:"inner-voice-box"},bn={class:"unspoken-section"},kn={class:"unspoken-text"},yn={key:1,class:"content-wrapper history-wrapper"},Sn={class:"scroll-container"},$n={class:"item-header"},Mn={class:"item-date"},wn={class:"prop-row"},Cn={class:"prop-row"},Tn={class:"prop-row"},xn={class:"prop-row"},In={class:"prop-row"},An={__name:"SingleCharStatus",props:{visible:{type:Boolean,default:!1},name:{type:String,default:""},avatar:{type:String,default:""},charId:{type:String,required:!0}},emits:["close"],setup(t,{emit:p}){const s=t,n=J(),{currentInnerVoice:r,innerVoices:h}=ct(n),v=V(()=>r.value[s.charId]||{emotion:"",outfit:"",posture:"",innerVoice:"",unspokenWords:""}),a=V(()=>h.value[s.charId]||[]),d=k=>k?new Date(k).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"."):"",g=p,f=C(!1),o=()=>{f.value=!f.value};F(()=>s.visible,k=>{k?(document.body.style.overflow="hidden",f.value=!1):document.body.style.overflow=""});const m=()=>{g("close")};return(k,l)=>t.visible?(b(),$("div",{key:0,class:"note-modal-mask",onClick:Y(m,["self"])},[e("div",sn,[e("div",{class:"tape-button",onClick:o}),e("div",{class:z(["note",{"history-mode":f.value}])},[l[11]||(l[11]=e("div",{class:"paper-texture"},null,-1)),f.value?(b(),$("div",yn,[e("div",{class:"note-header history-header"},[l[5]||(l[5]=e("div",{class:"header-title"},"历史心声",-1)),e("button",{class:"close-btn",onClick:m},"✕")]),e("div",Sn,[(b(!0),$(j,null,te(a.value,i=>(b(),$("div",{key:i.id,class:"history-item"},[e("div",$n,[e("span",null,y(i.title),1),e("span",Mn,y(d(i.timestamp)),1)]),e("div",wn,[l[6]||(l[6]=e("span",{class:"prop-label"},"情绪：",-1)),X(y(i.emotion),1)]),e("div",Cn,[l[7]||(l[7]=e("span",{class:"prop-label"},"穿着：",-1)),X(y(i.outfit),1)]),e("div",Tn,[l[8]||(l[8]=e("span",{class:"prop-label"},"姿态：",-1)),X(y(i.posture),1)]),e("div",xn,[l[9]||(l[9]=e("span",{class:"prop-label"},"内心独白：",-1)),X(y(i.innerVoice),1)]),e("div",In,[l[10]||(l[10]=e("span",{class:"prop-label"},"没说出口的话：",-1)),X(y(i.unspokenWords),1)])]))),128))])])):(b(),$("div",nn,[e("div",on,[t.avatar?(b(),$("img",{key:0,src:t.avatar,class:"avatar-img",alt:"avatar"},null,8,an)):(b(),$("div",ln,y(t.name?t.name.charAt(0):"?"),1)),e("div",rn,y(t.name),1),e("button",{class:"close-btn",onClick:m},"✕")]),e("div",cn,[e("div",dn,[l[0]||(l[0]=e("span",{class:"status-label"},"情绪",-1)),e("span",un,y(v.value.emotion||"无"),1)]),e("div",vn,[l[1]||(l[1]=e("span",{class:"status-label"},"穿着",-1)),e("span",gn,y(v.value.outfit||"无"),1)]),e("div",mn,[l[2]||(l[2]=e("span",{class:"status-label"},"姿态",-1)),e("span",fn,y(v.value.posture||"无"),1)])]),e("div",pn,[l[3]||(l[3]=e("div",{class:"section-title"},"Inner Voice",-1)),e("div",hn,[e("p",null,y(v.value.innerVoice||"（没有内心独白）"),1)])]),e("div",bn,[l[4]||(l[4]=e("div",{class:"unspoken-title"},"没说出口的话",-1)),e("div",kn,y(v.value.unspokenWords||"（没有想说的话）"),1)])])),l[12]||(l[12]=e("div",{class:"torn-edge"},null,-1))],2)])])):N("",!0)}},Pn=O(An,[["__scopeId","data-v-8274f6c4"]]),Bn={key:0,class:"transfer-modal"},Rn={class:"app-header transfer-header"},Vn={class:"target-section"},Ln={class:"target-info"},En={class:"target-text"},Dn={class:"transfer-to"},Nn=["src"],qn={key:1,class:"target-avatar-placeholder"},Un={class:"amount-card"},zn={class:"amount-input-wrapper"},Fn={key:0,class:"cursor"},On={class:"note-section"},jn={key:1,class:"note-input-row"},Hn={class:"number-keyboard"},Wn={class:"keyboard-grid"},Gn={__name:"MoneyPacket",props:{visible:{type:Boolean,default:!1},targetName:{type:String,default:""},targetAvatar:{type:String,default:""}},emits:["update:visible","confirm"],setup(t,{emit:p}){const s=t,n=p,r=C(""),h=C(""),v=C(!1),a=C(null),d=C(!0),g=C(!1),f=C(null),o=V(()=>!!a.value),m=V(()=>r.value),k=()=>(a.value=document.querySelector("#phone-screen-container"),!!a.value);ce(()=>{Q(()=>{k()&&(v.value=!0)})}),dt(()=>{v.value=!1});const l=V(()=>{const I=parseFloat(r.value);return!isNaN(I)&&I>0});F(()=>s.visible,I=>{I&&(r.value="",h.value="",d.value=!0)});const i=()=>{n("update:visible",!1)},S=()=>{d.value=!0},A=()=>{g.value=!0,Q(()=>{f.value&&f.value.focus()})},B=()=>{g.value=!1},P=I=>{if(I==="."){if(r.value.includes("."))return;if(r.value===""){r.value="0.";return}}if(r.value.includes(".")){const c=r.value.split(".");if(c[1]&&c[1].length>=2)return}if(!(!r.value.includes(".")&&I!=="."&&r.value.length>=8)){if(r.value==="0"&&I!=="."){r.value=I;return}r.value+=I}},E=()=>{r.value.length>0&&(r.value=r.value.slice(0,-1))},R=()=>{l.value&&(n("confirm",{amount:parseFloat(r.value).toFixed(2),note:h.value}),i())};return(I,c)=>v.value&&o.value?(b(),G(re,{key:0,to:"#phone-screen-container"},[q(ut,{name:"slide-up"},{default:W(()=>[t.visible?(b(),$("div",Bn,[e("div",Rn,[e("div",{class:"back-btn",onClick:i},[q(ee,{name:"back-btn"})]),c[12]||(c[12]=e("div",{class:"title"},null,-1)),c[13]||(c[13]=e("div",{class:"action-btn"},null,-1))]),e("div",Vn,[e("div",Ln,[e("div",En,[e("div",Dn,"转账给 "+y(t.targetName),1)])]),t.targetAvatar?(b(),$("img",{key:0,src:t.targetAvatar,class:"target-avatar"},null,8,Nn)):(b(),$("div",qn,[...c[14]||(c[14]=[e("svg",{viewBox:"0 0 24 24",width:"24",height:"24"},[e("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z",fill:"#999"})],-1)])]))]),e("div",Un,[c[16]||(c[16]=e("div",{class:"amount-label"},"转账金额",-1)),e("div",zn,[c[15]||(c[15]=e("span",{class:"currency-symbol"},"¥",-1)),e("div",{class:"amount-display",onClick:S},[X(y(m.value||"")+" ",1),d.value?(b(),$("span",Fn,"|")):N("",!0)])]),c[17]||(c[17]=e("div",{class:"amount-divider"},null,-1)),e("div",On,[g.value?(b(),$("div",jn,[H(e("input",{type:"text","onUpdate:modelValue":c[0]||(c[0]=u=>h.value=u),class:"base-input note-input",placeholder:"添加转账说明",maxlength:"20",ref_key:"noteInputRef",ref:f,onBlur:B,onKeyup:Me(B,["enter"])},null,544),[[K,h.value]])])):(b(),$("div",{key:0,class:"note-label-row",onClick:A},[e("span",{class:z(["note-text",{"has-note":h.value}])},y(h.value||"添加转账说明"),3)]))])]),e("div",Hn,[e("div",Wn,[e("div",{class:"key-btn",onClick:c[1]||(c[1]=u=>P("1"))},"1"),e("div",{class:"key-btn",onClick:c[2]||(c[2]=u=>P("2"))},"2"),e("div",{class:"key-btn",onClick:c[3]||(c[3]=u=>P("3"))},"3"),e("div",{class:"key-btn delete-btn",onClick:E},[...c[18]||(c[18]=[e("svg",{viewBox:"0 0 24 24",width:"22",height:"22"},[e("path",{d:"M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z",fill:"#333"})],-1)])]),e("div",{class:"key-btn",onClick:c[4]||(c[4]=u=>P("4"))},"4"),e("div",{class:"key-btn",onClick:c[5]||(c[5]=u=>P("5"))},"5"),e("div",{class:"key-btn",onClick:c[6]||(c[6]=u=>P("6"))},"6"),e("div",{class:z(["key-btn transfer-key",{disabled:!l.value}]),onClick:R}," 转账 ",2),e("div",{class:"key-btn",onClick:c[7]||(c[7]=u=>P("7"))},"7"),e("div",{class:"key-btn",onClick:c[8]||(c[8]=u=>P("8"))},"8"),e("div",{class:"key-btn",onClick:c[9]||(c[9]=u=>P("9"))},"9"),e("div",{class:"key-btn zero-btn",onClick:c[10]||(c[10]=u=>P("0"))},"0"),e("div",{class:"key-btn",onClick:c[11]||(c[11]=u=>P("."))},".")])])])):N("",!0)]),_:1})])):N("",!0)}},Yn=O(Gn,[["__scopeId","data-v-aeb4e21f"]]),Jn={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const p=t,s=ge(),{t:n}=Z(),r=J(),h=ne(),v=vt(),a=C(null),d=C(null),g=C(null),f=C(!1),o=C({visible:!1,messageId:null,targetEl:null}),m=C(!1),k=C(!1),l=C(!1),i=C(!1);C("");const S=C(!1),A=V(()=>r.getCharacter(p.charId)),B=V(()=>{var M;return((M=A.value)==null?void 0:M.isBlocked)||!1}),P=V(()=>{var M,x;return((M=A.value)==null?void 0:M.nickname)||((x=A.value)==null?void 0:x.name)||n("chat.unknownCharacter")}),E=V(()=>{var M;return((M=A.value)==null?void 0:M.name)||n("chat.unknownCharacter")}),R=V(()=>{var M;return(M=A.value)==null?void 0:M.avatar}),I=V(()=>{var M;return((M=A.value)==null?void 0:M.status)||{}}),c=V(()=>{var M;return((M=A.value)==null?void 0:M.chatBackground)||""}),u=V(()=>{const M=A.value;if(!M||!M.userPersona)return"";const x=r.userPersonas.find(L=>L.id===M.userPersona);return(x==null?void 0:x.avatar)||""}),T=V(()=>r.messages[p.charId]||[]),D=V(()=>{var M;return((M=A.value)==null?void 0:M.bubbleSettings)||{}}),{isSelectionMode:U,selectedMessageIds:_,isForwarding:ae,enterSelectionMode:we,exitSelectionMode:me,toggleMessageSelection:fe,handleBatchAction:Ce,handleConfirmForward:Te}=mt(ie(p,"charId")),{isTyping:xe,triggerAiResponse:pe}=pt(ie(p,"charId"),v),{inputText:le,quotingMessage:de,sendMessage:Ie,sendSticker:Ae,sendVoiceMessage:Pe,handleSendImage:Be,confirmSendLocation:Re,sendTransfer:Ve}=bt(r,ie(p,"charId"),h,g),{editingMessageId:he,handleEditMessage:Le,handleSaveEdit:Ee,updateInputText:De}=ht(r,ie(p,"charId"),le),{startLongPress:Ne,cancelLongPress:qe,handleTouchMove:Ue,wasClickAfterLongPress:ze}=kt(o),Fe=V(()=>{const M=D.value,x={fontSize:M.fontSize?`${M.fontSize}px`:"14px"};if(M.css){const L={};return M.css.split(";").forEach(st=>{const ue=st.split(":");if(ue.length>=2){const be=ue[0].trim(),ke=ue.slice(1).join(":").trim();be&&ke&&(L[be]=ke)}}),{...x,...L}}return x});F(f,M=>{M&&(s.push({name:"single-chat-settings",params:{id:p.charId}}),f.value=!1)}),F(()=>{var M;return(M=r.messages[p.charId])==null?void 0:M.length},()=>{r.clearUnreadCount(p.charId)}),ce(()=>{r.clearUnreadCount(p.charId)});const Oe=()=>{A.value&&(A.value.isBlocked=!1,r.messages[p.charId]&&r.messages[p.charId].forEach(M=>{M.blocked&&(M.blocked=!1)}),r.saveData(),h.showToast(n("chat.toast.unblocked")))},je=M=>{const x=M.target;x.closest(".modal-overlay.active")||(g.value&&!x.closest(".chat-footer")&&(g.value=null),U.value&&!x.closest(".message")&&!x.closest(".chat-action-row")&&!x.closest(".message-checkbox")&&!x.closest(".message-menu")&&me(),o.value.visible&&!x.closest(".message-menu")&&(o.value.visible=!1))},He=(M,x)=>{if(ze()){M.preventDefault(),M.stopPropagation();return}U.value&&fe(x)},We=M=>{const x=T.value.find(L=>L.id===M);x&&(de.value=x)},Ge=()=>{k.value=!0},Ye=M=>{Pe(M),k.value=!1},Je=()=>{g.value=null,m.value=!0},Ke=()=>{l.value=!0},Qe=({name:M,detail:x})=>{Re(M,x),l.value=!1},Xe=()=>{r.startVideoCall(p.charId,"user")},Ze=()=>{i.value=!0},_e=()=>{S.value=!0},et=({amount:M,note:x})=>{Ve(M,x),S.value=!1},tt=M=>{r.acceptTransfer(p.charId,M)};return(M,x)=>(b(),$("div",{class:z(["chat-room active",{"selection-mode":w(U)}]),onClick:je,ref_key:"chatRoomRef",ref:d},[e("div",{class:"chat-bg",style:se(c.value?{backgroundImage:`url(${c.value})`}:{})},null,4),q(It,{charId:p.charId,charName:P.value,charStatus:I.value,isTyping:w(xe),onTriggerAi:w(pe),onOpenSettings:x[0]||(x[0]=L=>f.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),q(Ws,{ref_key:"messageListRef",ref:a,messages:T.value,charName:P.value,charAvatar:R.value,userAvatar:u.value,bubbleStyle:Fe.value,isSelectionMode:w(U),selectedMessageIds:w(_),isBlocked:B.value,editingMessageId:w(he),activePanel:g.value,onSaveEdit:w(Ee),onCancelEdit:x[1]||(x[1]=L=>he.value=null),onToggleSelection:w(fe),onLongPress:w(Ne),onCancelLongPress:w(qe),onTouchMove:w(Ue),onClickMsg:He,onUnblock:Oe,onShowThought:Ze,onAcceptTransfer:tt},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),w(U)?N("",!0):(b(),G(ns,{key:0,modelValue:w(le),"onUpdate:modelValue":x[2]||(x[2]=L=>gt(le)?le.value=L:null),activePanel:g.value,"onUpdate:activePanel":x[3]||(x[3]=L=>g.value=L),charId:p.charId,quotingMessage:w(de),onCancelQuote:x[4]||(x[4]=L=>de.value=null),onSendMessage:w(Ie),onSendSticker:w(Ae),onTriggerVoice:Ge,onTriggerImage:Je,onTriggerVideo:Xe,onTriggerLocation:Ke,onTriggerTransfer:_e},null,8,["modelValue","activePanel","charId","quotingMessage","onSendMessage","onSendSticker"])),w(U)?(b(),G(cs,{key:1,onAction:w(Ce),onCancel:w(me)},null,8,["onAction","onCancel"])):N("",!0),q(Gs,{visible:k.value,"onUpdate:visible":x[5]||(x[5]=L=>k.value=L),onConfirm:Ye},null,8,["visible"]),q(Se,{visible:m.value,"onUpdate:visible":x[6]||(x[6]=L=>m.value=L),onSendImage:w(Be)},null,8,["visible","onSendImage"]),q(Ys,{visible:l.value,"onUpdate:visible":x[7]||(x[7]=L=>l.value=L),onConfirm:Qe},null,8,["visible"]),q(ls,{visible:o.value.visible,targetEl:o.value.targetEl,messageId:o.value.messageId,charId:p.charId,isSelectionMode:w(U),selectedMessageIds:w(_),onClose:x[8]||(x[8]=L=>o.value.visible=!1),onEnterSelectionMode:w(we),onTriggerAiResponse:w(pe),"onUpdate:inputText":w(De),onQuoteMessage:We,onEditMessage:w(Le)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),q(tn,{visible:w(ae),onClose:x[9]||(x[9]=L=>ae.value=!1),onConfirm:w(Te)},null,8,["visible","onConfirm"]),q(Pn,{visible:i.value,name:E.value,avatar:R.value,charId:p.charId,onClose:x[10]||(x[10]=L=>i.value=!1)},null,8,["visible","name","avatar","charId"]),q(Yn,{visible:S.value,"onUpdate:visible":x[11]||(x[11]=L=>S.value=L),targetName:P.value,targetAvatar:R.value,onConfirm:et},null,8,["visible","targetName","targetAvatar"])],2))}},Qn=O(Jn,[["__scopeId","data-v-3292bae6"]]);export{Qn as default};
