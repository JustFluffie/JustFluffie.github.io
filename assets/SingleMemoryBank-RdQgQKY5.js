import{_ as te,k as se,B as ae,Z as oe,r as l,m as ne,c as F,b as le,w as c,e as ie,x as re,q as ce,o as y,i as s,f as u,g as D,t as _,G as ue,H as de,S as x,j as ve,p as I,F as T}from"./index-BPODIDtX.js";const me={class:"header-actions"},fe={class:"memory-bank-content"},pe={class:"memory-scroll-container"},he={key:0,class:"empty-state"},ge={class:"empty-text"},be={key:1,class:"memory-list"},ye={class:"card-header-row"},_e={class:"header-left"},xe={class:"char-info",style:{"padding-left":"8px"}},Me={class:"char-name"},Se={class:"save-time"},ke={class:"header-right"},we=["onClick"],Ce=["onClick"],$e=["onClick","title"],Fe={class:"card-content-row"},De={class:"refine-range-info"},Ie={class:"refine-range-inputs"},Te={__name:"SingleMemoryBank",setup(Ne){const H=ne();re();const d=se(),v=ae(),O=oe(),N=l(H.params.charId),U=l(!1),p=l(!1),m=l(-1),r=l(""),M=l(!1),S=l(-1),k=l(!1),h=l(""),w=l(1),C=l(0),f=F(()=>d.getCharacter(N.value)),n=F(()=>{var t;return((t=f.value)==null?void 0:t.memories)||[]}),V=F(()=>{var t;return((t=f.value)==null?void 0:t.name)||"角色"}),R=F(()=>[...U.value?n.value.filter(e=>e.isFavorite):n.value].sort((e,o)=>(o.time||0)-(e.time||0))),P=()=>{p.value=!1,r.value=""},E=()=>{M.value=!1,S.value=-1},j=()=>{k.value=!1},A=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},q=()=>{m.value=-1,r.value="",p.value=!0},z=t=>{const e=n.value.findIndex(o=>o.id===t.id);e!==-1&&(m.value=e,r.value=t.content,p.value=!0)},L=()=>{if(!r.value.trim())return;const t=f.value;if(t.memories||(t.memories=[]),m.value>=0){const e=t.memories[m.value];typeof e=="string"?t.memories[m.value]={content:r.value,time:Date.now(),charName:t.name,isFavorite:!1}:e.content=r.value}else t.memories.unshift({content:r.value,time:Date.now(),charName:t.name,isFavorite:!1});d.saveData(),P()},Y=t=>{const e=n.value.findIndex(o=>o.id===t.id);e!==-1&&(S.value=e,M.value=!0)},Z=()=>{S.value>=0&&(f.value.memories.splice(S.value,1),d.saveData()),E()},J=t=>{const e=n.value.find(o=>o.id===t.id);if(e)if(typeof e=="string"){const o=n.value.indexOf(e),a={content:e,time:Date.now(),charName:V.value,isFavorite:!1};n.value[o]=a,d.toggleMemoryFavorite(N.value,a)}else d.toggleMemoryFavorite(N.value,e)},K=()=>{const t=`# 任务
你是一个记忆提炼助手,请对以下已有的长期记忆进行二次总结,生成一段更精炼的核心记忆。

这份记忆要**客观又自然**:

## 要求
- **字数限制**:总结控制在 200-300 字以内,只记录最核心的内容
- **我是叙述者,不是分析师**。只用我的口吻描述发生了什么,不作总结评价
- **保留时间线索**:尊重原记忆中的时间信息,不要将不同时间的事件混淆或合并
- **抓重点**:从已有记忆中提取最关键的事件、情感和关系变化
- **保持真实**:不要添加原记忆中没有的信息,只提炼已有内容
- **说人话**:务必避免"交互"、"需求"、"成功解决"这类报告式词汇

直接输出提炼后的记忆内容,不要加任何其他东西。`;h.value=f.value.memorySummaryPrompt||t,w.value=1,C.value=n.value.length,k.value=!0},Q=async()=>{const t=f.value;if(!t)return;const e=n.value.length,o=Math.max(1,w.value),a=Math.min(e,C.value);if(o>a){v.showToast("起始范围不能大于结束范围","error");return}t.memorySummaryPrompt=h.value,v.showToast("正在提炼记忆...","info"),j();const g=n.value.length,$=Math.max(0,g-a),W=Math.min(g,g-o+1);let B=n.value.slice($,W);if(B.reverse(),B.length===0){v.showToast("选定范围内没有记忆可供提炼","warn");return}const X=B.map((i,b)=>{const G=i.time?A(i.time):"";return`[${b+1}] ${G?`(${G}) `:""}${i.content}`}).join(`

`),ee=[{role:"user",content:`${h.value.trim()}

现有记忆如下：

${X}`}];try{const i=await O.getGenericCompletion(ee),b=i==null?void 0:i.content;b&&b.trim()?(t.memories||(t.memories=[]),t.memories.unshift({content:`[记忆提炼 ${o}-${a}] ${b.trim()}`,time:Date.now(),charName:t.name,isFavorite:!1}),d.saveData(),v.showToast("记忆提炼已完成","success")):v.showToast("提炼失败，未收到有效回复","error")}catch(i){console.error("记忆提炼失败:",i),v.showToast(`提炼失败: ${i.message}`,"error")}};return(t,e)=>{const o=ce("Modal");return y(),le(ie,{title:"长期记忆"},{action:c(()=>[s("div",me,[s("button",{class:"icon-btn",onClick:K,title:"提炼"},[u(x,{name:"Sparkles"})]),s("button",{class:"icon-btn",onClick:q,title:"添加"},[u(x,{name:"plus"})])])]),default:c(()=>[s("div",fe,[s("div",pe,[!R.value||R.value.length===0?(y(),D("div",he,[s("div",ge,_(U.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(y(),D("div",be,[(y(!0),D(ue,null,de(R.value,(a,g)=>(y(),D("div",{key:a.id||g,class:"card memory-card"},[s("div",ye,[s("div",_e,[s("div",xe,[s("span",Me,_(a.charName||V.value),1),s("span",Se,_(A(a.time)),1)])]),s("div",ke,[s("button",{class:"icon-btn",onClick:$=>z(a),title:"编辑"},[u(x,{name:"pencil"})],8,we),s("button",{class:"icon-btn danger",onClick:$=>Y(a),title:"删除"},[u(x,{name:"trash"})],8,Ce),s("button",{class:"icon-btn favorite-btn",onClick:$=>J(a),title:a.isFavorite?"取消收藏":"收藏"},[u(x,{name:a.isFavorite?"heart-solid":"heart",class:ve({"is-favorite":a.isFavorite})},null,8,["name","class"])],8,$e)])]),s("div",Fe,_(a.content),1)]))),128))]))])]),u(o,{visible:p.value,"onUpdate:visible":e[1]||(e[1]=a=>p.value=a),title:m.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:c(()=>[s("button",{class:"modal-btn cancel",onClick:P},"取消"),s("button",{class:"modal-btn confirm",onClick:L},"确定")]),default:c(()=>[I(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[0]||(e[0]=a=>r.value=a),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[T,r.value]])]),_:1},8,["visible","title"]),u(o,{visible:M.value,"onUpdate:visible":e[2]||(e[2]=a=>M.value=a),title:"确认删除",class:"nested"},{footer:c(()=>[s("button",{class:"modal-btn cancel",onClick:E},"取消"),s("button",{class:"modal-btn confirm danger",onClick:Z},"确认删除")]),default:c(()=>[e[7]||(e[7]=s("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),u(o,{visible:k.value,"onUpdate:visible":e[6]||(e[6]=a=>k.value=a),title:"记忆提炼",class:"nested"},{footer:c(()=>[s("button",{class:"modal-btn cancel",onClick:j},"取消"),s("button",{class:"modal-btn confirm",onClick:Q},"开始提炼")]),default:c(()=>[s("div",De," 当前共有 "+_(n.value.length)+" 条记忆。 ",1),s("div",Ie,[e[8]||(e[8]=s("label",{for:"refine-start"},"从第",-1)),I(s("input",{id:"refine-start",type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>w.value=a),class:"base-input range-input"},null,512),[[T,w.value,void 0,{number:!0}]]),e[9]||(e[9]=s("label",{for:"refine-end"},"条 到 第",-1)),I(s("input",{id:"refine-end",type:"number","onUpdate:modelValue":e[4]||(e[4]=a=>C.value=a),class:"base-input range-input"},null,512),[[T,C.value,void 0,{number:!0}]]),e[10]||(e[10]=s("label",null,"条",-1))]),e[11]||(e[11]=s("p",{class:"summary-tip"},"将对选定范围内的长期记忆进行再总结。",-1)),I(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[5]||(e[5]=a=>h.value=a),placeholder:"输入总结提示词...",style:{height:"100px"}},null,512),[[T,h.value]])]),_:1},8,["visible"])]),_:1})}}},Ue=te(Te,[["__scopeId","data-v-483ff46b"]]);export{Ue as default};
