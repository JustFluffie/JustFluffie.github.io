import{ci as Z,r as T,_ as W,C as ne,a7 as le,c as U,g as u,o as i,i as e,f as P,h as B,n as O,t as N,p as q,F as K,I as H,U as V,m as J,G,H as L,D as se,S as j,bz as ee,w as z,k as Y,Z as ae,b as E,j as re,Y as te,u as ie,d as ve,e as me,a6 as ge,y as fe}from"./index-D1qrJq6I.js";const Q=Z("charTheme",()=>{const t=T({}),m=o=>(t.value[o]||(t.value[o]={wallpaper:"",appIcons:{}}),t.value[o]),s=(o,y)=>{t.value[o]||m(o),t.value[o].wallpaper=y,n()},f=(o,y,h)=>{t.value[o]||m(o),t.value[o].appIcons||(t.value[o].appIcons={}),t.value[o].appIcons[y]=h,n()},b=(o,y)=>{var h,D;(D=(h=t.value[o])==null?void 0:h.appIcons)!=null&&D[y]&&(delete t.value[o].appIcons[y],n())},p=o=>{const y=m(o);return y.wallpaper?{backgroundImage:`url(${y.wallpaper})`,backgroundSize:"cover",backgroundPosition:"center"}:{}},k=(o,y)=>{var D;return((D=m(o).appIcons)==null?void 0:D[y])||null},n=()=>{localStorage.setItem("charphone_themes",JSON.stringify(t.value))},g=()=>{const o=localStorage.getItem("charphone_themes");if(o)try{t.value=JSON.parse(o)}catch(y){console.error("Failed to load charphone themes:",y)}};return g(),{charThemes:t,getCharTheme:m,setWallpaper:s,setAppIcon:f,deleteAppIcon:b,getWallpaperStyle:p,getAppIcon:k,saveThemes:n,loadThemes:g}}),be={key:0,class:"upload-hint"},ke={class:"left-section"},_e={key:0,class:"upload-hint"},ye={class:"date-info"},$e={class:"weekday"},we={class:"date"},Ce={class:"right-section"},De={class:"text-inputs-row"},Se={class:"photos-row"},Me={key:0,class:"upload-hint"},xe={key:0,class:"upload-hint"},Ie={__name:"CharPhoneHeader",props:{widgetData:{type:Object,default:()=>({background:"",avatar:"",photos:["",""],photoTexts:["",""]})}},emits:["update:widgetData"],setup(t,{emit:m}){var v,r;const s=t,f=m,b=T(!1),p=T("background"),k=T(0),n=T([((v=s.widgetData.photoTexts)==null?void 0:v[0])||"",((r=s.widgetData.photoTexts)==null?void 0:r[1])||""]),g=T(""),o=T("");let y=null;const h=()=>{const l=new Date,a=(l.getMonth()+1).toString().padStart(2,"0"),c=l.getDate().toString().padStart(2,"0");g.value=`${a}.${c}`;const d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];o.value=d[l.getDay()]};ne(()=>{h(),y=setInterval(h,6e4)}),le(()=>{y&&clearInterval(y)});const D=U(()=>s.widgetData.background?{backgroundImage:`url('${s.widgetData.background}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),C=U(()=>s.widgetData.avatar?{backgroundImage:`url('${s.widgetData.avatar}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),S=l=>s.widgetData.photos[l]?{backgroundImage:`url('${s.widgetData.photos[l]}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"},_=()=>{p.value="background",b.value=!0},I=()=>{p.value="avatar",b.value=!0},A=l=>{k.value=l,p.value=`photo${l}`,b.value=!0},M=l=>{const a={...s.widgetData};p.value==="background"?a.background=l.content:p.value==="avatar"?a.avatar=l.content:p.value.startsWith("photo")&&(a.photos=[...s.widgetData.photos],a.photos[k.value]=l.content),f("update:widgetData",a)},$=l=>{const a={...s.widgetData,photoTexts:[...n.value]};f("update:widgetData",a)};return(l,a)=>(i(),u("div",{class:"char-phone-header",onClick:H(_,["stop"])},[e("div",{class:"widget-background",style:O(D.value)},[t.widgetData.background?B("",!0):(i(),u("div",be," 点击上传 "))],4),e("div",{class:"widget-content",onClick:a[8]||(a[8]=H(()=>{},["stop"]))},[e("div",ke,[e("div",{class:"avatar-circle",style:O(C.value),onClick:I},[t.widgetData.avatar?B("",!0):(i(),u("div",_e," 点击上传 "))],4),e("div",ye,[e("div",$e,N(o.value),1),e("div",we,N(g.value),1)])]),e("div",Ce,[e("div",De,[q(e("input",{"onUpdate:modelValue":a[0]||(a[0]=c=>n.value[0]=c),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:a[1]||(a[1]=c=>$()),onClick:a[2]||(a[2]=H(()=>{},["stop"]))},null,544),[[K,n.value[0]]]),q(e("input",{"onUpdate:modelValue":a[3]||(a[3]=c=>n.value[1]=c),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:a[4]||(a[4]=c=>$()),onClick:a[5]||(a[5]=H(()=>{},["stop"]))},null,544),[[K,n.value[1]]])]),e("div",Se,[e("div",{class:"photo-item",style:O(S(0)),onClick:a[6]||(a[6]=c=>A(0))},[t.widgetData.photos[0]?B("",!0):(i(),u("div",Me," 点击上传 "))],4),e("div",{class:"photo-item",style:O(S(1)),onClick:a[7]||(a[7]=c=>A(1))},[t.widgetData.photos[1]?B("",!0):(i(),u("div",xe," 点击上传 "))],4)])])]),P(V,{visible:b.value,"onUpdate:visible":a[9]||(a[9]=c=>b.value=c),type:"basic","biz-type":p.value,onUploadComplete:M},null,8,["visible","biz-type"])]))}},Te=W(Ie,[["__scopeId","data-v-baafc6b9"]]),Ue={class:"char-phone-middle-widget"},Ae={class:"photo-section"},Ne={class:"photo-wrapper"},Pe={key:0,class:"upload-hint"},Be={class:"app-section"},Oe={class:"app-grid-wrapper"},We={class:"app-grid"},Fe=["onClick"],Re={class:"app-icon"},ze=["src"],Je={class:"app-label"},He={__name:"CharPhoneMiddleWidget",props:{widgetData:{type:Object,default:()=>({photo:"",apps:[]})}},emits:["update:widgetData","app-click"],setup(t,{emit:m}){const s=t,f=m,b=J(),p=Q(),k=b.params.charId,n=T(!1),g=U(()=>s.widgetData.photo?{backgroundImage:`url('${s.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),o=()=>{n.value=!0},y=C=>{f("app-click",C)},h=C=>{const S={...s.widgetData};S.photo=C.content,f("update:widgetData",S)},D=C=>p.getAppIcon(k,C);return(C,S)=>(i(),u("div",Ue,[e("div",Ae,[e("div",Ne,[e("div",{class:"photo-container",style:O(g.value),onClick:o},[t.widgetData.photo?B("",!0):(i(),u("div",Pe," 点击上传 "))],4)])]),e("div",Be,[e("div",Oe,[e("div",We,[(i(!0),u(G,null,L(t.widgetData.apps,(_,I)=>(i(),u("div",{key:I,class:"app-item",onClick:A=>y(_)},[e("div",Re,[D(_.label)?(i(),u("img",{key:0,src:D(_.label),alt:"app icon",class:"app-icon-img"},null,8,ze)):(i(),u("div",{key:1,class:"app-icon-placeholder",style:O({background:_.color})},null,4))]),e("div",Je,N(_.label),1)],8,Fe))),128))])])]),P(V,{visible:n.value,"onUpdate:visible":S[0]||(S[0]=_=>n.value=_),type:"basic","biz-type":"photo",onUploadComplete:h},null,8,["visible"])]))}},je=W(He,[["__scopeId","data-v-56c6ed61"]]),Ee={class:"char-phone-bottom-widget"},Ge={class:"app-section"},Le={class:"app-grid-wrapper"},Ve={class:"app-grid"},Ye=["onClick"],qe={class:"app-icon"},Ke=["src"],Ze={class:"app-label"},Qe={class:"photo-section"},Xe={class:"photo-wrapper"},et={key:0,class:"upload-hint"},tt={class:"text-inputs"},at={__name:"CharPhoneBottomWidget",props:{widgetData:{type:Object,default:()=>({photo:"",text1:"",text2:"",apps:[]})}},emits:["update:widgetData","app-click"],setup(t,{emit:m}){const s=t,f=m,b=J(),p=Q(),k=b.params.charId,n=T(!1),g=U(()=>s.widgetData.photo?{backgroundImage:`url('${s.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),o=()=>{n.value=!0},y=S=>{console.log("Bottom widget - 打开应用:",S.label),f("app-click",S)},h=S=>{const _={...s.widgetData};_.photo=S.content,f("update:widgetData",_)},D=()=>{f("update:widgetData",{...s.widgetData})},C=S=>p.getAppIcon(k,S);return(S,_)=>(i(),u("div",Ee,[e("div",Ge,[e("div",Le,[e("div",Ve,[(i(!0),u(G,null,L(t.widgetData.apps,(I,A)=>(i(),u("div",{key:A,class:"app-item",onClick:M=>y(I)},[e("div",qe,[C(I.label)?(i(),u("img",{key:0,src:C(I.label),alt:"app icon",class:"app-icon-img"},null,8,Ke)):(i(),u("div",{key:1,class:"app-icon-placeholder",style:O({background:I.color})},null,4))]),e("div",Ze,N(I.label),1)],8,Ye))),128))])])]),e("div",Qe,[e("div",Xe,[e("div",{class:"photo-container",style:O(g.value),onClick:o},[t.widgetData.photo?B("",!0):(i(),u("div",et," 点击上传 "))],4),e("div",tt,[q(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":_[0]||(_[0]=I=>t.widgetData.text1=I),placeholder:"输入文本1",onInput:D},null,544),[[K,t.widgetData.text1]]),q(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":_[1]||(_[1]=I=>t.widgetData.text2=I),placeholder:"输入文本2",onInput:D},null,544),[[K,t.widgetData.text2]])])])]),P(V,{visible:n.value,"onUpdate:visible":_[2]||(_[2]=I=>n.value=I),type:"basic","biz-type":"photo",onUploadComplete:h},null,8,["visible"])]))}},ot=W(at,[["__scopeId","data-v-6aec5625"]]),st={class:"char-phone-widget-container"},nt={class:"widget-item top-widget"},lt={class:"widget-item middle-widget"},rt={class:"widget-item bottom-widget"},it={__name:"CharPhoneWidgetContainer",props:{headerData:{type:Object,required:!0},middleData:{type:Object,required:!0},bottomData:{type:Object,required:!0}},emits:["update:headerData","update:middleData","update:bottomData","app-click"],setup(t,{emit:m}){const s=m,f=n=>{s("update:headerData",n)},b=n=>{s("update:middleData",n)},p=n=>{s("update:bottomData",n)},k=n=>{s("app-click",n)};return(n,g)=>(i(),u("div",st,[e("div",nt,[P(Te,{"widget-data":t.headerData,"onUpdate:widgetData":f},null,8,["widget-data"])]),e("div",lt,[P(je,{"widget-data":t.middleData,"onUpdate:widgetData":b,onAppClick:k},null,8,["widget-data"])]),e("div",rt,[P(ot,{"widget-data":t.bottomData,"onUpdate:widgetData":p,onAppClick:k},null,8,["widget-data"])])]))}},ct=W(it,[["__scopeId","data-v-06296b08"]]),dt={class:"char-phone-dock"},ut={class:"message-row other-message"},pt={key:0,class:"upload-hint"},ht=["data-placeholder"],vt={class:"message-row my-message"},mt=["data-placeholder"],gt={key:0,class:"upload-hint"},ft={__name:"CharPhoneDock",props:{dockData:{type:Object,default:()=>({avatars:{other:"",mine:""},messages:{other:"",mine:""}})}},emits:["update:dockData"],setup(t,{emit:m}){var M,$;const s=t,f=m,b=T(!1),p=T("avatar-other"),k=T({other:((M=s.dockData.messages)==null?void 0:M.other)||"",mine:(($=s.dockData.messages)==null?void 0:$.mine)||""}),n=T(!1),g=T(null),o=T(null);se(()=>k.value.other,v=>{g.value&&g.value.textContent!==v&&(g.value.textContent=v)},{immediate:!0}),se(()=>k.value.mine,v=>{o.value&&o.value.textContent!==v&&(o.value.textContent=v)},{immediate:!0});const y=()=>{n.value=!0},h=(v,r)=>{n.value=!1,k.value[r]=v.target.textContent},D=(v,r)=>{n.value||(k.value[r]=v.target.textContent)},C=(v,r)=>{k.value[r]=v.target.textContent,A()},S=v=>{var l;const r=(l=s.dockData.avatars)==null?void 0:l[v];return r?{backgroundImage:`url('${r}')`,backgroundSize:"cover",backgroundPosition:"center",backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.9)"}},_=v=>{p.value=`avatar-${v}`,b.value=!0},I=v=>{const r={...s.dockData,avatars:{...s.dockData.avatars}};p.value==="avatar-other"?r.avatars.other=v.content:p.value==="avatar-mine"&&(r.avatars.mine=v.content),f("update:dockData",r)},A=v=>{const r={...s.dockData,messages:{...k.value}};f("update:dockData",r)};return(v,r)=>(i(),u("div",dt,[e("div",ut,[e("div",{class:"avatar",style:O(S("other")),onClick:r[0]||(r[0]=l=>_("other"))},[t.dockData.avatars.other?B("",!0):(i(),u("div",pt," 点击上传 "))],4),e("div",{ref_key:"bubbleOtherRef",ref:g,class:"bubble bubble-other",onClick:r[1]||(r[1]=H(()=>{},["stop"])),contenteditable:"true",onCompositionstart:y,onCompositionend:r[2]||(r[2]=l=>h(l,"other")),onInput:r[3]||(r[3]=l=>D(l,"other")),onBlur:r[4]||(r[4]=l=>C(l,"other")),"data-placeholder":k.value.other?"":"点击输入文字"},null,40,ht)]),e("div",vt,[e("div",{ref_key:"bubbleMineRef",ref:o,class:"bubble bubble-mine",onClick:r[5]||(r[5]=H(()=>{},["stop"])),contenteditable:"true",onCompositionstart:y,onCompositionend:r[6]||(r[6]=l=>h(l,"mine")),onInput:r[7]||(r[7]=l=>D(l,"mine")),onBlur:r[8]||(r[8]=l=>C(l,"mine")),"data-placeholder":k.value.mine?"":"点击输入文字"},null,40,mt),e("div",{class:"avatar",style:O(S("mine")),onClick:r[9]||(r[9]=l=>_("mine"))},[t.dockData.avatars.mine?B("",!0):(i(),u("div",gt," 点击上传 "))],4)]),P(V,{visible:b.value,"onUpdate:visible":r[10]||(r[10]=l=>b.value=l),type:"basic","biz-type":p.value,onUploadComplete:I},null,8,["visible","biz-type"])]))}},bt=W(ft,[["__scopeId","data-v-0f4f42af"]]),kt=Z("diary",{state:()=>({diaries:{}}),actions:{addDiary(t,m){this.diaries[t]||(this.diaries[t]=[]),this.diaries[t].unshift({id:Date.now().toString(),content:m,timestamp:Date.now()})},getDiaries(t){return this.diaries[t]||[]},deleteDiary(t,m){if(this.diaries[t]){const s=this.diaries[t].findIndex(f=>f.id===m);s!==-1&&this.diaries[t].splice(s,1)}},clearDiaries(t){this.diaries[t]&&delete this.diaries[t]}},persist:!0}),_t={class:"c-phone-app-header"},yt={class:"title"},$t={class:"header-actions"},wt={__name:"CPhoneAppHeader",props:{title:{type:String,default:""},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["back","clear","refresh"],setup(t,{emit:m}){const s=m,f=()=>{s("back")};return(b,p)=>(i(),u("header",_t,[e("div",{class:"back-btn",onClick:f},[P(j,{name:"back-btn",class:"back-icon"})]),e("h1",yt,N(t.title),1),e("div",$t,[t.showClear?(i(),u("div",{key:0,class:"action-btn",onClick:p[0]||(p[0]=k=>s("clear"))},[P(j,{name:"trash"})])):B("",!0),t.showRefresh?(i(),u("div",{key:1,class:"action-btn",onClick:p[1]||(p[1]=k=>s("refresh"))},[P(j,{name:"refresh"})])):B("",!0),ee(b.$slots,"action",{},void 0,!0)])]))}},Ct=W(wt,[["__scopeId","data-v-05bc6111"]]),Dt={class:"app-container"},St={__name:"CPhoneAppsLayout",props:{title:{type:String,default:""},background:{type:String,default:"#ffffff"},color:{type:String,default:"#000000"},themeColor:{type:String,default:"#000000"},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["close","clear","refresh"],setup(t,{emit:m}){const s=m,f=()=>{s("close")};return(b,p)=>(i(),u("div",{class:"c-phone-app-layout",style:O({"--app-bg":t.background,"--app-text":t.color,"--app-theme":t.themeColor})},[P(Ct,{title:t.title,"show-clear":t.showClear,"show-refresh":t.showRefresh,onBack:f,onClear:p[0]||(p[0]=k=>s("clear")),onRefresh:p[1]||(p[1]=k=>s("refresh"))},{action:z(()=>[ee(b.$slots,"action",{},void 0,!0)]),_:3},8,["title","show-clear","show-refresh"]),e("div",Dt,[ee(b.$slots,"default",{},void 0,!0)])],4))}},X=W(St,[["__scopeId","data-v-9de005de"]]),Mt={key:0,class:"diary-notebook-container"},xt={class:"open-book-leather"},It={class:"paper-stack"},Tt={class:"paper-sheet"},Ut={key:0,class:"polaroid"},At={class:"photo-frame"},Nt=["src"],Pt={class:"photo-name"},Bt={class:"paper-content"},Ot={class:"diary-header"},Wt={class:"date-group"},Ft={class:"day"},Rt={class:"month-year-group"},zt={class:"month"},Jt={class:"year"},Ht={class:"weekday-badge"},jt={class:"diary-body"},Et={key:0,class:"generating-container"},Gt={class:"fountain-pen-loading"},Lt={key:1,class:"handwritten-text"},Vt={class:"page-number"},Yt={class:"cover-texture"},qt={class:"cover-label"},Kt={class:"label-border"},Zt={class:"book-subtitle"},Qt={class:"owner-name"},Xt={__name:"CharDiary",emits:["close"],setup(t,{emit:m}){const s=m,f=J(),b=Y(),p=kt(),k=ae(),n=f.params.charId,g=T(!1),o=U(()=>b.getCharacter(n)),y=U(()=>o.value?`${o.value.name}的日记`:"日记"),h=U(()=>p.getDiaries(n)),D=U(()=>h.value.length>0?h.value[0]:null),C=U(()=>{var a;return g.value?Date.now():((a=D.value)==null?void 0:a.timestamp)||Date.now()}),S=U(()=>{var a;return(a=D.value)!=null&&a.content?D.value.content.split(`
`).filter(c=>c.trim()):[]}),_=a=>new Date(Number(a)).getDate().toString().padStart(2,"0"),I=a=>["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][new Date(Number(a)).getMonth()],A=a=>new Date(Number(a)).getFullYear(),M=a=>["Sun.","Mon.","Tue.","Wed.","Thu.","Fri.","Sat."][new Date(Number(a)).getDay()],$=a=>{a.target.style.display="none",a.target.parentElement.style.backgroundColor="#eee"},v=()=>{s("close")},r=()=>{D.value&&confirm("确定要撕掉这页日记吗？")&&p.deleteDiary(n,D.value.id)},l=async()=>{if(!g.value){g.value=!0;try{const a=b.getCharacter(n);if(!a)return;const d=b.getFormattedRecentMessages(n,20).map(R=>`${R.role==="user"?"用户":"我"}: ${R.content}`).join(`
`),w=`你现在是${a.name}。请根据以下最近的聊天记录，写一篇简短的日记（100-200字）。
日记应该以第一人称“我”的视角，记录最近发生的事情、你的心情和对用户的想法。
请直接输出日记内容，不要包含任何其他解释或格式。

聊天记录：
${d}

日记内容：`;let x=null;a.api&&a.api!=="default"&&(x=k.presets.find(R=>R.name===a.api));const F=await k.getGenericCompletion([{role:"user",content:w}],{preset:x});F&&F.content&&p.addDiary(n,F.content.trim())}catch(a){console.error("Failed to generate diary:",a)}finally{g.value=!1}}};return(a,c)=>(i(),E(X,{title:y.value,"show-clear":!0,"show-refresh":!0,onClose:v,onClear:r,onRefresh:l,background:"#f8f6f3",color:"#37474f",themeColor:"#555"},{default:z(()=>{var d,w;return[e("div",{class:re(["diary-container",{"is-open":D.value||g.value}])},[c[10]||(c[10]=e("div",{class:"desktop-texture"},null,-1)),D.value||g.value?(i(),u("div",Mt,[e("div",xt,[c[2]||(c[2]=e("div",{class:"bookmark-ribbon"},null,-1)),e("div",It,[e("div",Tt,[o.value?(i(),u("div",Ut,[e("div",At,[e("img",{src:o.value.avatar,alt:"char",onError:$},null,40,Nt)]),e("div",Pt,N(o.value.name),1)])):B("",!0),e("div",Bt,[e("div",Ot,[e("div",Wt,[e("span",Ft,N(_(C.value)),1),e("div",Rt,[e("span",zt,N(I(C.value)),1),e("span",Jt,N(A(C.value)),1)]),e("div",Ht,N(M(C.value)),1)]),c[0]||(c[0]=e("div",{class:"stamp-mark"},[e("div",{class:"stamp-inner"},"CONFIDENTIAL")],-1))]),c[1]||(c[1]=e("div",{class:"diary-divider"},null,-1)),e("div",jt,[g.value?(i(),u("div",Et,[e("div",Gt,[P(j,{name:"pencil",class:"pen-icon"}),e("span",null,N(((d=o.value)==null?void 0:d.name)||"Ta")+" 正在提笔...",1)])])):(i(),u("div",Lt,[(i(!0),u(G,null,L(S.value,(x,F)=>(i(),u("p",{key:F},N(x),1))),128))]))]),e("div",Vt,"- "+N(new Date(Number(C.value)).getDate())+" -",1)])])])])])):(i(),u("div",{key:1,class:"diary-book-cover",onClick:l},[c[9]||(c[9]=e("div",{class:"book-spine"},null,-1)),e("div",Yt,[c[7]||(c[7]=e("div",{class:"stitching-border"},null,-1)),e("div",qt,[e("div",Kt,[c[4]||(c[4]=e("h2",{class:"book-title"},"DIARY",-1)),e("div",Zt,[e("span",Qt,N(((w=o.value)==null?void 0:w.name)||"Character"),1),c[3]||(c[3]=e("span",{class:"of-word"},"'s",-1))]),c[5]||(c[5]=e("div",{class:"label-line"},null,-1)),c[6]||(c[6]=e("div",{class:"book-hint"},"打开日记本",-1))])]),c[8]||(c[8]=e("div",{class:"elastic-band"},null,-1))])]))],2)]}),_:1},8,["title"]))}},ea=W(Xt,[["__scopeId","data-v-f3c18cd0"]]),ta=Z("memo",{state:()=>({memos:{}}),actions:{addMemo(t,m){this.memos[t]||(this.memos[t]=[]);const s=m.map(f=>({id:Date.now().toString()+Math.random(),content:f,timestamp:Date.now()}));this.memos[t].unshift(...s)},updateMemo(t,m,s){if(!this.memos[t])return;const f=this.memos[t].find(b=>b.id===m);f&&(f.content=s)},getMemos(t){return this.memos[t]||[]},deleteMemo(t,m){if(this.memos[t]){const s=this.memos[t].findIndex(f=>f.id===m);s!==-1&&this.memos[t].splice(s,1)}},clearMemos(t){this.memos[t]&&(this.memos[t]=[])}},persist:!0}),aa={key:0,class:"memo-list cork-board"},oa={key:0,class:"generating-overlay"},sa={class:"memo-item"},na={class:"memo-content"},la={class:"memo-footer"},ra={class:"memo-date"},ia=["onClick"],ca={key:1,class:"empty-state cork-board"},da={__name:"CharMemo",emits:["close"],setup(t,{emit:m}){const s=m,f=J(),b=Y(),p=ta(),k=ae(),n=f.params.charId,g=T(!1),o=U(()=>b.getCharacter(n)),y=U(()=>p.getMemos(n)),h=U(()=>o.value?`${o.value.name}的备忘录`:"备忘录"),D=()=>{s("close")},C=A=>A?new Date(A).toLocaleDateString("en-CA"):"",S=A=>{p.deleteMemo(n,A)},_=()=>{y.value.length>0&&confirm("确定要清空所有备忘录吗？")&&p.clearMemos(n)},I=async()=>{if(!g.value){g.value=!0;try{if(!o.value)return;const M=b.getFormattedRecentMessages(n,15).map(l=>`${l.role==="user"?"用户":"我"}: ${l.content}`).join(`
`),$=`角色: ${o.value.name}
任务: 你正在写一些私密的备忘录便利贴。请基于你的人设的日常琐事（如工作、爱好、生活习惯）以及最近和用户的聊天内容，写5-10条简短的备忘录。

规则:
1.  输出5-10条备忘录，每条字数控制在15-20字。
2.  每条备忘录都是独立的、零散的想法。
3.  内容可以关于你的日常生活、不为人知的小秘密、对用户的真实想法、或和用户聊天中产生的想法。
4.  风格要口语化、生活化，就像随手写下的笔记，体现角色性格和生活气息。
5.  每条内容占一行，不要带序号或任何标记。

参考聊天记录:
${M}

备忘录内容:`;let v=null;o.value.api&&o.value.api!=="default"&&(v=k.presets.find(l=>l.name===o.value.api));const r=await k.getGenericCompletion([{role:"user",content:$}],{preset:v});if(r&&r.content){const l=r.content.split(`
`).map(a=>a.trim()).filter(a=>a.length>0);l.length>0&&p.addMemo(n,l)}}catch(A){console.error("Failed to generate memos:",A)}finally{g.value=!1}}};return(A,M)=>(i(),E(X,{title:h.value,"show-clear":!0,"show-refresh":!0,onClose:D,onClear:_,onRefresh:I,background:"#ba9e76",color:"#3e2723",themeColor:"#795548"},{default:z(()=>[y.value.length>0||g.value?(i(),u("div",aa,[g.value?(i(),u("div",oa,[...M[0]||(M[0]=[e("div",{class:"generating-text"},"正在写备忘录...",-1)])])):B("",!0),(i(!0),u(G,null,L(y.value,$=>(i(),u("div",{key:$.id,class:"memo-item-wrapper"},[e("div",sa,[M[1]||(M[1]=e("div",{class:"pin"},null,-1)),e("p",na,N($.content),1),e("div",la,[e("span",ra,N(C($.timestamp)),1),e("div",{class:"delete-btn",onClick:v=>S($.id)},[P(j,{name:"delete",class:"delete-icon"})],8,ia)])])]))),128))])):(i(),u("div",ca,[...M[2]||(M[2]=[e("div",{class:"empty-hint"},[te(" 备忘录是空的... "),e("br"),e("small",null,"点击右上角，让我写点东西吧")],-1)])]))]),_:1},8,["title"]))}},ua=W(da,[["__scopeId","data-v-43a82927"]]),pa=Z("schedule",{state:()=>({schedules:{}}),actions:{addSchedule(t,m){this.schedules[t]||(this.schedules[t]=[]),this.schedules[t].unshift({id:Date.now().toString(),content:m,timestamp:Date.now()})},updateSchedule(t,m,s){if(!this.schedules[t])return;const f=this.schedules[t].find(b=>b.id===m);f&&(f.content=s)},getSchedules(t){return this.schedules[t]||[]},deleteSchedule(t,m){if(this.schedules[t]){const s=this.schedules[t].findIndex(f=>f.id===m);s!==-1&&this.schedules[t].splice(s,1)}},clearSchedules(t){this.schedules[t]&&delete this.schedules[t]}},persist:!0}),ha={key:0,class:"schedule-paper"},va={class:"paper-content"},ma={class:"schedule-header"},ga={class:"date-stamp"},fa={class:"schedule-body"},ba={key:0,class:"generating-text"},ka={key:1,class:"handwritten-text"},_a={class:"time-col"},ya={class:"event-col"},$a={key:1,class:"empty-state"},wa={__name:"CharSchedule",emits:["close"],setup(t,{emit:m}){const s=m,f=J(),b=Y(),p=pa(),k=ae(),n=f.params.charId,g=T(!1),o=U(()=>b.getCharacter(n)),y=U(()=>p.getSchedules(n)),h=U(()=>y.value.length>0?y.value[0]:null),D=U(()=>o.value?`${o.value.name}的行程`:"行程表"),C=()=>{s("close")},S=M=>{const $=new Date(Number(M)),v=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return`${$.getFullYear()}.${($.getMonth()+1).toString().padStart(2,"0")}.${$.getDate().toString().padStart(2,"0")} ${v[$.getDay()]}`},_=()=>{h.value&&confirm("确定要撕掉这张行程表吗？")&&p.deleteSchedule(n,h.value.id)},I=M=>M?M.split(`
`).map($=>{if($=$.trim(),!$)return null;const v=$.match(/^(\d{1,2}:\d{2})/);if(v){const r=v[1];let l=$.substring(r.length).trim();return(l.startsWith(":")||l.startsWith("：")||l.startsWith("-"))&&(l=l.substring(1).trim()),{time:r,event:l}}else return{time:"",event:$}}).filter($=>$!==null):[],A=async()=>{if(!g.value){g.value=!0;try{if(!o.value)return;const $=b.getFormattedRecentMessages(n,10).map(x=>`${x.role==="user"?"用户":"我"}: ${x.content}`).join(`
`),v=new Date,r=`${v.getFullYear()}.${(v.getMonth()+1).toString().padStart(2,"0")}.${v.getDate().toString().padStart(2,"0")}`;let l=null;if(h.value){const x=new Date(Number(h.value.timestamp));`${x.getFullYear()}.${(x.getMonth()+1).toString().padStart(2,"0")}.${x.getDate().toString().padStart(2,"0")}`===r&&(l=h.value)}const a=`${v.getHours().toString().padStart(2,"0")}:${v.getMinutes().toString().padStart(2,"0")}`;let c="";l?c=`角色:${o.value.name}
当前时间:${r} ${a}
任务:根据参考聊天和角色设定，补充现有行程表(仅补充${a}之前未记录的)。

规则:
1.严禁包含晚于${a}的时间点。
2.格式:HH:MM 事件内容
3.输出完整列表(含旧数据)，按时间排序。
4.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
5.每条字数控制在15-30字。
6.【重要】直接输出行程列表，不要包含任何解释、标题或总结性文字。

现有行程:
${l.content}

完整行程:`:c=`角色:${o.value.name}
当前时间:${r} ${a}
任务:根据参考聊天和角色设定，生成截止到目前为止角色的今日行程(已发生的事)。

规则:
1.严禁包含晚于${a}的时间点。
2.格式:HH:MM 事件内容
3.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
4.每条字数控制在15-30字。
5.【重要】直接输出行程列表，不要包含任何解释、标题或总结性文字。

参考聊天:
${$}

行程:`;let d=null;o.value.api&&o.value.api!=="default"&&(d=k.presets.find(x=>x.name===o.value.api));const w=await k.getGenericCompletion([{role:"user",content:c}],{preset:d});if(w&&w.content){const x=w.content.split(`
`).filter(F=>{const R=F.trim().match(/^(\d{1,2}:\d{2})/);if(R){const[oe,ce]=R[1].split(":").map(Number),de=oe*60+ce,[ue,pe]=a.split(":").map(Number),he=ue*60+pe;return de<=he}return!0}).join(`
`);l?p.updateSchedule(n,l.id,x.trim()):p.addSchedule(n,x.trim())}}catch(M){console.error("Failed to generate schedule:",M)}finally{g.value=!1}}};return(M,$)=>(i(),E(X,{title:D.value,"show-clear":!0,"show-refresh":!0,onClose:C,onClear:_,onRefresh:A,background:"#f0f4f8",color:"#37474f",themeColor:"#546e7a"},{default:z(()=>[h.value||g.value?(i(),u("div",ha,[e("div",va,[e("div",ma,[$[0]||($[0]=e("div",{class:"clip"},null,-1)),e("div",ga,N(g.value?S(Date.now()):S(h.value.timestamp)),1)]),e("div",fa,[g.value?(i(),u("div",ba,"正在确认行程...")):(i(),u("div",ka,[(i(!0),u(G,null,L(I(h.value.content),(v,r)=>(i(),u("div",{key:r,class:"schedule-item"},[e("div",_a,N(v.time),1),e("div",ya,N(v.event),1)]))),128))]))])])])):(i(),u("div",$a,[...$[1]||($[1]=[e("div",{class:"empty-hint"},[te("行程表是空的..."),e("br"),te("点击右上角，看看我今天做了什么吧")],-1)])]))]),_:1},8,["title"]))}},Ca=W(wa,[["__scopeId","data-v-96328039"]]),Da={class:"theme-container"},Sa={class:"theme-section"},Ma={class:"wallpaper-preview-container"},xa={key:0,class:"upload-hint"},Ia={class:"theme-section"},Ta={class:"app-icons-grid-new"},Ua=["onClick"],Aa={class:"app-icon-box"},Na=["src"],Pa={key:1,class:"app-icon-placeholder"},Ba={class:"app-name"},Oa={__name:"CharTheme",emits:["close"],setup(t,{emit:m}){const s=m,{t:f}=ie(),b=J(),p=Y(),k=Q(),n=b.params.charId,g=T(!1),o=T(""),y=T("theme"),h=T(null),D=U(()=>p.getCharacter(n)),C=U(()=>D.value?`${D.value.name}的主题`:"主题"),S=U(()=>k.getCharTheme(n)),_=U(()=>S.value.wallpaper),I=U(()=>_.value?{backgroundImage:`url(${_.value})`,backgroundSize:"cover",backgroundPosition:"center"}:{background:"#e0e0e0"}),A=U(()=>[{label:"微信",key:"char_chat"},{label:"行程表",key:"char_schedule"},{label:"日记",key:"char_diary"},{label:"备忘录",key:"char_memo"},{label:"购买记录",key:"char_purchase"},{label:"搜索记录",key:"char_search"},{label:"主题",key:"char_theme"},{label:"app1",key:"char_app1"}]),M=()=>{s("close")},$=()=>{o.value="设置壁纸",y.value="theme",h.value={type:"wallpaper"},g.value=!0},v=c=>{o.value=`设置 ${c.label} 图标`,y.value="avatar",h.value={type:"appIcon",appKey:c.key},g.value=!0},r=c=>{if(!h.value){console.error("currentUploadTarget is null. Aborting image upload handling.");return}const d=c.content;h.value.type==="wallpaper"?k.setWallpaper(n,d):h.value.type==="appIcon"&&k.setAppIcon(n,h.value.appKey,d),g.value=!1,h.value=null},l=()=>{confirm("确定要清除壁纸吗？")&&k.setWallpaper(n,"")},a=c=>k.getAppIcon(n,c);return(c,d)=>(i(),E(X,{title:C.value,onClose:M,background:"#f8f6f3",color:"#37474f",themeColor:"#555"},{default:z(()=>[e("div",Da,[e("div",Sa,[d[2]||(d[2]=e("div",{class:"section-title"},"壁纸设置",-1)),e("div",Ma,[e("div",{class:"wallpaper-preview",style:O(I.value),onClick:$},[_.value?B("",!0):(i(),u("div",xa,[P(j,{name:"image",class:"hint-icon"}),d[1]||(d[1]=e("span",null,"点击上传",-1))]))],4),_.value?(i(),u("button",{key:0,class:"btn-clear",onClick:l}," 清除壁纸 ")):B("",!0)])]),e("div",Ia,[d[4]||(d[4]=e("div",{class:"section-title"},"App图标自定义",-1)),e("div",Ta,[(i(!0),u(G,null,L(A.value,w=>(i(),u("div",{key:w.key,class:"app-icon-item",onClick:x=>v(w)},[e("div",Aa,[a(w.key)?(i(),u("img",{key:0,src:a(w.key),alt:"app icon"},null,8,Na)):(i(),u("div",Pa,[...d[3]||(d[3]=[e("span",null,"点击上传",-1)])]))]),e("span",Ba,N(w.label),1)],8,Ua))),128))])])]),P(V,{visible:g.value,"onUpdate:visible":d[0]||(d[0]=w=>g.value=w),title:o.value,bizType:y.value,type:"basic",onUploadComplete:r,onSendImage:r},null,8,["visible","title","bizType"])]),_:1},8,["title"]))}},Wa=W(Oa,[["__scopeId","data-v-ca191fd8"]]),Fa={class:"char-phone-container"},Ra={class:"char-phone-frame"},za={class:"char-status-bar"},Ja={class:"time"},Ha={class:"char-content"},ja={__name:"CharPhone",setup(t){const{t:m}=ie(),s=J();Y();const f=Q(),b=s.params.charId,p=U(()=>f.getWallpaperStyle(b)),k=T("");let n=null;const g=()=>{const d=new Date,w=d.getHours().toString().padStart(2,"0"),x=d.getMinutes().toString().padStart(2,"0");k.value=`${w}:${x}`};ne(()=>{g(),n=setInterval(g,1e3),A()}),le(()=>{n&&clearInterval(n)});const o=T({background:"",avatar:"",photos:["",""],photoTexts:["",""]}),y=[{label:"微信",color:"rgba(255, 255, 255, 0.9)",route:"/char_chat"},{label:"行程表",color:"rgba(255, 255, 255, 0.9)",route:"/char_schedule"},{label:"日记",color:"rgba(255, 255, 255, 0.9)",route:"/char_diary"},{label:"备忘录",color:"rgba(255, 255, 255, 0.9)",route:"/char_memo"}],h=T({photo:"",apps:JSON.parse(JSON.stringify(y))}),D=[{label:"购买记录",color:"rgba(255, 255, 255, 0.9)",route:"/char_purchase"},{label:"搜索记录",color:"rgba(255, 255, 255, 0.9)",route:"/char_search"},{label:"主题",color:"rgba(255, 255, 255, 0.9)",route:"/char_theme"},{label:"app1",color:"rgba(255, 255, 255, 0.9)",route:"/char_app1"}],C=T({photo:"",text1:"",text2:"",apps:JSON.parse(JSON.stringify(D))}),S=T({avatars:{other:"",mine:""},messages:{other:"",mine:""}}),_=T(null),I=U(()=>{switch(_.value){case"diary":return ea;case"memo":return ua;case"schedule":return Ca;case"theme":return Wa;default:return null}}),A=()=>{const d=`charphone_${b}`,w=localStorage.getItem(d);if(w)try{const x=JSON.parse(w);x.header&&(o.value={...o.value,...x.header}),x.middle&&(h.value={...h.value,...x.middle},(!h.value.apps||h.value.apps.length===0||!h.value.apps[0].label)&&(h.value.apps=JSON.parse(JSON.stringify(y)))),x.bottom&&(C.value={...C.value,...x.bottom},(!C.value.apps||C.value.apps.length===0||!C.value.apps[0].label)&&(C.value.apps=JSON.parse(JSON.stringify(D)))),x.dock&&(S.value={...S.value,...x.dock})}catch(x){console.error("Failed to load char phone data:",x)}},M=()=>{const d=`charphone_${b}`,w={header:o.value,middle:h.value,bottom:C.value,dock:S.value};localStorage.setItem(d,JSON.stringify(w))},$=d=>{o.value=d,M()},v=d=>{h.value=d,M()},r=d=>{C.value=d,M()},l=d=>{S.value=d,M()},a=d=>{console.log("App clicked:",d);try{d.label==="日记"||d.route==="/char_diary"?_.value="diary":d.label==="备忘录"||d.route==="/char_memo"?_.value="memo":d.label==="行程"||d.label==="行程表"||d.route==="/char_schedule"?_.value="schedule":d.label==="主题"||d.route==="/char_theme"?_.value="theme":console.warn("未识别的应用:",d)}catch(w){console.error("打开应用时出错:",w)}},c=()=>{_.value=null};return(d,w)=>(i(),E(me,{title:ve(m)("charPhone.title","查看手机"),"no-padding":"",class:re({"hide-back-btn":_.value})},{default:z(()=>[e("div",Fa,[e("div",Ra,[w[2]||(w[2]=e("div",{class:"char-notch"},null,-1)),e("div",{class:"char-phone-screen",style:O(p.value)},[e("div",za,[e("span",Ja,N(k.value),1),w[0]||(w[0]=e("div",{class:"icons"},[e("span",null,"5G"),e("div",{class:"battery-icon"})],-1))]),e("div",Ha,[P(ct,{"header-data":o.value,"middle-data":h.value,"bottom-data":C.value,"onUpdate:headerData":$,"onUpdate:middleData":v,"onUpdate:bottomData":r,onAppClick:a},null,8,["header-data","middle-data","bottom-data"])]),P(bt,{"dock-data":S.value,"onUpdate:dockData":l},null,8,["dock-data"]),P(ge,{name:"app-fade"},{default:z(()=>[I.value?(i(),E(fe(I.value),{key:0,onClose:c},null,32)):B("",!0)]),_:1}),w[1]||(w[1]=e("div",{class:"char-home-indicator"},null,-1))],4),w[3]||(w[3]=e("div",{class:"char-btn-power"},null,-1)),w[4]||(w[4]=e("div",{class:"char-btn-volume-up"},null,-1)),w[5]||(w[5]=e("div",{class:"char-btn-volume-down"},null,-1))])])]),_:1},8,["title","class"]))}},Ga=W(ja,[["__scopeId","data-v-75819887"]]);export{Ga as default};
