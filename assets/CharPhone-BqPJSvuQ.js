import{ch as Z,r as M,_ as R,x as ne,a6 as le,c as x,d as f,o as p,e,g as N,f as P,E as W,t as T,w as Q,A as X,D as z,O as Y,F as V,C as G,y as se,S as E,by as te,i as H,u as q,W as oe,b as K,k as j,n as re,V as ae,m as he,B as ve,a9 as me,a4 as ge,l as fe}from"./index-Zjw9oCgj.js";const ie=Z("charTheme",()=>{const t=M({}),b=a=>(t.value[a]||(t.value[a]={wallpaper:"",appIcons:{}}),t.value[a]),s=(a,h)=>{t.value[a]||b(a),t.value[a].wallpaper=h,l()},y=(a,h,d)=>{t.value[a]||b(a),t.value[a].appIcons||(t.value[a].appIcons={}),t.value[a].appIcons[h]=d,l()},m=(a,h)=>{var d,$;($=(d=t.value[a])==null?void 0:d.appIcons)!=null&&$[h]&&(delete t.value[a].appIcons[h],l())},c=a=>{const h=b(a);return h.wallpaper?{backgroundImage:`url(${h.wallpaper})`,backgroundSize:"cover",backgroundPosition:"center"}:{}},k=(a,h)=>{var $;return(($=b(a).appIcons)==null?void 0:$[h])||null},l=()=>{localStorage.setItem("charphone_themes",JSON.stringify(t.value))},_=()=>{const a=localStorage.getItem("charphone_themes");if(a)try{t.value=JSON.parse(a)}catch(h){console.error("Failed to load charphone themes:",h)}};return _(),{charThemes:t,getCharTheme:b,setWallpaper:s,setAppIcon:y,deleteAppIcon:m,getWallpaperStyle:c,getAppIcon:k,saveThemes:l,loadThemes:_}}),be={key:0,class:"upload-hint"},ke={class:"left-section"},ye={key:0,class:"upload-hint"},_e={class:"date-info"},$e={class:"weekday"},Ce={class:"date"},De={class:"right-section"},we={class:"text-inputs-row"},Se={class:"photos-row"},Me={key:0,class:"upload-hint"},xe={key:0,class:"upload-hint"},Ie={__name:"CharPhoneHeader",props:{widgetData:{type:Object,default:()=>({background:"",avatar:"",photos:["",""],photoTexts:["",""]})}},emits:["update:widgetData"],setup(t,{emit:b}){var v,r;const s=t,y=b,m=M(!1),c=M("background"),k=M(0),l=M([((v=s.widgetData.photoTexts)==null?void 0:v[0])||"",((r=s.widgetData.photoTexts)==null?void 0:r[1])||""]),_=M(""),a=M("");let h=null;const d=()=>{const n=new Date,o=(n.getMonth()+1).toString().padStart(2,"0"),i=n.getDate().toString().padStart(2,"0");_.value=`${o}.${i}`;const u=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];a.value=u[n.getDay()]};ne(()=>{d(),h=setInterval(d,6e4)}),le(()=>{h&&clearInterval(h)});const $=x(()=>s.widgetData.background?{backgroundImage:`url('${s.widgetData.background}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),S=x(()=>s.widgetData.avatar?{backgroundImage:`url('${s.widgetData.avatar}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"}),I=n=>s.widgetData.photos[n]?{backgroundImage:`url('${s.widgetData.photos[n]}')`,backgroundColor:"transparent"}:{backgroundColor:"#e0e0e0"},A=()=>{c.value="background",m.value=!0},B=()=>{c.value="avatar",m.value=!0},U=n=>{k.value=n,c.value=`photo${n}`,m.value=!0},w=n=>{const o={...s.widgetData};c.value==="background"?o.background=n.content:c.value==="avatar"?o.avatar=n.content:c.value.startsWith("photo")&&(o.photos=[...s.widgetData.photos],o.photos[k.value]=n.content),y("update:widgetData",o)},C=n=>{const o={...s.widgetData,photoTexts:[...l.value]};y("update:widgetData",o)};return(n,o)=>(p(),f("div",{class:"char-phone-header",onClick:z(A,["stop"])},[e("div",{class:"widget-background",style:W($.value)},[t.widgetData.background?P("",!0):(p(),f("div",be," 点击上传 "))],4),e("div",{class:"widget-content",onClick:o[8]||(o[8]=z(()=>{},["stop"]))},[e("div",ke,[e("div",{class:"avatar-circle",style:W(S.value),onClick:B},[t.widgetData.avatar?P("",!0):(p(),f("div",ye," 点击上传 "))],4),e("div",_e,[e("div",$e,T(a.value),1),e("div",Ce,T(_.value),1)])]),e("div",De,[e("div",we,[Q(e("input",{"onUpdate:modelValue":o[0]||(o[0]=i=>l.value[0]=i),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:o[1]||(o[1]=i=>C()),onClick:o[2]||(o[2]=z(()=>{},["stop"]))},null,544),[[X,l.value[0]]]),Q(e("input",{"onUpdate:modelValue":o[3]||(o[3]=i=>l.value[1]=i),type:"text",class:"photo-text-input",placeholder:"点击输入文字",onBlur:o[4]||(o[4]=i=>C()),onClick:o[5]||(o[5]=z(()=>{},["stop"]))},null,544),[[X,l.value[1]]])]),e("div",Se,[e("div",{class:"photo-item",style:W(I(0)),onClick:o[6]||(o[6]=i=>U(0))},[t.widgetData.photos[0]?P("",!0):(p(),f("div",Me," 点击上传 "))],4),e("div",{class:"photo-item",style:W(I(1)),onClick:o[7]||(o[7]=i=>U(1))},[t.widgetData.photos[1]?P("",!0):(p(),f("div",xe," 点击上传 "))],4)])])]),N(Y,{visible:m.value,"onUpdate:visible":o[9]||(o[9]=i=>m.value=i),type:"basic","biz-type":c.value,onUploadComplete:w},null,8,["visible","biz-type"])]))}},Te=R(Ie,[["__scopeId","data-v-baafc6b9"]]),Ue={class:"char-phone-middle-widget"},Ae={class:"photo-section"},Ne={class:"photo-wrapper"},Pe={key:0,class:"upload-hint"},Be={class:"app-section"},Oe={class:"app-grid-wrapper"},We={class:"app-grid"},Fe=["onClick"],Re={class:"app-label"},Je={__name:"CharPhoneMiddleWidget",props:{widgetData:{type:Object,default:()=>({photo:"",apps:[]})}},emits:["update:widgetData","app-click"],setup(t,{emit:b}){const s=t,y=b,m=M(!1),c=x(()=>s.widgetData.photo?{backgroundImage:`url('${s.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),k=()=>{m.value=!0},l=a=>{y("app-click",a)},_=a=>{const h={...s.widgetData};h.photo=a.content,y("update:widgetData",h)};return(a,h)=>(p(),f("div",Ue,[e("div",Ae,[e("div",Ne,[e("div",{class:"photo-container",style:W(c.value),onClick:k},[t.widgetData.photo?P("",!0):(p(),f("div",Pe," 点击上传 "))],4)])]),e("div",Be,[e("div",Oe,[e("div",We,[(p(!0),f(V,null,G(t.widgetData.apps,(d,$)=>(p(),f("div",{key:$,class:"app-item",onClick:S=>l(d)},[e("div",{class:"app-icon",style:W({background:d.color})},null,4),e("div",Re,T(d.label),1)],8,Fe))),128))])])]),N(Y,{visible:m.value,"onUpdate:visible":h[0]||(h[0]=d=>m.value=d),type:"basic","biz-type":"photo",onUploadComplete:_},null,8,["visible"])]))}},ze=R(Je,[["__scopeId","data-v-1ed9bd3c"]]),He={class:"char-phone-bottom-widget"},Ee={class:"app-section"},je={class:"app-grid-wrapper"},Ve={class:"app-grid"},Ge=["onClick"],Le={class:"app-label"},Ye={class:"photo-section"},qe={class:"photo-wrapper"},Ke={key:0,class:"upload-hint"},Qe={class:"text-inputs"},Xe={__name:"CharPhoneBottomWidget",props:{widgetData:{type:Object,default:()=>({photo:"",text1:"",text2:"",apps:[]})}},emits:["update:widgetData","app-click"],setup(t,{emit:b}){const s=t,y=b,m=M(!1),c=x(()=>s.widgetData.photo?{backgroundImage:`url('${s.widgetData.photo}')`,backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.3)"}),k=()=>{m.value=!0},l=h=>{console.log("Bottom widget - 打开应用:",h.label),y("app-click",h)},_=h=>{const d={...s.widgetData};d.photo=h.content,y("update:widgetData",d)},a=()=>{y("update:widgetData",{...s.widgetData})};return(h,d)=>(p(),f("div",He,[e("div",Ee,[e("div",je,[e("div",Ve,[(p(!0),f(V,null,G(t.widgetData.apps,($,S)=>(p(),f("div",{key:S,class:"app-item",onClick:I=>l($)},[e("div",{class:"app-icon",style:W({background:$.color})},null,4),e("div",Le,T($.label),1)],8,Ge))),128))])])]),e("div",Ye,[e("div",qe,[e("div",{class:"photo-container",style:W(c.value),onClick:k},[t.widgetData.photo?P("",!0):(p(),f("div",Ke," 点击上传 "))],4),e("div",Qe,[Q(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":d[0]||(d[0]=$=>t.widgetData.text1=$),placeholder:"输入文本1",onInput:a},null,544),[[X,t.widgetData.text1]]),Q(e("input",{type:"text",class:"custom-input","onUpdate:modelValue":d[1]||(d[1]=$=>t.widgetData.text2=$),placeholder:"输入文本2",onInput:a},null,544),[[X,t.widgetData.text2]])])])]),N(Y,{visible:m.value,"onUpdate:visible":d[2]||(d[2]=$=>m.value=$),type:"basic","biz-type":"photo",onUploadComplete:_},null,8,["visible"])]))}},Ze=R(Xe,[["__scopeId","data-v-b1cc1a4e"]]),et={class:"char-phone-widget-container"},tt={class:"widget-item top-widget"},at={class:"widget-item middle-widget"},ot={class:"widget-item bottom-widget"},st={__name:"CharPhoneWidgetContainer",props:{headerData:{type:Object,required:!0},middleData:{type:Object,required:!0},bottomData:{type:Object,required:!0}},emits:["update:headerData","update:middleData","update:bottomData","app-click"],setup(t,{emit:b}){const s=b,y=l=>{s("update:headerData",l)},m=l=>{s("update:middleData",l)},c=l=>{s("update:bottomData",l)},k=l=>{s("app-click",l)};return(l,_)=>(p(),f("div",et,[e("div",tt,[N(Te,{"widget-data":t.headerData,"onUpdate:widgetData":y},null,8,["widget-data"])]),e("div",at,[N(ze,{"widget-data":t.middleData,"onUpdate:widgetData":m,onAppClick:k},null,8,["widget-data"])]),e("div",ot,[N(Ze,{"widget-data":t.bottomData,"onUpdate:widgetData":c,onAppClick:k},null,8,["widget-data"])])]))}},nt=R(st,[["__scopeId","data-v-7ce323fa"]]),lt={class:"char-phone-dock"},rt={class:"message-row other-message"},it={key:0,class:"upload-hint"},dt=["data-placeholder"],ct={class:"message-row my-message"},ut=["data-placeholder"],pt={key:0,class:"upload-hint"},ht={__name:"CharPhoneDock",props:{dockData:{type:Object,default:()=>({avatars:{other:"",mine:""},messages:{other:"",mine:""}})}},emits:["update:dockData"],setup(t,{emit:b}){var w,C;const s=t,y=b,m=M(!1),c=M("avatar-other"),k=M({other:((w=s.dockData.messages)==null?void 0:w.other)||"",mine:((C=s.dockData.messages)==null?void 0:C.mine)||""}),l=M(!1),_=M(null),a=M(null);se(()=>k.value.other,v=>{_.value&&_.value.textContent!==v&&(_.value.textContent=v)},{immediate:!0}),se(()=>k.value.mine,v=>{a.value&&a.value.textContent!==v&&(a.value.textContent=v)},{immediate:!0});const h=()=>{l.value=!0},d=(v,r)=>{l.value=!1,k.value[r]=v.target.textContent},$=(v,r)=>{l.value||(k.value[r]=v.target.textContent)},S=(v,r)=>{k.value[r]=v.target.textContent,U()},I=v=>{var n;const r=(n=s.dockData.avatars)==null?void 0:n[v];return r?{backgroundImage:`url('${r}')`,backgroundSize:"cover",backgroundPosition:"center",backgroundColor:"transparent"}:{backgroundColor:"rgba(255, 255, 255, 0.9)"}},A=v=>{c.value=`avatar-${v}`,m.value=!0},B=v=>{const r={...s.dockData,avatars:{...s.dockData.avatars}};c.value==="avatar-other"?r.avatars.other=v.content:c.value==="avatar-mine"&&(r.avatars.mine=v.content),y("update:dockData",r)},U=v=>{const r={...s.dockData,messages:{...k.value}};y("update:dockData",r)};return(v,r)=>(p(),f("div",lt,[e("div",rt,[e("div",{class:"avatar",style:W(I("other")),onClick:r[0]||(r[0]=n=>A("other"))},[t.dockData.avatars.other?P("",!0):(p(),f("div",it," 点击上传 "))],4),e("div",{ref_key:"bubbleOtherRef",ref:_,class:"bubble bubble-other",onClick:r[1]||(r[1]=z(()=>{},["stop"])),contenteditable:"true",onCompositionstart:h,onCompositionend:r[2]||(r[2]=n=>d(n,"other")),onInput:r[3]||(r[3]=n=>$(n,"other")),onBlur:r[4]||(r[4]=n=>S(n,"other")),"data-placeholder":k.value.other?"":"点击输入文字"},null,40,dt)]),e("div",ct,[e("div",{ref_key:"bubbleMineRef",ref:a,class:"bubble bubble-mine",onClick:r[5]||(r[5]=z(()=>{},["stop"])),contenteditable:"true",onCompositionstart:h,onCompositionend:r[6]||(r[6]=n=>d(n,"mine")),onInput:r[7]||(r[7]=n=>$(n,"mine")),onBlur:r[8]||(r[8]=n=>S(n,"mine")),"data-placeholder":k.value.mine?"":"点击输入文字"},null,40,ut),e("div",{class:"avatar",style:W(I("mine")),onClick:r[9]||(r[9]=n=>A("mine"))},[t.dockData.avatars.mine?P("",!0):(p(),f("div",pt," 点击上传 "))],4)]),N(Y,{visible:m.value,"onUpdate:visible":r[10]||(r[10]=n=>m.value=n),type:"basic","biz-type":c.value,onUploadComplete:B},null,8,["visible","biz-type"])]))}},vt=R(ht,[["__scopeId","data-v-0f4f42af"]]),mt=Z("diary",{state:()=>({diaries:{}}),actions:{addDiary(t,b){this.diaries[t]||(this.diaries[t]=[]),this.diaries[t].unshift({id:Date.now().toString(),content:b,timestamp:Date.now()})},getDiaries(t){return this.diaries[t]||[]},deleteDiary(t,b){if(this.diaries[t]){const s=this.diaries[t].findIndex(y=>y.id===b);s!==-1&&this.diaries[t].splice(s,1)}},clearDiaries(t){this.diaries[t]&&delete this.diaries[t]}},persist:!0}),gt={class:"c-phone-app-header"},ft={class:"title"},bt={class:"header-actions"},kt={__name:"CPhoneAppHeader",props:{title:{type:String,default:""},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["back","clear","refresh"],setup(t,{emit:b}){const s=b,y=()=>{s("back")};return(m,c)=>(p(),f("header",gt,[e("div",{class:"back-btn",onClick:y},[N(E,{name:"back-btn",class:"back-icon"})]),e("h1",ft,T(t.title),1),e("div",bt,[t.showClear?(p(),f("div",{key:0,class:"action-btn",onClick:c[0]||(c[0]=k=>s("clear"))},[N(E,{name:"trash"})])):P("",!0),t.showRefresh?(p(),f("div",{key:1,class:"action-btn",onClick:c[1]||(c[1]=k=>s("refresh"))},[N(E,{name:"refresh"})])):P("",!0),te(m.$slots,"action",{},void 0,!0)])]))}},yt=R(kt,[["__scopeId","data-v-05bc6111"]]),_t={class:"app-container"},$t={__name:"CPhoneAppsLayout",props:{title:{type:String,default:""},background:{type:String,default:"#ffffff"},color:{type:String,default:"#000000"},themeColor:{type:String,default:"#000000"},showClear:{type:Boolean,default:!1},showRefresh:{type:Boolean,default:!1}},emits:["close","clear","refresh"],setup(t,{emit:b}){const s=b,y=()=>{s("close")};return(m,c)=>(p(),f("div",{class:"c-phone-app-layout",style:W({"--app-bg":t.background,"--app-text":t.color,"--app-theme":t.themeColor})},[N(yt,{title:t.title,"show-clear":t.showClear,"show-refresh":t.showRefresh,onBack:y,onClear:c[0]||(c[0]=k=>s("clear")),onRefresh:c[1]||(c[1]=k=>s("refresh"))},{action:H(()=>[te(m.$slots,"action",{},void 0,!0)]),_:3},8,["title","show-clear","show-refresh"]),e("div",_t,[te(m.$slots,"default",{},void 0,!0)])],4))}},ee=R($t,[["__scopeId","data-v-9de005de"]]),Ct={key:0,class:"diary-notebook-container"},Dt={class:"open-book-leather"},wt={class:"paper-stack"},St={class:"paper-sheet"},Mt={key:0,class:"polaroid"},xt={class:"photo-frame"},It=["src"],Tt={class:"photo-name"},Ut={class:"paper-content"},At={class:"diary-header"},Nt={class:"date-group"},Pt={class:"day"},Bt={class:"month-year-group"},Ot={class:"month"},Wt={class:"year"},Ft={class:"weekday-badge"},Rt={class:"diary-body"},Jt={key:0,class:"generating-container"},zt={class:"fountain-pen-loading"},Ht={key:1,class:"handwritten-text"},Et={class:"page-number"},jt={class:"cover-texture"},Vt={class:"cover-label"},Gt={class:"label-border"},Lt={class:"book-subtitle"},Yt={class:"owner-name"},qt={__name:"CharDiary",emits:["close"],setup(t,{emit:b}){const s=b,y=K(),m=q(),c=mt(),k=oe(),l=y.params.charId,_=M(!1),a=x(()=>m.getCharacter(l)),h=x(()=>a.value?`${a.value.name}的日记`:"日记"),d=x(()=>c.getDiaries(l)),$=x(()=>d.value.length>0?d.value[0]:null),S=x(()=>{var o;return _.value?Date.now():((o=$.value)==null?void 0:o.timestamp)||Date.now()}),I=x(()=>{var o;return(o=$.value)!=null&&o.content?$.value.content.split(`
`).filter(i=>i.trim()):[]}),A=o=>new Date(Number(o)).getDate().toString().padStart(2,"0"),B=o=>["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][new Date(Number(o)).getMonth()],U=o=>new Date(Number(o)).getFullYear(),w=o=>["Sun.","Mon.","Tue.","Wed.","Thu.","Fri.","Sat."][new Date(Number(o)).getDay()],C=o=>{o.target.style.display="none",o.target.parentElement.style.backgroundColor="#eee"},v=()=>{s("close")},r=()=>{$.value&&confirm("确定要撕掉这页日记吗？")&&c.deleteDiary(l,$.value.id)},n=async()=>{if(!_.value){_.value=!0;try{const o=m.getCharacter(l);if(!o)return;const u=m.getFormattedRecentMessages(l,20).map(O=>`${O.role==="user"?"用户":"我"}: ${O.content}`).join(`
`),g=`你现在是${o.name}。请根据以下最近的聊天记录，写一篇简短的日记（100-200字）。
日记应该以第一人称“我”的视角，记录最近发生的事情、你的心情和对用户的想法。
请直接输出日记内容，不要包含任何其他解释或格式。

聊天记录：
${u}

日记内容：`;let D=null;o.api&&o.api!=="default"&&(D=k.presets.find(O=>O.name===o.api));const J=await k.getGenericCompletion([{role:"user",content:g}],{preset:D,max_tokens:500});J&&c.addDiary(l,J.trim())}catch(o){console.error("Failed to generate diary:",o)}finally{_.value=!1}}};return(o,i)=>(p(),j(ee,{title:h.value,"show-clear":!0,"show-refresh":!0,onClose:v,onClear:r,onRefresh:n,background:"#f8f6f3",color:"#37474f",themeColor:"#555"},{default:H(()=>{var u,g;return[e("div",{class:re(["diary-container",{"is-open":$.value||_.value}])},[i[10]||(i[10]=e("div",{class:"desktop-texture"},null,-1)),$.value||_.value?(p(),f("div",Ct,[e("div",Dt,[i[2]||(i[2]=e("div",{class:"bookmark-ribbon"},null,-1)),e("div",wt,[e("div",St,[a.value?(p(),f("div",Mt,[e("div",xt,[e("img",{src:a.value.avatar,alt:"char",onError:C},null,40,It)]),e("div",Tt,T(a.value.name),1)])):P("",!0),e("div",Ut,[e("div",At,[e("div",Nt,[e("span",Pt,T(A(S.value)),1),e("div",Bt,[e("span",Ot,T(B(S.value)),1),e("span",Wt,T(U(S.value)),1)]),e("div",Ft,T(w(S.value)),1)]),i[0]||(i[0]=e("div",{class:"stamp-mark"},[e("div",{class:"stamp-inner"},"CONFIDENTIAL")],-1))]),i[1]||(i[1]=e("div",{class:"diary-divider"},null,-1)),e("div",Rt,[_.value?(p(),f("div",Jt,[e("div",zt,[N(E,{name:"pencil",class:"pen-icon"}),e("span",null,T(((u=a.value)==null?void 0:u.name)||"Ta")+" 正在提笔...",1)])])):(p(),f("div",Ht,[(p(!0),f(V,null,G(I.value,(D,J)=>(p(),f("p",{key:J},T(D),1))),128))]))]),e("div",Et,"- "+T(new Date(Number(S.value)).getDate())+" -",1)])])])])])):(p(),f("div",{key:1,class:"diary-book-cover",onClick:n},[i[9]||(i[9]=e("div",{class:"book-spine"},null,-1)),e("div",jt,[i[7]||(i[7]=e("div",{class:"stitching-border"},null,-1)),e("div",Vt,[e("div",Gt,[i[4]||(i[4]=e("h2",{class:"book-title"},"DIARY",-1)),e("div",Lt,[e("span",Yt,T(((g=a.value)==null?void 0:g.name)||"Character"),1),i[3]||(i[3]=e("span",{class:"of-word"},"'s",-1))]),i[5]||(i[5]=e("div",{class:"label-line"},null,-1)),i[6]||(i[6]=e("div",{class:"book-hint"},"打开日记本",-1))])]),i[8]||(i[8]=e("div",{class:"elastic-band"},null,-1))])]))],2)]}),_:1},8,["title"]))}},Kt=R(qt,[["__scopeId","data-v-9369952d"]]),Qt=Z("memo",{state:()=>({memos:{}}),actions:{addMemo(t,b){this.memos[t]||(this.memos[t]=[]);const s=b.map(y=>({id:Date.now().toString()+Math.random(),content:y,timestamp:Date.now()}));this.memos[t].unshift(...s)},updateMemo(t,b,s){if(!this.memos[t])return;const y=this.memos[t].find(m=>m.id===b);y&&(y.content=s)},getMemos(t){return this.memos[t]||[]},deleteMemo(t,b){if(this.memos[t]){const s=this.memos[t].findIndex(y=>y.id===b);s!==-1&&this.memos[t].splice(s,1)}},clearMemos(t){this.memos[t]&&(this.memos[t]=[])}},persist:!0}),Xt={key:0,class:"memo-list cork-board"},Zt={key:0,class:"generating-overlay"},ea={class:"memo-item"},ta={class:"memo-content"},aa={class:"memo-footer"},oa={class:"memo-date"},sa=["onClick"],na={key:1,class:"empty-state cork-board"},la={__name:"CharMemo",emits:["close"],setup(t,{emit:b}){const s=b,y=K(),m=q(),c=Qt(),k=oe(),l=y.params.charId,_=M(!1),a=x(()=>m.getCharacter(l)),h=x(()=>c.getMemos(l)),d=x(()=>a.value?`${a.value.name}的备忘录`:"备忘录"),$=()=>{s("close")},S=U=>U?new Date(U).toLocaleDateString("en-CA"):"",I=U=>{c.deleteMemo(l,U)},A=()=>{h.value.length>0&&confirm("确定要清空所有备忘录吗？")&&c.clearMemos(l)},B=async()=>{if(!_.value){_.value=!0;try{if(!a.value)return;const w=m.getFormattedRecentMessages(l,15).map(n=>`${n.role==="user"?"用户":"我"}: ${n.content}`).join(`
`),C=`角色: ${a.value.name}
任务: 你正在写一些私密的备忘录便利贴。请基于你的人设的日常琐事（如工作、爱好、生活习惯）以及最近和用户的聊天内容，写5-8条简短的备忘录。

规则:
1.  输出5-8条备忘录，每条字数控制在10-30字。
2.  每条备忘录都是独立的、零散的想法。
3.  内容可以关于你的日常生活、不为人知的小秘密、对用户的真实想法、或和用户聊天中产生的想法。
4.  风格要口语化、生活化，就像随手写下的笔记，体现角色性格和生活气息。
5.  每条内容占一行，不要带序号或任何标记。

参考聊天记录:
${w}

备忘录内容:`;let v=null;a.value.api&&a.value.api!=="default"&&(v=k.presets.find(n=>n.name===a.value.api));const r=await k.getGenericCompletion([{role:"user",content:C}],{preset:v,max_tokens:600});if(r){const n=r.split(`
`).map(o=>o.trim()).filter(o=>o.length>0);n.length>0&&c.addMemo(l,n)}}catch(U){console.error("Failed to generate memos:",U)}finally{_.value=!1}}};return(U,w)=>(p(),j(ee,{title:d.value,"show-clear":!0,"show-refresh":!0,onClose:$,onClear:A,onRefresh:B,background:"#ba9e76",color:"#3e2723",themeColor:"#795548"},{default:H(()=>[h.value.length>0||_.value?(p(),f("div",Xt,[_.value?(p(),f("div",Zt,[...w[0]||(w[0]=[e("div",{class:"generating-text"},"正在写备忘录...",-1)])])):P("",!0),(p(!0),f(V,null,G(h.value,C=>(p(),f("div",{key:C.id,class:"memo-item-wrapper"},[e("div",ea,[w[1]||(w[1]=e("div",{class:"pin"},null,-1)),e("p",ta,T(C.content),1),e("div",aa,[e("span",oa,T(S(C.timestamp)),1),e("div",{class:"delete-btn",onClick:v=>I(C.id)},[N(E,{name:"delete",class:"delete-icon"})],8,sa)])])]))),128))])):(p(),f("div",na,[...w[2]||(w[2]=[e("div",{class:"empty-hint"},[ae(" 备忘录是空的... "),e("br"),e("small",null,"点击右上角，让我写点东西吧")],-1)])]))]),_:1},8,["title"]))}},ra=R(la,[["__scopeId","data-v-d27b8dea"]]),ia=Z("schedule",{state:()=>({schedules:{}}),actions:{addSchedule(t,b){this.schedules[t]||(this.schedules[t]=[]),this.schedules[t].unshift({id:Date.now().toString(),content:b,timestamp:Date.now()})},updateSchedule(t,b,s){if(!this.schedules[t])return;const y=this.schedules[t].find(m=>m.id===b);y&&(y.content=s)},getSchedules(t){return this.schedules[t]||[]},deleteSchedule(t,b){if(this.schedules[t]){const s=this.schedules[t].findIndex(y=>y.id===b);s!==-1&&this.schedules[t].splice(s,1)}},clearSchedules(t){this.schedules[t]&&delete this.schedules[t]}},persist:!0}),da={key:0,class:"schedule-paper"},ca={class:"paper-content"},ua={class:"schedule-header"},pa={class:"date-stamp"},ha={class:"schedule-body"},va={key:0,class:"generating-text"},ma={key:1,class:"handwritten-text"},ga={class:"time-col"},fa={class:"event-col"},ba={key:1,class:"empty-state"},ka={__name:"CharSchedule",emits:["close"],setup(t,{emit:b}){const s=b,y=K(),m=q(),c=ia(),k=oe(),l=y.params.charId,_=M(!1),a=x(()=>m.getCharacter(l)),h=x(()=>c.getSchedules(l)),d=x(()=>h.value.length>0?h.value[0]:null),$=x(()=>a.value?`${a.value.name}的行程`:"行程表"),S=()=>{s("close")},I=w=>{const C=new Date(Number(w)),v=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return`${C.getFullYear()}.${(C.getMonth()+1).toString().padStart(2,"0")}.${C.getDate().toString().padStart(2,"0")} ${v[C.getDay()]}`},A=()=>{d.value&&confirm("确定要撕掉这张行程表吗？")&&c.deleteSchedule(l,d.value.id)},B=w=>w?w.split(`
`).map(C=>{if(C=C.trim(),!C)return null;const v=C.match(/^(\d{1,2}:\d{2})/);if(v){const r=v[1];let n=C.substring(r.length).trim();return(n.startsWith(":")||n.startsWith("：")||n.startsWith("-"))&&(n=n.substring(1).trim()),{time:r,event:n}}else return{time:"",event:C}}).filter(C=>C!==null):[],U=async()=>{if(!_.value){_.value=!0;try{if(!a.value)return;const C=m.getFormattedRecentMessages(l,10).map(D=>`${D.role==="user"?"用户":"我"}: ${D.content}`).join(`
`),v=new Date,r=`${v.getFullYear()}.${(v.getMonth()+1).toString().padStart(2,"0")}.${v.getDate().toString().padStart(2,"0")}`;let n=null;if(d.value){const D=new Date(Number(d.value.timestamp));`${D.getFullYear()}.${(D.getMonth()+1).toString().padStart(2,"0")}.${D.getDate().toString().padStart(2,"0")}`===r&&(n=d.value)}const o=`${v.getHours().toString().padStart(2,"0")}:${v.getMinutes().toString().padStart(2,"0")}`;let i="";n?i=`角色:${a.value.name}
当前时间:${r} ${o}
任务:以角色的口吻补充现有行程表(仅补充${o}之前未记录的)。

规则:
1.严禁包含晚于${o}的时间点。
2.格式:HH:MM 事件内容
3.输出完整列表(含旧数据)，按时间排序。
4.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
5.每条字数控制在10-20字。

现有行程:
${n.content}

完整行程:`:i=`角色:${a.value.name}
当前时间:${r} ${o}
任务:根据参考聊天和角色设定，以角色的口吻生成截止到目前的今日行程(已发生的事)。

规则:
1.严禁包含晚于${o}的时间点。
2.格式:HH:MM 事件内容
3.内容基于角色人设的日常（如工作、爱好、生活习惯），体现角色性格和生活气息，要有真实感。
4.每条字数控制在10-20字。

参考聊天:
${C}

行程:`;let u=null;a.value.api&&a.value.api!=="default"&&(u=k.presets.find(D=>D.name===a.value.api));const g=await k.getGenericCompletion([{role:"user",content:i}],{preset:u,max_tokens:1e3});if(g){const D=g.split(`
`).filter(J=>{const O=J.trim().match(/^(\d{1,2}:\d{2})/);if(O){const[F,L]=O[1].split(":").map(Number),de=F*60+L,[ce,ue]=o.split(":").map(Number),pe=ce*60+ue;return de<=pe}return!0}).join(`
`);n?c.updateSchedule(l,n.id,D.trim()):c.addSchedule(l,D.trim())}}catch(w){console.error("Failed to generate schedule:",w)}finally{_.value=!1}}};return(w,C)=>(p(),j(ee,{title:$.value,"show-clear":!0,"show-refresh":!0,onClose:S,onClear:A,onRefresh:U,background:"#f0f4f8",color:"#37474f",themeColor:"#546e7a"},{default:H(()=>[d.value||_.value?(p(),f("div",da,[e("div",ca,[e("div",ua,[C[0]||(C[0]=e("div",{class:"clip"},null,-1)),e("div",pa,T(_.value?I(Date.now()):I(d.value.timestamp)),1)]),e("div",ha,[_.value?(p(),f("div",va,"正在确认行程...")):(p(),f("div",ma,[(p(!0),f(V,null,G(B(d.value.content),(v,r)=>(p(),f("div",{key:r,class:"schedule-item"},[e("div",ga,T(v.time),1),e("div",fa,T(v.event),1)]))),128))]))])])])):(p(),f("div",ba,[...C[1]||(C[1]=[e("div",{class:"empty-hint"},[ae("行程表是空的..."),e("br"),ae("点击右上角，看看我今天做了什么吧")],-1)])]))]),_:1},8,["title"]))}},ya=R(ka,[["__scopeId","data-v-3eb8f33a"]]),_a={class:"theme-container"},$a={class:"theme-section"},Ca={class:"wallpaper-preview-container"},Da={key:0,class:"upload-hint"},wa={class:"theme-section"},Sa={class:"app-icons-grid"},Ma=["onClick"],xa={class:"app-icon-box"},Ia=["src"],Ta={key:1,class:"app-icon-placeholder"},Ua={class:"app-name"},Aa=["onClick"],Na={__name:"CharTheme",emits:["close"],setup(t,{emit:b}){const s=b,y=K(),m=q(),c=ie(),k=y.params.charId,l=M(!1),_=M(""),a=M("theme"),h=M(null),d=x(()=>m.getCharacter(k)),$=x(()=>d.value?`${d.value.name}的主题`:"主题"),S=x(()=>c.getCharTheme(k)),I=x(()=>S.value.wallpaper),A=x(()=>I.value?{backgroundImage:`url(${I.value})`,backgroundSize:"cover",backgroundPosition:"center"}:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}),B=x(()=>{var D,J;const i=`charphone_${k}`,u=localStorage.getItem(i),g=[];if(u)try{const O=JSON.parse(u);(D=O.middle)!=null&&D.apps&&O.middle.apps.forEach(F=>{F.label&&!g.find(L=>L.label===F.label)&&g.push({label:F.label,route:F.route})}),(J=O.bottom)!=null&&J.apps&&O.bottom.apps.forEach(F=>{F.label&&!g.find(L=>L.label===F.label)&&g.push({label:F.label,route:F.route})})}catch(O){console.error("Failed to parse charphone data:",O)}return g}),U=()=>{s("close")},w=()=>{_.value="设置壁纸",a.value="theme",h.value={type:"wallpaper"},l.value=!0},C=i=>{_.value=`设置 ${i} 图标`,a.value="avatar",h.value={type:"appIcon",appLabel:i},l.value=!0},v=i=>{const u=i.content;h.value.type==="wallpaper"?c.setWallpaper(k,u):h.value.type==="appIcon"&&c.setAppIcon(k,h.value.appLabel,u),l.value=!1,h.value=null},r=()=>{confirm("确定要清除壁纸吗？")&&c.setWallpaper(k,"")},n=i=>{confirm(`确定要清除 ${i} 的图标吗？`)&&c.deleteAppIcon(k,i)},o=i=>c.getAppIcon(k,i);return(i,u)=>(p(),j(ee,{title:$.value,onClose:U,background:"#f8f6f3",color:"#37474f",themeColor:"#555"},{default:H(()=>[e("div",_a,[e("div",$a,[u[2]||(u[2]=e("div",{class:"section-title"},"壁纸设置",-1)),e("div",Ca,[e("div",{class:"wallpaper-preview",style:W(A.value),onClick:w},[I.value?P("",!0):(p(),f("div",Da,[N(E,{name:"image",class:"hint-icon"}),u[1]||(u[1]=e("span",null,"点击上传壁纸",-1))]))],4),I.value?(p(),f("button",{key:0,class:"btn-clear",onClick:r}," 清除壁纸 ")):P("",!0)])]),e("div",wa,[u[3]||(u[3]=e("div",{class:"section-title"},"App图标设置",-1)),e("div",Sa,[(p(!0),f(V,null,G(B.value,g=>(p(),f("div",{key:g.label,class:"app-icon-item",onClick:D=>C(g.label)},[e("div",xa,[o(g.label)?(p(),f("img",{key:0,src:o(g.label),alt:"app icon"},null,8,Ia)):(p(),f("div",Ta,[e("span",null,T(g.label.charAt(0)),1)]))]),e("span",Ua,T(g.label),1),o(g.label)?(p(),f("button",{key:0,class:"btn-clear-icon",onClick:z(D=>n(g.label),["stop"])}," × ",8,Aa)):P("",!0)],8,Ma))),128))])])]),N(Y,{visible:l.value,"onUpdate:visible":u[0]||(u[0]=g=>l.value=g),title:_.value,bizType:a.value,type:"basic",onUploadComplete:v,onSendImage:v},null,8,["visible","title","bizType"])]),_:1},8,["title"]))}},Pa=R(Na,[["__scopeId","data-v-be4ff353"]]),Ba={class:"char-phone-container"},Oa={class:"char-phone-frame"},Wa={class:"char-status-bar"},Fa={class:"time"},Ra={class:"char-content"},Ja={__name:"CharPhone",setup(t){const{t:b}=he(),s=K();q();const y=ie(),m=s.params.charId,c=x(()=>y.getWallpaperStyle(m)),k=M("");let l=null;const _=()=>{const u=new Date,g=u.getHours().toString().padStart(2,"0"),D=u.getMinutes().toString().padStart(2,"0");k.value=`${g}:${D}`};ne(()=>{_(),l=setInterval(_,1e3),U()}),le(()=>{l&&clearInterval(l)});const a=M({background:"",avatar:"",photos:["",""],photoTexts:["",""]}),h=[{label:"微信",color:"rgba(255, 255, 255, 0.9)",route:"/chat"},{label:"行程表",color:"rgba(255, 255, 255, 0.9)",route:"/schedule"},{label:"日记",color:"rgba(255, 255, 255, 0.9)",route:"/diary"},{label:"备忘录",color:"rgba(255, 255, 255, 0.9)",route:"/memo"}],d=M({photo:"",apps:JSON.parse(JSON.stringify(h))}),$=[{label:"购买记录",color:"rgba(255, 255, 255, 0.9)",route:"/purchase"},{label:"搜索记录",color:"rgba(255, 255, 255, 0.9)",route:"/search"},{label:"主题",color:"rgba(255, 255, 255, 0.9)",route:"/theme"},{label:"app1",color:"rgba(255, 255, 255, 0.9)",route:"/app1"}],S=M({photo:"",text1:"",text2:"",apps:JSON.parse(JSON.stringify($))}),I=M({avatars:{other:"",mine:""},messages:{other:"",mine:""}}),A=M(null),B=x(()=>{switch(A.value){case"diary":return Kt;case"memo":return ra;case"schedule":return ya;case"theme":return Pa;default:return null}}),U=()=>{const u=`charphone_${m}`,g=localStorage.getItem(u);if(g)try{const D=JSON.parse(g);D.header&&(a.value={...a.value,...D.header}),D.middle&&(d.value={...d.value,...D.middle},(!d.value.apps||d.value.apps.length===0||!d.value.apps[0].label)&&(d.value.apps=JSON.parse(JSON.stringify(h)))),D.bottom&&(S.value={...S.value,...D.bottom},(!S.value.apps||S.value.apps.length===0||!S.value.apps[0].label)&&(S.value.apps=JSON.parse(JSON.stringify($)))),D.dock&&(I.value={...I.value,...D.dock})}catch(D){console.error("Failed to load char phone data:",D)}},w=()=>{const u=`charphone_${m}`,g={header:a.value,middle:d.value,bottom:S.value,dock:I.value};localStorage.setItem(u,JSON.stringify(g))},C=u=>{a.value=u,w()},v=u=>{d.value=u,w()},r=u=>{S.value=u,w()},n=u=>{I.value=u,w()},o=u=>{console.log("App clicked:",u);try{u.label==="日记"||u.route==="/diary"?A.value="diary":u.label==="备忘录"||u.route==="/memo"?A.value="memo":u.label==="行程"||u.label==="行程表"||u.route==="/schedule"?A.value="schedule":u.label==="主题"||u.route==="/theme"?A.value="theme":console.warn("未识别的应用:",u)}catch(g){console.error("打开应用时出错:",g)}},i=()=>{A.value=null};return(u,g)=>(p(),j(me,{title:ve(b)("charPhone.title","查看手机"),"no-padding":"",class:re({"hide-back-btn":A.value})},{default:H(()=>[e("div",Ba,[e("div",Oa,[g[2]||(g[2]=e("div",{class:"char-notch"},null,-1)),e("div",{class:"char-phone-screen",style:W(c.value)},[e("div",Wa,[e("span",Fa,T(k.value),1),g[0]||(g[0]=e("div",{class:"icons"},[e("span",null,"5G"),e("div",{class:"battery-icon"})],-1))]),e("div",Ra,[N(nt,{"header-data":a.value,"middle-data":d.value,"bottom-data":S.value,"onUpdate:headerData":C,"onUpdate:middleData":v,"onUpdate:bottomData":r,onAppClick:o},null,8,["header-data","middle-data","bottom-data"])]),N(vt,{"dock-data":I.value,"onUpdate:dockData":n},null,8,["dock-data"]),N(ge,{name:"app-fade"},{default:H(()=>[B.value?(p(),j(fe(B.value),{key:0,onClose:i},null,32)):P("",!0)]),_:1}),g[1]||(g[1]=e("div",{class:"char-home-indicator"},null,-1))],4),g[3]||(g[3]=e("div",{class:"char-btn-power"},null,-1)),g[4]||(g[4]=e("div",{class:"char-btn-volume-up"},null,-1)),g[5]||(g[5]=e("div",{class:"char-btn-volume-down"},null,-1))])])]),_:1},8,["title","class"]))}},Ha=R(Ja,[["__scopeId","data-v-ef7f78e1"]]);export{Ha as default};
