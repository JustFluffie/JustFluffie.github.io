import{_ as J,m as K,q as Q,O as W,r as c,u as X,c as C,d as Z,w as v,a2 as ee,i as te,g as se,o as _,e as s,f as l,a as M,z as x,F as ae,A as oe,S as m,n as ne,v as B,x as U}from"./index-BhBAuxlH.js";const le={class:"header-actions"},ie={class:"memory-bank-content"},re={class:"memory-scroll-container"},ce={key:0,class:"empty-state"},ue={class:"empty-text"},ve={key:1,class:"memory-list"},de={class:"card-header-row"},me={class:"header-left"},fe={class:"sort-buttons"},pe=["onClick","disabled"],he=["onClick","disabled"],be={class:"char-info"},_e={class:"char-name"},ge={class:"save-time"},ye={class:"header-right"},ke=["onClick"],Se=["onClick"],we=["onClick","title"],Ce={class:"card-content-row"},Me={__name:"SingleMemoryBank",setup(xe){const O=X();te();const f=K(),D=Q(),V=W(),A=c(O.params.charId),g=c(!1),h=c(!1),p=c(-1),i=c(""),y=c(!1),k=c(-1),S=c(!1),b=c(""),o=C(()=>f.getCharacter(A.value)),r=C(()=>{var e;return((e=o.value)==null?void 0:e.memories)||[]}),$=C(()=>{var e;return((e=o.value)==null?void 0:e.name)||"角色"}),F=C(()=>g.value?r.value.filter(e=>e.isFavorite):r.value),I=()=>{h.value=!1,i.value=""},N=()=>{y.value=!1,k.value=-1},R=()=>{S.value=!1},P=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`},d=e=>r.value.indexOf(e),z=()=>{p.value=-1,i.value="",h.value=!0},j=e=>{p.value=e;const t=r.value[e];i.value=typeof t=="string"?t:t.content,h.value=!0},q=()=>{if(!i.value.trim())return;const e=o.value;if(e.memories||(e.memories=[]),p.value>=0){const t=e.memories[p.value];typeof t=="string"?e.memories[p.value]={content:i.value,time:Date.now(),charName:e.name,isFavorite:!1}:t.content=i.value}else e.memories.unshift({content:i.value,time:Date.now(),charName:e.name,isFavorite:!1});f.saveData(),I()},E=e=>{k.value=e,y.value=!0},G=()=>{k.value>=0&&(o.value.memories.splice(k.value,1),f.saveData()),N()},T=(e,t)=>{const n=e+t;if(n<0||n>=r.value.length)return;const a=o.value.memories[e];o.value.memories[e]=o.value.memories[n],o.value.memories[n]=a,f.saveData()},H=e=>{const t=r.value[e];typeof t=="string"?r.value[e]={content:t,time:Date.now(),charName:$.value,isFavorite:!0}:t.isFavorite=!t.isFavorite,f.saveData()},L=()=>{b.value=o.value.memorySummaryPrompt||"",S.value=!0},Y=async()=>{const e=o.value;if(!e)return;e.memorySummaryPrompt=b.value,D.showToast("正在提炼记忆...","info"),R();const t=r.value.map(u=>u.content).join(`
---
`),n=b.value||"请总结以下内容，提取关键信息。",a=[{role:"system",content:"你是一个记忆总结助手。"},{role:"user",content:`现有记忆如下：
${t}

请根据以下要求进行总结：
${n}`}];try{const u=await V.getGenericCompletion(a);u?(e.memories||(e.memories=[]),e.memories.unshift({content:`[记忆再总结] ${u}`,time:Date.now(),charName:e.name,isFavorite:!1}),f.saveData(),D.showToast("记忆提炼已完成","success")):D.showToast("提炼失败，未收到有效回复","error")}catch(u){console.error("记忆提炼失败:",u)}};return(e,t)=>{const n=se("Modal");return _(),Z(ee,{title:"长期记忆"},{action:v(()=>[s("div",le,[s("button",{class:"icon-btn",onClick:L,title:"提炼"},[l(m,{name:"Sparkles"})]),s("button",{class:"icon-btn",onClick:z,title:"添加"},[l(m,{name:"plus"})])])]),default:v(()=>[s("div",ie,[s("div",re,[!F.value||F.value.length===0?(_(),M("div",ce,[s("div",ue,x(g.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(_(),M("div",ve,[(_(!0),M(ae,null,oe(F.value,(a,u)=>(_(),M("div",{key:a.id||u,class:"card memory-card"},[s("div",de,[s("div",me,[s("div",fe,[s("button",{class:"icon-btn sort-btn",onClick:w=>T(d(a),-1),disabled:d(a)===0||g.value,title:"上移"},[l(m,{name:"arrow-up"})],8,pe),s("button",{class:"icon-btn sort-btn",onClick:w=>T(d(a),1),disabled:d(a)===r.value.length-1||g.value,title:"下移"},[l(m,{name:"arrow-down"})],8,he)]),s("div",be,[s("span",_e,x(a.charName||$.value),1),s("span",ge,x(P(a.time)),1)])]),s("div",ye,[s("button",{class:"icon-btn",onClick:w=>j(d(a)),title:"编辑"},[l(m,{name:"pencil"})],8,ke),s("button",{class:"icon-btn danger",onClick:w=>E(d(a)),title:"删除"},[l(m,{name:"trash"})],8,Se),s("button",{class:"icon-btn favorite-btn",onClick:w=>H(d(a)),title:a.isFavorite?"取消收藏":"收藏"},[l(m,{name:a.isFavorite?"heart-solid":"heart",class:ne({"is-favorite":a.isFavorite})},null,8,["name","class"])],8,we)])]),s("div",Ce,x(a.content),1)]))),128))]))])]),l(n,{visible:h.value,"onUpdate:visible":t[1]||(t[1]=a=>h.value=a),title:p.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:v(()=>[s("button",{class:"modal-btn cancel",onClick:I},"取消"),s("button",{class:"modal-btn confirm",onClick:q},"确定")]),default:v(()=>[B(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[U,i.value]])]),_:1},8,["visible","title"]),l(n,{visible:y.value,"onUpdate:visible":t[2]||(t[2]=a=>y.value=a),title:"确认删除",class:"nested"},{footer:v(()=>[s("button",{class:"modal-btn cancel",onClick:N},"取消"),s("button",{class:"modal-btn confirm danger",onClick:G},"确认删除")]),default:v(()=>[t[5]||(t[5]=s("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),l(n,{visible:S.value,"onUpdate:visible":t[4]||(t[4]=a=>S.value=a),title:"记忆提炼",class:"nested"},{footer:v(()=>[s("button",{class:"modal-btn cancel",onClick:R},"取消"),s("button",{class:"modal-btn confirm",onClick:Y},"开始提炼")]),default:v(()=>[t[6]||(t[6]=s("p",{class:"summary-tip"},"将对现有长期记忆进行再总结。",-1)),B(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":t[3]||(t[3]=a=>b.value=a),placeholder:"输入总结提示词...",style:{height:"100px"}},null,512),[[U,b.value]])]),_:1},8,["visible"])]),_:1})}}},Fe=J(Me,[["__scopeId","data-v-82f520af"]]);export{Fe as default};
