import{k as Z,B as ne,r as V,J as le,L as st,N as nt,l as ot,O as at,P as it,Q as lt,m as rt,x as be,R as ct,_ as G,u as oe,C as ye,g as w,o as k,b as X,h as F,f as U,i as e,T as he,t as y,d as x,w as Q,p as J,F as se,M as de,c as q,G as W,H as re,j,v as ke,n as ce,U as Ce,E as Te,D as O,S as te,V as dt,I as z,W as ut,X as vt,s as gt,Y as ie,Z as mt,$ as ft,a0 as ve,a1 as pt}from"./index-BH1vO71R.js";import{M as ht}from"./MoneyPacket-Do3qlxAF.js";function kt(t){const f=Z(),s=ne(),n=V(!1),u=V(new Set),p=V(!1),v=(i,m)=>{console.log("[useMessageSelection] enterSelectionMode triggered");let I=0,d=0;const r=document.querySelector(".message-list");m&&r&&(I=r.scrollTop,d=m.getBoundingClientRect().top),n.value=!0,u.value.clear(),i&&u.value.add(i),m&&r&&le(()=>{const C=document.querySelector(".selection-bar"),M=C?C.offsetHeight:0,P=m.getBoundingClientRect().top-d;r.scrollTop=I+P-M})},o=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),n.value=!1,u.value.clear()};return{isSelectionMode:n,selectedMessageIds:u,isForwarding:p,enterSelectionMode:v,exitSelectionMode:o,toggleMessageSelection:i=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${i}`),u.value.has(i)?u.value.delete(i):u.value.add(i)},handleBatchAction:i=>{if(console.log(`[useMessageSelection] handleBatchAction: ${i}`),u.value.size===0)return;const m=f.messages[t.value];if(i==="forward")p.value=!0;else if(i==="delete")s.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),f.messages[t.value]=m.filter(I=>!u.value.has(I.id)),f.saveData(),o()});else if(i==="favorite"){const I=m.filter(d=>u.value.has(d.id));I.length>0&&(f.addToFavorites(t.value,I),s.showToast("已收藏","success")),o()}},handleConfirmForward:i=>{console.log("[useMessageSelection] handleConfirmForward triggered"),p.value=!1;const I=(f.messages[t.value]||[]).filter(d=>u.value.has(d.id));I.length!==0&&(i.forEach(d=>{f.messages[d]||(f.messages[d]=[]),I.forEach(r=>{const C={...r,id:Date.now().toString()+Math.random()};f.messages[d].push(C)})}),f.saveData(),s.showToast(`已转发 ${I.length} 条消息`),o())}}}function bt(t,f){const s=Z(),n=st(),u=nt(),p=ot(),v=at(),o=be(),l=rt(),{buildInnerVoicePrompt:g}=it(),h=V(!1),i=M=>{const a=/\[撤回\]/g;if(a.test(M)){const P=s.messages[t.value]||[];for(let A=P.length-1;A>=0;A--){const D=P[A];if(D.sender==="char"&&!D.isRevoked){s.revokeMessage(t.value,D.id),console.log(`[useAiHandler] Revoked message: ${D.id}`);break}}return M.replace(a,"").trim()}return M},m=M=>{const a=/\[互动朋友圈：(.+?)\]/g;let P;for(;(P=a.exec(M))!==null;)try{const A=JSON.parse(P[1]),{action:D,response:T}=A,B=p.moments.filter(c=>c.userId==="user");if(B.length>0){const c=B[0];D==="like"?p.likeMoment(c.id,t.value):D==="comment"&&T&&(p.likeMoment(c.id,t.value),p.addComment(c.id,{userId:t.value,content:T,time:Date.now()}))}}catch(A){console.error("[useAiHandler] Failed to parse moment interaction data:",A)}return M.replace(a,"").trim()},I=M=>{const a=/\[朋友圈：(.+?)\]/g;let P;for(;(P=a.exec(M))!==null;)try{const A=JSON.parse(P[1]),{text:D,imageDescription:T}=A,B=[];T&&B.push({content:T,isTextGenerated:!0}),(D||B.length>0)&&p.addMoment({userId:t.value,content:D||"",images:B,time:Date.now()})}catch(A){console.error("[useAiHandler] Failed to parse moment data:",A)}return M.replace(a,"").trim()},d=M=>{const a=/\[待办：(?:((?:\d{4}-\d{2}-\d{2}\s)?\d{1,2}:\d{2}|\d{4}-\d{2}-\d{2})\s)?(.+?)\]/g;let P;for(;(P=a.exec(M))!==null;){const A=P[1],D=P[2].trim();let T=new Date,B="";if(A)if(A.includes("-"))if(A.includes(":")){const[c,S]=A.split(/\s+/);T=new Date(c),B=S}else T=new Date(A),B="";else B=A;else{const c=new Date,S=[15,30,60],R=S[Math.floor(Math.random()*S.length)];c.setMinutes(c.getMinutes()+R);const Y=c.getHours().toString().padStart(2,"0"),L=c.getMinutes().toString().padStart(2,"0");B=`${Y}:${L}`}if(D){let c=D.substring(0,18)+(D.length>18?"...":"");u.addEvent({type:"todo",title:c,content:c,date:ct(T,{representation:"date"}),done:!1,time:B})}}return M.replace(a,"").trim()},r=async()=>{var M,a;try{const P=s.getCharacter(t.value);if(!P)return;const A=s.innerVoices[t.value]||[],D=(a=(M=A[0])==null?void 0:M.title.match(/#(\d+)/))==null?void 0:a[1];let T=(D?parseInt(D,10):A.length)+1;const B=A.length>0?A[0]:null,c=s.getFormattedRecentMessages(t.value,3),S=g(P,c,T,B),{content:R,usage:Y}=await f.getGenericCompletion([{role:"user",content:S}],{});if(v.addTokenUsage(Y),R){let L=R.trim();L.startsWith("```json")&&(L=L.substring(7)),L.endsWith("```")&&(L=L.slice(0,-3));const N=L.indexOf("{"),H=L.lastIndexOf("}");if(N!==-1&&H!==-1){const ee=L.substring(N,H+1);try{const _=JSON.parse(ee);s.addInnerVoice(t.value,_)}catch(_){console.error("[InnerVoice] Failed to parse JSON:",_,ee)}}}}catch(P){console.error("[useAiHandler] Failed to generate inner voice:",P),n.addNotification({type:"error",message:`心声生成失败: ${P.message}`})}};return{isTyping:h,triggerAiResponse:async()=>{h.value=!0;let M=!1;try{const a=s.getCharacter(t.value);if(!a){h.value=!1;return}const P=a.isOnline!==!1,{content:A,usage:D}=await f.getChatCompletion(t.value,{isOnline:P});if(v.addTokenUsage(D),A){M=!0;let T=i(A);if(T=m(T),T=I(T),T=d(T),!T)return;const B=(a==null?void 0:a.isBlocked)||!1,c=/(?:\||\\\||｜)\s*(?:\||\\\||｜)\s*(?:\||\\\||｜)+/;let S=T.split(c);S.length===1&&T.includes(`
`)&&(S=T.split(`
`).map(L=>L.trim()).filter(L=>L));const R=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g,Y=S.flatMap(L=>L.split(R).map(N=>N.trim()).filter(N=>N));for(let L=0;L<Y.length;L++){L>0&&await new Promise(K=>setTimeout(K,1e3+Math.random()*1e3));let{type:N,content:H,extraData:ee={}}=lt(Y[L]);if(N==="transfer_accepted"){await new Promise(K=>setTimeout(K,800+Math.random()*500)),s.autoAcceptPendingTransfers(t.value);continue}if(N==="sticker"){const K=s.stickers.find(me=>me.name===H);K?(H=K.url,ee.name=K.name):(N="text",H=`[表情包：${H}]`)}const _=N==="image"&&!H.startsWith("http")&&!H.startsWith("data:");s.addMessage(t.value,{id:Date.now().toString()+L,sender:"char",type:N,content:H,isTextGenerated:_,...ee,time:Date.now(),blocked:B}),l.path===`/chat/room/${t.value}`&&!document.hidden||(s.incrementUnreadCount(t.value),n.triggerNotification(a.nickname||a.name,N==="text"?H:`[${N}]`,a.avatar,()=>o.push(`/chat/room/${t.value}`),3e3,N))}}else M=!0}catch(a){console.error("[useAiHandler] triggerAiResponse failed:",a),n.addNotification({type:"error",message:`AI 响应失败: ${a.message}`}),M=!1}finally{h.value=!1,M&&r()}}}}function yt(t,f,s){const n=V(null);return{editingMessageId:n,handleEditMessage:o=>{console.log("[useMessageEditing] handleEditMessage for msgId:",o),n.value=o},handleSaveEdit:({msgId:o,newContent:l})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",o);const h=t.messages[f.value].find(i=>i.id===o);h&&(h.content=l,t.saveData()),n.value=null},updateInputText:o=>{console.log("[useMessageEditing] updateInputText called"),s&&(s.value=o,le(()=>{const l=document.querySelector(".chat-input");l&&l.focus()}))}}}function St(t,f,s,n,u={}){const p=V(""),v=V(null),o=(d,r,C={})=>{console.log(`[useMessageSender] sendMsg called with type: ${d}`);const M={...C};v.value&&(M.quote={id:v.value.id,sender:v.value.sender,content:v.value.content}),t.addMessage(f.value,{id:Date.now().toString()+Math.random(),sender:"user",type:d,content:r,timestamp:Date.now(),...M}),n&&(n.value=null),v.value=null};return{inputText:p,quotingMessage:v,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const d=p.value.trim();d&&(o("text",d),p.value="")},sendMsg:o,sendSticker:d=>{console.log("[useMessageSender] sendSticker triggered"),o("sticker",d.url,{name:d.name})},sendVoiceMessage:d=>{console.log("[useMessageSender] sendVoiceMessage triggered"),d&&o("voice",d)},handleSendImage:d=>{console.log("[useMessageSender] handleSendImage triggered"),d.isTextGenerated?o("image",d.description,{isTextGenerated:!0}):(d.type==="base64"||d.type==="url")&&o("image",d.content)},confirmSendLocation:(d,r)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!d){s.showToast("请输入位置名称","info");return}o("location",d,{detail:r})},sendTransfer:(d,r)=>{console.log("[useMessageSender] sendTransfer triggered",d,r),o("transfer",d,{note:r,status:"pending"})}}}function Mt(t){const f=V(null),s=V(!1),n=V({x:0,y:0}),u=(g,h)=>{console.log("[useMessageInteraction] showMenu triggered"),g.preventDefault();const i=g.target.closest(".msg-bubble, .system-message-wrapper");i&&(t.value={visible:!0,messageId:h,targetEl:i})};return{startLongPress:(g,h)=>{console.log("[useMessageInteraction] startLongPress triggered"),g.stopPropagation(),s.value=!1,clearTimeout(f.value),g.type.startsWith("touch")&&(n.value={x:g.touches[0].clientX,y:g.touches[0].clientY}),f.value=setTimeout(()=>{s.value=!0,u(g,h)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(f.value)},handleTouchMove:g=>{console.log("[useMessageInteraction] handleTouchMove triggered");const h=g.touches[0],i=Math.abs(h.clientX-n.value.x),m=Math.abs(h.clientY-n.value.y);(i>10||m>10)&&clearTimeout(f.value)},wasClickAfterLongPress:()=>s.value?(s.value=!1,!0):!1}}const wt={class:"header-title-area"},$t={key:0,class:"chat-room-title"},Ct={key:1,class:"typing-indicator"},Tt={class:"right-icons-group"},xt={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},It=["placeholder"],Pt=["placeholder"],At={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:f}){const s=t,{t:n}=oe(),u=be(),p=Z(),v=ne(),o=V(!1),l=V(""),g=V(""),h=V(!1);ye(()=>{h.value=!0});const i=()=>{const d=s.charStatus||{};l.value=d.icon||"✨",g.value=d.text||"",o.value=!0},m=()=>{const d=l.value.trim()||"✨",r=g.value.trim(),C=p.getCharacter(s.charId);C&&(r?C.status={icon:d,text:r}:C.status=null,p.saveData(),v.showToast(n("saveSuccess"))),o.value=!1},I=()=>{u.push({name:"memory-bank",params:{charId:s.charId}})};return(d,r)=>(k(),w("div",null,[h.value?(k(),X(he,{key:0,to:"#chatRoomLeftArea"},[e("div",{class:"btn-icon bell-btn",onClick:r[0]||(r[0]=C=>d.$emit("trigger-ai")),ref:"bellBtn"},[...r[6]||(r[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)])):F("",!0),h.value?(k(),X(he,{key:1,to:"#chatRoomTitleArea"},[e("div",wt,[t.isTyping?(k(),w("div",Ct,[e("span",null,y(x(n)("chat.singleChat.typing")),1),r[7]||(r[7]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(k(),w("div",$t,y(t.charName),1))]),e("div",{class:"chat-room-status",onClick:i},[e("span",null,y(t.charStatus.icon||"✨"),1),e("span",null,y(t.charStatus.text||x(n)("chat.singleChat.addStatus")),1)])])):F("",!0),h.value?(k(),X(he,{key:2,to:"#chatRoomActionArea"},[e("div",Tt,[e("div",{class:"btn-icon memory-btn",onClick:I},[...r[8]||(r[8]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e("polyline",{points:"14 2 14 8 20 8"}),e("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e("polyline",{points:"10 9 9 9 8 9"})],-1)])]),e("div",{class:"btn-icon more-btn",onClick:r[1]||(r[1]=C=>d.$emit("open-settings"))},[...r[9]||(r[9]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])])])):F("",!0),U(de,{visible:o.value,"onUpdate:visible":r[5]||(r[5]=C=>o.value=C),title:x(n)("chat.singleChat.setStatus")},{footer:Q(()=>[e("button",{class:"modal-btn cancel",onClick:r[4]||(r[4]=C=>o.value=!1)},y(x(n)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:m},y(x(n)("confirm")),1)]),default:Q(()=>[e("div",xt,[J(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[2]||(r[2]=C=>l.value=C),placeholder:x(n)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,It),[[se,l.value]]),J(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[3]||(r[3]=C=>g.value=C),placeholder:x(n)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,Pt),[[se,g.value]])])]),_:1},8,["visible","title"])]))}},Bt=G(At,[["__scopeId","data-v-9265e8b0"]]),Vt={key:0,class:"chat-panel",id:"stickerPanel"},Lt={class:"sticker-panel-header"},Dt={class:"sticker-groups"},Rt=["onClick"],Et={class:"sticker-panel-content"},qt=["onClick"],Ut=["src","alt"],Nt={class:"sticker-panel-footer"},Ft={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:f}){const s=f,n=Z(),u=ne(),p=V("默认"),v=V(!1),o=V(new Set),l=V(!1),g=V(!1),h=V(""),i=q(()=>["默认",...new Set(n.stickers.map(B=>B.group).filter(Boolean).filter(B=>B!=="默认"))]),m=q(()=>n.stickers.filter(T=>T.group===p.value)),I=T=>{v.value?o.value.has(T.id)?o.value.delete(T.id):o.value.add(T.id):s("send-sticker",T)},d=({group:T,stickers:B})=>{const c=B.map(S=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:S.url,name:S.name,group:T}));n.stickers.push(...c),n.saveData(),u.showToast(`成功导入 ${c.length} 个表情包`,"success")},r=()=>{l.value=!0},C=()=>{o.value.size>0&&(g.value=!0)},M=()=>{v.value=!v.value,o.value.clear()},a=()=>{const T=m.value;T.every(c=>o.value.has(c.id))?T.forEach(c=>o.value.delete(c.id)):T.forEach(c=>o.value.add(c.id))},P=()=>{o.value.size!==0&&u.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{n.stickers=n.stickers.filter(T=>!o.value.has(T.id)),n.saveData(),o.value.clear()})},A=()=>{const T=h.value.trim();if(!T)return u.showToast("请输入目标分组","info");n.stickers.forEach(B=>{o.value.has(B.id)&&(B.group=T)}),n.saveData(),g.value=!1,h.value="",o.value.clear(),v.value=!1,p.value=T},D=()=>{if(o.value.size===0)return;const T=n.stickers.filter(R=>o.value.has(R.id)).map(R=>`${R.name} ${R.url}`).join(`
`),B=new Blob([T],{type:"text/plain"}),c=URL.createObjectURL(B),S=document.createElement("a");S.href=c,S.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(c),o.value.clear(),v.value=!1};return(T,B)=>(k(),w("div",null,[t.visible?(k(),w("div",Vt,[e("div",Lt,[e("div",Dt,[(k(!0),w(W,null,re(i.value,c=>(k(),w("div",{class:j(["sticker-group-tab",{active:p.value===c}]),key:c,onClick:S=>p.value=c},y(c),11,Rt))),128))])]),e("div",Et,[(k(!0),w(W,null,re(m.value,c=>(k(),w("div",{class:j(["sticker-item",{selected:o.value.has(c.id),"manage-mode":v.value}]),key:c.id,onClick:S=>I(c)},[e("img",{src:c.url,alt:c.name},null,8,Ut),e("span",null,y(c.name),1)],10,qt))),128))]),e("div",Nt,[J(e("div",{class:"sticker-add-btn",onClick:r},"＋",512),[[ke,!v.value]]),e("div",{class:"sticker-manage-btn",style:ce({color:v.value?"var(--danger-color)":"#576B95"}),onClick:M},y(v.value?"完成":"管理"),5)]),e("div",{class:j(["manage-bar",{active:v.value}])},[e("button",{class:"btn btn-secondary",onClick:r},"导入"),e("button",{class:"btn btn-secondary",onClick:a},"全选"),e("button",{class:"btn btn-secondary",onClick:C},"移动"),e("button",{class:"btn btn-secondary",onClick:D},"导出"),e("button",{class:"btn btn-danger",onClick:P},"删除")],2)])):F("",!0),U(Ce,{visible:l.value,"onUpdate:visible":B[0]||(B[0]=c=>l.value=c),type:"sticker-import",onImportSticker:d},null,8,["visible"]),U(de,{visible:g.value,"onUpdate:visible":B[3]||(B[3]=c=>g.value=c),title:"移动到分组"},{footer:Q(()=>[e("button",{class:"modal-btn cancel",onClick:B[2]||(B[2]=c=>g.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:A},"确定")]),default:Q(()=>[J(e("input",{type:"text",class:"base-input","onUpdate:modelValue":B[1]||(B[1]=c=>h.value=c),placeholder:"输入目标分组名称"},null,512),[[se,h.value]])]),_:1},8,["visible"])]))}},Ht=G(Ft,[["__scopeId","data-v-c6bef6fa"]]),jt={class:"chat-panel",id:"morePanel"},Ot={class:"more-panel-content"},zt={class:"more-label"},Wt={class:"more-label"},Gt={class:"more-label"},Yt={class:"more-label"},Jt={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:f}=oe();return(s,n)=>(k(),w("div",jt,[e("div",Ot,[e("div",{class:"more-item",onClick:n[0]||(n[0]=u=>s.$emit("trigger-image-upload"))},[n[4]||(n[4]=Te('<div class="more-icon" data-v-d00cc944><svg class="svg-icon" viewBox="0 0 24 24" data-v-d00cc944><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-d00cc944></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-d00cc944></circle><polyline points="21 15 16 10 5 21" data-v-d00cc944></polyline></svg></div>',1)),e("span",zt,y(x(f)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:n[1]||(n[1]=u=>s.$emit("start-video-call"))},[n[5]||(n[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Wt,y(x(f)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:n[2]||(n[2]=u=>s.$emit("send-location"))},[n[6]||(n[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",Gt,y(x(f)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:n[3]||(n[3]=u=>s.$emit("send-transfer"))},[n[7]||(n[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M8 5 L4 9 H20 M16 19 L20 15 H4"})])],-1)),e("span",Yt,y(x(f)("chat.morePanel.transfer")),1)])])]))}},Qt=G(Jt,[["__scopeId","data-v-d00cc944"]]),Kt={class:"chat-footer"},Xt={key:0,class:"quote-preview"},Zt={class:"quote-content"},_t={class:"quote-sender"},es={class:"quote-text"},ts={class:"chat-input-row"},ss={class:"chat-input-wrapper"},ns=["value","onKeydown"],os={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"24px",height:"24px",position:"relative",top:"1px",left:"-1px"}},as={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null},charId:{type:String,required:!0}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:f}){const{t:s}=oe(),n=Z(),u=t,p=f,v=V(u.activePanel);O(()=>u.activePanel,i=>{v.value=i}),O(v,i=>{p("update:activePanel",i)});const o=q(()=>{if(!u.quotingMessage)return"";if(u.quotingMessage.sender==="user")return s("chat.self");{const i=n.getCharacter(u.charId);return(i==null?void 0:i.nickname)||(i==null?void 0:i.name)||s("chat.other")}}),l=i=>{v.value===i?v.value=null:v.value=i},g=()=>{u.modelValue.trim()&&p("send-message")},h=i=>{p("send-sticker",i),v.value=null};return(i,m)=>(k(),w("div",Kt,[t.quotingMessage?(k(),w("div",Xt,[e("div",Zt,[e("span",_t,y(o.value)+": ",1),e("span",es,y(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:m[0]||(m[0]=I=>i.$emit("cancel-quote"))},[...m[9]||(m[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):F("",!0),e("div",ts,[e("div",{class:"chat-tool-btn",onClick:m[1]||(m[1]=I=>i.$emit("trigger-voice"))},[U(te,{name:"voice-circle",class:"svg-icon"})]),e("div",ss,[e("textarea",{class:"chat-input",value:t.modelValue,onInput:m[2]||(m[2]=I=>i.$emit("update:modelValue",I.target.value)),onKeydown:dt(z(g,["exact","prevent"]),["enter"]),id:"messageInput",autocomplete:"off",rows:"1"},null,40,ns)]),e("div",{class:"chat-tool-btn",onClick:m[3]||(m[3]=I=>l("sticker"))},[U(te,{name:"sticker",class:"svg-icon"})]),t.modelValue?(k(),w("div",{key:1,class:"send-btn-icon",onClick:g},[(k(),w("svg",os,[...m[10]||(m[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(k(),w("div",{key:0,class:"chat-tool-btn",onClick:m[4]||(m[4]=I=>l("more"))},[U(te,{name:"plus-circle",class:"svg-icon"})]))]),U(Ht,{visible:v.value==="sticker",onSendSticker:h},null,8,["visible"]),v.value==="more"?(k(),X(Qt,{key:1,onTriggerImageUpload:m[5]||(m[5]=I=>i.$emit("trigger-image")),onStartVideoCall:m[6]||(m[6]=I=>i.$emit("trigger-video")),onSendLocation:m[7]||(m[7]=I=>i.$emit("trigger-location")),onSendTransfer:m[8]||(m[8]=I=>i.$emit("trigger-transfer"))})):F("",!0)]))}},is=G(as,[["__scopeId","data-v-3da6a910"]]),ls={class:"menu-grid"},rs={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:f}){const s=t,n=f,u=ut("phoneScreenRef"),{t:p}=oe(),v=Z(),o=ne(),l=V(null),g=V({}),h=V(0),i=V("top");O(()=>s.visible,async d=>{d&&s.targetEl&&(await le(),m())});const m=()=>{const d=l.value;if(!d)return;const r=s.targetEl.getBoundingClientRect(),C=d.offsetWidth,M=d.offsetHeight,a=8,P=u.value,A=P?P.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};i.value="top";let D=r.top-M-a;D<A.top+a&&(i.value="bottom",D=r.bottom+a);const T=r.left+r.width/2;let B=T-C/2;B<A.left+a&&(B=A.left+a),B+C>A.left+A.width-a&&(B=A.left+A.width-C-a);let c=T-B;const S=12,R=S/2+5,Y=C-S/2-5;c=Math.max(R,Math.min(c,Y)),g.value={top:`${D}px`,left:`${B}px`},h.value=c},I=d=>{const r=s.messageId;if(!r)return;const C=v.messages[s.charId],M=C.findIndex(A=>A.id===r),a=C[M],P={copy:()=>{a.content&&(navigator.clipboard.writeText(a.content),o.showToast(p("chat.messageMenu.toast.copied")))},favorite:()=>{v.addToFavorites(s.charId,a),o.showToast(p("chat.messageMenu.toast.favorited"))},delete:()=>{o.showConfirm(p("chat.messageMenu.confirmDelete"),p("chat.messageMenu.confirmDeleteMsg"),()=>{v.messages[s.charId].splice(M,1),v.saveData()})},revoke:()=>{a&&(a.type="revoked",v.saveData(),o.showToast(p("chat.messageMenu.toast.revoked")))},select:()=>n("enter-selection-mode",r,s.targetEl),quote:()=>n("quote-message",r),retry:()=>{a.sender!=="user"?v.messages[s.charId].splice(M,1):v.retryFromMessage(s.charId,r),v.saveData(),n("trigger-ai-response")},edit:()=>{a.type==="text"?n("edit-message",r):o.showToast(p("chat.messageMenu.toast.editTextOnly"),"info")}};P[d]&&P[d](),n("close")};return(d,r)=>t.visible?(k(),w("div",{key:0,ref_key:"menuRef",ref:l,class:j(["message-menu",{"menu-top":i.value==="top","menu-bottom":i.value==="bottom"}]),style:ce(g.value)},[e("div",ls,[e("div",{class:"menu-item",onClick:r[0]||(r[0]=C=>I("copy"))},y(x(p)("copy")),1),e("div",{class:"menu-item",onClick:r[1]||(r[1]=C=>I("favorite"))},y(x(p)("favorite")),1),e("div",{class:"menu-item",onClick:r[2]||(r[2]=C=>I("delete"))},y(x(p)("delete")),1),e("div",{class:"menu-item",onClick:r[3]||(r[3]=C=>I("revoke"))},y(x(p)("revoke")),1),e("div",{class:"menu-item",onClick:r[4]||(r[4]=C=>I("select"))},y(x(p)("select")),1),e("div",{class:"menu-item",onClick:r[5]||(r[5]=C=>I("quote"))},y(x(p)("quote")),1),e("div",{class:"menu-item",onClick:r[6]||(r[6]=C=>I("retry"))},y(x(p)("retry")),1),e("div",{class:"menu-item",onClick:r[7]||(r[7]=C=>I("edit"))},y(x(p)("edit")),1)]),e("div",{class:"menu-arrow",style:ce({left:h.value+"px"})},null,4)],6)):F("",!0)}},cs=G(rs,[["__scopeId","data-v-611c1739"]]),ds={class:"chat-action-row"},us={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:f}=oe();return(s,n)=>(k(),w("div",ds,[e("div",{class:"action-btn",onClick:n[0]||(n[0]=u=>s.$emit("action","favorite"))},[n[4]||(n[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,y(x(f)("favorite")),1)]),e("div",{class:"action-btn",onClick:n[1]||(n[1]=u=>s.$emit("action","forward"))},[n[5]||(n[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,y(x(f)("forward")),1)]),e("div",{class:"action-btn",onClick:n[2]||(n[2]=u=>s.$emit("action","delete"))},[n[6]||(n[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,y(x(f)("delete")),1)]),e("div",{class:"action-btn",onClick:n[3]||(n[3]=u=>s.$emit("cancel"))},[n[7]||(n[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,y(x(f)("done")),1)])]))}},vs=G(us,[["__scopeId","data-v-be1a592f"]]),gs=["src"],ms={class:"msg-content-wrapper"},fs={class:"msg-bubble-box"},ps={key:0,class:"quote-in-bubble"},hs={class:"quote-in-bubble-sender"},ks={class:"quote-in-bubble-text"},bs={key:1,class:"edit-view"},ys={key:0},Ss={class:"description-placeholder"},Ms=["src"],ws={key:2,class:"sticker-msg"},$s=["src"],Cs={key:3,class:"voice-msg-wrapper"},Ts={class:"voice-msg"},xs={key:4,class:"location-msg"},Is={class:"location-text"},Ps={class:"msg-title"},As={class:"transfer-content"},Bs={class:"transfer-icon"},Vs={key:0,viewBox:"0 0 24 24",fill:"currentColor"},Ls={key:1,viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},Ds={class:"transfer-info"},Rs={class:"transfer-amount"},Es={class:"transfer-desc"},qs={class:"transfer-footer"},Us={key:6,class:"call-summary-msg"},Ns={key:0,class:"blocked-icon"},Fs={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","show-thought","accept-transfer"],setup(t,{emit:f}){const s=t,n=f,u=vt(),p=V(!1),v=V(!1),o=V(""),l=q(()=>s.editingMessageId===s.msg.id),g=q(()=>{const c=s.msg.type,S=c==="transfer"&&s.msg.status==="accepted";return{"no-style":["image","sticker","location","transfer"].includes(c),"has-location":c==="location","has-transfer":c==="transfer",accepted:S}}),h=q(()=>{if(s.msg.type!=="transfer")return{};const c=s.msg.status==="accepted",S=s.msg.sender==="user";return{"accepted-sender":c&&S,"accepted-receiver":c&&!S,pending:!c}}),i=q(()=>{if(s.msg.type!=="transfer")return"";const c=s.msg.sender==="user",S=s.msg.status==="accepted",R=s.msg.isReceived;return s.msg.note?s.msg.note:R?"已收款":S?"已被接收":c?"你发起了一笔转账":"请收款"}),m=q(()=>s.msg.type!=="transfer"?"":s.msg.isReceived?"已收款":s.msg.status==="accepted"?"已被接收":"微信转账");O(l,c=>{c&&(o.value=s.msg.content)});const I=c=>{n("long-press",c,s.msg.id)},d=()=>{n("cancel-long-press")},r=c=>{n("touch-move",c)},C=c=>{s.msg.type==="voice"&&a(),s.msg.type!=="image"&&n("click-msg",c,s.msg.id)},M=()=>{s.msg.sender!=="user"&&n("show-thought",s.msg.id)},a=()=>{p.value=!p.value},P=()=>{v.value=!v.value},A=()=>{o.value.trim()&&n("save-edit",{msgId:s.msg.id,newContent:o.value})},D=()=>{n("cancel-edit")},T=()=>s.msg.type==="notification"?s.msg.content:s.msg.type==="revoked"?`"${s.msg.sender==="user"?"你":s.charName}" 撤回了一条消息`:"",B=()=>{(s.msg.status==="pending"||s.msg.status===void 0)&&s.msg.sender!=="user"&&!s.isSelectionMode&&n("accept-transfer",s.msg.id)};return(c,S)=>(k(),w("div",{class:j(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[t.msg.type==="revoked"||t.msg.type==="notification"?(k(),w(W,{key:0},[e("div",{class:j(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:S[0]||(S[0]=z(R=>c.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),e("div",{class:"system-message-wrapper",onMousedown:I,onMouseup:d,onMouseleave:d,onTouchstart:I,onTouchend:d,onTouchmove:r,onClick:z(C,["prevent"])},[e("div",{class:"system-message-text",onClick:S[1]||(S[1]=z(R=>!t.isSelectionMode&&P(),["stop"]))},y(T()),1),t.msg.type==="revoked"?J((k(),w("div",{key:0,class:"revoked-content"},y(t.msg.sender==="user"?"我":t.charName)+"："+y(t.msg.content),513)),[[ke,v.value]]):F("",!0)],32)],64)):(k(),w(W,{key:1},[e("div",{class:"msg-avatar",onClick:M},[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(k(),w("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,gs)):(k(),w("div",{key:1,class:j(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",ms,[e("div",fs,[e("div",{class:j(["msg-bubble",g.value]),style:ce(t.bubbleStyle),onMousedown:I,onMouseup:d,onMouseleave:d,onTouchstart:I,onTouchend:d,onTouchmove:r,onClick:z(C,["prevent"])},[t.msg.quote?(k(),w("div",ps,[e("div",hs,y(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",ks,y(t.msg.quote.content),1)])):F("",!0),l.value?(k(),w("div",bs,[J(e("textarea",{"onUpdate:modelValue":S[2]||(S[2]=R=>o.value=R),class:"edit-textarea",rows:"3"},null,512),[[se,o.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:D,class:"edit-btn cancel"},"取消"),e("button",{onClick:A,class:"edit-btn save"},"保存")])])):(k(),w(W,{key:2},[t.msg.type==="text"?(k(),w("div",ys,y(t.msg.content),1)):t.msg.type==="image"?(k(),w(W,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(k(),w("div",{key:0,class:"text-generated-image-container",onClick:S[3]||(S[3]=R=>x(u).preview(t.msg))},[e("div",Ss,y(t.msg.content),1)])):(k(),w("div",{key:1,class:"image-msg",onClick:S[4]||(S[4]=R=>x(u).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,Ms)]))],64)):t.msg.type==="sticker"?(k(),w("div",ws,[e("img",{src:t.msg.content,alt:"表情包"},null,8,$s)])):t.msg.type==="voice"?(k(),w("div",Cs,[e("div",Ts,[U(te,{name:"voice-wave",class:j(["voice-icon-svg",{playing:p.value}])},null,8,["class"]),e("span",null,y(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(k(),w("div",xs,[e("div",Is,[e("div",Ps,y(t.msg.content||"位置信息"),1),S[6]||(S[6]=e("div",{class:"msg-desc"},"详细地址",-1))]),S[7]||(S[7]=Te('<div class="location-map" data-v-219f64dd><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-219f64dd><div class="location-pin" data-v-219f64dd><svg viewBox="0 0 24 24" fill="currentColor" data-v-219f64dd><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-219f64dd></path></svg></div></div>',1))])):t.msg.type==="transfer"?(k(),w("div",{key:5,class:j(["transfer-msg",h.value]),onClick:z(B,["stop"])},[e("div",As,[e("div",Bs,[t.msg.status==="accepted"||t.msg.isReceived?(k(),w("svg",Vs,[...S[8]||(S[8]=[e("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"},null,-1)])])):(k(),w("svg",Ls,[...S[9]||(S[9]=[e("path",{d:"M8 5 L4 9 H20 M16 19 L20 15 H4"},null,-1)])]))]),e("div",Ds,[e("div",Rs,"¥"+y(t.msg.content),1),e("div",Es,y(i.value),1)])]),e("div",qs,y(m.value),1)],2)):t.msg.type==="call_summary"?(k(),w("div",Us,[S[10]||(S[10]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,y(t.msg.content),1)])):F("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(k(),w("div",Ns,[...S[11]||(S[11]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):F("",!0)]),t.msg.type==="voice"?J((k(),w("div",{key:0,class:"voice-text"},y(t.msg.content),513)),[[ke,p.value]]):F("",!0)]),e("div",{class:j(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:S[5]||(S[5]=z(R=>c.$emit("toggle-selection",t.msg.id),["stop"]))},null,2)],64))],2))}},Hs=G(Fs,[["__scopeId","data-v-219f64dd"]]),js={key:0,class:"empty-message"},Os={key:0,class:"timestamp"},zs={key:0,class:"blocked-overlay"},Ws={class:"blocked-content"},Gs=5*60*1e3,Ys={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content","show-thought","accept-transfer"],setup(t,{expose:f}){const s=t,n=V(null),u=o=>{if(o===0)return!0;const l=s.messages[o],g=s.messages[o-1];if(!l.timestamp||!g.timestamp)return!1;const h=new Date(l.timestamp).getTime(),i=new Date(g.timestamp).getTime();return h-i>Gs},p=o=>{if(!o)return"";const l=new Date(o),g=new Date,h=new Date(g.getFullYear(),g.getMonth(),g.getDate()),i=new Date(h.getTime()-864e5),m=g.getDay()===0?7:g.getDay(),I=new Date(h.getTime()-(m-1)*864e5),d=l.getHours().toString().padStart(2,"0"),r=l.getMinutes().toString().padStart(2,"0"),C=`${d}:${r}`;if(l.getTime()>=h.getTime())return C;if(l.getTime()>=i.getTime())return`昨天 ${C}`;if(l.getTime()>=I.getTime())return`${["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][l.getDay()]} ${C}`;{const M=l.getFullYear(),a=(l.getMonth()+1).toString(),P=l.getDate().toString();return M===g.getFullYear()?`${a}月${P}日 ${C}`:`${M}年${a}月${P}日 ${C}`}},v=()=>{n.value&&(n.value.scrollTop=n.value.scrollHeight)};return O(()=>s.messages,()=>{le(()=>{v()})},{deep:!0}),O(()=>s.activePanel,o=>{o&&le(()=>{v()})}),ye(()=>{v()}),f({scrollToBottom:v}),(o,l)=>(k(),w(W,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:n},[t.messages.length===0?(k(),w("div",js," 开始和 "+y(t.charName)+" 聊天吧~ ",1)):F("",!0),(k(!0),w(W,null,re(t.messages,(g,h)=>(k(),w(W,{key:g.id},[u(h)?(k(),w("div",Os,y(p(g.timestamp)),1)):F("",!0),U(Hs,{msg:g,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(g.id),editingMessageId:t.editingMessageId,onSaveEdit:l[0]||(l[0]=i=>o.$emit("save-edit",i)),onCancelEdit:l[1]||(l[1]=i=>o.$emit("cancel-edit")),onToggleSelection:l[2]||(l[2]=i=>o.$emit("toggle-selection",i)),onLongPress:l[3]||(l[3]=(i,m)=>o.$emit("long-press",i,m)),onCancelLongPress:l[4]||(l[4]=i=>o.$emit("cancel-long-press")),onTouchMove:l[5]||(l[5]=i=>o.$emit("touch-move",i)),onClickMsg:l[6]||(l[6]=(i,m)=>o.$emit("click-msg",i,m)),onShowTextContent:l[7]||(l[7]=i=>o.$emit("show-text-content",i)),onShowThought:l[8]||(l[8]=i=>o.$emit("show-thought",i)),onAcceptTransfer:l[9]||(l[9]=i=>o.$emit("accept-transfer",i))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"])],64))),128))],512),t.isBlocked?(k(),w("div",zs,[e("div",Ws,[l[11]||(l[11]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:l[10]||(l[10]=g=>o.$emit("unblock"))},"解除拉黑")])])):F("",!0)],64))}},Js=G(Ys,[["__scopeId","data-v-deb1a117"]]),Qs={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:f}){const s=t,n=f,u=q({get:()=>s.visible,set:o=>n("update:visible",o)}),p=V("");O(()=>s.visible,o=>{o&&(p.value="")});const v=()=>{const o=p.value.trim();n("confirm",o),u.value=!1};return(o,l)=>(k(),X(de,{visible:u.value,"onUpdate:visible":l[2]||(l[2]=g=>u.value=g),title:"发送语音"},{footer:Q(()=>[e("button",{class:"modal-btn cancel",onClick:l[1]||(l[1]=g=>u.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:v},"发送")]),default:Q(()=>[J(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[0]||(l[0]=g=>p.value=g),placeholder:"输入语音内容..."},null,512),[[se,p.value]])]),_:1},8,["visible"]))}},Ks={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:f}){const s=t,n=f,u=q({get:()=>s.visible,set:l=>n("update:visible",l)}),p=V(""),v=V("");O(()=>s.visible,l=>{l&&(p.value="",v.value="")});const o=()=>{const l=p.value.trim(),g=v.value.trim();l&&(n("confirm",{name:l,detail:g}),u.value=!1)};return(l,g)=>(k(),X(de,{visible:u.value,"onUpdate:visible":g[3]||(g[3]=h=>u.value=h),title:"发送位置"},{footer:Q(()=>[e("button",{class:"modal-btn cancel",onClick:g[2]||(g[2]=z(h=>u.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:o},"发送")]),default:Q(()=>[J(e("input",{type:"text",class:"base-input","onUpdate:modelValue":g[0]||(g[0]=h=>p.value=h),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[se,p.value]]),J(e("input",{type:"text",class:"base-input","onUpdate:modelValue":g[1]||(g[1]=h=>v.value=h),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[se,v.value]])]),_:1},8,["visible"]))}},Xs={class:"chat-list-container"},Zs=["onClick"],_s=["src"],en={class:"chat-info"},tn={class:"chat-name"},sn=["disabled"],nn={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:f}){const s=t,n=f,u=Z(),p=V(s.visible),v=V(new Set),o=q(()=>u.characters);O(()=>s.visible,h=>{p.value=h,h||v.value.clear()});const l=h=>{v.value.has(h)?v.value.delete(h):v.value.add(h)},g=()=>{v.value.size>0&&n("confirm",Array.from(v.value))};return(h,i)=>(k(),X(de,{visible:p.value,"onUpdate:visible":i[1]||(i[1]=m=>p.value=m),title:"选择聊天",onClose:i[2]||(i[2]=m=>h.$emit("close"))},{footer:Q(()=>[e("button",{class:"modal-btn cancel",onClick:i[0]||(i[0]=m=>h.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:v.value.size===0,onClick:g}," 确定 ("+y(v.value.size)+") ",9,sn)]),default:Q(()=>[e("div",Xs,[(k(!0),w(W,null,re(o.value,m=>(k(),w("div",{key:m.id,class:"chat-item",onClick:I=>l(m.id)},[e("img",{src:m.avatar,alt:"avatar",class:"avatar"},null,8,_s),e("div",en,[e("div",tn,y(m.name),1)]),e("div",{class:j(["checkbox",{selected:v.value.has(m.id)}])},null,2)],8,Zs))),128))])]),_:1},8,["visible"]))}},on=G(nn,[["__scopeId","data-v-00bcf675"]]),an={class:"note-container"},ln={key:0,class:"content-wrapper"},rn={class:"note-header current-header"},cn=["src"],dn={key:1,class:"avatar-placeholder"},un={class:"character-name"},vn={class:"content-body"},gn={class:"status-section"},mn={class:"status-row"},fn={class:"status-value"},pn={class:"status-row"},hn={class:"status-value"},kn={class:"status-row"},bn={class:"status-value"},yn={class:"inner-voice-section"},Sn={class:"inner-voice-box"},Mn={class:"unspoken-section"},wn={class:"unspoken-text"},$n={key:1,class:"content-wrapper history-wrapper"},Cn={class:"note-header history-header"},Tn={class:"scroll-container"},xn={class:"item-header"},In={class:"header-left"},Pn=["onClick"],An={key:0,viewBox:"0 0 24 24",width:"16",height:"16",fill:"#f39c12",stroke:"#f39c12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Bn={key:1,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"#ccc","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Vn={class:"header-right"},Ln={class:"item-date"},Dn=["onClick"],Rn={class:"prop-row"},En={class:"prop-row"},qn={class:"prop-row"},Un={class:"prop-row"},Nn={class:"prop-row"},Fn={__name:"SingleCharStatus",props:{visible:{type:Boolean,default:!1},name:{type:String,default:""},avatar:{type:String,default:""},charId:{type:String,required:!0}},emits:["close"],setup(t,{emit:f}){const s=t,n=Z(),u=ne(),{currentInnerVoice:p,innerVoices:v}=gt(n),o=q(()=>p.value[s.charId]||{emotion:"",outfit:"",posture:"",innerVoice:"",unspokenWords:""}),l=q(()=>v.value[s.charId]||[]),g=M=>n.favorites?n.favorites.some(a=>String(a.charId)===String(s.charId)&&a.type==="thoughts"&&a.originalId===M.id):!1,h=M=>{n.toggleThoughtFavorite(s.charId,M)},i=M=>{u.showConfirm("删除心声","确定要删除这条心声记录吗？",()=>{n.deleteInnerVoice(s.charId,M.id)})},m=M=>M?new Date(M).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"."):"",I=f,d=V(!1),r=()=>{d.value=!d.value};O(()=>s.visible,M=>{M?(document.body.style.overflow="hidden",d.value=!1):document.body.style.overflow=""});const C=()=>{I("close")};return(M,a)=>t.visible?(k(),w("div",{key:0,class:"note-modal-mask",onClick:z(C,["self"])},[e("div",an,[e("div",{class:"tape-button",onClick:r}),e("div",{class:j(["note",{"history-mode":d.value}])},[a[13]||(a[13]=e("div",{class:"paper-texture"},null,-1)),d.value?(k(),w("div",$n,[e("div",Cn,[a[5]||(a[5]=e("div",{class:"header-title"},"历史心声",-1)),e("button",{class:"close-btn",onClick:C},[U(te,{name:"x-mark"})])]),e("div",Tn,[(k(!0),w(W,null,re(l.value,P=>(k(),w("div",{key:P.id,class:"history-item"},[e("div",xn,[e("div",In,[e("button",{class:"star-btn",onClick:z(A=>h(P),["stop"])},[g(P)?(k(),w("svg",An,[...a[6]||(a[6]=[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"},null,-1)])])):(k(),w("svg",Bn,[...a[7]||(a[7]=[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"},null,-1)])]))],8,Pn),e("span",null,y(P.title),1)]),e("div",Vn,[e("span",Ln,y(m(P.timestamp)),1),e("button",{class:"delete-btn",onClick:z(A=>i(P),["stop"])},[U(te,{name:"x-mark"})],8,Dn)])]),e("div",Rn,[a[8]||(a[8]=e("span",{class:"prop-label"},"情绪：",-1)),ie(y(P.emotion),1)]),e("div",En,[a[9]||(a[9]=e("span",{class:"prop-label"},"穿着：",-1)),ie(y(P.outfit),1)]),e("div",qn,[a[10]||(a[10]=e("span",{class:"prop-label"},"姿态：",-1)),ie(y(P.posture),1)]),e("div",Un,[a[11]||(a[11]=e("span",{class:"prop-label"},"内心独白：",-1)),ie(y(P.innerVoice),1)]),e("div",Nn,[a[12]||(a[12]=e("span",{class:"prop-label"},"没说出口的话：",-1)),ie(y(P.unspokenWords),1)])]))),128))])])):(k(),w("div",ln,[e("div",rn,[t.avatar?(k(),w("img",{key:0,src:t.avatar,class:"avatar-img",alt:"avatar"},null,8,cn)):(k(),w("div",dn,y(t.name?t.name.charAt(0):"?"),1)),e("div",un,y(t.name),1),e("button",{class:"close-btn",onClick:C},[U(te,{name:"x-mark"})])]),e("div",vn,[e("div",gn,[e("div",mn,[a[0]||(a[0]=e("span",{class:"status-label"},"情绪",-1)),e("span",fn,y(o.value.emotion||"无"),1)]),e("div",pn,[a[1]||(a[1]=e("span",{class:"status-label"},"穿着",-1)),e("span",hn,y(o.value.outfit||"无"),1)]),e("div",kn,[a[2]||(a[2]=e("span",{class:"status-label"},"姿态",-1)),e("span",bn,y(o.value.posture||"无"),1)])]),e("div",yn,[a[3]||(a[3]=e("div",{class:"section-title"},"Inner Voice",-1)),e("div",Sn,[e("p",null,y(o.value.innerVoice||"（没有内心独白）"),1)])]),e("div",Mn,[a[4]||(a[4]=e("div",{class:"unspoken-title"},"没说出口的话",-1)),e("div",wn,y(o.value.unspokenWords||"（没有想说的话）"),1)])])])),a[14]||(a[14]=e("div",{class:"torn-edge"},null,-1))],2)])])):F("",!0)}},Hn=G(Fn,[["__scopeId","data-v-8a1bd83a"]]),jn={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const f=t,s=be(),{t:n}=oe(),u=Z(),p=ne(),v=mt(),o=ft(),l=V(null),g=V(null),h=V(null),i=V(!1),m=V({visible:!1,messageId:null,targetEl:null}),I=V(!1),d=V(!1),r=V(!1),C=V(!1);V("");const M=V(!1),a=q(()=>u.getCharacter(f.charId)),P=q(()=>{var $;return(($=a.value)==null?void 0:$.isBlocked)||!1}),A=q(()=>{var $,b;return(($=a.value)==null?void 0:$.nickname)||((b=a.value)==null?void 0:b.name)||n("chat.unknownCharacter")}),D=q(()=>{var $;return(($=a.value)==null?void 0:$.name)||n("chat.unknownCharacter")}),T=q(()=>{var $;return($=a.value)==null?void 0:$.avatar}),B=q(()=>{var $;return(($=a.value)==null?void 0:$.status)||{}}),c=q(()=>{var $;return(($=a.value)==null?void 0:$.chatBackground)||""}),S=q(()=>{const $=a.value;if(!$||!$.userPersona)return"";const b=u.userPersonas.find(E=>E.id===$.userPersona);return(b==null?void 0:b.avatar)||""}),R=q(()=>u.messages[f.charId]||[]),Y=q(()=>{var $;return(($=a.value)==null?void 0:$.bubbleSettings)||{}}),{isSelectionMode:L,selectedMessageIds:N,isForwarding:H,enterSelectionMode:ee,exitSelectionMode:_,toggleMessageSelection:ge,handleBatchAction:K,handleConfirmForward:me}=kt(ve(f,"charId")),{isTyping:xe,triggerAiResponse:Se}=bt(ve(f,"charId"),v),{inputText:ue,quotingMessage:fe,sendMessage:Ie,sendSticker:Pe,sendVoiceMessage:Ae,handleSendImage:Be,confirmSendLocation:Ve,sendTransfer:Le}=St(u,ve(f,"charId"),p,h),{editingMessageId:Me,handleEditMessage:De,handleSaveEdit:Re,updateInputText:Ee}=yt(u,ve(f,"charId"),ue),{startLongPress:qe,cancelLongPress:Ue,handleTouchMove:Ne,wasClickAfterLongPress:Fe}=Mt(m),He=q(()=>{const $=Y.value,b={fontSize:$.fontSize?`${$.fontSize}px`:"14px"};if($.css){const E={};return $.css.split(";").forEach(ae=>{const pe=ae.split(":");if(pe.length>=2){const we=pe[0].trim(),$e=pe.slice(1).join(":").trim();we&&$e&&(E[we]=$e)}}),{...b,...E}}return b});O(i,$=>{$&&(s.push({name:"single-chat-settings",params:{id:f.charId}}),i.value=!1)}),O(()=>{var $;return($=u.messages[f.charId])==null?void 0:$.length},()=>{u.clearUnreadCount(f.charId)}),ye(()=>{u.clearUnreadCount(f.charId)});const je=()=>{a.value&&(a.value.isBlocked=!1,u.messages[f.charId]&&u.messages[f.charId].forEach($=>{$.blocked&&($.blocked=!1)}),u.saveData(),p.showToast(n("chat.toast.unblocked")))},Oe=$=>{const b=$.target;b.closest(".modal-overlay.active")||(h.value&&!b.closest(".chat-footer")&&(h.value=null),L.value&&!b.closest(".message")&&!b.closest(".chat-action-row")&&!b.closest(".message-checkbox")&&!b.closest(".message-menu")&&_(),m.value.visible&&!b.closest(".message-menu")&&(m.value.visible=!1))},ze=($,b)=>{if(Fe()){$.preventDefault(),$.stopPropagation();return}L.value&&ge(b)},We=$=>{const b=R.value.find(E=>E.id===$);b&&(fe.value=b)},Ge=()=>{d.value=!0},Ye=$=>{Ae($),d.value=!1},Je=()=>{h.value=null,I.value=!0},Qe=()=>{r.value=!0},Ke=({name:$,detail:b})=>{Ve($,b),r.value=!1},Xe=()=>{u.startVideoCall(f.charId,"user")},Ze=()=>{C.value=!0},_e=()=>{M.value=!0},et=({amount:$,note:b})=>{o.consume($,`转账 - 转给 ${A.value}`)?(Le($,b),M.value=!1):p.showToast("余额不足","error")},tt=$=>{const b=R.value.find(ae=>ae.id===$),E=(b==null?void 0:b.status)==="pending"||(b==null?void 0:b.status)===void 0;if(b&&b.type==="transfer"&&E){if(b.sender!=="user"){const ae=parseFloat(b.content);o.income(ae,`转账 - 来自 ${A.value} `)?u.acceptTransfer(f.charId,$):p.showToast("收款失败","error")}}else u.acceptTransfer(f.charId,$)};return($,b)=>(k(),w("div",{class:j(["chat-room active",{"selection-mode":x(L)}]),onClick:Oe,ref_key:"chatRoomRef",ref:g},[e("div",{class:"chat-bg",style:ce(c.value?{backgroundImage:`url(${c.value})`}:{})},null,4),U(Bt,{charId:f.charId,charName:A.value,charStatus:B.value,isTyping:x(xe),onTriggerAi:x(Se),onOpenSettings:b[0]||(b[0]=E=>i.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),U(Js,{ref_key:"messageListRef",ref:l,messages:R.value,charName:A.value,charAvatar:T.value,userAvatar:S.value,bubbleStyle:He.value,isSelectionMode:x(L),selectedMessageIds:x(N),isBlocked:P.value,editingMessageId:x(Me),activePanel:h.value,onSaveEdit:x(Re),onCancelEdit:b[1]||(b[1]=E=>Me.value=null),onToggleSelection:x(ge),onLongPress:x(qe),onCancelLongPress:x(Ue),onTouchMove:x(Ne),onClickMsg:ze,onUnblock:je,onShowThought:Ze,onAcceptTransfer:tt},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),x(L)?F("",!0):(k(),X(is,{key:0,modelValue:x(ue),"onUpdate:modelValue":b[2]||(b[2]=E=>pt(ue)?ue.value=E:null),activePanel:h.value,"onUpdate:activePanel":b[3]||(b[3]=E=>h.value=E),charId:f.charId,quotingMessage:x(fe),onCancelQuote:b[4]||(b[4]=E=>fe.value=null),onSendMessage:x(Ie),onSendSticker:x(Pe),onTriggerVoice:Ge,onTriggerImage:Je,onTriggerVideo:Xe,onTriggerLocation:Qe,onTriggerTransfer:_e},null,8,["modelValue","activePanel","charId","quotingMessage","onSendMessage","onSendSticker"])),x(L)?(k(),X(vs,{key:1,onAction:x(K),onCancel:x(_)},null,8,["onAction","onCancel"])):F("",!0),U(Qs,{visible:d.value,"onUpdate:visible":b[5]||(b[5]=E=>d.value=E),onConfirm:Ye},null,8,["visible"]),U(Ce,{visible:I.value,"onUpdate:visible":b[6]||(b[6]=E=>I.value=E),onSendImage:x(Be)},null,8,["visible","onSendImage"]),U(Ks,{visible:r.value,"onUpdate:visible":b[7]||(b[7]=E=>r.value=E),onConfirm:Ke},null,8,["visible"]),U(cs,{visible:m.value.visible,targetEl:m.value.targetEl,messageId:m.value.messageId,charId:f.charId,isSelectionMode:x(L),selectedMessageIds:x(N),onClose:b[8]||(b[8]=E=>m.value.visible=!1),onEnterSelectionMode:x(ee),onTriggerAiResponse:x(Se),"onUpdate:inputText":x(Ee),onQuoteMessage:We,onEditMessage:x(De)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),U(on,{visible:x(H),onClose:b[9]||(b[9]=E=>H.value=!1),onConfirm:x(me)},null,8,["visible","onConfirm"]),U(Hn,{visible:C.value,name:D.value,avatar:T.value,charId:f.charId,onClose:b[10]||(b[10]=E=>C.value=!1)},null,8,["visible","name","avatar","charId"]),U(ht,{visible:M.value,"onUpdate:visible":b[11]||(b[11]=E=>M.value=E),targetName:A.value,targetAvatar:T.value,onConfirm:et},null,8,["visible","targetName","targetAvatar"])],2))}},Wn=G(jn,[["__scopeId","data-v-47e2e1dc"]]);export{Wn as default};
