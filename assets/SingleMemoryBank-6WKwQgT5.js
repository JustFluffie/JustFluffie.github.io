import{_ as W,m as X,q as Z,Q as ee,r as l,u as te,c as D,d as se,w as r,a3 as ae,i as oe,g as ne,o as b,e as t,f as u,a as F,z as g,F as le,A as ie,S as y,n as re,v as $,x as I}from"./index-TjeMOTEi.js";const ue={class:"header-actions"},ce={class:"memory-bank-content"},de={class:"memory-scroll-container"},ve={key:0,class:"empty-state"},me={class:"empty-text"},fe={key:1,class:"memory-list"},pe={class:"card-header-row"},he={class:"header-left"},be={class:"char-info",style:{"padding-left":"8px"}},ge={class:"char-name"},ye={class:"save-time"},_e={class:"header-right"},xe=["onClick"],Se=["onClick"],ke=["onClick","title"],we={class:"card-content-row"},Me={class:"refine-range-info"},Ce={class:"refine-range-inputs"},De={__name:"SingleMemoryBank",setup(Fe){const A=te();oe();const f=X(),d=Z(),P=ee(),z=l(A.params.charId),N=l(!1),p=l(!1),v=l(-1),i=l(""),_=l(!1),x=l(-1),S=l(!1),h=l(""),k=l(1),w=l(0),m=D(()=>f.getCharacter(z.value)),n=D(()=>{var s;return((s=m.value)==null?void 0:s.memories)||[]}),R=D(()=>{var s;return((s=m.value)==null?void 0:s.name)||"角色"}),T=D(()=>[...N.value?n.value.filter(e=>e.isFavorite):n.value].sort((e,o)=>(o.time||0)-(e.time||0))),U=()=>{p.value=!1,i.value=""},B=()=>{_.value=!1,x.value=-1},V=()=>{S.value=!1},E=s=>{if(!s)return"";const e=new Date(s);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},O=()=>{v.value=-1,i.value="",p.value=!0},j=s=>{const e=n.value.findIndex(o=>o.id===s.id);e!==-1&&(v.value=e,i.value=s.content,p.value=!0)},q=()=>{if(!i.value.trim())return;const s=m.value;if(s.memories||(s.memories=[]),v.value>=0){const e=s.memories[v.value];typeof e=="string"?s.memories[v.value]={content:i.value,time:Date.now(),charName:s.name,isFavorite:!1}:e.content=i.value}else s.memories.unshift({content:i.value,time:Date.now(),charName:s.name,isFavorite:!1});f.saveData(),U()},G=s=>{const e=n.value.findIndex(o=>o.id===s.id);e!==-1&&(x.value=e,_.value=!0)},H=()=>{x.value>=0&&(m.value.memories.splice(x.value,1),f.saveData()),B()},L=s=>{const e=n.value.find(o=>o.id===s.id);if(e){if(typeof e=="string"){const o=n.value.indexOf(e);n.value[o]={content:e,time:Date.now(),charName:R.value,isFavorite:!0}}else e.isFavorite=!e.isFavorite;f.saveData()}},Q=()=>{h.value=m.value.memorySummaryPrompt||"",k.value=1,w.value=n.value.length,S.value=!0},Y=async()=>{const s=m.value;if(!s)return;const e=n.value.length,o=Math.max(1,k.value),a=Math.min(e,w.value);if(o>a){d.showToast("起始范围不能大于结束范围","error");return}s.memorySummaryPrompt=h.value,d.showToast("正在提炼记忆...","info"),V();const M=n.value.slice(o-1,a);if(M.length===0){d.showToast("选定范围内没有记忆可供提炼","warn");return}const C=M.map(c=>c.content).join(`
---
`),J=h.value||"请总结以下内容，提取关键信息。",K=[{role:"system",content:"你是一个记忆总结助手。"},{role:"user",content:`现有记忆如下：
${C}

请根据以下要求进行总结：
${J}`}];try{const c=await P.getGenericCompletion(K);c?(s.memories||(s.memories=[]),s.memories.unshift({content:`[记忆再总结] ${c}`,time:Date.now(),charName:s.name,isFavorite:!1}),f.saveData(),d.showToast("记忆提炼已完成","success")):d.showToast("提炼失败，未收到有效回复","error")}catch(c){console.error("记忆提炼失败:",c),d.showToast(`提炼失败: ${c.message}`,"error")}};return(s,e)=>{const o=ne("Modal");return b(),se(ae,{title:"长期记忆"},{action:r(()=>[t("div",ue,[t("button",{class:"icon-btn",onClick:Q,title:"提炼"},[u(y,{name:"Sparkles"})]),t("button",{class:"icon-btn",onClick:O,title:"添加"},[u(y,{name:"plus"})])])]),default:r(()=>[t("div",ce,[t("div",de,[!T.value||T.value.length===0?(b(),F("div",ve,[t("div",me,g(N.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(b(),F("div",fe,[(b(!0),F(le,null,ie(T.value,(a,M)=>(b(),F("div",{key:a.id||M,class:"card memory-card"},[t("div",pe,[t("div",he,[t("div",be,[t("span",ge,g(a.charName||R.value),1),t("span",ye,g(E(a.time)),1)])]),t("div",_e,[t("button",{class:"icon-btn",onClick:C=>j(a),title:"编辑"},[u(y,{name:"pencil"})],8,xe),t("button",{class:"icon-btn danger",onClick:C=>G(a),title:"删除"},[u(y,{name:"trash"})],8,Se),t("button",{class:"icon-btn favorite-btn",onClick:C=>L(a),title:a.isFavorite?"取消收藏":"收藏"},[u(y,{name:a.isFavorite?"heart-solid":"heart",class:re({"is-favorite":a.isFavorite})},null,8,["name","class"])],8,ke)])]),t("div",we,g(a.content),1)]))),128))]))])]),u(o,{visible:p.value,"onUpdate:visible":e[1]||(e[1]=a=>p.value=a),title:v.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:r(()=>[t("button",{class:"modal-btn cancel",onClick:U},"取消"),t("button",{class:"modal-btn confirm",onClick:q},"确定")]),default:r(()=>[$(t("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[0]||(e[0]=a=>i.value=a),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[I,i.value]])]),_:1},8,["visible","title"]),u(o,{visible:_.value,"onUpdate:visible":e[2]||(e[2]=a=>_.value=a),title:"确认删除",class:"nested"},{footer:r(()=>[t("button",{class:"modal-btn cancel",onClick:B},"取消"),t("button",{class:"modal-btn confirm danger",onClick:H},"确认删除")]),default:r(()=>[e[7]||(e[7]=t("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),u(o,{visible:S.value,"onUpdate:visible":e[6]||(e[6]=a=>S.value=a),title:"记忆提炼",class:"nested"},{footer:r(()=>[t("button",{class:"modal-btn cancel",onClick:V},"取消"),t("button",{class:"modal-btn confirm",onClick:Y},"开始提炼")]),default:r(()=>[t("div",Me," 当前共有 "+g(n.value.length)+" 条记忆。 ",1),t("div",Ce,[e[8]||(e[8]=t("label",{for:"refine-start"},"从第",-1)),$(t("input",{id:"refine-start",type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>k.value=a),class:"base-input range-input"},null,512),[[I,k.value,void 0,{number:!0}]]),e[9]||(e[9]=t("label",{for:"refine-end"},"条 到 第",-1)),$(t("input",{id:"refine-end",type:"number","onUpdate:modelValue":e[4]||(e[4]=a=>w.value=a),class:"base-input range-input"},null,512),[[I,w.value,void 0,{number:!0}]]),e[10]||(e[10]=t("label",null,"条",-1))]),e[11]||(e[11]=t("p",{class:"summary-tip"},"将对选定范围内的长期记忆进行再总结。",-1)),$(t("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[5]||(e[5]=a=>h.value=a),placeholder:"输入总结提示词...",style:{height:"100px"}},null,512),[[I,h.value]])]),_:1},8,["visible"])]),_:1})}}},Ie=W(De,[["__scopeId","data-v-255d3819"]]);export{Ie as default};
