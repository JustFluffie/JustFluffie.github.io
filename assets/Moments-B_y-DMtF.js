import{_ as ce,s as me,Q as Ue,r as m,c as B,a1 as Pe,b as r,o as i,f as n,D as O,d as g,A as v,n as de,F as A,B as F,C as p,j,T as Q,E as ve,u as Le,t as Be,U as Oe,a2 as ze,x as re,v as De,a3 as Ae,P as Ee,g as q,y as J,z as X,O as Ne,N as Ve,w as H,M as ue,e as Re}from"./index-JvTCRUPv.js";import je from"./PostMoment-Cwg1YRFh.js";const qe={class:"moment-content"},He={class:"moment-name"},Fe={key:0,class:"moment-text"},Ge=["onClick"],Ye=["src"],Ke=["onClick"],We={class:"text-inner-scroll"},Qe={key:2,class:"moment-remind"},Je={key:3,class:"moment-visibility"},Xe={key:0},Ze={key:1},_e={class:"moment-footer"},et={class:"time-and-location"},tt={class:"time"},nt={key:0,class:"moment-location"},ot={class:"actions"},st={key:0,class:"action-menu"},lt={key:4,class:"moment-interactions"},at={key:0,class:"likes-list"},it={key:1,class:"comments-list"},rt=["onClick"],ut={class:"comment-user"},ct={key:0,class:"comment-reply"},mt={class:"comment-user"},dt={class:"comment-content"},vt={__name:"MomentItem",props:{moment:{type:Object,required:!0},currentUserAvatar:String,currentUserName:String,isMenuOpen:Boolean},emits:["toggle-menu","like","comment","reply","long-press"],setup(s,{emit:G}){const h=s,c=G,x=me(),$=Ue(),{getImageUrl:z,preview:C}=$,S=m([]),w=m(null),U=a=>{if(a==="user")return h.currentUserAvatar;const o=x.getCharacter(a);return o?o.avatar:""},k=a=>{if(a==="user")return h.currentUserName;const o=x.getCharacter(a);return o?o.name:"未知用户"},Y=a=>{const o=Date.now()-a;if(o<6e4)return"刚刚";if(o<36e5)return`${Math.floor(o/6e4)}分钟前`;if(o<864e5)return`${Math.floor(o/36e5)}小时前`;const l=new Date(a);return`${l.getMonth()+1}月${l.getDate()}日`},b=a=>{if(!a||a.isTextGenerated)return!1;const o=a.content||a.url;return typeof o=="string"&&(o.startsWith("http")||o.startsWith("data:image"))},D=B(()=>h.moment.likes.includes("user")),y=()=>{c("toggle-menu",h.moment.id)},P=()=>{c("like",h.moment)},M=()=>{c("comment",h.moment)},E=a=>{c("reply",h.moment,a)},I=a=>{a.target.closest(".image-item, .action-btn, .action-menu")||(w.value=setTimeout(()=>{c("long-press",h.moment)},600))},T=()=>{w.value&&clearTimeout(w.value),w.value=null},N=()=>{ve(()=>{S.value.forEach(a=>{a&&a.classList.toggle("is-overflowing",a.scrollHeight>a.clientHeight)})})};return Pe(()=>{N()}),(a,o)=>(i(),r("div",{class:"moment-item",onTouchstart:I,onTouchend:T,onMousedown:I,onMouseup:T,onContextmenu:o[0]||(o[0]=p(()=>{},["prevent"]))},[n("div",{class:"moment-avatar",style:O({backgroundImage:`url(${U(s.moment.userId)})`})},null,4),n("div",qe,[n("div",He,v(k(s.moment.userId)),1),s.moment.content?(i(),r("div",Fe,v(s.moment.content),1)):g("",!0),s.moment.images&&s.moment.images.length>0?(i(),r("div",{key:1,class:de(["moment-images",[`grid-${s.moment.images.length}`,{"single-image":s.moment.images.length===1}]])},[(i(!0),r(A,null,F(s.moment.images,(l,f)=>(i(),r(A,{key:f},[s.moment.images.length===1&&!l.isTextGenerated?(i(),r("div",{key:0,class:"moment-single-image-adaptive",onClick:p(d=>j(C)(l),["stop"])},[n("img",{src:j(z)(l),alt:"moment image"},null,8,Ye)],8,Ge)):(i(),r("div",{key:1,class:"image-item",style:O({backgroundImage:b(l)?`url(${j(z)(l)})`:"none",backgroundColor:l.isTextGenerated?"var(--text-quaternary)":"#e7e7e7"}),onClick:p(d=>j(C)(l),["stop"])},[l.isTextGenerated?(i(),r("div",{key:0,class:"moment-text-placeholder",ref_for:!0,ref:d=>{d&&(S.value[f]=d)}},[n("div",We,v(s.moment.images.length>1?`第${f+1}张图片`:"一张图片"),1)],512)):g("",!0)],12,Ke))],64))),128))],2)):g("",!0),s.moment.remind&&s.moment.remind.length>0?(i(),r("div",Qe," 提到了: "+v(s.moment.remind.map(l=>k(l)).join(", ")),1)):g("",!0),s.moment.visibility&&s.moment.visibility.type!=="public"?(i(),r("div",Je,[s.moment.visibility.allowed.length>0?(i(),r("span",Xe,"部分可见: "+v(s.moment.visibility.allowed.map(l=>k(l)).join(", ")),1)):(i(),r("span",Ze,"私密"))])):g("",!0),n("div",_e,[n("div",et,[n("span",tt,v(Y(s.moment.time)),1),s.moment.location?(i(),r("div",nt,[o[1]||(o[1]=n("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"#576B95",xmlns:"http://www.w3.org/2000/svg"},[n("circle",{cx:"12",cy:"8",r:"4.5"}),n("rect",{x:"11.4",y:"12",width:"2",height:"9"})],-1)),n("span",null,v(s.moment.location),1)])):g("",!0)]),n("div",ot,[n("div",{class:"action-btn",onClick:p(y,["stop"])},[...o[2]||(o[2]=[n("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[n("circle",{cx:"12",cy:"12",r:"1"}),n("circle",{cx:"19",cy:"12",r:"1"}),n("circle",{cx:"5",cy:"12",r:"1"})],-1)])]),s.isMenuOpen?(i(),r("div",st,[n("div",{class:"menu-item",onClick:p(P,["stop"])},[o[3]||(o[3]=n("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[n("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})],-1)),Q(" "+v(D.value?"取消":"赞"),1)]),n("div",{class:"menu-item",onClick:p(M,["stop"])},[...o[4]||(o[4]=[n("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[n("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})],-1),Q(" 评论 ",-1)])])])):g("",!0)])]),s.moment.likes.length||s.moment.comments.length?(i(),r("div",lt,[s.moment.likes.length?(i(),r("div",at,[o[5]||(o[5]=n("svg",{class:"svg-icon like-icon",viewBox:"0 0 24 24",fill:"#576b95",stroke:"none"},[n("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})],-1)),(i(!0),r(A,null,F(s.moment.likes,(l,f)=>(i(),r("span",{key:l},v(k(l))+v(f<s.moment.likes.length-1?", ":""),1))),128))])):g("",!0),s.moment.comments.length?(i(),r("div",it,[(i(!0),r(A,null,F(s.moment.comments,l=>(i(),r("div",{key:l.id,class:"comment-item",onClick:p(f=>E(l),["stop"])},[n("span",ut,v(k(l.userId)),1),l.replyTo?(i(),r("span",ct,[o[6]||(o[6]=Q("回复 ",-1)),n("span",mt,v(l.replyTo.name),1)])):g("",!0),n("span",dt,": "+v(l.content),1)],8,rt))),128))])):g("",!0)])):g("",!0)])],32))}},gt=ce(vt,[["__scopeId","data-v-7d5c88be"]]),ht={class:"moments-header"},ft={class:"user-info"},pt={class:"moments-list"},kt={key:0,class:"comment-input-header"},yt={class:"comment-input-wrapper"},Mt=["placeholder"],bt=["disabled"],Ct={class:"modal-actions"},wt={__name:"Moments",setup(s,{expose:G}){const h=me(),c=Le(),x=Be();Oe();const $=Ee("setShowMomentsCamera"),z=B(()=>c.userMomentsProfile.cover),C=B(()=>c.userMomentsProfile.name),S=B(()=>c.userMomentsProfile.avatar),w=B(()=>c.userMomentsProfile.signature),U=m(C.value||"我"),k=m(w.value),Y=B(()=>{const e="user";return c.moments.filter(t=>{var ie;if(t.userId===e)return!0;if(h.getCharacter(t.userId)){const R=t.visibility;if(!R||R.type==="public"||R.type==="private"&&((ie=R.allowed)!=null&&ie.includes(e)))return!0}return!1})}),b=m(null),D=m(!1),y=m(""),P=m(null),M=m(null),E=m(null),I=m(!1),T=ze({title:"",bizType:"avatar"}),N=m(""),a=m(!1),o=m(null),l=m(!1),f=m(null),d=m(0),L=m(!1),V=m(0),K=m(!1);re(C,e=>{U.value=e}),re(w,e=>{k.value=e}),De(()=>{document.addEventListener("click",le);const e=document.querySelector(".chat-moments");e&&e.addEventListener("scroll",ae)}),Ae(()=>{document.removeEventListener("click",le);const e=document.querySelector(".chat-moments");e&&e.removeEventListener("scroll",ae),$&&$(!0)});const ge=e=>{if(e==="user")return C.value;const t=h.getCharacter(e);return t?t.name:"未知用户"},Z=e=>{const t=e==="name"?U.value:k.value;c.updateUserMomentsProfile({[e]:t})},_=e=>{N.value=e,T.title=e==="cover"?"修改封面":"修改头像",T.bizType="avatar",I.value=!0},he=e=>{const t=(e.type==="url",e.content);t&&c.updateUserMomentsProfile({[N.value]:t}),I.value=!1},fe=()=>{K.value=!0},ee=()=>{K.value=!1},pe=e=>{c.addMoment({userId:"user",...e,time:Date.now(),likes:[],comments:[]}),ee()},ke=e=>{o.value=e,a.value=!0},W=()=>{a.value=!1,o.value=null},ye=()=>{o.value&&(c.deleteMoment(o.value.id),W())},Me=async()=>{if(!o.value)return;x.showToast("正在重新生成...","info");const e=o.value.id;W(),await c.retryMoment(e)?x.showToast("动态已更新","success"):x.showToast("重试失败","error")},be=e=>{c.likeMoment(e.id,"user"),b.value=null},te=(e,t=null)=>{P.value=e,M.value=t,y.value="",D.value=!0,ve(()=>{var u;return(u=E.value)==null?void 0:u.focus()})},Ce=e=>{te(e.id),b.value=null},we=(e,t)=>{t.userId==="user"?(f.value={momentId:e.id,commentId:t.id},l.value=!0):te(e.id,{id:t.userId,name:ge(t.userId)})},Ie=()=>{if(f.value){const{momentId:e,commentId:t}=f.value;c.deleteComment(e,t),ne()}},ne=()=>{l.value=!1,f.value=null},oe=()=>{D.value=!1,P.value=null,M.value=null,y.value=""},se=()=>{!y.value.trim()||!P.value||(c.addComment(P.value,{userId:"user",content:y.value,time:Date.now(),replyTo:M.value}),oe())},Te=e=>{document.querySelector(".chat-moments").scrollTop===0&&(V.value=e.touches[0].clientY)},xe=e=>{if(V.value>0&&!L.value){const t=e.touches[0].clientY-V.value;t>0&&(d.value=Math.min(t*.5,100),t>10&&e.cancelable&&e.preventDefault())}},$e=async()=>{const e=()=>{const t=setInterval(()=>{d.value-=5,d.value<=0&&(d.value=0,V.value=0,clearInterval(t))},10)};d.value>60&&!L.value?(L.value=!0,d.value=60,await c.triggerRandomCharacterMoment(),setTimeout(()=>{L.value=!1,e()},500)):L.value||e()},Se=e=>{b.value=b.value===e?null:e},le=e=>{e.target.closest(".actions")||(b.value=null)},ae=e=>{$&&$(e.target.scrollTop<300/2)};return G({openPostMomentModal:fe}),(e,t)=>(i(),r("div",{class:"chat-moments",onTouchstart:Te,onTouchmove:xe,onTouchend:$e},[n("div",{class:"pull-refresh-loading",style:O({opacity:Math.min(d.value/60,1),transform:`rotate(${d.value*5}deg)`})},[n("div",{class:de(["loading-icon",{"is-spinning":L.value}])},[...t[13]||(t[13]=[n("svg",{viewBox:"0 0 24 24",width:"30",height:"30",fill:"white"},[n("path",{d:"M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"})],-1)])],2)],4),n("div",{class:"moments-content-wrapper",style:O({transform:`translateY(${d.value}px)`})},[n("div",ht,[n("div",{class:"cover-image",style:O(z.value?{backgroundImage:`url(${z.value})`}:{backgroundColor:"#333"}),onClick:t[7]||(t[7]=u=>_("cover"))},[n("div",ft,[J(n("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>U.value=u),class:"username-input",onClick:t[1]||(t[1]=p(()=>{},["stop"])),onInput:t[2]||(t[2]=u=>Z("name")),placeholder:"昵称"},null,544),[[X,U.value]]),n("div",{class:"avatar",style:O(S.value?{backgroundImage:`url(${S.value})`}:{backgroundColor:"#ccc"}),onClick:t[3]||(t[3]=p(u=>_("avatar"),["stop"]))},null,4),J(n("input",{"onUpdate:modelValue":t[4]||(t[4]=u=>k.value=u),class:"signature-input",onClick:t[5]||(t[5]=p(()=>{},["stop"])),onInput:t[6]||(t[6]=u=>Z("signature")),placeholder:"个性签名"},null,544),[[X,k.value]])])],4)]),n("div",pt,[(i(!0),r(A,null,F(Y.value,u=>(i(),Re(gt,{key:u.id,moment:u,"current-user-avatar":S.value,"current-user-name":C.value,"is-menu-open":b.value===u.id,onToggleMenu:Se,onLike:be,onComment:Ce,onReply:we,onLongPress:ke},null,8,["moment","current-user-avatar","current-user-name","is-menu-open"]))),128))])],4),D.value?(i(),r("div",{key:0,class:"comment-input-overlay",onClick:oe},[n("div",{class:"comment-input-box",onClick:t[9]||(t[9]=p(()=>{},["stop"]))},[M.value?(i(),r("div",kt," 回复 "+v(M.value.name)+": ",1)):g("",!0),n("div",yt,[J(n("input",{ref_key:"commentInputRef",ref:E,"onUpdate:modelValue":t[8]||(t[8]=u=>y.value=u),class:"base-input",placeholder:M.value?`回复 ${M.value.name}`:"评论",onKeyup:Ne(se,["enter"])},null,40,Mt),[[X,y.value]]),n("button",{onClick:se,disabled:!y.value.trim()},"发送",8,bt)])])])):g("",!0),q(Ve,{visible:I.value,"onUpdate:visible":t[10]||(t[10]=u=>I.value=u),title:T.title,bizType:T.bizType,type:"basic",onSendImage:he},null,8,["visible","title","bizType"]),q(ue,{visible:a.value,"onUpdate:visible":t[11]||(t[11]=u=>a.value=u),title:"动态操作"},{footer:H(()=>[n("button",{class:"modal-btn cancel",onClick:W},"取消")]),default:H(()=>[n("div",Ct,[o.value?(i(),r("button",{key:0,class:"btn btn-secondary big-btn",onClick:Me},"重试")):g("",!0),n("button",{class:"btn btn-secondary big-btn",onClick:ye},"删除")])]),_:1},8,["visible"]),q(ue,{visible:l.value,"onUpdate:visible":t[12]||(t[12]=u=>l.value=u),title:"评论操作"},{footer:H(()=>[n("button",{class:"modal-btn cancel",onClick:ne},"取消")]),default:H(()=>[n("div",{class:"modal-actions"},[n("button",{class:"btn btn-secondary big-btn",onClick:Ie},"删除")])]),_:1},8,["visible"]),q(je,{show:K.value,onClose:ee,onPost:pe},null,8,["show"])],32))}},xt=ce(wt,[["__scopeId","data-v-9b07a823"]]);export{xt as default};
