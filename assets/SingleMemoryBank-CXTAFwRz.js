import{_ as re,k as ue,B as ce,Z as de,r as n,m as ve,c as B,b as me,w as r,e as fe,x as pe,q as he,o as _,i as s,f as c,g as V,t as b,G as be,H as ge,S,j as ye,p as w,F as k}from"./index-PcupIFr8.js";const xe={class:"header-actions"},Me={class:"memory-bank-content"},_e={class:"memory-scroll-container"},Se={key:0,class:"empty-state"},we={class:"empty-text"},ke={key:1,class:"memory-list"},Ce={class:"card-header-row"},$e={class:"header-left"},Fe={class:"char-info",style:{"padding-left":"8px"}},De={class:"char-name"},Re={class:"save-time"},Te={class:"header-right"},Ie=["onClick"],Ue=["onClick"],Ne=["onClick","title"],Be={class:"card-content-row"},Ve={class:"refine-range-info"},Ee={class:"refine-range-inputs"},Pe={class:"summary-tip"},Oe=`# 任务
你是一个记忆提炼助手,请对以下已有的长期记忆进行二次总结,生成一段更精炼的核心记忆。

这份记忆要**直白、真实且带有温度**:

## 要求
- **白描风格**:使用最朴素、直白的语言记录事实。**少用形容词堆砌，多用动作和心理描写来体现当时的情绪和氛围**
- **我是叙述者,不是分析师**。用我的口吻讲述发生了什么,**融入我的性格色彩**
- **保留时间线索**:尊重原记忆中的时间信息,不要将不同时间的事件混淆或合并
- **抓重点**:从已有记忆中提取最关键的事件、情感和关系变化
- **保持真实**:不要添加原记忆中没有的信息,只提炼已有内容
- **说人话**:务必避免"交互"、"需求"、"成功解决"这类报告式词汇
- **字数限制**:总结控制在 200-300 字以内,只记录最核心的内容

直接输出提炼后的记忆内容,不要加任何其他东西。`,Ae={__name:"SingleMemoryBank",setup(je){const Z=ve();pe();const f=ue(),p=ce(),J=de(),E=n(Z.params.charId),A=n(!1),g=n(!1),h=n(-1),u=n(""),C=n(!1),$=n(-1),F=n(!1),y=n(""),D=n(1),R=n(0),T=n(!1),x=n(""),d=n([]),m=B(()=>f.getCharacter(E.value)),l=B(()=>{var t;return((t=m.value)==null?void 0:t.memories)||[]}),j=B(()=>{var t;return((t=m.value)==null?void 0:t.name)||"角色"}),P=B(()=>[...A.value?l.value.filter(e=>e.isFavorite):l.value].sort((e,o)=>(o.time||0)-(e.time||0))),G=()=>{g.value=!1,u.value=""},H=()=>{C.value=!1,$.value=-1},L=()=>{F.value=!1},q=()=>{T.value=!1,x.value="",d.value=[]},z=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},K=()=>{h.value=-1,u.value="",g.value=!0},I=()=>Date.now().toString(36)+Math.random().toString(36).substr(2,5),O=t=>{let e=-1;return t.id&&(e=l.value.findIndex(o=>o.id===t.id)),e===-1&&(e=l.value.indexOf(t)),e},Q=t=>{const e=O(t);e!==-1&&(h.value=e,u.value=t.content,g.value=!0)},W=()=>{if(!u.value.trim())return;const t=m.value;if(t.memories||(t.memories=[]),h.value>=0){const e=t.memories[h.value];typeof e=="string"?t.memories[h.value]={id:I(),content:u.value,time:Date.now(),charName:t.name,isFavorite:!1}:(e.content=u.value,e.id||(e.id=I()))}else t.memories.unshift({id:I(),content:u.value,time:Date.now(),charName:t.name,isFavorite:!1});f.saveData(),G()},X=t=>{const e=O(t);e!==-1&&($.value=e,C.value=!0)},ee=()=>{$.value>=0&&(m.value.memories.splice($.value,1),f.saveData()),H()},te=t=>{const e=O(t);if(e===-1)return;const o=l.value[e];if(typeof o=="string"){const a=l.value.indexOf(o),v={content:o,time:Date.now(),charName:j.value,isFavorite:!1};l.value[a]=v,f.toggleMemoryFavorite(E.value,v)}else f.toggleMemoryFavorite(E.value,o)},se=()=>{y.value=m.value.memorySummaryPrompt||"",D.value=1,R.value=l.value.length,F.value=!0},ae=async()=>{const t=m.value;if(!t)return;const e=l.value.length,o=Math.max(1,D.value),a=Math.min(e,R.value);if(o>a){p.showToast("起始范围不能大于结束范围","error");return}t.memorySummaryPrompt=y.value,p.showToast("正在提炼记忆...","info"),L();const v=l.value.length,U=Math.max(0,v-a),ne=Math.min(v,v-o+1);let N=l.value.slice(U,ne);if(N.reverse(),N.length===0){p.showToast("选定范围内没有记忆可供提炼","warn");return}const le=N.map((i,M)=>{const Y=i.time?z(i.time):"";return`[${M+1}] ${Y?`(${Y}) `:""}${i.content}`}).join(`

`),ie=[{role:"user",content:`${y.value.trim()||Oe}

现有记忆如下：

${le}`}];try{const i=await J.getGenericCompletion(ie),M=i==null?void 0:i.content;M&&M.trim()?(x.value=`[记忆提炼 ${o}-${a}] ${M.trim()}`,d.value=N,T.value=!0):p.showToast("提炼失败，未收到有效回复","error")}catch(i){console.error("记忆提炼失败:",i),p.showToast(`提炼失败: ${i.message}`,"error")}},oe=()=>{const t=m.value;if(!t)return;t.memories||(t.memories=[]),d.value&&d.value.length>0&&(t.memories=t.memories.filter(o=>!d.value.includes(o)));let e=Date.now();if(d.value.length>0){const o=d.value[0];o&&o.time&&(e=o.time)}t.memories.unshift({id:I(),content:x.value,time:e,charName:t.name,isFavorite:!1}),f.saveData(),p.showToast("记忆提炼已保存并替换旧记忆","success"),q()};return(t,e)=>{const o=he("Modal");return _(),me(fe,{title:"长期记忆"},{action:r(()=>[s("div",xe,[s("button",{class:"icon-btn",onClick:se,title:"提炼"},[c(S,{name:"Sparkles"})]),s("button",{class:"icon-btn",onClick:K,title:"添加"},[c(S,{name:"plus"})])])]),default:r(()=>[s("div",Me,[s("div",_e,[!P.value||P.value.length===0?(_(),V("div",Se,[s("div",we,b(A.value?"暂无收藏记忆":"暂无长期记忆"),1)])):(_(),V("div",ke,[(_(!0),V(be,null,ge(P.value,(a,v)=>(_(),V("div",{key:a.id||v,class:"card memory-card"},[s("div",Ce,[s("div",$e,[s("div",Fe,[s("span",De,b(a.charName||j.value),1),s("span",Re,b(z(a.time)),1)])]),s("div",Te,[s("button",{class:"icon-btn",onClick:U=>Q(a),title:"编辑"},[c(S,{name:"pencil"})],8,Ie),s("button",{class:"icon-btn danger",onClick:U=>X(a),title:"删除"},[c(S,{name:"trash"})],8,Ue),s("button",{class:"icon-btn favorite-btn",onClick:U=>te(a),title:a.isFavorite?"取消收藏":"收藏"},[c(S,{name:a.isFavorite?"heart-solid":"heart",class:ye({"is-favorite":a.isFavorite})},null,8,["name","class"])],8,Ne)])]),s("div",Be,b(a.content),1)]))),128))]))])]),c(o,{visible:g.value,"onUpdate:visible":e[1]||(e[1]=a=>g.value=a),title:h.value>=0?"编辑记忆":"新增记忆",class:"nested"},{footer:r(()=>[s("button",{class:"modal-btn cancel",onClick:G},"取消"),s("button",{class:"modal-btn confirm",onClick:W},"确定")]),default:r(()=>[w(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[0]||(e[0]=a=>u.value=a),placeholder:"输入希望AI记住的内容...",style:{height:"150px"}},null,512),[[k,u.value]])]),_:1},8,["visible","title"]),c(o,{visible:C.value,"onUpdate:visible":e[2]||(e[2]=a=>C.value=a),title:"确认删除",class:"nested"},{footer:r(()=>[s("button",{class:"modal-btn cancel",onClick:H},"取消"),s("button",{class:"modal-btn confirm danger",onClick:ee},"确认删除")]),default:r(()=>[e[9]||(e[9]=s("p",{class:"confirm-text"},"确定要删除这条记忆吗？",-1))]),_:1},8,["visible"]),c(o,{visible:F.value,"onUpdate:visible":e[6]||(e[6]=a=>F.value=a),title:"记忆提炼",class:"nested"},{footer:r(()=>[s("button",{class:"modal-btn cancel",onClick:L},"取消"),s("button",{class:"modal-btn confirm",onClick:ae},"开始提炼")]),default:r(()=>[s("div",Ve," 当前共有 "+b(l.value.length)+" 条记忆。 ",1),s("div",Ee,[e[10]||(e[10]=s("label",{for:"refine-start"},"从第",-1)),w(s("input",{id:"refine-start",type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>D.value=a),class:"base-input range-input"},null,512),[[k,D.value,void 0,{number:!0}]]),e[11]||(e[11]=s("label",{for:"refine-end"},"条 到 第",-1)),w(s("input",{id:"refine-end",type:"number","onUpdate:modelValue":e[4]||(e[4]=a=>R.value=a),class:"base-input range-input"},null,512),[[k,R.value,void 0,{number:!0}]]),e[12]||(e[12]=s("label",null,"条",-1))]),e[13]||(e[13]=s("p",{class:"summary-tip"},"将对选定范围内的长期记忆进行再总结。",-1)),w(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[5]||(e[5]=a=>y.value=a),placeholder:"输入总结提示词...（留空将使用默认提示词）",style:{height:"100px"}},null,512),[[k,y.value]])]),_:1},8,["visible"]),c(o,{visible:T.value,"onUpdate:visible":e[8]||(e[8]=a=>T.value=a),title:"确认提炼结果",class:"nested"},{footer:r(()=>[s("button",{class:"modal-btn cancel",onClick:q},"取消"),s("button",{class:"modal-btn confirm",onClick:oe},"确定并替换")]),default:r(()=>[s("p",Pe,"请确认提炼后的记忆内容。点击确定将保存此内容并删除原有的 "+b(d.value.length)+" 条记忆。",1),w(s("textarea",{class:"base-input modal-textarea","onUpdate:modelValue":e[7]||(e[7]=a=>x.value=a),placeholder:"提炼结果...",style:{height:"150px"}},null,512),[[k,x.value]])]),_:1},8,["visible"])]),_:1})}}},Le=re(Ae,[["__scopeId","data-v-b8ba76c8"]]);export{Le as default};
