import{t as G,H as Ze,I as _e,r as x,J as ke,L as et,a as tt,k as de,x as _,G as ae,_ as O,q as Q,y as ue,b as S,o as b,l as W,e as D,f as q,d as e,T as re,B as k,j as y,h as H,w as j,A as Y,M as ee,c as E,F,C as X,n as U,v as ce,E as Z,N as ye,i as Se,z,S as oe,O as st,D as J,P as nt,Q as ot,R as at,U as K,V as lt,W as ne,X as it}from"./index-Cvx2CjzQ.js";const rt=(t,g,a)=>{const n=g.map(f=>`${f.role==="user"?"用户":t.name}: ${f.content}`).join(`
`),u=a.toString().padStart(2,"0");return`
你正在扮演角色“${t.name}”，你需要根据以下设定和最近的对话，生成一段角色的实时“心声”。
心声由多个部分组成，请严格按照下面的JSON格式返回，不要添加任何额外的解释或文字。

**角色人设:**
${t.charPersona}

**最近对话:**
${n}

**你的任务:**
生成符合当前情境和角色性格的内心活动。
- **情绪 (emotion)**: 描述角色当前的主要情绪，应在一定时间内保持稳定，5字以内。
- **穿着 (outfit)**: 描述角色当前的穿着，应在一定时间内保持稳定，10字以内。
- **姿态 (posture)**: 描述角色当前的姿态或小动作，应在一定时间内保持稳定，15字以内。
- **内心独白 (innerVoice)**: 角色此刻具体的内心想法，50字以内。
- **没说出口的话 (unspokenWords)**: 一句角色想说但没说出口的话，风格可以多变（如阴暗、腹黑、酸涩、色情等），必须符合人设，15字以内。
- **标题 (title)**: 为这次心声生成一个简短的小标题，格式固定为“#${u} 标题内容”，例如“#${u} 初次见面”。

**输出格式 (必须是可被解析的JSON):**
{
  "emotion": "...",
  "outfit": "...",
  "posture": "...",
  "innerVoice": "...",
  "unspokenWords": "...",
  "title": "#${u} ..."
}
`};function ct(t,g){const a=G(),n=Ze(),u=_e(),f=de(),i=tt(),o=x(!1),l=async()=>{console.log("[useAiResponder] triggerAiResponse triggered"),o.value=!0;try{const c=a.getCharacter(t.value);let s=await g.getChatCompletion(t.value);if(s){const p=/\[待办：(?:((?:\d{4}-\d{2}-\d{2}\s)?\d{1,2}:\d{2}|\d{4}-\d{2}-\d{2})\s)?(.+?)\]/g;let v;for(;(v=p.exec(s))!==null;){const T=v[1],V=v[2].trim();let $=new Date,C="";if(T)if(T.includes("-"))if(T.includes(":")){const[A,P]=T.split(/\s+/);$=new Date(A),C=P}else $=new Date(T),C="";else C=T;else C=new Date().toTimeString().slice(0,5);V&&(u.addEvent({type:"todo",title:V,content:V,date:ke($,{representation:"date"}),done:!1,time:C}),console.log(`[useAiResponder] Added new todo: "${V}" at ${C} on ${ke($,{representation:"date"})}`))}if(s=s.replace(p,"").trim(),!s){o.value=!1,d();return}a.messages[t.value]||(a.messages[t.value]=[]);const m=(c==null?void 0:c.isBlocked)||!1;let r=s.split("|||"),h=[];const B=/(\[(?:图片|表情包|语音|位置|转账)：.+?\])/g;r.forEach(T=>{const V=T.split(B).map($=>$.trim()).filter($=>$);h.push(...V)});for(let T=0;T<h.length;T++){const V=h[T];T>0&&await new Promise(I=>setTimeout(I,1e3+Math.random()*1e3));let{type:$,content:C}=et(V),A={};if($==="sticker"){const I=C,R=a.stickers.find(N=>N.name===I);R?(C=R.url,A.name=I):($="text",C=`[表情包：${I}]`)}let P=!1;$==="image"&&!C.startsWith("http")&&!C.startsWith("data:")&&(P=!0),a.messages[t.value].push({id:Date.now().toString()+T,sender:"char",type:$,content:C,isTextGenerated:P,...A,time:Date.now(),blocked:m}),a.saveData(),i.path!==`/chat/room/${t.value}`&&(a.incrementUnreadCount(t.value),n.triggerNotification(c.nickname||c.name,$==="text"?C:`[${$}]`,c.avatar,()=>{f.push(`/chat/room/${t.value}`)},3e3,$))}}}catch(c){console.error("[useAiResponder] triggerAiResponse failed:",c)}finally{o.value=!1,d()}},d=async()=>{try{const c=a.getCharacter(t.value);if(!c)return;const s=a.innerVoices[t.value]||[];let p=1;if(s.length>0){const h=s[0].title;if(h){const B=h.match(/#(\d+)/);B?p=parseInt(B[1],10)+1:p=s.length+1}else p=s.length+1}const v=a.getFormattedRecentMessages(t.value,10),m=rt(c,v,p),r=await g.getGenericCompletion([{role:"user",content:m}]);if(r){const h=r.indexOf("{"),B=r.lastIndexOf("}");if(h!==-1&&B!==-1){const T=r.substring(h,B+1),V=JSON.parse(T);a.addInnerVoice(t.value,V),console.log("[useAiResponder] Inner voice generated and saved:",V)}else console.warn("[useAiResponder] Failed to find JSON in inner voice response.")}}catch(c){console.error("[useAiResponder] Failed to generate inner voice:",c)}};return{isTyping:o,triggerAiResponse:l}}function dt(t){const g=G(),a=_(),n=x(!1),u=x(new Set),f=x(!1),i=s=>{console.log("[useMessageSelection] enterSelectionMode triggered"),n.value=!0,u.value.clear(),s&&u.value.add(s)},o=()=>{console.log("[useMessageSelection] exitSelectionMode triggered"),n.value=!1,u.value.clear()};return{isSelectionMode:n,selectedMessageIds:u,isForwarding:f,enterSelectionMode:i,exitSelectionMode:o,toggleMessageSelection:s=>{console.log(`[useMessageSelection] toggleMessageSelection for msgId: ${s}`),u.value.has(s)?u.value.delete(s):u.value.add(s)},handleBatchAction:s=>{if(console.log(`[useMessageSelection] handleBatchAction: ${s}`),u.value.size===0)return;const p=g.messages[t.value];s==="forward"?f.value=!0:s==="delete"?a.showConfirm("删除消息","确定删除选中的消息吗？",()=>{console.log("[useMessageSelection] Deleting selected messages"),g.messages[t.value]=p.filter(v=>!u.value.has(v.id)),g.saveData(),o()}):s==="favorite"&&(g.favorites||(g.favorites=[]),p.forEach(v=>{u.value.has(v.id)&&(g.favorites.some(m=>m.id===v.id)||g.favorites.push(v))}),g.saveData(),a.showToast("已收藏","success"),o())},handleConfirmForward:s=>{console.log("[useMessageSelection] handleConfirmForward triggered"),f.value=!1;const v=(g.messages[t.value]||[]).filter(m=>u.value.has(m.id));v.length!==0&&(s.forEach(m=>{g.messages[m]||(g.messages[m]=[]),v.forEach(r=>{const h={...r,id:Date.now().toString()+Math.random()};g.messages[m].push(h)})}),g.saveData(),a.showToast(`已转发 ${v.length} 条消息`),o())}}}function ut(t,g,a){const n=x(null);return{editingMessageId:n,handleEditMessage:o=>{console.log("[useMessageEditing] handleEditMessage for msgId:",o),n.value=o},handleSaveEdit:({msgId:o,newContent:l})=>{console.log("[useMessageEditing] handleSaveEdit for msgId:",o);const c=t.messages[g.value].find(s=>s.id===o);c&&(c.content=l,t.saveData()),n.value=null},updateInputText:o=>{console.log("[useMessageEditing] updateInputText called"),a&&(a.value=o,ae(()=>{const l=document.querySelector(".chat-input");l&&l.focus()}))}}}function vt(t,g,a,n){const u=x(""),f=x(null),i=(v,m,r={})=>{console.log(`[useMessageSender] sendMsg called with type: ${v}`);const h={...r};f.value&&(h.quote={id:f.value.id,sender:f.value.sender,content:f.value.content}),t.messages[g.value]||(t.messages[g.value]=[]),t.messages[g.value].push({id:Date.now().toString()+Math.random(),sender:"user",type:v,content:m,timestamp:Date.now(),...h}),t.saveData(),n&&(n.value=null),f.value=null};return{inputText:u,quotingMessage:f,sendMessage:()=>{console.log("[useMessageSender] sendMessage triggered");const v=u.value.trim();v&&(i("text",v),u.value="")},sendMsg:i,sendSticker:v=>{console.log("[useMessageSender] sendSticker triggered"),i("sticker",v.url,{name:v.name})},sendVoiceMessage:v=>{console.log("[useMessageSender] sendVoiceMessage triggered"),v&&i("voice",v)},handleSendImage:v=>{console.log("[useMessageSender] handleSendImage triggered"),v.isTextGenerated?i("image",v.description,{isTextGenerated:!0}):(v.type==="base64"||v.type==="url")&&i("image",v.content)},confirmSendLocation:(v,m)=>{if(console.log("[useMessageSender] confirmSendLocation triggered"),!v){a.showToast("请输入位置名称","info");return}i("location",v,{detail:m})},sendTransfer:()=>{console.log("[useMessageSender] sendTransfer triggered"),i("transfer","88.88")}}}function gt(t){const g=x(null),a=x(!1),n=x({x:0,y:0}),u=(d,c)=>{console.log("[useMessageInteraction] showMenu triggered"),d.preventDefault();const s=d.target.closest(".msg-bubble, .system-message-wrapper");s&&(t.value={visible:!0,messageId:c,targetEl:s})};return{startLongPress:(d,c)=>{console.log("[useMessageInteraction] startLongPress triggered"),d.stopPropagation(),a.value=!1,clearTimeout(g.value),d.type.startsWith("touch")&&(n.value={x:d.touches[0].clientX,y:d.touches[0].clientY}),g.value=setTimeout(()=>{a.value=!0,u(d,c)},400)},cancelLongPress:()=>{console.log("[useMessageInteraction] cancelLongPress triggered"),clearTimeout(g.value)},handleTouchMove:d=>{console.log("[useMessageInteraction] handleTouchMove triggered");const c=d.touches[0],s=Math.abs(c.clientX-n.value.x),p=Math.abs(c.clientY-n.value.y);(s>10||p>10)&&clearTimeout(g.value)},wasClickAfterLongPress:()=>a.value?(a.value=!1,!0):!1}}const mt={class:"header-title-area"},ft={key:0,class:"chat-room-title"},pt={key:1,class:"typing-indicator"},ht={class:"right-icons-group"},bt={style:{display:"flex",gap:"10px","margin-bottom":"10px"}},kt=["placeholder"],yt=["placeholder"],St={__name:"SingleChatHeader",props:{charId:{type:String,required:!0},charName:{type:String,default:""},charStatus:{type:Object,default:()=>({})},isTyping:{type:Boolean,default:!1}},emits:["trigger-ai","open-settings"],setup(t,{emit:g}){const a=t,{t:n}=Q(),u=de(),f=G(),i=_(),o=x(!1),l=x(""),d=x(""),c=x(!1);ue(()=>{c.value=!0});const s=()=>{const m=a.charStatus||{};l.value=m.icon||"✨",d.value=m.text||"",o.value=!0},p=()=>{const m=l.value.trim()||"✨",r=d.value.trim(),h=f.getCharacter(a.charId);h&&(r?h.status={icon:m,text:r}:h.status=null,f.saveData(),i.showToast(n("saveSuccess"))),o.value=!1},v=()=>{u.push({name:"memory-bank",params:{charId:a.charId}})};return(m,r)=>(b(),S("div",null,[c.value?(b(),W(re,{key:0,to:"#chatRoomLeftArea"},[e("div",{class:"btn-icon bell-btn",onClick:r[0]||(r[0]=h=>m.$emit("trigger-ai")),ref:"bellBtn"},[...r[6]||(r[6]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"}),e("path",{d:"M13.73 21a2 2 0 0 1-3.46 0"})],-1)])],512)])):D("",!0),c.value?(b(),W(re,{key:1,to:"#chatRoomTitleArea"},[e("div",mt,[t.isTyping?(b(),S("div",pt,[e("span",null,k(y(n)("chat.singleChat.typing")),1),r[7]||(r[7]=e("span",{class:"dots"},[e("span",null,"."),e("span",null,"."),e("span",null,".")],-1))])):(b(),S("div",ft,k(t.charName),1))]),e("div",{class:"chat-room-status",onClick:s},[e("span",null,k(t.charStatus.icon||"✨"),1),e("span",null,k(t.charStatus.text||y(n)("chat.singleChat.addStatus")),1)])])):D("",!0),c.value?(b(),W(re,{key:2,to:"#chatRoomActionArea"},[e("div",ht,[e("div",{class:"btn-icon memory-btn",onClick:v},[...r[8]||(r[8]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e("polyline",{points:"14 2 14 8 20 8"}),e("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e("polyline",{points:"10 9 9 9 8 9"})],-1)])]),e("div",{class:"btn-icon more-btn",onClick:r[1]||(r[1]=h=>m.$emit("open-settings"))},[...r[9]||(r[9]=[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"1"}),e("circle",{cx:"19",cy:"12",r:"1"}),e("circle",{cx:"5",cy:"12",r:"1"})],-1)])])])])):D("",!0),q(ee,{visible:o.value,"onUpdate:visible":r[5]||(r[5]=h=>o.value=h),title:y(n)("chat.singleChat.setStatus")},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:r[4]||(r[4]=h=>o.value=!1)},k(y(n)("cancel")),1),e("button",{class:"modal-btn confirm",onClick:p},k(y(n)("confirm")),1)]),default:H(()=>[e("div",bt,[j(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[2]||(r[2]=h=>l.value=h),placeholder:y(n)("chat.singleChat.statusIcon"),style:{width:"60px","text-align":"center"}},null,8,kt),[[Y,l.value]]),j(e("input",{type:"text",class:"base-input","onUpdate:modelValue":r[3]||(r[3]=h=>d.value=h),placeholder:y(n)("chat.singleChat.statusText"),style:{flex:"1"}},null,8,yt),[[Y,d.value]])])]),_:1},8,["visible","title"])]))}},$t=O(St,[["__scopeId","data-v-9c4c5fa1"]]),Mt={key:0,class:"chat-panel",id:"stickerPanel"},wt={class:"sticker-panel-header"},Ct={class:"sticker-groups"},xt=["onClick"],Tt={class:"sticker-panel-content"},It=["onClick"],At=["src","alt"],Pt={class:"sticker-panel-footer"},Vt={__name:"StickersPanel",props:{visible:Boolean},emits:["send-sticker","update:visible"],setup(t,{emit:g}){const a=g,n=G(),u=_(),f=x("默认"),i=x(!1),o=x(new Set),l=x(!1),d=x(!1),c=x(""),s=E(()=>["默认",...new Set(n.stickers.map(P=>P.group).filter(Boolean).filter(P=>P!=="默认"))]),p=E(()=>n.stickers.filter(A=>A.group===f.value)),v=A=>{i.value?o.value.has(A.id)?o.value.delete(A.id):o.value.add(A.id):a("send-sticker",A)},m=({group:A,stickers:P})=>{const I=P.map(R=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:R.url,name:R.name,group:A}));n.stickers.push(...I),n.saveData(),u.showToast(`成功导入 ${I.length} 个表情包`,"success")},r=()=>{l.value=!0},h=()=>{o.value.size>0&&(d.value=!0)},B=()=>{i.value=!i.value,o.value.clear()},T=()=>{const A=p.value;A.every(I=>o.value.has(I.id))?A.forEach(I=>o.value.delete(I.id)):A.forEach(I=>o.value.add(I.id))},V=()=>{o.value.size!==0&&u.showConfirm("删除表情包","确定删除选中的表情包吗？",()=>{n.stickers=n.stickers.filter(A=>!o.value.has(A.id)),n.saveData(),o.value.clear()})},$=()=>{const A=c.value.trim();if(!A)return u.showToast("请输入目标分组","info");n.stickers.forEach(P=>{o.value.has(P.id)&&(P.group=A)}),n.saveData(),d.value=!1,c.value="",o.value.clear(),i.value=!1,f.value=A},C=()=>{if(o.value.size===0)return;const A=n.stickers.filter(N=>o.value.has(N.id)).map(N=>`${N.name} ${N.url}`).join(`
`),P=new Blob([A],{type:"text/plain"}),I=URL.createObjectURL(P),R=document.createElement("a");R.href=I,R.download=`stickers_export_${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(I),o.value.clear(),i.value=!1};return(A,P)=>(b(),S("div",null,[t.visible?(b(),S("div",Mt,[e("div",wt,[e("div",Ct,[(b(!0),S(F,null,X(s.value,I=>(b(),S("div",{class:U(["sticker-group-tab",{active:f.value===I}]),key:I,onClick:R=>f.value=I},k(I),11,xt))),128))])]),e("div",Tt,[(b(!0),S(F,null,X(p.value,I=>(b(),S("div",{class:U(["sticker-item",{selected:o.value.has(I.id),"manage-mode":i.value}]),key:I.id,onClick:R=>v(I)},[e("img",{src:I.url,alt:I.name},null,8,At),e("span",null,k(I.name),1)],10,It))),128))]),e("div",Pt,[j(e("div",{class:"sticker-add-btn",onClick:r},"＋",512),[[ce,!i.value]]),e("div",{class:"sticker-manage-btn",style:Z({color:i.value?"var(--danger-color)":"#576B95"}),onClick:B},k(i.value?"完成":"管理"),5)]),e("div",{class:U(["manage-bar",{active:i.value}])},[e("button",{class:"btn btn-secondary",onClick:r},"导入"),e("button",{class:"btn btn-secondary",onClick:T},"全选"),e("button",{class:"btn btn-secondary",onClick:h},"移动"),e("button",{class:"btn btn-secondary",onClick:C},"导出"),e("button",{class:"btn btn-danger",onClick:V},"删除")],2)])):D("",!0),q(ye,{visible:l.value,"onUpdate:visible":P[0]||(P[0]=I=>l.value=I),type:"sticker-import",onImportSticker:m},null,8,["visible"]),q(ee,{visible:d.value,"onUpdate:visible":P[3]||(P[3]=I=>d.value=I),title:"移动到分组"},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:P[2]||(P[2]=I=>d.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:$},"确定")]),default:H(()=>[j(e("input",{type:"text",class:"base-input","onUpdate:modelValue":P[1]||(P[1]=I=>c.value=I),placeholder:"输入目标分组名称"},null,512),[[Y,c.value]])]),_:1},8,["visible"])]))}},Bt=O(Vt,[["__scopeId","data-v-f9fb1def"]]),Lt={class:"chat-panel",id:"morePanel"},Et={class:"more-panel-content"},Rt={class:"more-label"},Dt={class:"more-label"},qt={class:"more-label"},Nt={class:"more-label"},Ut={__name:"MorePanel",emits:["trigger-image-upload","start-video-call","send-location","send-transfer"],setup(t){const{t:g}=Q();return(a,n)=>(b(),S("div",Lt,[e("div",Et,[e("div",{class:"more-item",onClick:n[0]||(n[0]=u=>a.$emit("trigger-image-upload"))},[n[4]||(n[4]=Se('<div class="more-icon" data-v-731b24d5><svg class="svg-icon" viewBox="0 0 24 24" data-v-731b24d5><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-731b24d5></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-731b24d5></circle><polyline points="21 15 16 10 5 21" data-v-731b24d5></polyline></svg></div>',1)),e("span",Rt,k(y(g)("chat.morePanel.image")),1)]),e("div",{class:"more-item",onClick:n[1]||(n[1]=u=>a.$emit("start-video-call"))},[n[5]||(n[5]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("polygon",{points:"23 7 16 12 23 17 23 7"}),e("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})])],-1)),e("span",Dt,k(y(g)("chat.morePanel.videoCall")),1)]),e("div",{class:"more-item",onClick:n[2]||(n[2]=u=>a.$emit("send-location"))},[n[6]||(n[6]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e("circle",{cx:"12",cy:"10",r:"3"})])],-1)),e("span",qt,k(y(g)("chat.morePanel.location")),1)]),e("div",{class:"more-item",onClick:n[3]||(n[3]=u=>a.$emit("send-transfer"))},[n[7]||(n[7]=e("div",{class:"more-icon"},[e("svg",{class:"svg-icon",viewBox:"0 0 24 24"},[e("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),e("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})])],-1)),e("span",Nt,k(y(g)("chat.morePanel.transfer")),1)])])]))}},zt=O(Ut,[["__scopeId","data-v-731b24d5"]]),Ot={class:"chat-footer"},jt={key:0,class:"quote-preview"},Ft={class:"quote-content"},Ht={class:"quote-sender"},Wt={class:"quote-text"},Gt={class:"chat-input-row"},Jt={class:"chat-input-wrapper"},Yt=["value","onKeydown"],Qt={class:"svg-icon",viewBox:"0 0 24 24",style:{stroke:"white",width:"21px",height:"21px",position:"relative",top:"1px",left:"-1px"}},Kt={__name:"ChatInputBar",props:{modelValue:{type:String,default:""},activePanel:{type:String,default:null},quotingMessage:{type:Object,default:null},charId:{type:String,required:!0}},emits:["update:modelValue","update:activePanel","cancel-quote","send-message","send-sticker","trigger-voice","trigger-image","trigger-video","trigger-location","trigger-transfer"],setup(t,{emit:g}){const{t:a}=Q(),n=G(),u=t,f=g,i=x(u.activePanel);z(()=>u.activePanel,s=>{i.value=s}),z(i,s=>{f("update:activePanel",s)});const o=E(()=>{if(!u.quotingMessage)return"";if(u.quotingMessage.sender==="user")return a("chat.self");{const s=n.getCharacter(u.charId);return(s==null?void 0:s.nickname)||(s==null?void 0:s.name)||a("chat.other")}}),l=s=>{i.value===s?i.value=null:i.value=s},d=()=>{u.modelValue.trim()&&f("send-message")},c=s=>{f("send-sticker",s),i.value=null};return(s,p)=>(b(),S("div",Ot,[t.quotingMessage?(b(),S("div",jt,[e("div",Ft,[e("span",Ht,k(o.value)+": ",1),e("span",Wt,k(t.quotingMessage.content),1)]),e("div",{class:"quote-close",onClick:p[0]||(p[0]=v=>s.$emit("cancel-quote"))},[...p[9]||(p[9]=[e("div",{class:"quote-close-icon"},[e("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12"},[e("path",{d:"M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z",fill:"currentColor"})])],-1)])])])):D("",!0),e("div",Gt,[e("div",{class:"chat-tool-btn",onClick:p[1]||(p[1]=v=>s.$emit("trigger-voice"))},[q(oe,{name:"voice-circle",class:"svg-icon"})]),e("div",Jt,[e("textarea",{class:"chat-input",value:t.modelValue,onInput:p[2]||(p[2]=v=>s.$emit("update:modelValue",v.target.value)),onKeydown:st(J(d,["exact","prevent"]),["enter"]),id:"messageInput",autocomplete:"off",rows:"1"},null,40,Yt)]),e("div",{class:"chat-tool-btn",onClick:p[3]||(p[3]=v=>l("sticker"))},[q(oe,{name:"sticker",class:"svg-icon"})]),t.modelValue?(b(),S("div",{key:1,class:"send-btn-icon",onClick:d},[(b(),S("svg",Qt,[...p[10]||(p[10]=[e("line",{x1:"22",y1:"2",x2:"11",y2:"13"},null,-1),e("polygon",{points:"22 2 15 22 11 13 2 9 22 2"},null,-1)])]))])):(b(),S("div",{key:0,class:"chat-tool-btn",onClick:p[4]||(p[4]=v=>l("more"))},[q(oe,{name:"plus-circle",class:"svg-icon"})]))]),q(Bt,{visible:i.value==="sticker",onSendSticker:c},null,8,["visible"]),i.value==="more"?(b(),W(zt,{key:1,onTriggerImageUpload:p[5]||(p[5]=v=>s.$emit("trigger-image")),onStartVideoCall:p[6]||(p[6]=v=>s.$emit("trigger-video")),onSendLocation:p[7]||(p[7]=v=>s.$emit("trigger-location")),onSendTransfer:p[8]||(p[8]=v=>s.$emit("trigger-transfer"))})):D("",!0)]))}},Xt=O(Kt,[["__scopeId","data-v-490ed303"]]),Zt={class:"menu-grid"},_t={__name:"MessageMenu",props:{visible:{type:Boolean,default:!1},targetEl:{type:Object,default:null},messageId:{type:String,default:null},charId:{type:String,required:!0}},emits:["close","enter-selection-mode","trigger-ai-response","quote-message","edit-message"],setup(t,{emit:g}){const a=t,n=g,u=nt("phoneScreenRef"),{t:f}=Q(),i=G(),o=_(),l=x(null),d=x({}),c=x(0),s=x("top");z(()=>a.visible,async m=>{m&&a.targetEl&&(await ae(),p())});const p=()=>{const m=l.value;if(!m)return;const r=a.targetEl.getBoundingClientRect(),h=m.offsetWidth,B=m.offsetHeight,T=8,V=u.value,$=V?V.getBoundingClientRect():{top:0,left:0,width:window.innerWidth};s.value="top";let C=r.top-B-T;C<$.top+T&&(s.value="bottom",C=r.bottom+T);const A=r.left+r.width/2;let P=A-h/2;P<$.left+T&&(P=$.left+T),P+h>$.left+$.width-T&&(P=$.left+$.width-h-T);let I=A-P;const R=12,N=R/2+5,te=h-R/2-5;I=Math.max(N,Math.min(I,te)),d.value={top:`${C}px`,left:`${P}px`},c.value=I},v=m=>{const r=a.messageId;if(!r)return;const h=i.messages[a.charId],B=h.findIndex($=>$.id===r),T=h[B],V={copy:()=>{T.content&&(navigator.clipboard.writeText(T.content),o.showToast(f("chat.messageMenu.toast.copied")))},favorite:()=>{i.favorites||(i.favorites=[]),i.favorites.some($=>$.id===T.id)?o.showToast(f("chat.messageMenu.toast.alreadyFavorited")):(i.favorites.push(T),i.saveData(),o.showToast(f("chat.messageMenu.toast.favorited")))},delete:()=>{o.showConfirm(f("chat.messageMenu.confirmDelete"),f("chat.messageMenu.confirmDeleteMsg"),()=>{i.messages[a.charId].splice(B,1),i.saveData()})},revoke:()=>{T&&(T.type="revoked",i.saveData(),o.showToast(f("chat.messageMenu.toast.revoked")))},select:()=>n("enter-selection-mode",r),quote:()=>n("quote-message",r),retry:()=>{T.sender!=="user"?i.messages[a.charId].splice(B,1):i.retryFromMessage(a.charId,r),i.saveData(),n("trigger-ai-response")},edit:()=>{T.type==="text"?n("edit-message",r):o.showToast(f("chat.messageMenu.toast.editTextOnly"),"info")}};V[m]&&V[m](),n("close")};return(m,r)=>t.visible?(b(),S("div",{key:0,ref_key:"menuRef",ref:l,class:U(["message-menu",{"menu-top":s.value==="top","menu-bottom":s.value==="bottom"}]),style:Z(d.value)},[e("div",Zt,[e("div",{class:"menu-item",onClick:r[0]||(r[0]=h=>v("copy"))},k(y(f)("copy")),1),e("div",{class:"menu-item",onClick:r[1]||(r[1]=h=>v("favorite"))},k(y(f)("favorite")),1),e("div",{class:"menu-item",onClick:r[2]||(r[2]=h=>v("delete"))},k(y(f)("delete")),1),e("div",{class:"menu-item",onClick:r[3]||(r[3]=h=>v("revoke"))},k(y(f)("revoke")),1),e("div",{class:"menu-item",onClick:r[4]||(r[4]=h=>v("select"))},k(y(f)("select")),1),e("div",{class:"menu-item",onClick:r[5]||(r[5]=h=>v("quote"))},k(y(f)("quote")),1),e("div",{class:"menu-item",onClick:r[6]||(r[6]=h=>v("retry"))},k(y(f)("retry")),1),e("div",{class:"menu-item",onClick:r[7]||(r[7]=h=>v("edit"))},k(y(f)("edit")),1)]),e("div",{class:"menu-arrow",style:Z({left:c.value+"px"})},null,4)],6)):D("",!0)}},es=O(_t,[["__scopeId","data-v-466575cd"]]),ts={class:"chat-action-row"},ss={__name:"SelectionBar",emits:["action","cancel"],setup(t){const{t:g}=Q();return(a,n)=>(b(),S("div",ts,[e("div",{class:"action-btn",onClick:n[0]||(n[0]=u=>a.$emit("action","favorite"))},[n[4]||(n[4]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})])],-1)),e("span",null,k(y(g)("favorite")),1)]),e("div",{class:"action-btn",onClick:n[1]||(n[1]=u=>a.$emit("action","forward"))},[n[5]||(n[5]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M18 8L22 12L18 16"}),e("path",{d:"M2 12H22"})])],-1)),e("span",null,k(y(g)("forward")),1)]),e("div",{class:"action-btn",onClick:n[2]||(n[2]=u=>a.$emit("action","delete"))},[n[6]||(n[6]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})])],-1)),e("span",null,k(y(g)("delete")),1)]),e("div",{class:"action-btn",onClick:n[3]||(n[3]=u=>a.$emit("cancel"))},[n[7]||(n[7]=e("div",{class:"action-btn-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])],-1)),e("span",null,k(y(g)("done")),1)])]))}},ns=O(ss,[["__scopeId","data-v-be1a592f"]]),os=["src"],as={class:"msg-content-wrapper"},ls={class:"msg-bubble-box"},is={key:0,class:"quote-in-bubble"},rs={class:"quote-in-bubble-sender"},cs={class:"quote-in-bubble-text"},ds={key:1,class:"edit-view"},us={key:0},vs={class:"description-placeholder"},gs=["src"],ms={key:2,class:"sticker-msg"},fs=["src"],ps={key:3,class:"voice-msg-wrapper"},hs={class:"voice-msg"},bs={key:4,class:"location-msg"},ks={class:"location-text"},ys={class:"msg-title"},Ss={key:5,class:"transfer-msg"},$s={class:"transfer-content"},Ms={class:"transfer-info"},ws={class:"transfer-amount"},Cs={class:"transfer-desc"},xs={key:6,class:"call-summary-msg"},Ts={key:0,class:"blocked-icon"},Is={__name:"MessageItem",props:{msg:{type:Object,required:!0},charName:{type:String,default:""},charAvatar:{type:String,default:""},userAvatar:{type:String,default:""},bubbleStyle:{type:Object,default:()=>({})},isSelectionMode:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1},editingMessageId:{type:String,default:null}},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","show-thought"],setup(t,{emit:g}){const a=t,n=g,u=ot(),f=x(!1),i=x(!1),o=x(""),l=E(()=>a.editingMessageId===a.msg.id),d=E(()=>{const $=a.msg.type;return{"no-style":["image","sticker","location","transfer"].includes($),"has-location":$==="location","has-transfer":$==="transfer"}});z(l,$=>{$&&(o.value=a.msg.content)});const c=$=>{n("long-press",$,a.msg.id)},s=()=>{n("cancel-long-press")},p=$=>{n("touch-move",$)},v=$=>{a.msg.type==="voice"&&r(),a.msg.type!=="image"&&n("click-msg",$,a.msg.id)},m=()=>{a.msg.sender!=="user"&&n("show-thought",a.msg.id)},r=()=>{f.value=!f.value},h=()=>{i.value=!i.value},B=()=>{o.value.trim()&&n("save-edit",{msgId:a.msg.id,newContent:o.value})},T=()=>{n("cancel-edit")},V=()=>a.msg.type==="notification"?a.msg.content:a.msg.type==="revoked"?`"${a.msg.sender==="user"?"你":a.charName}" 撤回了一条消息`:"";return($,C)=>(b(),S("div",{class:U(["message",{sent:t.msg.sender==="user",received:t.msg.sender!=="user",revoked:t.msg.type==="revoked"||t.msg.type==="notification","selection-mode-active":t.isSelectionMode}])},[e("div",{class:U(["message-checkbox",{checked:t.isSelected,visible:t.isSelectionMode}]),onClick:C[0]||(C[0]=J(A=>$.$emit("toggle-selection",t.msg.id),["stop"]))},null,2),t.msg.type==="revoked"||t.msg.type==="notification"?(b(),S("div",{key:0,class:"system-message-wrapper",onMousedown:c,onMouseup:s,onMouseleave:s,onTouchstart:c,onTouchend:s,onTouchmove:p,onClick:J(v,["prevent"])},[e("div",{class:"system-message-text",onClick:C[1]||(C[1]=J(A=>!t.isSelectionMode&&h(),["stop"]))},k(V()),1),t.msg.type==="revoked"?j((b(),S("div",{key:0,class:"revoked-content"},k(t.msg.sender==="user"?"我":t.charName)+"："+k(t.msg.content),513)),[[ce,i.value]]):D("",!0)],32)):(b(),S(F,{key:1},[e("div",{class:"msg-avatar",onClick:m},[(t.msg.sender==="user"?t.userAvatar:t.charAvatar)?(b(),S("img",{key:0,src:t.msg.sender==="user"?t.userAvatar:t.charAvatar,alt:"avatar"},null,8,os)):(b(),S("div",{key:1,class:U(["default-avatar",{user:t.msg.sender==="user"}])},null,2))]),e("div",as,[e("div",ls,[e("div",{class:U(["msg-bubble",d.value]),style:Z(t.bubbleStyle),onMousedown:c,onMouseup:s,onMouseleave:s,onTouchstart:c,onTouchend:s,onTouchmove:p,onClick:J(v,["prevent"])},[t.msg.quote?(b(),S("div",is,[e("div",rs,k(t.msg.quote.sender==="user"?"你":t.charName)+":",1),e("div",cs,k(t.msg.quote.content),1)])):D("",!0),l.value?(b(),S("div",ds,[j(e("textarea",{"onUpdate:modelValue":C[2]||(C[2]=A=>o.value=A),class:"edit-textarea",rows:"3"},null,512),[[Y,o.value]]),e("div",{class:"edit-actions"},[e("button",{onClick:T,class:"edit-btn cancel"},"取消"),e("button",{onClick:B,class:"edit-btn save"},"保存")])])):(b(),S(F,{key:2},[t.msg.type==="text"?(b(),S("div",us,k(t.msg.content),1)):t.msg.type==="image"?(b(),S(F,{key:1},[t.msg.isTextGenerated||t.msg.sender!=="user"&&!t.msg.content.startsWith("http")&&!t.msg.content.startsWith("data:")?(b(),S("div",{key:0,class:"text-generated-image-container",onClick:C[3]||(C[3]=A=>y(u).preview(t.msg))},[e("div",vs,k(t.msg.content),1)])):(b(),S("div",{key:1,class:"image-msg",onClick:C[4]||(C[4]=A=>y(u).preview(t.msg))},[e("img",{src:t.msg.content,alt:"图片"},null,8,gs)]))],64)):t.msg.type==="sticker"?(b(),S("div",ms,[e("img",{src:t.msg.content,alt:"表情包"},null,8,fs)])):t.msg.type==="voice"?(b(),S("div",ps,[e("div",hs,[q(oe,{name:"voice-wave",class:U(["voice-icon-svg",{playing:f.value}])},null,8,["class"]),e("span",null,k(Math.min(60,Math.ceil(t.msg.content.length/2)))+'"',1)])])):t.msg.type==="location"?(b(),S("div",bs,[e("div",ks,[e("div",ys,k(t.msg.content||"位置信息"),1),C[5]||(C[5]=e("div",{class:"msg-desc"},"详细地址",-1))]),C[6]||(C[6]=Se('<div class="location-map" data-v-9aec6d12><img src="https://files.catbox.moe/uryae6.png" alt="地图" data-v-9aec6d12><div class="location-pin" data-v-9aec6d12><svg viewBox="0 0 24 24" fill="currentColor" data-v-9aec6d12><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" data-v-9aec6d12></path></svg></div></div>',1))])):t.msg.type==="transfer"?(b(),S("div",Ss,[e("div",$s,[C[7]||(C[7]=e("div",{class:"transfer-icon"},"¥",-1)),e("div",Ms,[e("div",ws,"¥"+k(t.msg.content),1),e("div",Cs,k(t.msg.sender==="user"?`转账给${t.charName}`:"转账给你"),1)])]),C[8]||(C[8]=e("div",{class:"transfer-footer"},"微信转账",-1))])):t.msg.type==="call_summary"?(b(),S("div",xs,[C[9]||(C[9]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1 0-1.35c2.93-2.94 6.86-4.73 11.21-4.73s8.28 1.79 11.21 4.73c.38.38.38 1.02 0 1.4l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.66-1.85.995.995 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})],-1)),e("span",null,k(t.msg.content),1)])):D("",!0)],64))],38),t.msg.blocked&&t.msg.sender!=="user"?(b(),S("div",Ts,[...C[10]||(C[10]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)])])):D("",!0)]),t.msg.type==="voice"?j((b(),S("div",{key:0,class:"voice-text"},k(t.msg.content),513)),[[ce,f.value]]):D("",!0)])],64))],2))}},As=O(Is,[["__scopeId","data-v-9aec6d12"]]),Ps={key:0,class:"empty-message"},Vs={key:0,class:"timestamp"},Bs={key:0,class:"blocked-overlay"},Ls={class:"blocked-content"},Es=5*60*1e3,Rs={__name:"MessageList",props:{messages:{type:Array,default:()=>[]},charName:String,charAvatar:String,userAvatar:String,bubbleStyle:Object,isSelectionMode:Boolean,selectedMessageIds:Set,isBlocked:Boolean,editingMessageId:String,activePanel:String},emits:["save-edit","cancel-edit","toggle-selection","long-press","cancel-long-press","touch-move","click-msg","unblock","show-text-content","show-thought"],setup(t,{expose:g}){const a=t,n=x(null),u=o=>{if(o===0)return!0;const l=a.messages[o],d=a.messages[o-1];if(!l.timestamp||!d.timestamp)return!1;const c=new Date(l.timestamp).getTime(),s=new Date(d.timestamp).getTime();return c-s>Es},f=o=>{if(!o)return"";const l=new Date(o),d=new Date,c=new Date(d.getFullYear(),d.getMonth(),d.getDate()),s=new Date(c.getTime()-864e5),p=d.getDay()===0?7:d.getDay(),v=new Date(c.getTime()-(p-1)*864e5),m=l.getHours().toString().padStart(2,"0"),r=l.getMinutes().toString().padStart(2,"0"),h=`${m}:${r}`;if(l.getTime()>=c.getTime())return h;if(l.getTime()>=s.getTime())return`昨天 ${h}`;if(l.getTime()>=v.getTime())return`${["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][l.getDay()]} ${h}`;{const B=l.getFullYear(),T=(l.getMonth()+1).toString(),V=l.getDate().toString();return B===d.getFullYear()?`${T}月${V}日 ${h}`:`${B}年${T}月${V}日 ${h}`}},i=()=>{n.value&&(n.value.scrollTop=n.value.scrollHeight)};return z(()=>a.messages,()=>{ae(()=>{i()})},{deep:!0}),z(()=>a.activePanel,o=>{o&&ae(()=>{i()})}),ue(()=>{i()}),g({scrollToBottom:i}),(o,l)=>(b(),S(F,null,[e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:n},[t.messages.length===0?(b(),S("div",Ps," 开始和 "+k(t.charName)+" 聊天吧~ ",1)):D("",!0),(b(!0),S(F,null,X(t.messages,(d,c)=>(b(),S(F,{key:d.id},[u(c)?(b(),S("div",Vs,k(f(d.timestamp)),1)):D("",!0),q(As,{msg:d,charName:t.charName,charAvatar:t.charAvatar,userAvatar:t.userAvatar,bubbleStyle:t.bubbleStyle,isSelectionMode:t.isSelectionMode,isSelected:t.selectedMessageIds.has(d.id),editingMessageId:t.editingMessageId,onSaveEdit:l[0]||(l[0]=s=>o.$emit("save-edit",s)),onCancelEdit:l[1]||(l[1]=s=>o.$emit("cancel-edit")),onToggleSelection:l[2]||(l[2]=s=>o.$emit("toggle-selection",s)),onLongPress:l[3]||(l[3]=(s,p)=>o.$emit("long-press",s,p)),onCancelLongPress:l[4]||(l[4]=s=>o.$emit("cancel-long-press")),onTouchMove:l[5]||(l[5]=s=>o.$emit("touch-move",s)),onClickMsg:l[6]||(l[6]=(s,p)=>o.$emit("click-msg",s,p)),onShowTextContent:l[7]||(l[7]=s=>o.$emit("show-text-content",s)),onShowThought:l[8]||(l[8]=s=>o.$emit("show-thought",s))},null,8,["msg","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","isSelected","editingMessageId"])],64))),128))],512),t.isBlocked?(b(),S("div",Bs,[e("div",Ls,[l[10]||(l[10]=e("div",{class:"blocked-text"},"对方已被你拉黑",-1)),e("button",{class:"blocked-btn",onClick:l[9]||(l[9]=d=>o.$emit("unblock"))},"解除拉黑")])])):D("",!0)],64))}},Ds=O(Rs,[["__scopeId","data-v-6207cf47"]]),qs={__name:"VoiceInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:g}){const a=t,n=g,u=E({get:()=>a.visible,set:o=>n("update:visible",o)}),f=x("");z(()=>a.visible,o=>{o&&(f.value="")});const i=()=>{const o=f.value.trim();n("confirm",o),u.value=!1};return(o,l)=>(b(),W(ee,{visible:u.value,"onUpdate:visible":l[2]||(l[2]=d=>u.value=d),title:"发送语音"},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:l[1]||(l[1]=d=>u.value=!1)},"取消"),e("button",{class:"modal-btn confirm",onClick:i},"发送")]),default:H(()=>[j(e("input",{type:"text",class:"base-input","onUpdate:modelValue":l[0]||(l[0]=d=>f.value=d),placeholder:"输入语音内容..."},null,512),[[Y,f.value]])]),_:1},8,["visible"]))}},Ns={__name:"LocationInput",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","confirm"],setup(t,{emit:g}){const a=t,n=g,u=E({get:()=>a.visible,set:l=>n("update:visible",l)}),f=x(""),i=x("");z(()=>a.visible,l=>{l&&(f.value="",i.value="")});const o=()=>{const l=f.value.trim(),d=i.value.trim();l&&(n("confirm",{name:l,detail:d}),u.value=!1)};return(l,d)=>(b(),W(ee,{visible:u.value,"onUpdate:visible":d[3]||(d[3]=c=>u.value=c),title:"发送位置"},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:d[2]||(d[2]=J(c=>u.value=!1,["stop"]))},"取消"),e("button",{class:"modal-btn confirm",onClick:o},"发送")]),default:H(()=>[j(e("input",{type:"text",class:"base-input","onUpdate:modelValue":d[0]||(d[0]=c=>f.value=c),placeholder:"位置名称 (如: 广州塔)",autocomplete:"new-password"},null,512),[[Y,f.value]]),j(e("input",{type:"text",class:"base-input","onUpdate:modelValue":d[1]||(d[1]=c=>i.value=c),placeholder:"详细地址 (可选)",style:{"margin-top":"10px"},autocomplete:"new-password"},null,512),[[Y,i.value]])]),_:1},8,["visible"]))}},Us={class:"chat-list-container"},zs=["onClick"],Os=["src"],js={class:"chat-info"},Fs={class:"chat-name"},Hs=["disabled"],Ws={__name:"ForwardSelection",props:{visible:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:g}){const a=t,n=g,u=G(),f=x(a.visible),i=x(new Set),o=E(()=>u.characters);z(()=>a.visible,c=>{f.value=c,c||i.value.clear()});const l=c=>{i.value.has(c)?i.value.delete(c):i.value.add(c)},d=()=>{i.value.size>0&&n("confirm",Array.from(i.value))};return(c,s)=>(b(),W(ee,{visible:f.value,"onUpdate:visible":s[1]||(s[1]=p=>f.value=p),title:"选择聊天",onClose:s[2]||(s[2]=p=>c.$emit("close"))},{footer:H(()=>[e("button",{class:"modal-btn cancel",onClick:s[0]||(s[0]=p=>c.$emit("close"))},"取消"),e("button",{class:"modal-btn confirm",disabled:i.value.size===0,onClick:d}," 确定 ("+k(i.value.size)+") ",9,Hs)]),default:H(()=>[e("div",Us,[(b(!0),S(F,null,X(o.value,p=>(b(),S("div",{key:p.id,class:"chat-item",onClick:v=>l(p.id)},[e("img",{src:p.avatar,alt:"avatar",class:"avatar"},null,8,Os),e("div",js,[e("div",Fs,k(p.name),1)]),e("div",{class:U(["checkbox",{selected:i.value.has(p.id)}])},null,2)],8,zs))),128))])]),_:1},8,["visible"]))}},Gs=O(Ws,[["__scopeId","data-v-00bcf675"]]),Js={class:"note-container"},Ys={key:0,class:"content-wrapper"},Qs={class:"note-header current-header"},Ks=["src"],Xs={key:1,class:"avatar-placeholder"},Zs={class:"character-name"},_s={class:"status-section"},en={class:"status-row"},tn={class:"status-value"},sn={class:"status-row"},nn={class:"status-value"},on={class:"status-row"},an={class:"status-value"},ln={class:"inner-voice-section"},rn={class:"inner-voice-box"},cn={class:"unspoken-section"},dn={class:"unspoken-text"},un={key:1,class:"content-wrapper history-wrapper"},vn={class:"scroll-container"},gn={class:"item-header"},mn={class:"item-date"},fn={class:"prop-row"},pn={class:"prop-row"},hn={class:"prop-row"},bn={class:"prop-row"},kn={class:"prop-row"},yn={__name:"SingleCharStatus",props:{visible:{type:Boolean,default:!1},name:{type:String,default:""},avatar:{type:String,default:""},charId:{type:String,required:!0}},emits:["close"],setup(t,{emit:g}){const a=t,n=G(),{currentInnerVoice:u,innerVoices:f}=at(n),i=E(()=>u.value[a.charId]||{emotion:"",outfit:"",posture:"",innerVoice:"",unspokenWords:""}),o=E(()=>f.value[a.charId]||[]),l=v=>v?new Date(v).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"."):"",d=g,c=x(!1),s=()=>{c.value=!c.value};z(()=>a.visible,v=>{v?(document.body.style.overflow="hidden",c.value=!1):document.body.style.overflow=""});const p=()=>{d("close")};return(v,m)=>t.visible?(b(),S("div",{key:0,class:"note-modal-mask",onClick:J(p,["self"])},[e("div",Js,[e("div",{class:"tape-button",onClick:s}),e("div",{class:U(["note",{"history-mode":c.value}])},[m[11]||(m[11]=e("div",{class:"paper-texture"},null,-1)),c.value?(b(),S("div",un,[e("div",{class:"note-header history-header"},[m[5]||(m[5]=e("div",{class:"header-title"},"历史心声",-1)),e("button",{class:"close-btn",onClick:p},"✕")]),e("div",vn,[(b(!0),S(F,null,X(o.value,r=>(b(),S("div",{key:r.id,class:"history-item"},[e("div",gn,[e("span",null,k(r.title),1),e("span",mn,k(l(r.timestamp)),1)]),e("div",fn,[m[6]||(m[6]=e("span",{class:"prop-label"},"情绪：",-1)),K(k(r.emotion),1)]),e("div",pn,[m[7]||(m[7]=e("span",{class:"prop-label"},"穿着：",-1)),K(k(r.outfit),1)]),e("div",hn,[m[8]||(m[8]=e("span",{class:"prop-label"},"姿态：",-1)),K(k(r.posture),1)]),e("div",bn,[m[9]||(m[9]=e("span",{class:"prop-label"},"内心独白：",-1)),K(k(r.innerVoice),1)]),e("div",kn,[m[10]||(m[10]=e("span",{class:"prop-label"},"没说出口的话：",-1)),K(k(r.unspokenWords),1)])]))),128))])])):(b(),S("div",Ys,[e("div",Qs,[t.avatar?(b(),S("img",{key:0,src:t.avatar,class:"avatar-img",alt:"avatar"},null,8,Ks)):(b(),S("div",Xs,k(t.name?t.name.charAt(0):"?"),1)),e("div",Zs,k(t.name),1),e("button",{class:"close-btn",onClick:p},"✕")]),e("div",_s,[e("div",en,[m[0]||(m[0]=e("span",{class:"status-label"},"情绪",-1)),e("span",tn,k(i.value.emotion||"无"),1)]),e("div",sn,[m[1]||(m[1]=e("span",{class:"status-label"},"穿着",-1)),e("span",nn,k(i.value.outfit||"无"),1)]),e("div",on,[m[2]||(m[2]=e("span",{class:"status-label"},"姿态",-1)),e("span",an,k(i.value.posture||"无"),1)])]),e("div",ln,[m[3]||(m[3]=e("div",{class:"section-title"},"Inner Voice",-1)),e("div",rn,[e("p",null,k(i.value.innerVoice||"（没有内心独白）"),1)])]),e("div",cn,[m[4]||(m[4]=e("div",{class:"unspoken-title"},"没说出口的话",-1)),e("div",dn,k(i.value.unspokenWords||"（没有想说的话）"),1)])])),m[12]||(m[12]=e("div",{class:"torn-edge"},null,-1))],2)])])):D("",!0)}},Sn=O(yn,[["__scopeId","data-v-8274f6c4"]]),$n={__name:"SingleChat",props:{charId:{type:String,required:!0}},setup(t){const g=t,a=de(),{t:n}=Q(),u=G(),f=_(),i=lt(),o=x(null),l=x(null),d=x(null),c=x(!1),s=x({visible:!1,messageId:null,targetEl:null}),p=x(!1),v=x(!1),m=x(!1),r=x(!1);x("");const h=E(()=>u.getCharacter(g.charId)),B=E(()=>{var w;return((w=h.value)==null?void 0:w.isBlocked)||!1}),T=E(()=>{var w,M;return((w=h.value)==null?void 0:w.nickname)||((M=h.value)==null?void 0:M.name)||n("chat.unknownCharacter")}),V=E(()=>{var w;return((w=h.value)==null?void 0:w.name)||n("chat.unknownCharacter")}),$=E(()=>{var w;return(w=h.value)==null?void 0:w.avatar}),C=E(()=>{var w;return((w=h.value)==null?void 0:w.status)||{}}),A=E(()=>{var w;return((w=h.value)==null?void 0:w.chatBackground)||""}),P=E(()=>{const w=h.value;if(!w||!w.userPersona)return"";const M=u.userPersonas.find(L=>L.id===w.userPersona);return(M==null?void 0:M.avatar)||""}),I=E(()=>u.messages[g.charId]||[]),R=E(()=>{var w;return((w=h.value)==null?void 0:w.bubbleSettings)||{}}),{isSelectionMode:N,selectedMessageIds:te,isForwarding:ve,enterSelectionMode:$e,exitSelectionMode:ge,toggleMessageSelection:me,handleBatchAction:Me,handleConfirmForward:we}=dt(ne(g,"charId")),{isTyping:Ce,triggerAiResponse:fe}=ct(ne(g,"charId"),i),{inputText:se,quotingMessage:le,sendMessage:xe,sendSticker:Te,sendVoiceMessage:Ie,handleSendImage:Ae,confirmSendLocation:Pe,sendTransfer:Ve}=vt(u,ne(g,"charId"),f,d),{editingMessageId:pe,handleEditMessage:Be,handleSaveEdit:Le,updateInputText:Ee}=ut(u,ne(g,"charId"),se),{startLongPress:Re,cancelLongPress:De,handleTouchMove:qe,wasClickAfterLongPress:Ne}=gt(s),Ue=E(()=>{const w=R.value,M={fontSize:w.fontSize?`${w.fontSize}px`:"14px"};if(w.css){const L={};return w.css.split(";").forEach(Xe=>{const ie=Xe.split(":");if(ie.length>=2){const he=ie[0].trim(),be=ie.slice(1).join(":").trim();he&&be&&(L[he]=be)}}),{...M,...L}}return M});z(c,w=>{w&&(a.push({name:"single-chat-settings",params:{id:g.charId}}),c.value=!1)}),ue(()=>{u.clearUnreadCount(g.charId)});const ze=()=>{h.value&&(h.value.isBlocked=!1,u.messages[g.charId]&&u.messages[g.charId].forEach(w=>{w.blocked&&(w.blocked=!1)}),u.saveData(),f.showToast(n("chat.toast.unblocked")))},Oe=w=>{const M=w.target;M.closest(".modal-overlay.active")||(d.value&&!M.closest(".chat-footer")&&(d.value=null),N.value&&!M.closest(".message")&&!M.closest(".chat-action-row")&&!M.closest(".message-checkbox")&&!M.closest(".message-menu")&&ge(),s.value.visible&&!M.closest(".message-menu")&&(s.value.visible=!1))},je=(w,M)=>{if(Ne()){w.preventDefault(),w.stopPropagation();return}N.value&&me(M)},Fe=w=>{const M=I.value.find(L=>L.id===w);M&&(le.value=M)},He=()=>{v.value=!0},We=w=>{Ie(w),v.value=!1},Ge=()=>{d.value=null,p.value=!0},Je=()=>{m.value=!0},Ye=({name:w,detail:M})=>{Pe(w,M),m.value=!1},Qe=()=>{u.startVideoCall(g.charId,"user")},Ke=()=>{r.value=!0};return(w,M)=>(b(),S("div",{class:U(["chat-room active",{"selection-mode":y(N)}]),onClick:Oe,ref_key:"chatRoomRef",ref:l},[e("div",{class:"chat-bg",style:Z(A.value?{backgroundImage:`url(${A.value})`}:{})},null,4),q($t,{charId:g.charId,charName:T.value,charStatus:C.value,isTyping:y(Ce),onTriggerAi:y(fe),onOpenSettings:M[0]||(M[0]=L=>c.value=!0)},null,8,["charId","charName","charStatus","isTyping","onTriggerAi"]),q(Ds,{ref_key:"messageListRef",ref:o,messages:I.value,charName:T.value,charAvatar:$.value,userAvatar:P.value,bubbleStyle:Ue.value,isSelectionMode:y(N),selectedMessageIds:y(te),isBlocked:B.value,editingMessageId:y(pe),activePanel:d.value,onSaveEdit:y(Le),onCancelEdit:M[1]||(M[1]=L=>pe.value=null),onToggleSelection:y(me),onLongPress:y(Re),onCancelLongPress:y(De),onTouchMove:y(qe),onClickMsg:je,onUnblock:ze,onShowThought:Ke},null,8,["messages","charName","charAvatar","userAvatar","bubbleStyle","isSelectionMode","selectedMessageIds","isBlocked","editingMessageId","activePanel","onSaveEdit","onToggleSelection","onLongPress","onCancelLongPress","onTouchMove"]),y(N)?D("",!0):(b(),W(Xt,{key:0,modelValue:y(se),"onUpdate:modelValue":M[2]||(M[2]=L=>it(se)?se.value=L:null),activePanel:d.value,"onUpdate:activePanel":M[3]||(M[3]=L=>d.value=L),charId:g.charId,quotingMessage:y(le),onCancelQuote:M[4]||(M[4]=L=>le.value=null),onSendMessage:y(xe),onSendSticker:y(Te),onTriggerVoice:He,onTriggerImage:Ge,onTriggerVideo:Qe,onTriggerLocation:Je,onTriggerTransfer:y(Ve)},null,8,["modelValue","activePanel","charId","quotingMessage","onSendMessage","onSendSticker","onTriggerTransfer"])),y(N)?(b(),W(ns,{key:1,onAction:y(Me),onCancel:y(ge)},null,8,["onAction","onCancel"])):D("",!0),q(qs,{visible:v.value,"onUpdate:visible":M[5]||(M[5]=L=>v.value=L),onConfirm:We},null,8,["visible"]),q(ye,{visible:p.value,"onUpdate:visible":M[6]||(M[6]=L=>p.value=L),onSendImage:y(Ae)},null,8,["visible","onSendImage"]),q(Ns,{visible:m.value,"onUpdate:visible":M[7]||(M[7]=L=>m.value=L),onConfirm:Ye},null,8,["visible"]),q(es,{visible:s.value.visible,targetEl:s.value.targetEl,messageId:s.value.messageId,charId:g.charId,isSelectionMode:y(N),selectedMessageIds:y(te),onClose:M[8]||(M[8]=L=>s.value.visible=!1),onEnterSelectionMode:y($e),onTriggerAiResponse:y(fe),"onUpdate:inputText":y(Ee),onQuoteMessage:Fe,onEditMessage:y(Be)},null,8,["visible","targetEl","messageId","charId","isSelectionMode","selectedMessageIds","onEnterSelectionMode","onTriggerAiResponse","onUpdate:inputText","onEditMessage"]),q(Gs,{visible:y(ve),onClose:M[9]||(M[9]=L=>ve.value=!1),onConfirm:y(we)},null,8,["visible","onConfirm"]),q(Sn,{visible:r.value,name:V.value,avatar:$.value,charId:g.charId,onClose:M[10]||(M[10]=L=>r.value=!1)},null,8,["visible","name","avatar","charId"])],2))}},wn=O($n,[["__scopeId","data-v-1b9190c7"]]);export{wn as default};
